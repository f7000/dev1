<?xml version="1.0" encoding="EUC-KR"?>
<sqls> 

   <!-- 2011.12.15 건보, 의보 자격 정보 조회 -->
   <statement id="getMsg2Info"><![CDATA[    
	SELECT	*
	FROM	(         
         SELECT	a.rrgstno,
         			a.proccorpcd,
         			a.hngnm,
         			a.workdt,
         			a.instcd,
         			a.orddd,
         			a.loginid,
         			a.password,
         			a.datainptdt,
         			a.msgtype,
         			a.clntuniqval,
         			a.empno,
         			a.qualflag,
         			a.qualacqtdd,
         			a.hshdnm,
         			a.secuinstmark,
         			a.estmmark,
         			a.paylimdd,
         			a.ownbflag,
         			a.heallifeamtval,
         			a.choicorpmark1,
         			a.choicorpmark2,
         			a.choicorpmark3,
         			a.choicorpmark4,
         			a.choicorpnm1,
         			a.choicorpnm2,
         			a.choicorpnm3,
         			a.choicorpnm4,
         			a.dcntrypsnyn,
         			a.handicaprrgstdd,
         			a.rareobsttrgtman,
         			a.befwomntrgtman,
         			a.scndsuptrgtman,
         			a.serdiagtrgtman,
         			a.msgcd,
         			a.msg,
         			a.fstrgstrid,
         			a.fstrgstdt,
         			a.lastupdtrid,
         			a.lastupdtdt,
         			a.pregremamt,
         			a.burntrgtman,
         			CASE	WHEN nvl(SERDIAGTRGTMAN, '-') = '-' THEN 'N'
							WHEN #orddd# between substr(SERDIAGTRGTMAN, 20, 8) and substr(SERDIAGTRGTMAN, 28, 8) THEN 'Y'
							ELSE 'N' END AS srdgyn,		--중증여부
					( SELECT	CASE WHEN GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD') THEN 'Y' ELSE 'N' END
					  FROM	EMR.MMOHSDOA d
					  WHERE	d.instcd = a.instcd
					  AND		d.pid = b.pid
					  AND		d.histcd = 'O'
					  AND		NVL(d.serdiagno, '-') in ('-' ,'0','0000000000',NULL)
					  AND		d.insukind = #insukind# 
					  AND		d.GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD')
					  AND		rownum < 2
					) AS srdgtdaygenyn,	--당일중증신청여부
					CASE	WHEN nvl(BEFWOMNTRGTMAN, '-') = '-' THEN 'N'
							WHEN #orddd# between substr(BEFWOMNTRGTMAN, 20, 8) and substr(BEFWOMNTRGTMAN, 28, 8) THEN 'Y'
							ELSE 'N' END AS rooayn,		--희귀난치여부
					( SELECT  'Y'		--희귀난치성산정특례 번호 체크여부 Y 체크안함
		              FROM   emr.mmohdiag f
						  	  ,  emr.mrtddiagattr c
						  	  ,  emr.mrtmterm d
						  	  ,  pam.picmessc e
					  WHERE  f.pid        = #pid#
					   AND  f.orddd      = #orddd#
					   AND  f.cretno     = #cretno#
					   AND  f.orddeptcd  = #orddeptcd#
					   AND  f.diaghistcd = 'O'
					   AND  f.diagtypecd = 'D'
					   AND  f.diagkindcd ='C'
					   AND  f.diagkindcdflag = 'M'
					   AND  d.termcd = f.diagcd 
					   AND  d.termflag   = '0'    
					   AND  f.diagdd between d.termfromdd AND d.termtodd
					   AND  c.diagattrcd = d.attrcd 
					   AND  f.diagdd between c.DIAGATTRFROMDD and c.DIAGATTRTODD
					   AND  a.instcd = f.instcd
					   AND  a.instcd = c.instcd
					   AND  a.instcd = d.instcd
					   AND  e.instcd = a.instcd
					   AND  e.insukind = #insukind# 
					   AND  #orddd# between e.fromdd and e.todd
					   AND  e.spclflag in (	'10' ) --10 희귀난치성산정특례  
					   AND  e.srchflag IN ('A', 'B', 'F' )	--A 상병, B 상병+처방, F 처방  희귀번호체크 안함.
					   AND  decode(e.diagkind, '1', c.icd10cd, d.attrcd) BETWEEN e.diagcdfrom AND e.diagcdto
					   AND  rownum = 1
					) AS rooaesscyn,		--희귀난치성산정특례 번호 체크여부 Y 체크안함
					( SELECT	CASE WHEN GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD') THEN 'Y' ELSE 'N' END
					  FROM	EMR.MMOHROOA d
					  WHERE	d.instcd = a.instcd
					  AND		d.pid = b.pid
					  AND		d.histcd = 'O'
					  AND		NVL(d.rareobstno, '-') in ('-' ,'0','0000000000',NULL)
					  AND		d.rgstkindcd  ='01'  --01 희귀산특, 02 화상중증
					  AND		d.GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD')
					  AND		rownum < 2
					) AS rooatdaygenyn,	--당일희귀신청여부
					CASE	WHEN nvl(BURNTRGTMAN, '-') = '-' THEN 'N'
							WHEN #orddd# between substr(BURNTRGTMAN, 20, 8) and substr(BURNTRGTMAN, 28, 8) THEN 'Y'
							ELSE 'N' END AS burnyn,		--중증화상여부
					( SELECT	CASE WHEN GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD') THEN 'Y' ELSE 'N' END
					  FROM	EMR.MMOHROOA d
					  WHERE	d.instcd = a.instcd
					  AND		d.pid = b.pid
					  AND		d.histcd = 'O'
					  AND		NVL(d.rareobstno, '-') in ('-' ,'0','0000000000',NULL)
					  AND		d.rgstkindcd  ='02'  --01 희귀산특, 02 화상중증
					  AND		d.GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD')
					  AND		rownum < 2
					) AS burntdaygenyn,	--당일중증화상신청여부
					DENTTOP,
					CASE	WHEN nvl(DENTTOP, '-') = '-' THEN 'N'
							WHEN #orddd# between substr(DENTTOP, 40, 8) and DECODE(substr(DENTTOP, 48, 8), '        ', '99991231', substr(DENTTOP, 48, 8)) THEN 'Y'
							ELSE 'N' END AS denturestopyn,		--레진상틀니여부상악
					DENTBOTTOM,
					CASE	WHEN nvl(DENTBOTTOM, '-') = '-' THEN 'N'
							WHEN #orddd# between substr(DENTBOTTOM, 40, 8) and DECODE(substr(DENTBOTTOM, 48, 8), '        ', '99991231', substr(DENTBOTTOM, 48, 8)) THEN 'Y'
							ELSE 'N' END AS denturesbottomyn,		--레진상틀니여부상악
					( SELECT	CASE WHEN GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD') THEN 'Y' ELSE 'N' END
					  FROM	EMR.MMOHROOA d
					  WHERE	d.instcd = a.instcd
					  AND		d.pid = b.pid
					  AND		d.histcd = 'O'
					  AND		NVL(d.rareobstno, '-') in ('-' ,'0','0000000000',NULL)
					  AND		d.rgstkindcd  IN ('03', '04')  --01 희귀산특, 02 화상중증, 03 레진상틀니상악, 04 레진상틀니하악
					  AND		d.GENRDD = TO_CHAR(SYSDATE, 'YYYYMMDD')
					  AND		rownum < 2
					) AS denturestdaygenyn,	--당일레진상틀니신청여부
					CASE	WHEN nvl(RAREOBSTTRGTMAN, '-') = '-' THEN 'N1'
					   		WHEN substr(RAREOBSTTRGTMAN, 1, 1) != 'H' THEN 'N2'
							WHEN #orddd# between substr(RAREOBSTTRGTMAN, 5, 8) and NVL(trim(substr(RAREOBSTTRGTMAN, 13, 8)), '99991231') THEN 'Y'
							ELSE 'N3' END AS rareyn,		--H희귀여부
					CASE	WHEN nvl(PAYLIMDD, '-') = '-' THEN 'N'
							WHEN #orddd# > PAYLIMDD and NVL(OWNBFLAG, '-') = '-' THEN 'Y'
							ELSE 'N' END AS paylimityn,	--급여제한여부
					( SELECT CDNM
					  FROM	PAM.PMCMCODE d
					  WHERE	d.INSTCD = A.INSTCD
					  AND		d.CDGRUPID = 'P0032'
					  AND		d.CDID = '300' ) as errortype
         FROM	PAM.PMCMMSG2 A, PAM.PMCMPTBS B         
         WHERE 	B.pid      = #pid#
         AND		B.instcd	= #instcd#
         AND 		A.rrgstno = B.rrgstno1 || B.rrgstno2
         AND 		A.instcd   = B.instcd
         			-- 당일/예약은 오늘 자격조회한 내역을 체크
         AND 		A.workdt  >= TO_CHAR(SYSDATE, 'YYYYMMDD') 
         AND 		( #orddd# <= A.orddd OR #orddd# > TO_CHAR(SYSDATE, 'YYYYMMDD') )
         order by workdt desc
		)
	WHERE	rownum = 1
             ]]>
   </statement> 
    
  <!-- 외래등록조회(외래수납)  --> 
  <!-- TRPAO00101 -->    
    <statement id="getOutRgstList"><![CDATA[    
        SELECT distinct a.pid
                    ,   a.orddd
                    ,   a.cretno
                    ,   a.acptseqno
                    ,   a.instcd
                    ,   a.histstat
                    ,   a.orgorddd
                    ,   a.orgcretno
                    ,   a.calcbaseflag
                    ,   a.calcyn
                    ,   a.ordtm
                    ,   a.orddeptcd
                    ,   COM.FN_ZS_GETDEPTNAME(a.instcd, a.orddeptcd, a.orddd) AS orddeptcdnm
                    ,   a.orddrid
                    ,   COM.FN_ZS_GETUSERNM(a.orddrid, a.orddd) AS orddridnm
                    ,   a.dutdeptcd
                    ,   a.centcd
                    ,   a.supdeptcd
                    ,   a.mskind
                    ,   a.insukind
                    ,   a.suppkind
                    ,   a.insucd
                    ,   a.suppkindresn
                    ,   a.specordyn
                    ,   a.holiflag
                    ,   a.fsexamflag
                    ,   a.fsexammanlyn
                    ,   a.ordtype
                    ,   a.brateflag
                    ,   a.medamtestmyn
                    ,   a.medamtpostyn
                    ,   a.medamtfreeresn
                    ,   a.rsrvflag
                    ,   a.etcordflag
                    ,   a.disccd
                    ,   a.hosoutexptresncd
                    ,   a.clincstdyacptflag
                    ,   a.clincstdyno
                    ,   a.chrtlendyn
                    ,   a.specorddescyn
                    ,   a.ordreqdescyn
                    ,   a.ordreqhospgrde
                    ,   a.insuchrgyn
                    ,   a.nursacptyn
                    ,   a.nursacptdt
                    ,   a.dracptyn
                    ,   a.dracptdt
                    ,   a.prcpgenryn
                    ,   a.prcpnotoccrresn
                    ,   a.estmspclappyn                 --산정특례적용여부(진료부에서입력)
                    ,   a.elbulbodstat
                    ,   a.elbulbodstatdt
                    ,   a.calcflag
                    ,   a.calcmthdflag
                    ,   a.dnoracptyn
                    ,   a.rqstflag
                    ,   a.rqsthospcd
                    ,   a.rqstdrid
                    ,   a.tdayinflag
                    ,   a.tranindd
                    ,   a.rcptdd
                    ,   a.rcptno
                    ,   a.rcptseqno
                    ,   a.telrsrvrem
                    ,   a.updtcnclresn
                    ,   a.fstacptid
                    ,   a.fstacptdt
                    ,   a.fstrgstrid
                    ,   a.fstrgstdt
                    ,   a.lastupdtrid
                    ,   a.lastupdtdt
                    ,   a.handicaprbookpossnyn              --장애인수첩소지자여부
                    ,   a.undersixageyn                     --6세미만여부
                    ,   a.ordreqformflag                    --진료의뢰서구분(수급절차)
                    ,   case when (a.orddd >= b.indd and a.orddd <= SUBSTR(TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'), 1, 8)) then 'N' else 'Y' 
                        end as inddflag
                    ,   a.ownbflag
                    ,   a.uncocd
					,   a.pmflag
                    ,   a.emplno
                    ,   a.suppkindsubyn
                    ,   a.earnendyn
                    ,   a.rareobstflag                       --희귀난치대상자구분
                    ,   a.tranflag
                    ,   a.onlnno
                    ,   a.inetproxyrrgstno
                    ,   a.holdflag
                    ,	a.probjudgflag
                    ,	a.dschjudgprcsstat
                    ,   (select c.insuno from pam.pmcmptin c where c.pid = a.pid AND c.insukind = a.insukind AND c.fromdd <= a.orddd AND c.todd >= a.orddd AND c.instcd = a.instcd AND c.histstat = 'Y' AND rownum =1) as insuno
                    --,   (select dcgm.discreducd from pam.PADHDCGM dcgm where dcgm.pid = a.pid AND dcgm.instcd = a.instcd AND dcgm.rcptdd = a.rcptdd AND dcgm.rcptno = a.rcptno AND dcgm.rcptseqno = a.rcptseqno AND dcgm.discreduflag ='G' AND rownum =1) as discreducd
                    ,  CASE when a.orddd < TO_CHAR(sysdate,'YYYYMMDD') THEN
                                    CASE WHEN
                                     (SELECT count(*) FROM pam.pmohopcg k 
			                          WHERE k.pid = a.pid
			                          AND    k.orddd = a.orddd
			                          AND    k.cretno = a.cretno
			                          AND    k.instcd = a.instcd
			                          AND		k.genrdd = TO_CHAR(sysdate,'YYYYMMDD')
			                          AND    k.histstat = 'Y') = 0 THEN 'P' ELSE 'T' END
                             when a.orddd = TO_CHAR(sysdate,'YYYYMMDD') then 'T'
                             when a.orddd > TO_CHAR(sysdate,'YYYYMMDD') then 'R'
                              END AS srchcond
					,   a.mig
					,   a.subdeptcd


                    ,  CASE WHEN  (SELECT count(*) FROM emr.mmodexop m
			                                      WHERE m.instcd = a.instcd
			                                        AND m.pid = a.pid
			                                        AND m.actorddd  = a.orddd
			                                        AND m.actcretno = a.cretno
			                                        AND m.execprcphistcd = 'O' ) = 0 then
			                                           CASE  when a.etcordflag = 'M' AND a.medamtestmyn = 'N' then '환불'
			                                                 when a.etcordflag = 'J' AND a.medamtestmyn = 'N' then '환불'
															 when a.etcordflag = 'T' AND a.medamtestmyn = 'N' AND a.orddeptcd = '2170000000' then '환불'
															 when a.rsrvflag   = 'A' AND a.medamtestmyn = 'N' AND a.specordyn = 'N'          then '환불'
			                                            END
			                      END AS refundyn


					,(SELECT NVL(SUM(c1.precardamt + DECODE(c1.uncorcptflag,'3',0,'4',0,c1.cardamt)),0)
					     FROM pam.paohopmi c1
					   WHERE c1.pid        = a.pid
					       AND c1.instcd    = a.instcd
					       AND c1.orddd     = a.orddd
					       AND c1.cretno    = a.cretno
					       AND c1.rcptstat   = 'Y')                                   AS precardamt

                    ,0                                                                        AS cardamt

					,(SELECT NVL(SUM(c1.precashamt + DECODE(c1.uncorcptflag,'3',0,'4',0,c1.cashamt)),0)
					     FROM pam.paohopmi c1
					    WHERE c1.pid       = a.pid
					        AND c1.instcd   = a.instcd
					        AND c1.orddd    = a.orddd
					        AND c1.cretno   = a.cretno
					        AND c1.rcptstat  = 'Y')                                    AS precashamt

                    ,0                                                                         AS cashamt

                    ,0                                                                         AS rcptexptamt

                    ,(SELECT sum(payownbamt + NOPYOWNBAMT + ALLOWNOWNBAMT + SPECOWNBAMT)
                         FROM pam.paohoscl s
                       WHERE s.instcd =a.instcd
                            AND s.pid = a.pid
                            AND s.orddd = a.orddd
                            AND s.cretno = a.cretno
                            AND s.calcstat ='R')                                        AS totownbamt
					,a.remfact                                                              AS remfact
					,a.spclcd                                                               AS spclcd
                    ,a.rcptvipresncd													   AS rcptvipresncd
                    ,a.rcptvipetcresn													   AS rcptvipetcresn
                    ,a.prcptdayaftrcptyn												   AS prcptdayaftrcptyn
                    ,a.coopteamcd														   AS coopteamcd
                    ,a.specordtype														   AS specordtype
					,decode(to_char(to_date(a.orddd,'yyyymmdd'),'d'),'1','일','2','월','3','화', '4','수', '5','목', '6','금','토') AS day

					,(	select count(*) 
						from pam.pmcmspif s1
						where a.instcd = s1.instcd
						and a.pid = s1.pid
						and a.orddd between s1.fromdd and s1.todd
						and a.orddeptcd = s1.orddeptcd
						and a.orddrid = s1.orddrid
						and s1.histstat = 'Y'
						and s1.returnyn = 'Y'
						and s1.ioflag = 'O'
						and s1.msflag = 'M' ) as specsign_cnt
				    ,(	SELECT count(*) FROM emr.mmodexop z
			          	WHERE z.instcd = a.instcd
			            AND z.pid = a.pid
			            AND z.actorddd  = a.orddd
			            AND z.actcretno = a.cretno
			            AND z.execprcphistcd = 'O')  AS prcpyn
			        ,CASE WHEN a.MEDAMTESTMYN = 'N' --진찰료 미산정 체크
			        				AND a.dracptyn = 'Y'		--진료완료건만 체크
			        				AND a.MEDAMTFREERESN in ('01', '10',  '15', '16', '21', '23', '24', '25') ----01제증명발급, 10진료기록, 11가접수, 15의사소견서발급, 16방문간호지시서발급, 21기록복사, 23	입퇴원확인서, 24취학전 예방접종확인서, 25CD복사
			        				AND NVL((	select  COUNT(*)
									                from   emr.mmodexop exop, emr.mmohoprc oprc, pam.picmmech mech
									                where exop.pid = a.pid
									                and    exop.actorddd = a.orddd
									                and    exop.actcretno = a.cretno
									                and    exop.instcd = a.instcd
									                and    exop.execprcphistcd = 'O'
									                and    exop.pid = oprc.pid
									                and    exop.prcpdd = oprc.prcpdd
									                and    exop.prcpno = oprc.prcpno
									                and    exop.prcphistno = oprc.prcphistno
									                and    exop.instcd = oprc.instcd
									                and    oprc.prcphistcd = 'O'
									                and    oprc.prcpinptflag != '28' --시행부서처방 제외
									                and    exop.calcscorcd = mech.calcscorcd
									                and    exop.instcd = mech.instcd
									                and    exop.actorddd between mech.fromdd and mech.todd
									                and    mech.earncls1 not in ('01', '02', '24', '27') --01기본진료료, 02환자식, 24의료영상복사, 27건진
									             ), 0) > 0
									THEN 'Y'		--진찰료 산정해야 함.
							ELSE 'N' 
					END  AS extrmedamtrcptyn
			        
              FROM  pam.pmohotpt  a 
                    LEFT OUTER JOIN pam.pmihinpt b ON (b.pid = #pid# AND b.indschacptstat = 'A' AND b.histstat = 'Y' AND b.instcd = a.instcd)
             WHERE a.pid         = #pid#
               AND a.histstat   IN ( 'R' , 'T')
               AND a.ordtype     = 'O'
               AND a.instcd      = #sessinstcd#
               AND (a.tranindd   = '00000000' OR NVL(a.tranindd, '-')  = '-' OR NVL(a.tdayinflag, '-') = '-')   
           ]]>
           <isEqual property="srchcond" compare="N">
               <isNotEmpty property="jssrchcond">
                   <isEqual property="jssrchcond" compare="1"><![CDATA[
                        AND a.calcflag = 'N'                
                        AND a.rcptdd BETWEEN #jsfromdd# AND #jstodd#
                    ]]>
                   </isEqual> 
                   <isEqual property="jssrchcond" compare="2"><![CDATA[
                        AND a.calcflag = 'N'                 
                        AND a.orddd BETWEEN #jsfromdd# AND #jstodd#
                    ]]>
                   </isEqual> 
               </isNotEmpty>
           </isEqual>
           <isEqual property="srchcond" compare="Y">
               AND a.calcflag !='N'
                  <isEqual property="allpast" compare="false"><![CDATA[
                    AND a.orddd >= TO_CHAR(sysdate -365,'YYYYMMDD')
                    ]]>
                  </isEqual>
           </isEqual>
           <isEqual property="srchcond" compare="H">
               AND a.holdflag   = 'Y'
               AND a.calcflag   = 'N'
           </isEqual>
           <isEqual property="srchcond" compare="J">
		       AND a.holdflag   != 'Y'
               AND a.calcflag   =  'N'
                  <isEqual property="allpast" compare="false"><![CDATA[
                    AND a.orddd >= TO_CHAR(sysdate -365,'YYYYMMDD')
                    ]]>
                  </isEqual>
           </isEqual>
		   <isEqual property="srchcond" compare="E"><![CDATA[
               AND exists (SELECT e.*
                             FROM emr.mmodexop e
                            WHERE e.instcd    = a.instcd
                              AND e.pid       = a.pid
                              AND e.actorddd  = a.orddd
                              AND e.actcretno = a.cretno
                              AND e.execprcphistcd ='O'
                            )
		   ]]>
		   </isEqual>
           <isEqual property="inptYN" compare="Y">
               AND a.rsrvflag in ('3','4','S') 
           </isEqual>
         ORDER BY a.orddd desc, a.ordtm                      
    </statement>
	<!-- AND (a.histstat   = 'R' or (a.histstat = 'T' and a.etcordflag <> 'H')) -->

    <!-- 외래선수금 내역  조회  -->
    <!-- TRPAO00701 -->
    <statement id="getMdlAmtList"><![CDATA[    
            SELECT a.pid                     AS pid         
                  ,a.rcptdd                  AS rcptdd      
                  ,a.rcptno                  AS rcptno      
                  ,a.rcptseqno               AS rcptseqno   
                  ,a.seqno                   AS seqno       
                  ,a.instcd                  AS instcd      
                  ,a.rcptstat                AS rcptstat    
                  ,a.ordtype                 AS ordtype     
                  ,a.rcptflag                AS rcptflag    
                  ,a.cashamt                 AS cashamt     
                  ,a.cardamt                 AS cardamt     
                  ,a.onlineamt               AS onlineamt   
                  ,a.rcptexecdd              AS rcptexecdd  
                  ,a.rcpttm                  AS rcpttm      
				  ,(select usernm from  COM.ZSUMUSRB where userid =a.rcptrid and rownum =1) as rcptrid
                  ,a.orddeptcd               AS orddeptcd   
                  ,a.remfact                 AS remfact     
                  ,a.paypsnflag              AS paypsnflag  
                  ,a.paydepoamt              AS paydepoamt  
                  ,a.paypsnrem               AS paypsnrem   
                  ,a.fstrgstrid              AS fstrgstrid  
                  ,a.fstrgstdt               AS fstrgstdt   
                  ,a.lastupdtrid             AS lastupdtrid 
                  ,a.lastupdtdt              AS lastupdtdt  
                  --,c.cardno                  AS cardno      
                  --,c.allotmm                 AS allotmm     
                  --,substr(c.valiterm,3,4)    AS valiterm    
                  --,s.qualcnfmno              AS qualcnfmno  
                  --,s.indinstflag             AS indinstflag 
                  --,s.cashamt                 AS acptcashamt 
                  --,o.acntno                  AS acntno      
                  --,o.bankcd                  AS bankcd      
                  --,o.paydd                   AS paydd       
                  --,o.paypsnnm                AS paypsnnm    
                  ,(a.cashamt + a.cardamt + a.onlineamt)  AS rcptexptamt
            FROM pam.paohbogj a
                        --LEFT OUTER JOIN pam.PAMHCARD c on (a.PID = c.pid AND a.rcptdd = c.rcptdd AND a.RCPTNO = c.rcptno AND a.RCPTSEQNO = c.rcptseqno AND a.instcd = c.instcd)
                        --LEFT OUTER JOIN pam.PACHCASH s on (a.PID = s.pid AND a.rcptdd = s.rcptdd AND a.RCPTNO = s.rcptno AND a.RCPTSEQNO = s.rcptseqno AND a.instcd = s.instcd)
                        --LEFT OUTER JOIN pam.PACHONLN o on (a.PID = o.pid AND a.rcptdd = o.rcptdd AND a.RCPTNO = o.rcptno AND a.RCPTSEQNO = o.rcptseqno AND a.instcd = o.instcd)
             WHERE a.pid      = #pid#
               AND a.instcd   = #sessinstcd#
           ]]>         
           <isEqual property="srchcond" compare="A0"><![CDATA[
               AND a.rcptflag LIKE 'A0%' 
			   ]]>
           </isEqual> 
           <isEqual property="srchcond" compare="A1"><![CDATA[
               AND a.rcptflag LIKE 'A1%' 
			   ]]>
           </isEqual>                
           <![CDATA[     
     ORDER BY a.rcptexecdd DESC, a.rcpttm DESC
           ]]>
    </statement> 
    
    <!-- 외래선수금 상세내역(카드) 조회 -->
    <!-- TRPAO00702 -->
    <statement id="getCardAmtList"><![CDATA[    
        SELECT  pid
                    ,   rcptdd
                    ,   rcptno
                    ,   rcptseqno
                    ,   seqno
                    ,   instcd
                    ,   rcptstat
                    ,   ordtype
                    ,   keyinptflag
                    ,   cardcmpycd
                    ,   cardno
                    ,   aprvflag
                    ,   aprvdd
                    ,   aprvtm
                    ,   aprvno
                    ,   vancd
                    ,   allotmm
                    ,   cardamt
                    ,   valiterm
                    ,   rcptexecdd
                    ,   rcpttm
                    ,   rcptrid
                    ,   innrtretyn
                    ,   preamtyn
                    ,   remfact
                    ,   fstrgstrid
                    ,   fstrgstdt
                    ,   lastupdtrid
                    ,   lastupdtdt
           FROM     pam.pamhcard         
          WHERE pid         = #pid#
            AND rcptdd      = #rcptdd#
            AND rcptno      = #rcptno#
            AND rcptseqno   = #rcptseqno#
             ]]>
             <isNotEmpty property="ordtype"><![CDATA[
            AND ordtype     = #ordtype#
               ]]>
             </isNotEmpty> 
            AND instcd      = #sessinstcd#
    </statement> 

    <!-- 외래선수금 상세내역(현금영수증) 조회 --> 
    <!-- TRPAO00702 -->   
    <statement id="getCashAmtList"><![CDATA[    
        SELECT  pid
                    ,   rcptdd
                    ,   rcptno
                    ,   rcptseqno
                    ,   seqno
                    ,   instcd
                    ,   rcptstat
                    ,   ordtype
                    ,   keyinptflag
                    ,   indinstflag
                    ,   qualcnfmflag
                    ,   qualcnfmno
                    ,   aprvflag
                    ,   aprvno
                    ,   aprvdd
                    ,   aprvtm
                    ,   cashamt
                    ,   rcptexecdd
                    ,   rcpttm
                    ,   rcptrid
                    ,   preamtyn
                    ,   innrtretyn
                    ,   remfact
                    ,   fstrgstrid
                    ,   fstrgstdt
                    ,   lastupdtrid
                    ,   lastupdtdt
           FROM     pam.pachcash         
          WHERE pid             =   #pid#
               AND  rcptdd          = #rcptdd#
               AND  rcptno          = #rcptno#
               AND  rcptseqno   = #rcptseqno#
               ]]>
               <isNotEmpty property="ordtype"><![CDATA[
              AND   ordtype         = #ordtype#
                 ]]>
               </isNotEmpty> 
               AND  instcd          = #sessinstcd#
    </statement> 
    
    <!-- 외래선수금 상세내역(온라인입금) 조회 -->        
    <!-- TRPAO00702 -->
    <statement id="getOnlineAmtList"><![CDATA[    
        SELECT  pid
                    ,   rcptdd
                    ,   rcptno
                    ,   rcptseqno
                    ,   seqno
                    ,   instcd
                    ,   rcptstat
                    ,   ordtype
                    ,   onlineamt
                    ,   bankcd
                    ,   acntno
                    ,   paydd
                    ,   paypsnnm
                    ,   rcptexecdd
                    ,   rcpttm
                    ,   rcptrid
                    ,   preamtyn
                    ,   innrtretyn
                    ,   remfact
                    ,   fstrgstrid
                    ,   fstrgstdt
                    ,   lastupdtrid
                    ,   lastupdtdt
           FROM     pam.pachonln         
          WHERE pid             =   #pid#
               AND  rcptdd          =   #rcptdd#
               AND  rcptno          =   #rcptno#
               AND  rcptseqno   =   #rcptseqno#
               ]]>
               <isNotEmpty property="ordtype"><![CDATA[
              AND   ordtype         =   #ordtype#
                 ]]>
               </isNotEmpty> 
               AND  instcd          =   #sessinstcd#
    </statement>         

   <!-- 외래선수금 잔액 조회 -->
    <statement id="getMdlRemAmt"><![CDATA[  
         SELECT nvl(SUM(CASE SUBSTR(rcptflag,3,1) WHEN '1' THEN (cashamt + cardamt + onlineamt)
                                                  ELSE (cashamt + cardamt + onlineamt)      
                                                   END) ,0)                                      AS remamt                 
          FROM pam.paohbogj
         WHERE pid    = #pid#
           AND instcd = #sessinstcd#
        ]]> 
        <isNotEqual property="etcordflag" compare="N"><![CDATA[  
           AND rcptflag LIKE 'A0%'
		]]>   
        </isNotEqual>		   
        <isEqual property="etcordflag" compare="N"><![CDATA[  
           AND rcptflag LIKE 'A1%'
		]]>   
        </isEqual>
    </statement> 
	<!-- AND rcptflag NOT LIKE 'A0%' -->

   <!-- 외래선수금화면 선수금 잔액 조회 -->         
   <!-- TRPAO00701 -->
    <statement id="getMdlRemAmt2"><![CDATA[  
         SELECT
          SUM(decode(rcptflag,'A01',cashamt + cardamt + onlineamt,'A02',cashamt + cardamt + onlineamt,'A03',cashamt + cardamt + onlineamt)) AS remamt
         ,SUM(decode(rcptflag,'A11',cashamt + cardamt + onlineamt,'A12',cashamt + cardamt + onlineamt,'A13',cashamt + cardamt + onlineamt)) AS remamt2
          FROM pam.paohbogj
         WHERE pid  = #pid#
           AND instcd = #sessinstcd#
    ]]>   
    </statement> 

   <!-- 외래선수금화면 미수금 잔액 조회 -->         
   <!-- TRPAO00701 -->
    <statement id="getUncoRemAmt"><![CDATA[  
       SELECT	COALESCE(SUM(CASE WHEN  a.ordtype = 'O' AND  a.uncorcptflag = '1' THEN a.uncoamt ELSE 0 END),0) -
               (COALESCE(SUM(CASE WHEN  a.ordtype = 'O' AND (a.uncorcptflag = '1' OR a.uncorcptflag = '2') THEN a.rcptamt ELSE 0 END),0) +
                COALESCE(SUM(CASE WHEN  a.ordtype = 'O' AND  a.uncorcptflag in ('3','4') THEN a.debtamt ELSE 0 END),0))
                                                                                                                   AS outuncoamt		--외래미수
          FROM 	pam.pamhunco a
        WHERE	a.pid	    = #pid#
          AND	a.instcd	= #sessinstcd#
          AND	a.rcptstat 	= 'Y'
          AND	a.uncocd 	!= 'I41'   --임상미수 제외
        ]]>   
    </statement> 

   <!-- 외래선수금 수납 --> 
   <!-- TXPAO00701 -->
    <statement id="insMdlAmt"><![CDATA[    
        INSERT INTO pam.paohbogj
                            (   pid              
                            ,   rcptdd           
                            ,   rcptno           
                            ,   rcptseqno        
                            ,   seqno            
                            ,   instcd           
                            ,   rcptstat         
                            ,   ordtype          
                            ,   rcptflag         
                            ,   cashamt          
                            ,   cardamt          
                            ,   onlineamt        
                            ,   rcptexecdd       
                            ,   rcpttm           
                            ,   rcptrid          
                            ,   remfact       
                            ,   orddeptcd   
                            ,   paypsnflag       
                            ,   paydepoamt
                            ,   paypsnrem        
                            ,   fstrgstrid       
                            ,   fstrgstdt        
                            ,   lastupdtrid      
                            ,   lastupdtdt       
                            )  
                SELECT                  
                               CAST(#pid#                    AS VARCHAR2(10))                      
                            ,  CAST(#rcptdd#                 AS VARCHAR2(8))                       
                            ,  CAST(#rcptno#                 AS NUMBER)                            
                            ,  CAST(#rcptseqno#              AS NUMBER)                            
                            ,  NVL(CAST(MAX(CAST(seqno  AS NUMBER))   AS NUMBER),0)+1            
                            ,  CAST(#sessinstcd#                 AS VARCHAR2(3))                       
                            ,  CAST(#rcptstat#               AS VARCHAR2(1))                       
                            ,  CAST(#ordtype#                AS VARCHAR2(1))                       
                            ,  CAST(#rcptflag#               AS VARCHAR2(3))                       
                            ,  CAST(#cashamt#                AS NUMBER(10,0))                   
                            ,  CAST(#cardamt#                AS NUMBER(10,0))                    
                            ,  CAST(#onlineamt#              AS NUMBER(10,0))                    
                            ,  CAST(#rcptexecdd#             AS VARCHAR2(8))                       
                            ,  CAST(#rcpttm#                 AS VARCHAR2(6))                       
                            ,  CAST(#rcptrid#                AS VARCHAR2(10))                      
                            ,  CAST(#remfact#                AS VARCHAR2(200))                     
                            ,  CAST(#orddeptcd#              AS VARCHAR2(10))                      
                            ,  CAST(#paypsnflag#             AS VARCHAR2(1))                       
                            ,  CAST(#paydepoamt#             AS VARCHAR2(10))                  
                            ,  CAST(#paypsnrem#              AS VARCHAR2(100))                     
                            ,  CAST(#rcptrid#             AS VARCHAR2(10))                      
                            ,  SYSTIMESTAMP                                                
                            ,  CAST(#rcptrid#            AS VARCHAR2(10))                      
                            ,  SYSTIMESTAMP     
                    FROM    pam.paohbogj                        
                  WHERE pid             = #pid#
                       AND  rcptdd          = #rcptdd#    
                       AND  rcptno          = #rcptno#    
                       AND  rcptseqno       = #rcptseqno#    
                       AND  instcd          = #sessinstcd#   
           ]]>
    </statement> 

   <!-- 외래선수금 수납(온라인입금) --> 
   <!-- TXPAO00701 -->
   <statement id="insOnlineAmt"><![CDATA[    
        INSERT INTO     pam.pachonln
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd           
                            ,   rcptno           
                            ,   rcptseqno        
                            ,   seqno            
                            ,   instcd           
                            ,   rcptstat         
                            ,   ordtype
                            ,   onlineamt  
                            ,   bankcd
                            ,   acntno
                            ,   paydd
                            ,   paypsnnm      
                            ,   rcptexecdd       
                            ,   rcpttm           
                            ,   rcptrid    
                            ,   preamtyn
                            ,   innrtretyn      
                            ,   remfact          
                            ,   fstrgstrid       
                            ,   fstrgstdt        
                            ,   lastupdtrid      
                            ,   lastupdtdt       
                            )  
                SELECT  
                              CAST(#pid#                    AS VARCHAR2(10)) 
							, CAST(#orddd#                  AS VARCHAR2(8)) 
							, CAST(#cretno#                 AS NUMBER) 
                            , CAST(#rcptdd#                 AS VARCHAR2(8))                     
                            , CAST(#rcptno#                 AS NUMBER)                     
                            , CAST(#rcptseqno#              AS NUMBER)                     
                            , NVL(CAST(MAX(CAST(seqno  AS NUMBER))  AS NUMBER),0)+1     
                            , CAST(#sessinstcd#                 AS VARCHAR2(3))                     
                            , CAST(#rcptstat#               AS VARCHAR2(1))                     
                            , CAST(#ordtype#                AS VARCHAR2(1))                     
                            , CAST(#onlineamt#              AS NUMBER(10,0))               
                            , CAST(#bankcd#                 AS VARCHAR2(2))                  
                            , CAST(#acntno#                 AS VARCHAR2(20))                 
                            , CAST(#paydd#                  AS VARCHAR2(8))                  
                            , CAST(#paypsnnm#               AS VARCHAR2(200))                 
                            , CAST(#rcptexecdd#             AS VARCHAR2(8))                     
                            , CAST(#rcpttm#                 AS VARCHAR2(6))                     
                            , CAST(#rcptrid#                AS VARCHAR2(10))                    
                            , CAST(#preamtyn#               AS VARCHAR2(1))                     
                            , CAST(#innrtretyn#             AS VARCHAR2(1))                     
                            , CAST(#remfact#                AS VARCHAR2(100))                
                            , #sessuserid#                 
                            , SYSTIMESTAMP                                      
                            , #sessuserid#               
                            , SYSTIMESTAMP  
                       FROM pam.pachonln                        
                      WHERE pid             = #pid#
                        AND rcptdd          = #rcptdd#    
                        AND rcptno          = #rcptno#    
                        AND rcptseqno       = #rcptseqno#    
                        AND instcd          = #sessinstcd#   
           ]]>
    </statement> 

   <!-- 영수증번호 조회 
    <statement id="getRcptNo"><![CDATA[    
        SELECT  NVL(genrno,0) AS rcptno
           FROM     pam.pacmrcno
         WHERE      genrdd          =   #rcptdd# 
              AND   genrkind        = 'R'
              AND   genrflag        = 'C'   
              AND   instcd          = #sessinstcd#
             WITH   RS USE AND KEEP UPDATE LOCKS
           ]]>
    </statement> 
    --> 
    
   <!-- 영수증번호 조회 
   			SELECT   pam.SQ_PACMRCNO_01.NEXTVAL AS rcptno
        FROM    dual
   -->
    <statement id="getRcptNo"><![CDATA[  
        SELECT  PAM.FN_GETRCPTNO(to_char(sysdate, 'YYYYMMDD')) AS rcptno
        FROM    dual
           ]]>
    </statement> 
     

   <!-- 영수증번호 갱신 --> 
    <statement id="setRcptNo"><![CDATA[    
        UPDATE  pam.PACMRCNO
              SET   genrno          = #rcptno#  
         WHERE  genrdd          = #rcptdd#
              AND   genrkind        = 'R'
              AND   genrflag        = 'C'    
              AND   instcd          = #sessinstcd#            
           ]]>
         
    </statement> 
 
   <!-- 영수증번호 입력(최초입력시) --> 
    <statement id="insRcptNo"><![CDATA[    
        INSERT INTO pam.PACMRCNO
                            (   genrdd
                            ,   genrkind
                            ,   genrflag
                            ,   instcd
                            ,   genrno
                            )
                VALUES      
                            (   #rcptdd#
                            ,   'R'
                            ,   'C'
                            ,   #sessinstcd#
                            ,   #rcptno#
                            )
           ]]>
    </statement> 

  <!-- 외래등록조회(무인수납) --> 
  <!-- TXPAO09901 -->    
    <statement id="getOutRgstList2"><![CDATA[    
        SELECT  pid                         AS otpt_pid
                    ,   orddd                       AS otpt_orddd                           
                    ,   cretno                      AS otpt_cretno               
                    ,   acptseqno               AS otpt_acptseqno            
                    ,   instcd                          AS otpt_instcd               
                    ,   histstat                        AS otpt_histstat             
                    ,   orgorddd                    AS otpt_orgorddd             
                    ,   orgcretno                   AS otpt_orgcretno            
                    ,   calcbaseflag            AS otpt_calcbaseflag         
                    ,   calcyn                      AS otpt_calcyn               
                    ,   ordtm                           AS otpt_ordtm                
                    ,   orddeptcd                   AS otpt_orddeptcd            
                    ,   orddrid                     AS otpt_orddrid              
                    ,   dutdeptcd                   AS otpt_dutdeptcd            
                    ,   centcd                      AS otpt_centcd               
                    ,   supdeptcd                   AS otpt_supdeptcd            
                    ,   mskind                      AS otpt_mskind               
                    ,   insukind                    AS otpt_insukind             
                    ,   suppkind                    AS otpt_suppkind             
                    ,   insucd                      AS otpt_insucd               
                    ,   suppkindresn            AS otpt_suppkindresn         
                    ,   specordyn               AS otpt_specordyn            
                    ,   holiflag                        AS otpt_holiflag             
                    ,   fsexamflag                  AS otpt_fsexamflag           
                    ,   fsexammanlyn            AS otpt_fsexammanlyn         
                    ,   ordtype                     AS otpt_ordtype              
                    ,   brateflag                   AS otpt_brateflag            
                    ,   medamtestmyn            AS otpt_medamtestmyn         
                    ,   medamtpostyn            AS otpt_medamtpostyn         
                    ,   medamtfreeresn          AS otpt_medamtfreeresn       
                    ,   rsrvflag                        AS otpt_rsrvflag             
                    ,   etcordflag                  AS otpt_etcordflag           
                    ,   disccd                      AS otpt_disccd               
                    ,   hosoutexptresncd    AS otpt_hosoutexptresncd     
                    ,   clincstdyacptflag       AS otpt_clincstdyacptflag    
                    ,   clincstdyno                 AS otpt_clincstdyno          
                    ,   chrtlendyn                  AS otpt_chrtlendyn           
                    ,   specorddescyn       AS otpt_specorddescyn        
                    ,   ordreqdescyn            AS otpt_ordreqdescyn         
                    ,   ordreqhospgrde          AS otpt_ordreqhospgrde       
                    ,   insuchrgyn                  AS otpt_insuchrgyn           
                    ,   nursacptyn                  AS otpt_nursacptyn           
                    ,   nursacptdt                  AS otpt_nursacptdt           
                    ,   dracptyn                    AS otpt_dracptyn             
                    ,   dracptdt                    AS otpt_dracptdt             
                    ,   prcpgenryn              AS otpt_prcpgenryn           
                    ,   prcpnotoccrresn         AS otpt_prcpnotoccrresn      
                    ,   estmspclappyn           AS otpt_estmspclappyn        
                    ,   elbulbodstat                AS otpt_elbulbodstat         
                    ,   elbulbodstatdt              AS otpt_elbulbodstatdt       
                    ,   calcflag                    AS otpt_calcflag             
                    ,   calcmthdflag                AS otpt_calcmthdflag         
                    ,   dnoracptyn                  AS otpt_dnoracptyn           
                    ,   rqstflag                        AS otpt_rqstflag             
                    ,   rqsthospcd              AS otpt_rqsthospcd           
                    ,   rqstdrid                    AS otpt_rqstdrid                       
                    ,   tdayinflag                  AS otpt_tdayinflag           
                    ,   tranindd                    AS otpt_tranindd             
                    ,   rcptdd                      AS otpt_rcptdd               
                    ,   rcptno                      AS otpt_rcptno               
                    ,   rcptseqno                   AS otpt_rcptseqno            
                    ,   telrsrvrem                  AS otpt_telrsrvrem                     
                    ,   updtcnclresn            AS otpt_updtcnclresn         
                    ,   fstacptid                   AS otpt_fstacptid            
                    ,   fstacptdt                   AS otpt_fstacptdt            
                    ,   fstrgstrid                      AS otpt_fstrgstrid           
                    ,   fstrgstdt                       AS otpt_fstrgstdt            
                    ,   lastupdtrid                 AS otpt_lastupdtrid          
                    ,   lastupdtdt                  AS otpt_lastupdtdt 
                    ,   rareobstflag                AS otpt_rareobstflag
                    ,   tranflag                    AS otpt_tranflag
					,   holdflag                    AS otpt_holdflag
					,   subdeptcd                   AS otpt_subdeptcd
           FROM     pam.pmohotpt         
          WHERE pid             =   #pid#
            AND histstat        IN ('R','T')
            AND ordtype         = 'O'
            AND instcd          = #sessinstcd#
            AND calcflag        !='N'   
            ANd     orddd   >=      TO_CHAR(sysdate,'YYYYMMDD')   
          ORDER BY
                        orddd ASC, orddeptcd ASC                     
           ]]>
    </statement> 



  <!-- 보험정보조회(외래수납) --> 
  <!-- TRPAO00103 -->
  <!-- TRPAO00203 -->
   <statement id="getInsuInfo"><![CDATA[    
        SELECT  a.pid                       AS  pid
                    ,   a.insukind          AS  insukind
                    ,   a.todd                  AS  todd
                    ,   a.seqno             AS  seqno
                    ,   a.instcd                AS  instcd
                    ,   a.histstat              AS  histstat
                    ,   a.fromdd                AS  fromdd
                    ,   a.insucd                AS  insucd
                    ,   a.insuno                AS  insuno
                    ,   a.insdnm                AS  insdnm
                    ,   a.insdrrgstno1      AS  insdrrgstno1
                    ,   a.insdrrgstno2      AS  insdrrgstno2
                    ,   a.insdrela              AS  insdrela
                    ,   b.insucdnm          AS  insucdnm
            FROM    pam.pmcmptin a    LEFT OUTER JOIN
                        pam.pmbmincd b      ON (a.insucd = b.insucd AND SUBSTR(a.insukind,1,1) = b.insuflag)
         WHERE  a.pid           =   #pid#
              AND   a.instcd        = #sessinstcd#
              AND   a.histstat      = 'Y'
              ]]>
            <isNotEmpty property="insukind"><![CDATA[
              AND   a.insukind  = #insukind#
                 ]]>
            </isNotEmpty>
            <isNotEmpty property="insucd"><![CDATA[
              AND   a.insucd        = #insucd#
                ]]>
            </isNotEmpty>
            <isNotEmpty property="appdd"><![CDATA[
              AND   a.todd          >= #appdd#
              AND   a.fromdd    <= #appdd#
                ]]>
            </isNotEmpty>               
    </statement> 
    
 <!-- 중증정보조회(외래수납)  사용안함 -->
 <!--   insuflag A=>1, B=>2 로 변경(코드 재정의 2007.05.23) -->         
 <!-- TRPAO00104 -->
   <statement id="getSrdgInfo"><![CDATA[    
        SELECT  pid
                    ,   insuflag
                    ,   suppkind
                    ,   todd
                    ,   seqno
                    ,   instcd
                    ,   histstat
                    ,   fromdd
                    ,   seridiagno
                    ,   apppsnnm
                    ,   rela
                    ,   acptdd
                    ,   acpttm
                    ,   acptid
                    ,   remfact
                    ,   fstrgstrid
                    ,   fstrgstdt
                    ,   lastupdtrid
                    ,   lastupdtdt
           FROM     pam.pmcmsrdg
         WHERE  pid         =   #pid#
              AND   instcd      = #sessinstcd#
              AND   histstat        = 'Y'
              ]]>
            <isNotEmpty property="insukind">
                <isEqual property="insukind" compare="11"><![CDATA[
             AND   insuflag ='1'     ]]>
                </isEqual>
                <isEqual property="insukind" compare="21"><![CDATA[
             AND   insuflag ='2'     ]]>
                </isEqual>
                <isEqual property="insukind" compare="22"><![CDATA[
             AND   insuflag ='2'     ]]>
                </isEqual>
            </isNotEmpty>               
            <isNotEmpty property="appdd"><![CDATA[
              AND   todd        >= #appdd#
              AND   fromdd      <= #appdd#
                ]]>
            </isNotEmpty>               
    </statement> 


 <!-- 계산정보조회(외래수납,정산) 스칼라쿼리, orderby 절대 손대지 말것!!! 외래수납내역 계산내역 그리드 틀리게 보임-->  
 <!-- TRPAO00106 -->      
   <statement id="getOsclInfo"><![CDATA[ 
   
    SELECT DECODE(a.payownbrate_org,9999,'',a.payownbrate_org) AS payownbrate 
          ,a.* 
     FROM (

    SELECT         DECODE((SELECT count(t.grupcalcscorcd)
                             FROM pam.paohoscl t
                            WHERE t.pid             = a.pid
                              AND t.orddd           = a.orddd
                              AND t.cretno          = a.cretno
                              AND t.instcd          = a.instcd
                              AND t.calcstat        = a.calcstat
                              AND t.grupcalcscorcd  != t.snglcalcscorcd
                              AND t.grupcalcscorcd  = a.grupcalcscorcd
                           ) ,0,'1','2')        AS hidden
                   ,    a.pid                   AS pid
                   ,    a.orddd                 AS orddd
                   ,    a.cretno                AS cretno
                   ,    a.calcseqno             AS calcseqno
                   ,    a.calcscorseqno         AS calcscorseqno
                   ,    a.instcd                AS instcd
                   ,    a.calcstat              AS calcstat
                   ,    a.clamtrgtstat          AS clamtrgtstat
                   ,    a.acptseqno             AS acptseqno
                   ,    a.orddeptcd             AS orddeptcd
                   ,    a.orddrid               AS orddrid
                   ,    a.mskind                AS mskind
                   ,    a.ordtype               AS ordtype
                   ,    a.grupcalcscorcd        AS grupcalcscorcd
                   ,    a.snglcalcscorcd        AS snglcalcscorcd
                   ,    a.grupcalcscorcls       AS grupcalcscorcls
                   ,    a.snglcalcscorcls       AS snglcalcscorcls
                   ,    a.grupearncls           AS grupearncls
                   ,    a.snglearncls           AS snglearncls
                   ,    a.ordqty                AS ordqty
                   ,    a.ordtims               AS ordtims
                   ,    a.orddays               AS orddays
                   ,    a.calcqty               AS calcqty
                   ,    a.calctims              AS calctims
                   ,    a.calcdays              AS calcdays
                   ,    a.matractflag           AS matractflag
                   ,    a.calcpayflag           AS calcpayflag
                   ,    a.prcppayflag           AS prcppayflag
                   ,    a.calcscorpayflag       AS calcscorpayflag
                   ,    a.ansttm                AS ansttm
                   ,    a.spccd                 AS spccd
                   ,    a.pntunitcost           AS pntunitcost
                   ,    a.calcscorpnt           AS calcscorpnt
                   ,    a.estmpnt               AS estmpnt
                   ,    a.calcamt               AS calcamt
                   ,    a.hospaddamt            AS hospaddamt
                   ,    a.specamt               AS specamt
                   ,    a.payamt                AS payamt
                   ,    a.allownbamt            AS allownbamt
                   ,    a.nopyamt               AS nopyamt
                   ,    a.payownbrate           AS payownbrate_org
                   ,    a.payinsubamt           AS payinsubamt
                   ,    a.payownbamt            AS payownbamt
                   ,    a.paydiscamt            AS paydiscamt
                   ,    a.nopydiscamt           AS nopydiscamt
                   ,    a.specdiscamt           AS specdiscamt
                   ,    a.hosoutexptresncd      AS hosoutexptresncd
                   ,    a.hosoutdrugno          AS hosoutdrugno
                   ,    a.specordyn             AS specordyn
                   ,    a.execdeptcd            AS execdeptcd
                   ,    a.execdd                AS execdd
                   ,    a.exectm                AS exectm
                   ,    a.execrid               AS execrid
                   ,    a.pamexecdd             AS pamexecdd
                   ,    a.earnenddd             AS earnenddd
                   ,    a.actcnclresn           AS actcnclresn
                   ,    a.clamspclcd            AS clamspclcd
                   ,    a.clamkey               AS clamkey
                   ,    a.clamcretdd            AS clamcretdd
                   ,    a.clamcretyn            AS clamcretyn
                   ,    a.estmcls               AS estmcls
                   ,    a.estmmeancd            AS estmmeancd
                   ,    a.estmcd                AS estmcd
                   ,    a.readdrid              AS readdrid
                   ,    a.clincstdyno           AS clincstdyno
                   ,    a.exitprvntdrugyn       AS exitprvntdrugyn
                   ,    a.exitprvntdrugamt      AS exitprvntdrugamt
                   ,    a.trustaddrate          AS trustaddrate
                   ,    a.bothaddyn             AS bothaddyn
                   ,    a.prcpdd                AS prcpdd
                   ,    a.prcpno                AS prcpno
                   ,    a.prcphistno            AS prcphistno
                   ,    a.execprcpseqno         AS execprcpseqno
                   ,    a.cvrtinprcpdeptcd      AS cvrtinprcpdeptcd
                   ,    a.cvrtinprcpdrid        AS cvrtinprcpdrid
                   ,    a.rcptdd                AS rcptdd
                   ,    a.rcptno                AS rcptno
                   ,    a.rcptseqno             AS rcptseqno
                   ,    a.rcptexecdd            AS rcptexecdd
                   ,    a.rcpttm                AS rcpttm
                   ,    a.fstrgstrid            AS fstrgstrid
                   ,    a.fstrgstdt             AS fstrgstdt
                   ,    a.lastupdtrid           AS lastupdtrid
                   ,    a.lastupdtdt            AS lastupdtdt
                   , decode( d.precureprcpflag , 'Y', '[선]' ,'') ||
                    (Select m.hngnm From pam.picmmech m
                                   where m.calcscorcd = a.snglcalcscorcd
                                     AND a.orddd BETWEEN  m.fromdd AND m.todd
                                     AND m.instcd = a.instcd AND rownum = 1)                    AS snglcalcscorcdnm
                   ,    CASE a.grupcalcscorcd   WHEN a.snglcalcscorcd THEN ''
                                                                      ELSE 'G'
                                                                       END       AS grupflag
                   ,    a.specownbamt + a.allownownbamt + a.nopyownbamt + a.payownbamt      AS ownbamt
                   ,    CASE a.matractflag  WHEN '0' THEN 'Y'
                                                     ELSE ' '
                                                      END                        AS outordyn
                   ,    CASE a.clincstdyno  WHEN ''  THEN ' '
                                                     WHEN '-'   THEN ' '
                                                     WHEN ' '   THEN ' '
                                                     WHEN '00'  THEN ' '
                                                     ELSE 'Y'
                                                      END                        AS clincstdyyn
                   ,     DECODE(d.prcphistcd, 'E',d.prcphistcd, d.prcpstatcd)    AS execprcpstatcd
                   ,     d.prcphistcd AS execprcphistcd

                   ,     (select e.rsrvdd
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvdd

                   ,     (select e.rsrvtm
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvtm
                   , m.vatappyn
           FROM pam.paohoscl a LEFT OUTER JOIN emr.mmohoprc d on (d.pid = a.pid
                                                              AND d.orddd  = a.orddd
                                                              AND d.cretno = a.cretno
                                                              AND d.prcpdd = a.prcpdd
                                                              AND d.prcpno = a.prcpno
                                                              AND d.instcd = a.instcd
                                                              AND d.prcpflag IN ('1', '3')
                                                              AND d.tempprcpflag = 'N'
                                                              AND d.hscttempprcpflag = 'N'
                                                              AND d.prcphistcd in ('O','E'))
                               LEFT OUTER JOIN pam.PICMMECH m ON  m.instcd = a.instcd
                               								  AND m.calcscorcd = a.snglcalcscorcd
                                                              AND a.prcpdd BETWEEN m.fromdd AND m.todd
         WHERE a.pid             = #pid#       
           AND a.orddd           = #orddd#     
           AND a.cretno          = #cretno#    
           AND a.instcd          = #sessinstcd#
           AND a.calcstat        = #calcstat#  
           --AND a.grupcalcscorcd ='DDCF75J'
   UNION
        SELECT      '1'                                  AS hidden
                   ,    MAX(a.pid)                   AS pid
                   ,    MAX(a.orddd)                 AS orddd
                   ,    MAX(a.cretno)                AS cretno
                   ,    MAX(a.calcseqno)             AS calcseqno
                   ,    MAX(a.calcscorseqno)         AS calcscorseqno
                   ,    MAX(a.instcd)                AS instcd
                   ,    MAX(a.calcstat)              AS calcstat
                   ,    MAX(a.clamtrgtstat)          AS clamtrgtstat
                   ,    MAX(a.acptseqno)             AS acptseqno
                   ,    MAX(a.orddeptcd)             AS orddeptcd
                   ,    MAX(a.orddrid)               AS orddrid
                   ,    MAX(a.mskind)                AS mskind
                   ,    MAX(a.ordtype)               AS ordtype
                   ,    MAX(a.grupcalcscorcd)        AS grupcalcscorcd
                   ,    MAX(a.grupcalcscorcd)        AS snglcalcscorcd
                   ,    MAX(a.grupcalcscorcls)       AS grupcalcscorcls
                   ,    MAX(a.grupcalcscorcls)       AS snglcalcscorcls
                   ,    MAX(a.grupearncls)           AS grupearncls
                   ,    MAX(a.grupearncls)           AS snglearncls
                   ,    0                            AS ordqty
                   ,    0                            AS ordtims
                   ,    0                            AS orddays
                   ,    0                            AS calcqty
                   ,    0                            AS calctims
                   ,    0                            AS calcdays
                   ,    ''                           AS matractflag
                   ,    ''                           AS calcpayflag
                   ,    ''                           AS prcppayflag
                   ,    ''                           AS calcscorpayflag
                   ,    ''                           AS ansttm
                   ,    ''                           AS spccd
                   ,    SUM(a.pntunitcost)           AS pntunitcost
                   ,    SUM(a.calcscorpnt)           AS calcscorpnt
                   ,    SUM(a.estmpnt)               AS estmpnt
                   ,    SUM(a.calcamt)               AS calcamt
                   ,    SUM(a.hospaddamt)            AS hospaddamt
                   ,    SUM(a.specamt)               AS specamt
                   ,    SUM(a.payamt)                AS payamt
                   ,    SUM(a.allownbamt)            AS allownbamt
                   ,    SUM(a.nopyamt)               AS nopyamt
                   ,    9999                         AS payownbrate_org
                   ,    SUM(a.payinsubamt)           AS payinsubamt
                   ,    SUM(a.payownbamt)            AS payownbamt
                   ,    SUM(a.paydiscamt)            AS paydiscamt
                   ,    SUM(a.nopydiscamt)           AS nopydiscamt
                   ,    SUM(a.specdiscamt)           AS specdiscamt
                   ,    ''                           AS hosoutexptresncd
                   ,    0                            AS hosoutdrugno
                   ,    ''                           AS specordyn
                   ,    ''                           AS execdeptcd
                   ,    ''                           AS execdd
                   ,    ''                           AS exectm
                   ,    ''                           AS execrid
                   ,    ''                           AS pamexecdd
                   ,    ''                           AS earnenddd
                   ,    ''                           AS actcnclresn
                   ,    ''                           AS clamspclcd
                   ,    ''                           AS clamkey
                   ,    ''                           AS clamcretdd
                   ,    ''                           AS clamcretyn
                   ,    ''                           AS estmcls
                   ,    ''                           AS estmmeancd
                   ,    ''                           AS estmcd
                   ,    ''                           AS readdrid
                   ,    ''                           AS clincstdyno
                   ,    ''                           AS exitprvntdrugyn
                   ,    0                            AS exitprvntdrugamt
                   ,    0                            AS trustaddrate
                   ,    ''                           AS bothaddyn
                   ,    ''                           AS prcpdd
                   ,    MIN(a.prcpno)                AS prcpno
                   ,    0                            AS prcphistno
                   ,    0                            AS execprcpseqno
                   ,    ''                           AS cvrtinprcpdeptcd
                   ,    ''                           AS cvrtinprcpdrid
                   ,    ''                           AS rcptdd
                   ,    0                            AS rcptno
                   ,    0                            AS rcptseqno
                   ,    ''                           AS rcptexecdd
                   ,    ''                           AS rcpttm
                   ,    ''                           AS fstrgstrid
                   ,    MAX(a.fstrgstdt)             AS fstrgstdt
                   ,    ''                           AS lastupdtrid
                   ,    MAX(a.lastupdtdt)            AS lastupdtdt
                   ,
                    (Select m.hngnm From pam.picmmech m
                                   where m.calcscorcd = a.grupcalcscorcd
                                     AND a.orddd BETWEEN  m.fromdd AND m.todd
                                     AND m.instcd = a.instcd)                    AS snglcalcscorcdnm
                   ,    'G'                          AS grupflag
                   ,    SUM(a.specownbamt + a.allownownbamt + a.nopyownbamt + a.payownbamt)  AS ownbamt
                   ,    ''                           AS outordyn
                   ,    ''                           AS clincstdyyn
                   ,     DECODE(d.prcphistcd, 'E',d.prcphistcd, d.prcpstatcd)    AS execprcpstatcd
                   ,     d.prcphistcd                                            AS execprcphistcd

                   ,     (select e.rsrvdd
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvdd

                   ,     (select e.rsrvtm
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvtm
                   , m.vatappyn
           FROM pam.paohoscl a LEFT OUTER JOIN emr.mmohoprc d on (d.pid = a.pid
                                                              AND d.orddd  = a.orddd
                                                              AND d.cretno = a.cretno
                                                              AND d.prcpdd = a.prcpdd
                                                              AND d.prcpno = a.prcpno
                                                              AND d.instcd = a.instcd
                                                              AND d.prcpflag IN ('1', '3')
                                                              AND d.tempprcpflag = 'N'
                                                              AND d.hscttempprcpflag = 'N'
                                                              AND d.prcphistcd in ('O','E'))
                               LEFT OUTER JOIN pam.PICMMECH m ON  m.instcd = a.instcd
                               								  AND m.calcscorcd = a.snglcalcscorcd
                                                              AND a.prcpdd BETWEEN m.fromdd AND m.todd
         WHERE a.pid             = #pid#       
           AND a.orddd           = #orddd#     
           AND a.cretno          = #cretno#    
           AND a.instcd          = #sessinstcd#
           AND a.calcstat        = #calcstat#
           --AND a.grupcalcscorcd ='DDCF75J'
           AND a.grupcalcscorcd  IN (SELECT k.grupcalcscorcd
                                       FROM pam.paohoscl k
                                     WHERE k.pid             = a.pid
                                       AND k.orddd           = a.orddd
                                       AND k.cretno          = a.cretno
                                       AND k.instcd          = a.instcd
                                       AND k.calcstat        = a.calcstat
                                       AND k.grupcalcscorcd != k.snglcalcscorcd
                                     GROUP BY k.grupcalcscorcd
                                     HAVING count(*) > 0   )

         GROUP BY  a.grupcalcscorcd , a.pid,a.orddd ,a.cretno, a.instcd ,a.prcpdd,a.prcpno,a.prcphistno,a.execprcpseqno, d.prcphistcd  ,d.prcpstatcd ,d.inclprcpno, m.vatappyn
         ORDER BY  prcpno ,grupcalcscorcd, hidden  ,prcpdd desc,calcscorseqno desc
         ) a

    ]]>
    </statement> 
    

   <!-- 외래수납 계산내역oscl로 opmi생성 TXPAO00101 -->
   <statement id="getOpmiInfoFromOscl"><![CDATA[    
        SELECT   NVL(CAST(SUM(a.payamt) AS NUMBER(10,0)),0)                                                      AS opmi_payamt
               , NVL(CAST(SUM(a.payownbamt) AS NUMBER(10,0)),0)                                                  AS opmi_payownbamt
               , NVL(CAST(SUM(a.payinsubamt) AS NUMBER(10,0)),0)                                                 AS opmi_payinsubamt
               , NVL(CAST(SUM(a.nopyamt) AS NUMBER(10,0)),0)                                                     AS opmi_nopyamt
               , NVL(CAST(SUM(a.nopyownbamt) AS NUMBER(10,0)),0)                                                 AS opmi_nopyownbamt
               , NVL(CAST(SUM(a.nopyinsubamt) AS NUMBER(10,0)),0)                                                AS opmi_nopyinsubamt
               , NVL(CAST(SUM(a.allownbamt) AS NUMBER(10,0)),0)                                                  AS opmi_allownbamt
               , NVL(CAST(SUM(a.allownownbamt) AS NUMBER(10,0)),0)                                               AS opmi_allownownbamt
               , NVL(CAST(SUM(a.allowninsubamt) AS NUMBER(10,0)),0)                                              AS opmi_allowninsubamt
               , NVL(CAST(SUM(a.specamt) AS NUMBER(10,0)),0)                                                     AS opmi_specamt
               , NVL(CAST(SUM(a.specownbamt) AS NUMBER(10,0)),0)                                                 AS opmi_specownbamt
               , NVL(CAST(SUM(a.specinsubamt) AS NUMBER(10,0)),0)                                                AS opmi_specinsubamt
               , NVL(CAST(SUM(a.paydiscamt+nopydiscamt+specdiscamt) AS NUMBER(10,0)),0)                          AS opmi_discamt                    
               , NVL(CAST(SUM(a.paydiscamt) AS NUMBER(10,0)),0)                                                  AS opmi_paydiscamt                 
               , NVL(CAST(SUM(a.nopydiscamt) AS NUMBER(10,0)),0)                                                 AS opmi_nopydiscamt                    
               , NVL(CAST(SUM(a.specdiscamt) AS NUMBER(10,0)),0)                                                 AS opmi_specdiscamt
               , 0                                                                                               AS opmi_labamt
               , max(a.clincstdyno)                                                                              AS opmi_clincstdyno                                     
               , max(d.depthngnm)                                                                                AS opmi_orddeptcdnm
               , max(u.usernm)                                                                                   AS opmi_orddridnm               
           FROM  pam.paohoscl  a
                 LEFT OUTER JOIN com.zsdddept d on (a.orddeptcd = d.deptcd AND d.orddeptflag='D' AND d.orduseyn='Y' AND 
                                                                                    TO_CHAR(sysdate,'YYYYMMDD')  BETWEEN d.valifromdd AND d.valitodd AND d.instcd = a.instcd)
                 LEFT OUTER JOIN com.zsumusrb u on (a.orddrid = u.userid AND 
                                                                                    TO_CHAR(sysdate,'YYYYMMDD')  BETWEEN u.userfromdd AND u.usertodd AND u.dutinstcd = a.instcd)
             , pam.picmmech b
         WHERE a.pid          = #pid#
           AND a.orddd        = #orddd#
           AND a.cretno       = #cretno#
           AND a.instcd       = #sessinstcd#
           AND a.calcstat     = #calcstat#
           AND b.calcscorcd   = a.grupcalcscorcd
           AND a.instcd       = b.instcd
           AND a.orddd        BETWEEN  b.fromdd AND b.todd
       ]]>
    </statement> 


<!-- 기수납금 조회(외래수납) -->  
<!-- TRPAO00107 -->       
   <statement id="getPreOpmiInfo"><![CDATA[    
       SELECT
             NVL(SUM(bloddiscamt),0)                                                AS opmi_bloddiscamt
            ,NVL(SUM(discamt),0)                                                    AS opmi_discamt
            ,NVL(SUM(reduamt),0)                                                    AS opmi_reduamt
            ,NVL(SUM(uncoamt) + sum(DECODE(uncorcptflag,'2', cashamt+ cardamt+onlineamt,'3', cashamt+ cardamt+onlineamt,'4',cashamt+ cardamt+onlineamt,0))* -1,0) AS opmi_uncoamt
            ,NVL(SUM(payinsubamt),0)                                                AS opmi_payinsubamt
            ,NVL(SUM(precashamt    + DECODE(uncorcptflag,'3',0,'4',0,cashamt)),0)         AS opmi_precashamt
            ,NVL(SUM(precardamt    + DECODE(uncorcptflag,'3',0,'4',0,cardamt)),0)         AS opmi_precardamt
            ,NVL(SUM(preonlineamt  + DECODE(uncorcptflag,'3',0,'4',0,onlineamt)),0)       AS opmi_preonlineamt
            ,NVL(SUM(premdlrcptamt + mdlrcptamt),0)                                 AS opmi_premdlrcptamt
            ,NVL(SUM(heallifeamtclamamt),0)                                         AS opmi_heallifeamtclamamt
            ,NVL(SUM(prepregdmndamt +pregdmndamt),0)                                AS opmi_prepregdmndamt
       FROM pam.paohopmi a
      WHERE a.pid        = #pid#
        AND a.instcd     = #sessinstcd#
        AND a.rcptstat   = 'Y' 
        AND a.orddd      = #orddd#
        AND a.cretno     = #cretno#
 ]]>
    </statement> 

<!-- 보험유형 부담률 조회(외래수납) -->
<!-- TRPAO00107 -->
   <statement id="getInsuRateInfo"><![CDATA[    
        SELECT  insukind                    AS  insu_insukind
                   ,    suppkind                    AS  insu_suppkind
                   ,    todd                            AS  insu_todd
                   ,    seqno                       AS  insu_seqno
                   ,    instcd                      AS  insu_instcd
                   ,    histstat                        AS  insu_histstat
                   ,    fromdd                      AS  insu_fromdd
                   ,    calcscorappflag     AS  insu_calcscorappflag
                   ,    ioflag                      AS  insu_ioflag
                   ,    corpactaddrate      AS  insu_corpactaddrate
                   ,    outpayownbrate      AS  insu_outpayownbrate
                   ,    inpayownbrate           AS  insu_inpayownbrate
                   ,    medownbrate         AS  insu_medownbrate    
                   ,    ctownbrate              AS  insu_ctownbrate
                   ,    mriownbrate             AS  insu_mriownbrate
                   ,    sonoownbrate            AS  insu_sonoownbrate
                   ,    petctownbrate           AS  insu_petctownbrate
                   ,    basemealownbrate    AS  insu_basemealownbrate
                   ,    addmealownbrate AS  insu_addmealownbrate    
                   ,    drugexptownbrate    AS  insu_drugexptownbrate
                   ,    fixbaseamt              AS  insu_fixbaseamt
                   ,    fixminamt                   AS  insu_fixminamt
                   ,    fixmaxamt                   AS  insu_fixmaxamt
           FROM     pam.pmbminsu 
         WHERE  insukind        =   #insukind#
              AND   suppkind        =  #suppkind# ]]>
           <isNotEmpty property="orddd">
           <isNotEqual property="orddd" compare="-"><![CDATA[
              AND   fromdd          <= #orddd#
              AND   todd             >= #orddd#
               ]]>
           </isNotEqual> 
           <isEqual property="orddd" compare="-"><![CDATA[
              AND   todd             = '99991231'
               ]]>
           </isEqual> 
           </isNotEmpty> 
           <![CDATA[
              AND   instcd          =   #sessinstcd#
              AND   histstat            =   'Y'
              AND   ioflag          in ('A','O') 
              ]]>
    </statement> 

<!-- 원외약존재여부 체크(외래수납)  -->      
<!-- TXPAO00102 ,TXPAO00202-->   
<!-- 원외약존재여부 체크 matractflg (재료행위구분) = 0 (원외) -->
   <statement id="getOutOrdExist"><![CDATA[    
        SELECT  pid
           FROM     pam.paohoscl
         WHERE  pid             =   #pid#
              AND   orddd           =  #orddd#
              AND   cretno          =  #cretno#
              AND   instcd          =   #sessinstcd#
              AND   calcstat        =   #calcstat#
              AND   matractflag =  '0'
              ]]>
    </statement> 
    
<!-- 장애인환자여부 체크(외래수납)  -->      
<!-- TXPAO00102 ,TXPAO00202 -->   
<!-- 환자마스터 : 장애인환자여부  -->
   <statement id="getHandicapYN"><![CDATA[    
        SELECT  CASE handicaprbookpossnyn WHEN '' THEN 'N' 
                                                                        ELSE  handicaprbookpossnyn
                        END     AS handicapryn
           FROM     pam.pmohotpt
         WHERE  pid             =   #pid#
              AND   orddd           =   #orddd#
              AND   cretno          =  #cretno#
              AND   instcd          =   #sessinstcd#              
              AND   histstat            in ('R','T')
              AND   ordtype         = 'O'
              ]]>
    </statement> 

<!-- 연속처방 외래등록 또는 일반 외래등록의 원 ORDDD  조회 - 약국집계용 -->      
<!-- TXPAO00102 ,TXPAO00202 -->   
<!-- 실시처방테이블  : orddd  -->
   <statement id="getOrddd"><![CDATA[
        SELECT distinct pid              as pid
                       ,orddd            as orddd
                       ,cretno           as cretno
                       ,#opmi_orddeptcd# as orddeptcd
                       ,#opmi_orddrid#   as orddrid
                       ,instcd           as instcd
                       ,'O'              as ioflag
                       ,'O'              as prcpgenrflag
          FROM emr.mmodexop
         WHERE pid             = #opmi_pid#
           AND actorddd        = #opmi_orddd#
           AND actcretno       = #opmi_cretno#
           AND instcd          = #sessinstcd#
    ]]>
    </statement>


<!-- 외래선수금 수납취소 update  -->
    <statement id="setMdlAmt"><![CDATA[    
        UPDATE pam.paohbogj
           SET rcptstat    = 'C'
              ,lastupdtrid = #rcptrid#
              ,lastupdtdt  = SYSTIMESTAMP
         WHERE pid      = #pid#
           AND rcptdd   = #rcptdd#
           AND rcptno   = #rcptno#
           AND ordtype  = #ordtype#
           AND rcptstat = 'Y'
           AND instcd   = #sessinstcd#            
           ]]>
    </statement> 

<!-- 온라인금액 수납취소 update  -->
   <statement id="setOnlineAmt"><![CDATA[    
        UPDATE pam.pachonln
           SET rcptstat     = 'C'
              ,lastupdtrid  = #sessinstcd#
              ,lastupdtdt   = SYSTIMESTAMP
         WHERE pid  = #pid#
           AND rcptdd   = #rcptdd#
           AND rcptno   = #rcptno#
           AND ordtype  = #ordtype#
           AND rcptstat = 'Y'
           AND instcd   = #sessinstcd#            
           ]]>
    </statement> 
    
   <!-- 외래수납내역 생성 map : TXPAO00102 --> 
   <!-- CAST(#pid# AS VARCHAR2(10))           
                        ,       CAST(#rcptdd#  AS VARCHAR2(8))     
                        ,       CAST(#rcptno#  AS  INTEGER)     
                        ,       CAST(#rcptseqno# AS  INTEGER)      
                        ,       NVL(CAST(MAX(CAST(seqno AS integer)) AS integer),0)+1       
                        ,       CAST(#sessinstcd# AS  VARCHAR2(3))       
                        ,       CAST(#rcptstat#  AS  VARCHAR2(1))    
                        ,       CAST(#ordtype#  AS  VARCHAR2(1))     
                        ,       CAST(#rcptflag#  AS   VARCHAR2(3))  
                        ,       CAST(#cashamt#  AS  NUMBER(10,0))    
                        ,       CAST(#cardamt#  AS   NUMBER(10,0))      
                        ,       CAST(#onlineamt#  AS  NUMBER(10,0))      
                        ,       CAST(#rcptexecdd# AS VARCHAR2(8))   
                        ,       CAST(#rcpttm# AS  VARCHAR2(6))       
                        ,       CAST(#rcptrid# AS  VARCHAR2(10))      
                        ,       CAST(#remfact#  AS  VARCHAR2(200))     
                        ,       CAST(#paypsnflag#  AS  VARCHAR2(1))  
                        ,       CAST(#paypsnrem# AS VARCHAR2(100))    
                        ,       CAST(#sessinstcd#  AS  VARCHAR2(10))  
                        ,       SYSTIMESTAMP
                        ,       CAST(#sessinstcd# AS VARCHAR2(10)) 
                        ,       SYSTIMESTAMP     
                        
                        ,       hosindrugno     
                        ,       hosoutdrugno    
                        ,       CAST(#opmi_hosindrugno#  AS NUMBER(5))  
                        ,       CAST(#opmi_hosoutdrugno# AS NUMBER(5))  
                        
                        ,       orgrcptdd       
                        ,       orgrcptno       
                        ,       orgrcptseqno   
                        ,       CAST(#opmi_orgrcptdd#  AS VARCHAR2(8))
                        ,       CAST(#opmi_orgrcptno#   AS INTEGER)   
                        ,       CAST(#opmi_orgrcptseqno#  AS INTEGER)  
                         
                        -->
    <statement id="insOutOrdAmt"><![CDATA[    
        INSERT INTO     pam.paohopmi
                            (   pid                 
                            ,   rcptdd          
                            ,   rcptno          
                            ,   rcptseqno       
                            ,   instcd          
                            ,   rcptstat        
                            ,   uncorcptflag    
                            ,   orddd           
                            ,   cretno          
                            ,   acptseqno       
                            ,   orddeptcd       
                            ,   orddrid         
                            ,   ordtype         
                            ,   mskind          
                            ,   insukind        
                            ,   suppkind        
                            ,   insucd                                  
                            ,   payamt          
                            ,   nopyamt         
                            ,   allownbamt      
                            ,   payownbamt      
                            ,   payinsubamt     
                            ,   handcapfund     
                            ,   ersubtamt       
                            ,   procsubtamt     
                            ,   specamt         
                            ,   discamt         
                            ,   reduamt         
                            ,   bloddiscamt     
                            ,   totownbamt      
                            ,   precashamt      
                            ,   premdlrcptamt   
                            ,   precardamt      
                            ,   preonlineamt    
                            ,   mdlrcptamt      
                            ,   uncoamt         
                            ,   cardamt         
                            ,   cashamt         
                            ,   onlineamt       
                            ,   restamt         
                            ,   calcmthdflag    
                            ,   remfact         
                            ,   paypsnflag    
                            ,   paydepoamt  
                            ,   paypsnrem       
                            ,   rcptexecdd      
                            ,   rcpttm          
                            ,   rcptrid          
                            ,   orgrcptdd
                            ,   orgrcptno
                            ,   orgrcptseqno
                            ,   fstrgstrid      
                            ,   fstrgstdt       
                            ,   lastupdtrid     
                            ,   lastupdtdt   
                            ,   nopyinsubamt
                            ,   nopyownbamt
                            ,   allowninsubamt
                            ,   allownownbamt
                            ,   specinsubamt
                            ,   specownbamt 
                            ,   heallifeamtclamamt
							,   pregdmndamt
                            ,   suppamt  
							,   ktrmnno
							,   refundyn
							,   prepregdmndamt
							,   centcd
							,   subdeptcd
							,   coopteamcd
							,   payinsurestamt
							,		taxamt
                            )  
                VALUES(
                                #opmi_pid#                          
                            ,   #opmi_rcptdd#                       
                            ,   #opmi_rcptno#                       
                            ,   #opmi_rcptseqno#                    
                            ,   #sessinstcd#                        
                            ,   #opmi_rcptstat#                     
                            ,   #opmi_uncorcptflag#
                            ,   #opmi_orddd#                        
                            ,   #opmi_cretno#                       
                            ,   #opmi_acptseqno#                    
                            ,   #opmi_orddeptcd#                    
                            ,   #opmi_orddrid#                      
                            ,   #opmi_ordtype#                      
                            ,   #opmi_mskind#                       
                            ,   #opmi_insukind#                     
                            ,   #opmi_suppkind#                     
                            ,   #opmi_insucd#                       
                            ,   #opmi_payamt#                       
                            ,   #opmi_nopyamt#                      
                            ,   #opmi_allownbamt#                   
                            ,   #opmi_payownbamt#                   
                            ,   #opmi_payinsubamt#                  
                            ,   #opmi_handcapfund#                  
                            ,   #opmi_ersubtamt#                    
                            ,   #opmi_procsubtamt#                  
                            ,   #opmi_specamt#                      
                            ,   #opmi_discamt#                      
                            ,   #opmi_reduamt#                      
                            ,   #opmi_bloddiscamt#                  
                            ,   #opmi_totownbamt#                   
                            ,   #opmi_precashamt#                   
                            ,   #opmi_premdlrcptamt#                
                            ,   #opmi_precardamt#                   
                            ,   #opmi_preonlineamt#                 
                            ,   #opmi_mdlrcptamt#                   
                            ,   #opmi_uncoamt#                      
                            ,   #opmi_cardamt#                      
                            ,   #opmi_cashamt#                      
                            ,   #opmi_onlineamt#                    
                            ,   #opmi_restamt#                      
                            ,   #opmi_calcmthdflag#                 
                            ,   #opmi_remfact#                      
                            ,   #opmi_paypsnflag#                   
                            ,   #opmi_paydepoamt#                   
                            ,   #opmi_paypsnrem#                    
                            ,   #opmi_rcptexecdd#                   
                            ,   #opmi_rcpttm#                       
                            ,   #opmi_rcptrid#                      
                            ,   #opmi_orgrcptdd#                    
                            ,   #opmi_orgrcptno#                    
                            ,   #opmi_orgrcptseqno#                 
                            ,   #opmi_rcptrid#                        
                            ,   SYSTIMESTAMP    
                            ,   #opmi_rcptrid#                        
                            ,   SYSTIMESTAMP   
                            ,   #opmi_nopyinsubamt#                 
                            ,   #opmi_nopyownbamt#                  
                            ,   #opmi_allowninsubamt#               
                            ,   #opmi_allownownbamt#                
                            ,   #opmi_specinsubamt#                 
                            ,   #opmi_specownbamt#                  
                            ,   #opmi_heallifeamtclamamt#
														,   #opmi_pregdmndamt#
                            ,   #opmi_suppamt#  
														,   #opmi_ktrmnno#
														,   ''
														,   #opmi_prepregdmndamt#
														,   #opmi_centcd#
														,   #opmi_subdeptcd#
														,   #opmi_coopteamcd#
														,		#opmi_payinsurestamt#
														, 	#opmi_taxamt#
                            )
           ]]>
    </statement> 

<!-- 생성된 외래수납내역에 대한 계산내역 update(수납정보:수납상태,수납일자,번호)  
      2007.06.11 청구대상상태 UPDATE
      2007.09.07 acptseqno 조건 삭제                AND acptseqno   =  opmi_acptseqno
      
      20090610 유정란 clamkey,clamcretdd,clamcretyn 
-->    
    <statement id="setOutOrdAmtOscl"><![CDATA[    
        UPDATE /*+ index (a PK_PAOHOSCL) */ pam.paohoscl a
           SET a.rcptdd      = #opmi_rcptdd#
             , a.rcptexecdd  = #opmi_rcptexecdd#
             , a.rcpttm      = #opmi_rcpttm#
             , a.rcptno      = #opmi_rcptno#
             , a.rcptseqno   = #opmi_rcptseqno#
             , a.calcstat    = #opmi_rcptstat#
             , a.clamtrgtstat = CASE a.clamtrgtstat WHEN 'D' THEN a.clamtrgtstat
                                                    ELSE #opmi_rcptstat#
                                                     END
             , a.clamkey  =  CASE WHEN a.clamcretyn = 'Y' THEN a.clamkey
                             ELSE NVL((	SELECT b.clamkey 
                             			FROM pam.paohoscl b 
                             			WHERE b.instcd = a.instcd 
                             			AND b.pid = a.pid 
                                        AND b.orddd = a.orddd
                                        AND b.cretno = a.cretno
                             			AND b.calcstat = 'Y' 
                             			AND b.prcpdd = a.prcpdd 
                             			AND b.execprcpuniqno = a.execprcpuniqno 
                             			AND ROWNUM = 1),a.clamkey)
                             END
             , a.clamcretdd = CASE WHEN a.clamcretyn = 'Y' THEN a.clamcretdd
                              ELSE NVL((SELECT b.clamcretdd 
                              			FROM pam.paohoscl b 
                              			WHERE b.instcd = a.instcd 
                              			AND b.pid = a.pid 
                                        AND b.orddd = a.orddd
                                        AND b.cretno = a.cretno
                              			AND b.calcstat = 'Y' 
                              			AND b.prcpdd = a.prcpdd 
                              			AND b.execprcpuniqno = a.execprcpuniqno 
                              			AND ROWNUM = 1),a.clamcretdd)
                              END
             , a.clamcretyn = CASE WHEN a.clamcretyn = 'Y' THEN a.clamcretyn
                              ELSE NVL((SELECT b.clamcretyn 
                              			FROM pam.paohoscl b 
                              			WHERE b.instcd = a.instcd 
                              			AND b.pid = a.pid 
                                        AND b.orddd = a.orddd
                                        AND b.cretno = a.cretno
                              			AND b.calcstat = 'Y' 
                              			AND b.prcpdd = a.prcpdd 
                              			AND b.execprcpuniqno = a.execprcpuniqno 
                              			AND ROWNUM = 1),a.clamcretyn)
                              END
             , a.earnenddd  = CASE when  (a.execdd != '00000000' and  a.earnenddd < to_char(sysdate, 'yyyymmdd')) then to_char(sysdate, 'yyyymmdd')
                              ELSE  a.earnenddd
                              END
             , a.lastupdtrid = #sessuserid#
             , a.lastupdtdt  = SYSTIMESTAMP                                                        
         WHERE a.pid      = #opmi_pid#
           AND a.orddd    = #opmi_orddd#
           AND a.cretno   = #opmi_cretno#
           AND a.instcd   = #sessinstcd#
           AND a.calcstat = 'R'               
           ]]>         
    </statement> 
 
<!-- 생성된 외래수납내역에 대한 외래등록내역 update(수납정보:수납상태,수납일자,번호)  -->    
    <statement id="setOutOrdAmtOtpt"><![CDATA[    
        UPDATE pam.pmohotpt
              SET rcptdd      = #otpt_rcptdd#
                  , rcptno      = #otpt_rcptno#
				  , rcptseqno = #otpt_rcptseqno#
				  , calcflag    = #otpt_calcflag#
				  , histstat     = #otpt_histstat#
				  , holdflag    = #otpt_holdflag#
				  , lastupdtrid = #sessuserid#
				  , lastupdtdt  = SYSTIMESTAMP
         WHERE pid         = #otpt_pid#
              AND orddd     = #otpt_orddd#
              AND cretno    = #otpt_cretno#
              AND instcd     = #sessinstcd#
              AND histstat  in ('R','T')
              AND ordtype   = 'O'
           ]]>         
    </statement> 
    
<!-- 외래내역의 계산상태코드  update(외래수납상태)  -->    
    <statement id="setOutOrdStat"><![CDATA[    
        UPDATE pam.pmohotpt
           SET rcptdd    = #otpt_rcptdd#
             , rcptno    = #otpt_rcptno#
             , rcptseqno = #otpt_rcptseqno#
             , calcflag  = #otpt_calcflag#
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP 
         WHERE pid       = #otpt_pid#
           AND orddd     = #otpt_orddd#
           AND cretno    = #otpt_cretno#
           AND instcd    = #sessinstcd#
           AND histstat  in  ('R','T')
           ]]>         
    </statement> 

<!-- 외래처방내역의 처방상태코드  MMOHOPRC update(외래수납상태)  -->    
<!-- 실시일자별 수납시와 오더일자별 수납시의 조건값 확인 -->
<!-- 처방진행상태 230(수납) 이상일 경우에는 처방진행상태는 update 하지 않는다. -->
<!-- 처방진행상태 170(검수완료) 일 경우에는 처방진행상태는 update 한다.-약국 2007.09.12-->
    <statement id="setOutOprcStat"><![CDATA[
        UPDATE emr.mmohoprc a
           SET a.prcpstatcd = CASE a.prcpstatcd WHEN '000' THEN #prcpstatcd#
                                                WHEN '170' THEN #prcpstatcd#
                                                ELSE a.prcpstatcd
                                                 END
              ,a.lastupdtrid = #sessuserid#
              ,a.lastupdtdt  = SYSTIMESTAMP
         WHERE a.pid              = #pid#
           AND a.instcd           =  #sessinstcd#
           AND a.prcphistcd       = 'O'
           AND a.tempprcpflag     <> 'Y'
           AND a.hscttempprcpflag <>'Y'
           AND a.prcpflag         IN ('1','3')
           AND exists  (SELECT 'x'
                          FROM pam.paohoscl b
                         WHERE b.pid      = #pid#
                           AND b.orddd    = #orddd#
                           AND b.cretno   = #cretno#
                           AND b.calcstat = 'Y'
                           AND b.prcpno      > 0
                           AND b.prcphistno  > 0
                           AND b.instcd   = #sessinstcd#
                           AND b.prcpdd   = a.prcpdd
                           AND b.prcpno   = a.prcpno
                            )
           ]]>
    </statement>
<!--
           AND (prcpdd,prcpno)  IN (SELECT DISTINCT prcpdd, prcpno
									  FROM pam.paohoscl
								     WHERE pid = #pid#
									   AND orddd    = #orddd#
									   AND cretno   = #cretno#
									   AND calcstat = 'Y'
									   AND prcpno      > 0
									   AND prcphistno  > 0
									   AND instcd   = #sessinstcd# )
-->

	<!-- 홀드상태로 수납시 처방상태값을 000으로 초기화 한다 09/08/17 cys-->
    <statement id="setOutOprcHoldStat"><![CDATA[    
        UPDATE emr.mmohoprc a
           SET prcpstatcd = CASE  WHEN prcpstatcd <= '230' THEN  '000'
                                  ELSE prcpstatcd
                                   END
               , lastupdtrid = #sessuserid#
               , lastupdtdt  = SYSTIMESTAMP
         WHERE pid        = #pid#
           AND instcd     = #sessinstcd#
           AND orddd      = #orddd#
           AND cretno     = #cretno#
           AND prcphistcd ='O'
           AND exists (  SELECT 'x'
						   FROM emr.mmodexop b
						   WHERE b.pid          = a.pid
						   AND b.instcd         = a.instcd
						   AND b.actorddd       = a.orddd
						   AND b.actcretno      = a.cretno
						   and b.prcpdd         = a.prcpdd
						   and b.prcpno         = a.prcpno
						   and b.prcphistno     = a.prcphistno
						   AND b.execprcphistcd = 'O'  
						   AND b.execrcptstatcd = '210'
                   )
           ]]>         
    </statement>
<!--
           AND (prcpdd,prcpno ,prcphistno)  IN (SELECT distinct prcpdd, prcpno,prcphistno
									              FROM emr.mmodexop b
							                     WHERE b.pid            = a.pid
												   AND b.instcd         = a.instcd
												   AND b.actorddd       = a.orddd
												   AND b.actcretno      = a.cretno
												   AND b.execprcphistcd = 'O'
												   AND b.execrcptstatcd = '210')
-->
	
	<!-- 사용안함-->
    <statement id="setRollBackOprc"><![CDATA[    
        UPDATE emr.MMOHOPRC m
              SET m.prcpstatcd =  (SELECT a.execrcptstatcd
											 FROM pam.paohexop a
										   WHERE a.pid     = m.pid
												AND a.instcd = m.instcd
												AND a.prcpdd = m.prcpdd
												AND a.prcpno = m.prcpno
												AND a.prcphistno = m.prcphistno
												AND a.seqno = (SELECT max(a.seqno)
																		 FROM pam.paohexop a
																		  WHERE a.pid     = m.pid
																			AND a.instcd = m.instcd
																			AND a.orddd = m.orddd
																			AND a.prcpdd = m.prcpdd
																			AND a.prcpno = m.prcpno
																			AND a.prcphistno = m.prcphistno
																			AND a.execrcptstatcd != m.prcpstatcd
																	)
										 )
                  , m.lastupdtrid = #sessuserid#
                  , m.lastupdtdt  = SYSTIMESTAMP 
         WHERE m.pid               = #otpt_pid#
              AND m.instcd           =  #sessinstcd#
			  AND m.orddd            = #otpt_orddd#
			  AND m.cretno           = #otpt_cretno#
			  AND m.prcphistcd      = 'O'
			  AND m.prcpstatcd      ='200'
           ]]>         
    </statement> 
	
	<!-- MMODEXOP 테이블에 원무상태값과 처방상태값이 다를경우 처방상태값 위주로 수정한다. cys 20090804 -->
    <statement id="setRollBackExop"><![CDATA[    
        UPDATE emr.mmodexop m
              SET   m.execrcptstatcd = decode(m.rcptno , '0' , '000' , '230')
                  , m.lastupdtrid = #sessuserid#
                  , m.lastupdtdt  = SYSTIMESTAMP 
			 WHERE m.pid              = #otpt_pid#
			   AND m.instcd           = #sessinstcd#
			   AND m.actorddd         = #otpt_orddd#
			   AND m.actcretno        = #otpt_cretno#
			   AND m.execprcphistcd   = 'O'
			   AND m.execrcptstatcd   = '210'

           ]]>         
    </statement> 

<!-- 외래처방내역의 처방상태코드  MMODEXOP update(외래수납상태)  -->    
<!-- 실시일자별 수납시와 오더일자별 수납시의 , 조건 값 확인 -->
<!-- 처방진행상태 230(수납) 이상일 경우에는 처방진행상태는 update 하지 않는다. -->
<!-- 이미 수납?던 내역은 수납정보를 보존한다.(정산시 모두 update하는 것 방지) -->
    <statement id="setOutExopStat"><![CDATA[    
        UPDATE  emr.mmodexop a
           SET  a.execprcpstatcd = CASE a.execprcpstatcd WHEN '000' THEN #prcpstatcd#
                                                         WHEN '170' THEN #prcpstatcd#
                                                         ELSE  a.execprcpstatcd
                                                          END
               ,a.execrcptstatcd = CASE a.execrcptstatcd WHEN '000' THEN #prcpstatcd#
                                                         WHEN '170' THEN #prcpstatcd#
                                                         ELSE  a.execrcptstatcd
                                                          END

               ,a.rcptdd  = CASE WHEN a.rcptdd ='00000000' THEN #rcptdd#
							     WHEN a.rcptno = 0         THEN #rcptdd#
                                 ELSE a.rcptdd
                                  END			   
			   
			   ,a.rcptno = CASE WHEN a.rcptno = 0         THEN #rcptno#
                                                          ELSE TO_CHAR(a.rcptno)
                                                           END

               ,a.rcptseqno = CASE WHEN a.rcptseqno = 0      THEN #rcptseqno#
                                                             ELSE TO_CHAR(a.rcptseqno)
                                                              END        

               ,a.rcptrid = CASE WHEN a.rcptrid ='-'       THEN #rcptrid#
							     WHEN a.rcptno = 0         THEN #rcptrid#
                                                           ELSE a.rcptrid
                                                            END
               ,a.lastupdtrid = #sessuserid#
               ,a.lastupdtdt  = SYSTIMESTAMP 
        WHERE   a.pid             = #pid#
          AND   a.actorddd        = #orddd#
          AND   a.actcretno       = #cretno#
          AND   a.instcd          = #sessinstcd#
          AND   a.execprcphistcd  = 'O'
          AND   exists  (SELECT 'x'
                          FROM pam.paohoscl b
                         WHERE b.pid  = #pid#
                           AND b.orddd       = #orddd#
                           AND b.cretno      = #cretno#
                           AND b.calcstat    = 'Y'
                           AND b.prcpno      > 0
                           AND b.prcphistno  > 0
                           AND b.instcd      = #sessinstcd#
                           AND b.prcpdd        = a.prcpdd
                           AND b.prcpno        = a.prcpno
                           AND b.execprcpseqno = a.execprcpno
                         )
           ]]>
    </statement>
<!--
          AND   (prcpdd, prcpno,execprcpno) IN (SELECT DISTINCT prcpdd,prcpno,execprcpseqno
                                                  FROM pam.paohoscl
                                                 WHERE pid  = #pid#
                                                   AND orddd       = #orddd#
                                                   AND cretno      = #cretno#
                                                   AND calcstat    = 'Y'
                                                   AND prcpno      > 0      
                                                   AND prcphistno  > 0
                                                   AND instcd      = #sessinstcd#
                                                 )
-->

	<!--  처방을 홀드상태로 수납하면 영수번호 초기화 09/07/30 cys -->
    <statement id="setOutExopHoldStat"><![CDATA[    
        UPDATE emr.mmodexop
           SET execprcpstatcd = CASE  WHEN execprcpstatcd <= '230' THEN  '000'
									  ELSE execprcpstatcd
									   END
		      ,rcptdd         = '00000000'
              ,rcptno         = 0
			  ,rcptseqno      = 0
              ,lastupdtrid    = #sessuserid#
              ,lastupdtdt     = SYSTIMESTAMP 
         WHERE pid            = #pid#
           AND instcd         = #sessinstcd#
           AND actorddd       = #orddd#
           AND actcretno      = #cretno#
           AND execprcphistcd = 'O'
           AND execrcptstatcd = '210'
           ]]>
    </statement> 

    <!--  보험유형, 할인내역, 외래등록내역(초재진구분,선택진료구분,진찰료산정구분 등) -->    
    <!--  등의 유형변경 사항 체크하여 정산구분 조회(return) -->
    <!--  비교하는 것 중에, 변경사항이 하나라도 있을 경우, 정산 calcyn = Y  -->
    <!--
    <statement id="getChangelist"><![CDATA[    
        SELECT  'N' AS calcyn
          FROM  pam.pmohotpt
         WHERE  pid                     = #pid#                                            
           AND  orddd                   = #orddd#                                          
           AND  cretno                  = #cretno#                                         
           AND  instcd                  = #sessinstcd#                                     
           AND  histstat                in ('R','T')                                       
           AND  insukind                = #insukind#                  
           AND  suppkind                = #suppkind#                  
           AND  insucd                  = #insucd#                    
           AND  suppkindresn            = #suppkindresn#              
           AND  disccd                  = #disccd#                    
           AND  specordyn               = #specordyn#                 
           AND  fsexamflag              = #fsexamflag#                
           AND  fsexammanlyn            = #fsexammanlyn#              
           AND  medamtestmyn            = #medamtestmyn#              
           AND  medamtpostyn            = #medamtpostyn#              
           AND  medamtfreeresn          = #medamtfreeresn#            
           AND  etcordflag              = #etcordflag#                
           AND  handicaprbookpossnyn    = #handicaprbookpossnyn#      
           AND  ordreqformflag          = #ordreqformflag#            
           AND  clincstdyacptflag       = #clincstdyacptflag#         
           AND  ordtype                 = 'O'                         
           AND  hosoutexptresncd        = #hosoutexptresncd#                               
           ]]>
    </statement>
    -->

   <!-- 외래등록 내역 이력 추가 (계산 수행시, 유형변경된 내역 있을 경우) --> 
   <!-- TXPAO00101 -->
   <!-- CAST(#pid# AS VARCHAR2(10))  -->
   <statement id="insOtptHist"><![CDATA[    
        INSERT INTO     pam.pmohotpt
                            (   pid 
                            ,   orddd   
                            ,   cretno  
                            ,   acptseqno   
                            ,   instcd  
                            ,   histstat    
                            ,   orgorddd    
                            ,   orgcretno   
                            ,   calcbaseflag    
                            ,   calcyn  
                            ,   ordtm   
                            ,   orddeptcd   
                            ,   orddrid 
                            ,   dutdeptcd   
                            ,   centcd  
                            ,   supdeptcd   
                            ,   mskind  
                            ,   insukind    
                            ,   suppkind    
                            ,   insucd  
                            ,   suppkindresn    
                            ,   specordyn   
                            ,   holiflag    
                            ,   fsexamflag  
                            ,   fsexammanlyn    
                            ,   ordtype 
                            ,   brateflag   
                            ,   medamtestmyn    
                            ,   medamtpostyn    
                            ,   medamtfreeresn  
                            ,   rsrvflag    
                            ,   etcordflag  
                            ,   disccd  
                            ,   hosoutexptresncd    
                            ,   clincstdyacptflag   
                            ,   clincstdyno 
                            ,   chrtlendyn  
                            ,   specorddescyn   
                            ,   ordreqdescyn    
                            ,   ordreqhospgrde  
                            ,   insuchrgyn  
                            ,   nursacptyn  
                            ,   nursacptdt  
                            ,   dracptyn    
                            ,   dracptdt    
                            ,   prcpgenryn  
                            ,   prcpnotoccrresn 
                            ,   estmspclappyn   
                            ,   elbulbodstat    
                            ,   elbulbodstatdt  
                            ,   calcflag    
                            ,   calcmthdflag
                            ,   dnoracptyn  
                            ,   rqstflag    
                            ,   rqsthospcd  
                            ,   rqstdrid    
                            ,   tdayinflag  
                            ,   tranindd    
                            ,   rcptdd  
                            ,   rcptno  
                            ,   rcptseqno   
                            ,   telrsrvrem      
                            ,   updtcnclresn
                            ,   fstacptid   
                            ,   fstacptdt   
                            ,   fstrgstrid  
                            ,   fstrgstdt   
                            ,   lastupdtrid 
                            ,   lastupdtdt  
                            ,   ordreqformflag
                            ,   handicaprbookpossnyn
                            ,   outercdrgstyn
                            ,   undersixageyn
                            ,   remfact
                            ,   spclcd
                            ,   onestop
                            ,   ownbflag
                            ,   ordpatyn
                            ,   uncocd
                            ,   pmflag
                            ,   emplno
                            ,   suppkindsubyn   
                            ,   earnendyn
                            ,   rareobstflag
                            ,   tranflag
                            ,   onlnno
                            ,   inetproxyrrgstno
                            ,   holdflag
							,   subdeptcd
                            )
                SELECT  pid 
                            ,   orddd   
                            ,   cretno  
                            ,   1  
                            ,   instcd  
                            ,   histstat--'R'
                            ,   orgorddd    
                            ,   orgcretno   
                            ,   calcbaseflag    
                            ,   CAST(#calcyn#   AS VARCHAR2(1))
                            ,   ordtm   
                            ,   orddeptcd   
                            ,   orddrid 
                            ,   dutdeptcd   
                            ,   centcd  
                            ,   supdeptcd   
                            ,   mskind  
                            ,   CAST(#insukind#  AS VARCHAR2(2))
                            ,   CAST(#suppkind#  AS VARCHAR2(2))
                            ,   CAST(#insucd#   AS VARCHAR2(20))
                            ,   CAST(#suppkindresn# AS VARCHAR2(2))
                            ,   CAST(#specordyn#    AS VARCHAR2(1))
                            ,   holiflag    
                            ,   CAST(#fsexamflag#   AS VARCHAR2(1))
                            ,   CAST(#fsexammanlyn# AS VARCHAR2(1))
                            ,   ordtype 
                            ,   brateflag   
                            ,   CAST(#medamtestmyn# AS VARCHAR2(1))
                            ,   CAST(#medamtpostyn# AS VARCHAR2(1))
                            ,   CAST(#medamtfreeresn#    AS VARCHAR2(2))
                            ,   rsrvflag    
                            ,   CAST(#etcordflag#   AS VARCHAR2(1))
                            ,   CAST(#disccd#    AS VARCHAR2(3))
                            ,   CAST(#hosoutexptresncd#  AS VARCHAR2(2))    
                            ,   CAST(#clincstdyacptflag# AS VARCHAR2(1))    
                            ,   clincstdyno 
                            ,   chrtlendyn  
                            ,   specorddescyn   
                            ,   ordreqdescyn    
                            ,   ordreqhospgrde  
                            ,   insuchrgyn  
                            ,   nursacptyn  
                            ,   nursacptdt  
                            ,   dracptyn    
                            ,   dracptdt    
                            ,   prcpgenryn  
                            ,   prcpnotoccrresn 
                            ,   estmspclappyn   
                            ,   elbulbodstat    
                            ,   elbulbodstatdt  
                            ,   calcflag    
                            ,   CAST(#calcmthdflag# AS VARCHAR2(1))
                            ,   dnoracptyn  
                            ,   rqstflag    
                            ,   rqsthospcd  
                            ,   rqstdrid        
                            ,   tdayinflag  
                            ,   tranindd    
                            ,   rcptdd  
                            ,   rcptno  
                            ,   rcptseqno   
                            ,   telrsrvrem  
                            ,   updtcnclresn
                            ,   fstacptid   
                            ,   fstacptdt   
                            ,   CAST(#sessinstcd#    AS VARCHAR2(10))
                            ,   SYSTIMESTAMP
                            ,   CAST(#sessinstcd#  AS VARCHAR2(10))
                            ,   SYSTIMESTAMP
                            ,   CAST(#ordreqformflag#   AS VARCHAR2(1))
                            ,   CAST(#handicaprbookpossnyn#     AS VARCHAR2(1))
                            ,   outercdrgstyn
                            ,   undersixageyn
                            ,   remfact
                            ,   spclcd
                            ,   onestop
                            ,   ownbflag
                            ,   ordpatyn
                            ,   uncocd
                            ,   pmflag
                            ,   emplno
                            ,   suppkindsubyn
                            ,   earnendyn
                            ,   rareobstflag
                            ,   tranflag
                            ,   onlnno
                            ,   inetproxyrrgstno
                            ,   holdflag
							,   subdeptcd
                       FROM pam.pmohotpt                
                      WHERE pid       = #pid#
                        AND orddd     = #orddd#    
                        AND cretno    = #cretno#    
                        AND instcd    = #sessinstcd#
           ]]>         
    </statement> 

<!-- 외래등록내역 HistStat update  -->    
<!-- add  acptseqno  
AND    acptseqno = #acptseqno#
-->    
    <statement id="setOtptPreHist"><![CDATA[    
        UPDATE pam.pmohotpt a
           SET histstat = #histstat# 
              ,calcflag = 'Y' 
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP 
         WHERE pid         = #pid#
           AND orddd       = #orddd#
           AND cretno      = #cretno#
           AND instcd      = #sessinstcd#
           AND histstat    in ('R','T')
    ]]>
    </statement> 

   <!-- 외래등록 내역 이력 추가 (계산 수행시, 유형변경된 내역 있을 경우) --> 
   <!-- TXPAO00101 -->
   <!-- CAST(#pid# AS VARCHAR2(10))  -->
    <statement id="setOtptAddHist"><![CDATA[    
        UPDATE  pam.pmohotpt a
           SET  
            --   instcd                = instcd
            -- , pid                   = pid                     
            -- , orddd                 = orddd                   
            -- , cretno                = cretno                  
            -- , acptseqno             = acptseqno               
            -- , histstat              = histstat                
            -- , orgorddd              = orgorddd                
            -- , orgcretno             = orgcretno               
                 calcbaseflag          = #calcbaseflag#            
               , calcyn                = #calcyn#                  
            -- , ordtm                 = ordtm                   
            -- , orddeptcd             = orddeptcd               
            -- , orddrid               = orddrid                 
            -- , dutdeptcd             = dutdeptcd               
            -- , centcd                = centcd                  
            -- , supdeptcd             = supdeptcd               
            -- , mskind                = mskind                  
               , insukind              = #insukind#                
               , suppkind              = #suppkind#                
               , insucd                = #insucd#                  
               , suppkindresn          = #suppkindresn#            
               , specordyn             = #specordyn#               
            -- , holiflag              = holiflag                
               , fsexamflag            = #fsexamflag#              
               , fsexammanlyn          = #fsexammanlyn#            
            -- , ordtype               = ordtype                 
            -- , brateflag             = brateflag               
               , medamtestmyn          = #medamtestmyn#            
               , medamtpostyn          = #medamtpostyn#            
               , medamtfreeresn        = #medamtfreeresn#         
               , rsrvflag              = #rsrvflag#                
               , etcordflag            = #etcordflag#              
               , disccd                = #disccd#                  
               , hosoutexptresncd      = #hosoutexptresncd#        
               , clincstdyacptflag     = #clincstdyacptflag#       
            -- , clincstdyno           = clincstdyno             
            -- , chrtlendyn            = chrtlendyn              
            -- , specorddescyn         = specorddescyn           
            -- , ordreqdescyn          = ordreqdescyn            
            -- , ordreqhospgrde        = ordreqhospgrde          
            -- , insuchrgyn            = insuchrgyn              
            -- , nursacptyn            = nursacptyn              
            -- , nursacptdt            = nursacptdt              
            -- , dracptyn              = dracptyn                
            -- , dracptdt              = dracptdt                
            -- , prcpgenryn            = prcpgenryn              
            -- , prcpnotoccrresn       = prcpnotoccrresn         
            -- , estmspclappyn         = estmspclappyn           
            -- , elbulbodstat          = elbulbodstat            
            -- , elbulbodstatdt        = elbulbodstatdt          
               , calcflag              = #calcflag#                
               , calcmthdflag          = #calcmthdflag#            
            -- , dnoracptyn            = dnoracptyn              
            -- , rqstflag              = rqstflag                
            -- , rqsthospcd            = rqsthospcd              
            -- , rqstdrid              = rqstdrid                
            -- , tdayinflag            = tdayinflag              
            -- , tranindd              = tranindd                
            -- , rcptdd                = rcptdd                  
            -- , rcptno                = rcptno                  
            -- , rcptseqno             = rcptseqno               
            -- , telrsrvrem            = telrsrvrem              
            -- , updtcnclresn          = updtcnclresn            
            -- , fstacptid             = fstacptid               
            -- , fstacptdt             = fstacptdt               
               , ordreqformflag        = #ordreqformflag#      
            -- , prcplockid            = prcplockid              
            -- , dschjudgprcsstat      = dschjudgprcsstat        
            -- , judgmdlid             = judgmdlid               
            -- , lastjudgdt            = lastjudgdt              
            -- , mainjudgid            = mainjudgid              
            -- , probjudgflag          = probjudgflag            
            -- , spcljudgflag          = spcljudgflag            
               , handicaprbookpossnyn  = #handicaprbookpossnyn#      
            -- , outercdrgstyn         = outercdrgstyn           
            -- , undersixageyn         = undersixageyn           
            -- , remfact               = remfact                 
            -- , spclcd                = spclcd                  
            -- , onestop               = onestop                 
               , ownbflag              = #ownbflag#                 
            -- , ordpatyn              = ordpatyn                
            -- , uncocd                = uncocd                  
            -- , pmflag                = pmflag                  
            -- , emplno                = emplno                  
            -- , suppkindsubyn         = suppkindsubyn           
            -- , earnendyn             = earnendyn               
               , rareobstflag          = #rareobstflag#            
            -- , tranflag              = tranflag                
            -- , onlnno                = onlnno                  
            -- , inetproxyrrgstno      = inetproxyrrgstno        
            -- , fstrgstrid            = fstrgstrid              
            -- , fstrgstdt             = fstrgstdt               
               , lastupdtrid           = #sessuserid#             
               , lastupdtdt            = SYSTIMESTAMP              
            -- , mig                   = mig                     
               , holdflag              = #holdflag#
			-- , subdeptcd             = subdeptcd
         WHERE pid       =  #pid#
           AND orddd     =  #orddd#
           AND cretno    =  #cretno#
           AND instcd    =  #sessinstcd#
           AND histstat  in ('R','T')
           ]]>
    </statement> 

<!-- 외래등록내역 HistStat update  -->    
<!-- add  acptseqno  
AND    acptseqno = #acptseqno#
-->    
    <statement id="setOtptPreHistCancel"><![CDATA[    
        UPDATE pam.pmohotpt a
           SET histstat    = #histstat# 
              ,calcflag    = 'Y'
              ,lastupdtrid = #sessinstcd#
              ,lastupdtdt  = SYSTIMESTAMP  
         WHERE pid         = #pid#
           AND orddd       = #orddd#
           AND cretno      = #cretno#
           AND instcd      = #sessinstcd#
           AND histstat    in ('R','T')
           ]]>
    </statement>     

   <!-- 외래등록 내역 조회--> 
   <statement id="getLastOtpt"><![CDATA[    
	     SELECT  a.pid
				,a.orddd
				,a.cretno
				,a.acptseqno
				,a.instcd
				,a.histstat
				,a.orgorddd
				,a.orgcretno
				,a.calcbaseflag
				,a.calcyn
				,a.ordtm
				,a.orddeptcd
				,COM.FN_ZS_GETDEPTNAME(a.instcd, a.orddeptcd, a.orddd) AS orddeptcdnm
				,a.orddrid
				,COM.FN_ZS_GETUSERNM(a.orddrid, a.orddd) AS orddridnm
				,a.dutdeptcd
				,a.centcd
				,a.supdeptcd
				,a.mskind
				,a.insukind
				,a.suppkind
				,a.insucd
				,a.suppkindresn
				,a.specordyn
				,a.holiflag
				,a.fsexamflag
				,a.fsexammanlyn
				,a.ordtype
				,a.brateflag
				,a.medamtestmyn
				,a.medamtpostyn
				,a.medamtfreeresn
				,a.rsrvflag
				,a.etcordflag
				,a.disccd
				,a.hosoutexptresncd
				,a.clincstdyacptflag
				,a.clincstdyno
				,a.chrtlendyn
				,a.specorddescyn
				,a.ordreqdescyn
				,a.ordreqhospgrde
				,a.insuchrgyn
				,a.nursacptyn
				,a.nursacptdt
				,a.dracptyn
				,a.dracptdt
				,a.prcpgenryn
				,a.prcpnotoccrresn
				,a.estmspclappyn                 --산정특례적용여부(진료부에서입력)
				,a.elbulbodstat
				,a.elbulbodstatdt
				,a.calcflag
				,a.calcmthdflag
				,a.dnoracptyn
				,a.rqstflag
				,a.rqsthospcd
				,a.rqstdrid
				,a.tdayinflag
				,a.tranindd
				,a.rcptdd
				,a.rcptno
				,a.rcptseqno
				,a.telrsrvrem
				,a.updtcnclresn
				,a.fstacptid
				,a.fstacptdt
				,a.fstrgstrid
				,a.fstrgstdt
				,a.lastupdtrid
				,a.lastupdtdt
				,a.handicaprbookpossnyn              --장애인수첩소지자여부
				,a.undersixageyn                     --6세미만여부
				,a.ordreqformflag                    --진료의뢰서구분(수급절차)
				,a.ownbflag
				,a.uncocd
				,a.emplno
				,a.suppkindsubyn
				,a.earnendyn
				,a.rareobstflag                       --희귀난치대상자구분
				,a.tranflag
				,a.onlnno
				,a.inetproxyrrgstno
				,a.holdflag
				,a.subdeptcd
				,#refundyn#  as refundyn
				,(select c.insuno from pam.pmcmptin c where c.pid = a.pid AND c.insukind = a.insukind AND c.fromdd <= a.orddd AND c.todd >= a.orddd AND c.instcd = a.instcd AND c.histstat = 'Y' AND rownum =1) as insuno
				--,(select dcgm.discreducd from pam.PADHDCGM dcgm where dcgm.pid = a.pid AND dcgm.instcd = a.instcd AND dcgm.rcptdd = a.rcptdd AND dcgm.rcptno = a.rcptno AND dcgm.rcptseqno = a.rcptseqno AND dcgm.discreduflag ='G' AND rownum =1) as discreducd
				,  CASE when a.orddd < TO_CHAR(sysdate,'YYYYMMDD') THEN
								CASE WHEN
								 (SELECT count(*) FROM pam.pmohopcg k 
								  WHERE k.pid = a.pid
								  AND    k.orddd = a.orddd
								  AND    k.cretno = a.cretno
								  AND    k.instcd = a.instcd
								  AND	k.genrdd = TO_CHAR(sysdate,'YYYYMMDD')
								  AND    k.histstat = 'Y') = 0 THEN 'P' ELSE 'T' END
						 when a.orddd = TO_CHAR(sysdate,'YYYYMMDD') then 'T'
						 when a.orddd > TO_CHAR(sysdate,'YYYYMMDD') then 'R'
						  END AS srchcond
				,a.mig
				,#calcflag_org#  as calcflag_org
				,a.remfact
				,a.rcptvipresncd    
				,a.rcptvipetcresn    
				,a.prcptdayaftrcptyn 
				,a.coopteamcd       
				,a.specordtype 
				,decode(to_char(to_date(a.orddd,'yyyymmdd'),'d'),'1','일','2','월','3','화', '4','수', '5','목', '6','금','토') AS day
            FROM pam.pmohotpt a                
           WHERE a.pid        = #pid#
             AND a.orddd      = #orddd# 
             AND a.cretno     = #cretno# 
             AND a.histstat   in ('R','T')
             AND a.instcd     = #sessinstcd#
			 ORDER BY a.orddd desc, a.ordtm  
           ]]>         
    </statement> 
    
    <statement id="setPatInsu">
        <![CDATA[
        UPDATE pam.pmcmptin SET
			  histstat        = #ptin_histstat#,
			  fromdd          = #ptin_fromdd#,
			  todd            = #ptin_todd#,
			  insucd          = #ptin_insucd#,  
			  insuno          = #ptin_insuno#,  
			  insdnm          = #ptin_insdnm#,   
			  insdrrgstno1    = #ptin_insdrrgstno1#,   
			  insdrrgstno2    = #ptin_insdrrgstno2#,   
			  insdrela        = #ptin_insdrela#,    
			  lastupdtrid     = #sessuserid#,  
			  lastupdtdt      = SYSTIMESTAMP
        WHERE pid       = #ptin_pid_org#
          AND insukind  = #ptin_insukind_org#
		  AND fromdd    = #ptin_fromdd_org#
          AND todd      = #ptin_todd_org#
          AND instcd    = #sessinstcd#
          AND histstat  = 'Y'
        ]]>			
    </statement>


    <statement id="insPatInsu"><![CDATA[
      INSERT INTO pam.pmcmptin(
                      pid,    
                      insukind,   
                      todd,   
                      seqno,
                      instcd,
                      histstat,   
                      fromdd, 
                      insucd, 
                      insuno, 
                      insdnm, 
                      insdrrgstno1,   
                      insdrrgstno2,   
                      insdrela,   
                      fstrgstrid, 
                      fstrgstdt,  
                      lastupdtrid,    
                      lastupdtdt
      )VALUES(
                      #ptin_pid#, 
                      #ptin_insukind#,    
                      #ptin_todd#,
                      (
                          SELECT COALESCE(MAX(seqno),0) + 1
                            FROM pam.pmcmptin
                           WHERE pid = #ptin_pid#
                             AND insukind = #ptin_insukind#
                             AND todd     = #ptin_todd#
                             AND instcd   = #sessinstcd# 
                      ),
                      #sessinstcd#,
                      'Y',
                      #ptin_fromdd#,  
                      #ptin_insucd#,  
                      #ptin_insuno#,  
                      #ptin_insdnm#,  
                      #ptin_insdrrgstno1#,    
                      #ptin_insdrrgstno2#,    
                      #ptin_insdrela#,    
                      #sessuserid#,  
                      SYSTIMESTAMP,   
                      #sessuserid#,  
                      SYSTIMESTAMP
      )
      ]]>			
    </statement>
    
<!-- 보험정보  이력추가  -->    
    <statement id="insPtinPreHist"><![CDATA[    
        INSERT INTO pam.pmcmptin
                          (     pid
                          ,     insukind
                          ,     todd
                          ,     seqno
                          ,     instcd
                          ,     histstat
                          ,     fromdd
                          ,     insucd
                          ,     insuno
                          ,     insdnm
                          ,     insdrrgstno1
                          ,     insdrrgstno2
                          ,     insdrela
                          ,     fstrgstrid
                          ,     fstrgstdt
                          ,     lastupdtrid
                          ,     lastupdtdt
                          )
                SELECT  pid
                          ,     insukind
                          ,     SUBSTR(TO_CHAR(TO_DATE(  SUBSTR(#ptin_fromdd#,1,4)||'-'|| 
                                                         SUBSTR(#ptin_fromdd#,5,2)||'-'|| 
                                                         SUBSTR(#ptin_fromdd#,7,2),'YYYY-MM-DD')-1 , 'YYYYMMDD') ,1,8)
                          ,     CAST((SELECT    NVL(CAST(MAX(CAST(seqno AS INTEGER)) AS INTEGER),0)+1 
                                             FROM       pam.pmcmptin
                                             WHERE  pid             = #ptin_pid#
                                             AND            insukind        = #ptin_insukind#
                                             AND            instcd          = #sessinstcd#   
                                        ) AS INTEGER)  
                          ,     instcd
                          ,     histstat
                          ,     fromdd
                          ,     insucd
                          ,     insuno
                          ,     insdnm
                          ,     insdrrgstno1
                          ,     insdrrgstno2
                          ,     insdrela
                          ,     fstrgstrid
                          ,     SYSTIMESTAMP
                          ,     #sessuserid#
                          ,     SYSTIMESTAMP
                  FROM pam.pmcmptin
                 WHERE pid        =  #ptin_pid#
                   AND insukind   =  #ptin_insukind#
                   AND instcd     =  #sessinstcd#  
                   AND histstat   = 'Y'     
                   AND #ptin_fromdd# BETWEEN fromdd AND todd
           ]]>
    </statement> 

<!-- 보험정보  존재여부 체크  -->    
    <statement id="getPtinHist"><![CDATA[    
        SELECT  'Y'
           FROM pam.pmcmptin
         WHERE  pid         = #ptin_pid#
              AND   insukind    = #ptin_insukind#
              AND   #ptin_fromdd#   BETWEEN fromdd  AND todd
              AND   instcd      = #sessinstcd#
              AND   histstat        = 'Y'
           ]]>
    </statement> 


   <!-- 환자기본정보 내역 조회--> 
   <statement id="getPatInfo"><![CDATA[    
        SELECT  a.pid               AS  pid
                    ,   a.instcd            AS  instcd
                    ,   a.hngnm             AS  hngnm
                    ,   a.engnm             AS  engnm
                    ,   a.chinm             AS  chinm
                    ,   a.rrgstno1      AS  rrgstno1
                    ,   a.rrgstno2      AS  rrgstno2
                    ,   a.brthdd            AS  brthdd  
                    ,   a.sex               AS  sex 
                    ,   com.fn_zz_getageas(a.rrgstno1,a.rrgstno2, SUBSTR(TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'), 1, 8),'B',a.brthdd) AS   age
                    ,   a.bindpid           AS  bindpid 
                    ,   a.hometel       AS  hometel 
                    ,   a.mpphontel     AS  mpphontel   
                    ,   a.etctel1           AS  etctel1 
                    ,   a.etctel2           AS  etctel2 
                    ,   a.smsaprvyn     AS  smsaprvyn   
                    ,   a.email             AS  email   
                    ,   a.zipcd1            AS  zipcd1  
                    ,   a.zipcd2            AS  zipcd2  
                    ,   a.zipcdseq      AS  zipcdseq
                    ,   b.city || ' ' || b.citycntyarea || ' ' || b.blok  AS    addr
                    ,   a.detladdr      AS  detladdr    
                    ,   a.btype             AS  btype   
                    ,   a.rh                    AS  rh  
                    ,   a.forgeryn      AS  forgeryn    
                    ,   a.nati              AS  nati    
                    ,   a.psptno            AS  psptno  
                    ,   a.recmyn            AS  recmyn  
                    ,   a.recmerid      AS  recmerid    
                    ,   a.recmerrela    AS  recmerrela
                    ,   a.vipyn             AS  vipyn   
                    ,   a.viprem            AS  viprem
                    ,   a.religncd      AS  religncd
                    ,   a.baptnm            AS  baptnm  
                    ,   a.chchnm        AS  chchnm  
                    ,   a.dethyn            AS  dethyn  
                    ,   a.dethdt            AS  dethdt  
                    ,   a.chosresn      AS  chosresn    
                    ,   a.animyn            AS  animyn  
                    ,   a.exptresncd    AS  exptresncd  
                    ,   a.inhospyn      AS  inhospyn    
                    ,   a.remfact           AS  remfact 
                    ,   a.fstrgstrid        AS  fstrgstrid  
                    ,   a.fstrgstdt         AS  fstrgstdt   
                    ,   a.lastupdtrid   AS  lastupdtrid 
                    ,   a.lastupdtdt        AS  lastupdtdt
                    ,   c.indd              AS    indd                  
            FROM    pam.pmcmptbs a   LEFT OUTER JOIN com.zbpmzpsn b  ON (a.zipcd1 = b.ZIPCDHEAD AND a.zipcd2 = b.zipcdfoot AND a.zipcdseq =  b.seqno)
                   ,pam.PMIHINPT c
             ]]>                                
                <isEqual property="srchcond" compare="1"><![CDATA[
                   WHERE   a.pid =  #pid#    ]]>
                </isEqual>
                <isEqual property="srchcond" compare="2"><![CDATA[
                   WHERE   a.hngnm = #hngnm#     ]]>
                </isEqual>
                <isEqual property="srchcond" compare="3"><![CDATA[
                   WHERE  a.rrgstno1 = #rrgstno1#   
                    AND      a.rrgstno2  = #rrgstno2# ]]>
                 </isEqual>  
                 <![CDATA[    
                    AND     a.instcd    = #sessinstcd#
                    ANd     c.PID = a.pid
                    AND     c.indschacptstat = 'A'
                    ANd     c.HISTSTAT = 'Y'                    
                ]]>
    </statement> 

   <!-- 상병 조회--> 
   <!-- 추후 공통으로 뺄 경우, genrflagcd 발생구분코드 :O,E,I  
        a.diagkindcdflag : 주진단,부진단
   -->
   <statement id="getPatDiag"><![CDATA[    
        SELECT  a.diagcd                AS diag_diagcd
               ,b.termhngnm             AS diag_diagcdnm
               ,a.orddd                 AS diag_orddd
               ,REPLACE(REPLACE(NVL(c.chrncsickyn,'N'),'','N'),' ','N')   AS diag_chrncsickyn --만성병여부
               ,c.estmexptyn            AS diag_estmexptyn --산정특례여부
               ,(select cdnm from com.zbcmcode where cdgrupid ='M0018' and cdid = a.diagkindcd and rownum = 1) as diag_kind
			   ,c.icd10cd               AS diag_icd10cd
            FROM emr.mmohdiag a
                ,emr.mrtmterm b
                ,emr.mrtddiagattr c
           WHERE a.pid       = #pid#
             AND a.instcd      = #instcd#
             AND a.genrflagcd = 'O'
             AND a.diaghistcd = 'O'
             AND a.diagtypecd = 'D'
             AND a.diagkindcdflag = 'M'              
             AND a.diagcd = b.termcd
             AND b.termflag   = '0'    
             AND a.diagdd BETWEEN b.termfromdd AND b.termtodd
             AND c.diagattrcd = b.attrcd
             AND a.diagdd BETWEEN c.diagattrfromdd AND c.diagattrtodd
              ]]>
            <isNotEqual property="mjyn" compare="y"><![CDATA[            
                    AND a.orddd  = #orddd#
                    AND a.cretno = #cretno#
             ]]>
            </isNotEqual>
            <isEqual property="mjyn" compare="y"><![CDATA[
                 AND (a.pid , a.orddd , a.cretno ) in  (select e.pid , e.orddd , e.cretno
                                                                     from emr.mmodexop e
                                                                   where e.instcd      = #instcd#
                                                                      and e.pid          = #pid#
                                                                      and e.actorddd   = #orddd#
                                                                      and e.actcretno  = #cretno#
                                                                      and rownum       = 1)
               ]]>
            </isEqual> 
    </statement> 

 <!-- 외래수납내역 조회(외래정산:외래등록키 조건) --> 
 <!-- TRPAO00207 -->
   <statement id="getopmiList3"><![CDATA[    
        SELECT  a.pid                                                                               AS  opmi_pid                
                    ,   b.hngnm                                                                     AS  opmi_hngnm
                    ,   a.rcptdd                                                                        AS  opmi_rcptdd             
                    ,   a.rcptno                                                                        AS  opmi_rcptno             
                    ,   a.rcptseqno                                                                 AS  opmi_rcptseqno          
                    ,   a.instcd                                                                        AS  opmi_instcd             
                    ,   a.rcptstat                                                                      AS  opmi_rcptstat           
                    ,   a.uncorcptflag                                                              AS  opmi_uncorcptflag       
                    ,   a.orddd                                                                     AS  opmi_orddd              
                    ,   a.cretno                                                                        AS  opmi_cretno             
                    ,   a.acptseqno                                                                 AS  opmi_acptseqno          
                    ,   a.orddeptcd                                                                 AS  opmi_orddeptcd          
                    ,   a.orddrid                                                                       AS  opmi_orddrid            
                    ,   a.ordtype                                                                       AS  opmi_ordtype            
                    ,   a.mskind                                                                        AS  opmi_mskind             
                    ,   a.insukind                                                                  AS  opmi_insukind           
                    ,   a.suppkind                                                                  AS  opmi_suppkind           
                    ,   a.insucd                                                                        AS  opmi_insucd   
                    ,   a.payamt + a.allownbamt + a.nopyamt + a.specamt     AS  opmi_totamt
                    ,   a.payamt                                                                        AS  opmi_payamt 
                    ,   a.allownbamt + a.nopyamt                                            AS  opmi_totnopyamt            
                    ,   a.allownbamt                                                                AS  opmi_allownbamt         
                    ,   a.nopyamt                                                                   AS  opmi_nopyamt            
                    ,   a.payownbamt - a.payinsurestamt                                                               AS  opmi_payownbamt         
                    ,   a.payinsubamt + a.payinsurestamt                                                              AS  opmi_payinsubamt    
                    ,   a.nopyownbamt                                                           AS  opmi_nopyownbamt            
                    ,   a.nopyinsubamt                                                          AS  opmi_nopyinsubamt   
                    ,   a.allownownbamt                                                         AS  opmi_allownownbamt          
                    ,   a.allowninsubamt                                                            AS  opmi_allowninsubamt 
                    ,   a.nopyownbamt+allownownbamt                                 AS    opmi_totnopyownbamt
                    ,   a.nopyinsubamt+allowninsubamt                                   AS  opmi_totnopyinsubamt
                    ,   a.specownbamt                                                           AS  opmi_specownbamt            
                    ,   a.specinsubamt                                                          AS  opmi_specinsubamt   
                    ,   a.handcapfund                                                               AS  opmi_handcapfund     
                    ,   a.procsubtamt + a.ersubtamt                                     AS  opmi_subtamt   
                    ,   a.procsubtamt                                                               AS  opmi_procsubtamt        
                    ,   a.ersubtamt                                                                 AS  opmi_ersubtamt          
                    ,   a.specamt                                                                   AS  opmi_specamt     
                    ,   a.discamt + a.reduamt                                                   AS  opmi_discreduamt       
                    ,   a.discamt                                                                       AS  opmi_discamt            
                    ,   a.reduamt                                                                       AS  opmi_reduamt            
                    ,   a.bloddiscamt                                                               AS  opmi_bloddiscamt        
                    ,   a.totownbamt - a.payinsurestamt                                                               AS  opmi_totownbamt         
                    ,   a.premdlrcptamt                                                         AS  opmi_premdlrcptamt      
                    ,   a.precardamt                                                                AS  opmi_precardamt         
                    ,   a.precashamt                                                                AS  opmi_precashamt         
                    ,   a.preonlineamt                                                              AS  opmi_preonlineamt   
                    ,   a.premdlrcptamt + a.precardamt + a.precashamt+ a.preonlineamt       
                                                                                                            AS  opmi_totpreamt
                    ,   a.mdlrcptamt                                                                AS  opmi_mdlrcptamt         
                    ,   a.uncoamt                                                                   AS  opmi_uncoamt            
                    ,   a.cardamt + a.cashamt + a.onlineamt                         AS  opmi_rcptexptamt
                    ,   a.cardamt                                                                       AS  opmi_cardamt            
                    ,   a.cashamt                                                                   AS  opmi_cashamt            
                    ,   a.onlineamt                                                                 AS  opmi_onlineamt          
                    ,   a.restamt                                                                       AS  opmi_restamt            
                    ,   a.hosindrugno                                                               AS  opmi_hosindrugno        
                    ,   a.hosoutdrugno                                                          AS  opmi_hosoutdrugno       
                    ,   a.calcmthdflag                                                              AS  opmi_calcmthdflag       
                    ,   a.remfact                                                                       AS  opmi_remfact            
                    ,   a.paypsnflag                                                                AS  opmi_paypsnflag         
                    ,   a.paydepoamt                                                                AS  opmi_paydepoamt         
                    ,   a.paypsnrem                                                             AS  opmi_paypsnrem          
                    ,   a.orgrcptdd                                                                 AS  opmi_orgrcptdd          
                    ,   a.orgrcptno                                                                 AS  opmi_orgrcptno          
                    ,   a.orgrcptseqno                                                              AS  opmi_orgrcptseqno       
                    ,   a.rcptexecdd                                                                AS  opmi_rcptexecdd         
                    ,   a.rcpttm                                                                        AS  opmi_rcpttm             
                    ,   a.rcptrid                                                                       AS  opmi_rcptrid            
                    ,   a.fstrgstrid                                                                    AS  opmi_fstrgstrid         
                    ,   a.fstrgstdt                                                                     AS  opmi_fstrgstdt          
                    ,   a.lastupdtrid                                                                   AS  opmi_lastupdtrid        
                    ,   a.lastupdtdt                                                                    AS  opmi_lastupdtdt
                    ,   c.cardno                                                                        AS      opmi_cardno
                    ,   s.qualcnfmno                                                                AS  opmi_qualcnfmno 
                    ,   o.acntno                                                                        AS  opmi_acntno
                    ,   d.depthngnm                                                             AS  opmi_orddeptcdnm
                    ,   d.deptengabbr                                                               AS  opmi_deptengabbr
                    ,   u.usernm                                                                        AS  opmi_orddridnm
                    ,   i.outpayownbrate                                                            AS  opmi_outpayownbrate
                    ,   u2.usernm                                                                   AS  opmi_rcptridnm
                    ,   a.heallifeamtclamamt                                                    AS  opmi_heallifeamtclamamt
										,   a.pregdmndamt                                                           AS   opmi_pregdmndamt
                    ,   a.suppamt                                                               AS  opmi_suppamt
										,   a.refundyn                                                              AS   opmi_refundyn
										,   a.prepregdmndamt                                                           AS   opmi_prepregdmndamt
										,   a.centcd																			AS   opmi_centcd
										,   a.subdeptcd																	AS   opmi_subdeptcd
										,   a.coopteamcd																	AS   opmi_coopteamcd
										,	  a.payinsurestamt																	AS   opmi_payinsurestamt
										,   a.taxamt																					AS   opmi_taxamt
            FROM    pam.paohopmi    a
                        LEFT OUTER JOIN pam.PAMHCARD c on (a.PID = c.pid AND a.rcptdd = c.rcptdd AND a.RCPTNO = c.rcptno AND a.RCPTSEQNO = c.rcptseqno AND a.instcd = c.instcd)
                        LEFT OUTER JOIN pam.PACHCASH s on (a.PID = s.pid AND a.rcptdd = s.rcptdd AND a.RCPTNO = s.rcptno AND a.RCPTSEQNO = s.rcptseqno AND a.instcd = s.instcd)
                        LEFT OUTER JOIN pam.PACHONLN o on (a.PID = o.pid AND a.rcptdd = o.rcptdd AND a.RCPTNO = o.rcptno AND a.RCPTSEQNO = o.rcptseqno ANd a.instcd = o.instcd)
                        LEFT OUTER JOIN com.zsdddept d on (a.orddeptcd = d.deptcd AND d.orduseyn='Y' AND 
                                                                                    SUBSTR(TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'), 1, 8) BETWEEN d.valifromdd AND d.valitodd AND a.instcd = d.instcd)
                        LEFT OUTER JOIN com.zsumusrb u on (a.orddrid = u.userid AND 
                                                                                    SUBSTR(TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'), 1, 8) BETWEEN u.userfromdd AND u.usertodd AND a.instcd = u.dutinstcd)
                        LEFT OUTER JOIN com.zsumusrb u2 on (a.rcptrid = u2.userid AND 
                                                                                    SUBSTR(TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'), 1, 8) BETWEEN u2.userfromdd AND u2.usertodd AND a.instcd = u2.dutinstcd)                                                               
                    ,   pam.pmcmptbs    b
                    ,   pam.pmbminsu     i
          WHERE a.instcd        = #sessinstcd#
               AND  a.pid       = #pid#
               AND  a.orddd     = #orddd#
               AND  a.cretno    = #cretno#
               ]]> 
               <isNotEmpty property="orddeptcd">
               AND  a.orddeptcd =   #orddeptcd#
               </isNotEmpty> 
               <isNotEmpty property="orddrid">
               AND  a.orddrid   =   #orddrid#
               </isNotEmpty> 
               <![CDATA[    
               AND  b.pid       = a.pid     
               AND  a.instcd    = b.instcd
               AND  a.instcd    = i.instcd
               AND  i.insukind  = a.insukind               
               AND  i.suppkind  = a.suppkind
               AND  i.histstat  ='Y'
               AND  a.orddd     BETWEEN i.fromdd AND i.todd
          ORDER BY  a.fstrgstdt DESC
             ]]> 
    </statement> 


   <!-- 외래등록내역 조회(수납내역조건으로) --> 
   <!-- TRPAO00202 -->
   <statement id="getOtptInfo"><![CDATA[    
           SELECT     
                 pid                  AS otpt_pid              
                ,orddd                AS otpt_orddd            
                ,cretno               AS otpt_cretno           
                ,acptseqno            AS otpt_acptseqno        
                ,instcd               AS otpt_instcd           
                ,histstat             AS otpt_histstat         
                ,orgorddd             AS otpt_orgorddd         
                ,orgcretno            AS otpt_orgcretno        
                ,calcbaseflag         AS otpt_calcbaseflag     
                ,calcyn               AS otpt_calcyn           
                ,ordtm                AS otpt_ordtm            
                ,orddeptcd            AS otpt_orddeptcd        
                ,orddrid              AS otpt_orddrid          
                ,dutdeptcd            AS otpt_dutdeptcd        
                ,centcd               AS otpt_centcd           
                ,supdeptcd            AS otpt_supdeptcd        
                ,mskind               AS otpt_mskind           
                ,insukind             AS otpt_insukind         
                ,suppkind             AS otpt_suppkind         
                ,insucd               AS otpt_insucd           
                ,suppkindresn         AS otpt_suppkindresn     
                ,specordyn            AS otpt_specordyn        
                ,holiflag             AS otpt_holiflag         
                ,fsexamflag           AS otpt_fsexamflag       
                ,fsexammanlyn         AS otpt_fsexammanlyn     
                ,ordtype              AS otpt_ordtype          
                ,brateflag            AS otpt_brateflag        
                ,medamtestmyn         AS otpt_medamtestmyn     
                ,medamtpostyn         AS otpt_medamtpostyn     
                ,medamtfreeresn       AS otpt_medamtfreeresn   
                ,rsrvflag             AS otpt_rsrvflag         
                ,etcordflag           AS otpt_etcordflag       
                ,disccd               AS otpt_disccd           
                ,hosoutexptresncd     AS otpt_hosoutexptresncd 
                ,clincstdyacptflag    AS otpt_clincstdyacptflag
                ,clincstdyno          AS otpt_clincstdyno      
                ,chrtlendyn           AS otpt_chrtlendyn       
                ,specorddescyn        AS otpt_specorddescyn    
                ,ordreqdescyn         AS otpt_ordreqdescyn     
                ,ordreqhospgrde       AS otpt_ordreqhospgrde   
                ,insuchrgyn           AS otpt_insuchrgyn       
                ,nursacptyn           AS otpt_nursacptyn       
                ,nursacptdt           AS otpt_nursacptdt       
                ,dracptyn             AS otpt_dracptyn         
                ,dracptdt             AS otpt_dracptdt         
                ,prcpgenryn           AS otpt_prcpgenryn       
                ,prcpnotoccrresn      AS otpt_prcpnotoccrresn  
                ,estmspclappyn        AS otpt_estmspclappyn    
                ,elbulbodstat         AS otpt_elbulbodstat     
                ,elbulbodstatdt       AS otpt_elbulbodstatdt   
                ,calcflag             AS otpt_calcflag         
                ,calcmthdflag         AS otpt_calcmthdflag     
                ,dnoracptyn           AS otpt_dnoracptyn       
                ,rqstflag             AS otpt_rqstflag         
                ,rqsthospcd           AS otpt_rqsthospcd       
                ,rqstdrid             AS otpt_rqstdrid            
                ,tdayinflag           AS otpt_tdayinflag       
                ,tranindd             AS otpt_tranindd         
                ,rcptdd               AS otpt_rcptdd           
                ,rcptno               AS otpt_rcptno           
                ,rcptseqno            AS otpt_rcptseqno        
                ,telrsrvrem           AS otpt_telrsrvrem          
                ,updtcnclresn         AS otpt_updtcnclresn     
                ,fstacptid            AS otpt_fstacptid        
                ,fstacptdt            AS otpt_fstacptdt        
                ,fstrgstrid           AS otpt_fstrgstrid       
                ,fstrgstdt            AS otpt_fstrgstdt        
                ,lastupdtrid          AS otpt_lastupdtrid      
                ,lastupdtdt           AS otpt_lastupdtdt       
                ,rareobstflag         AS otpt_rareobstflag     
                ,tranflag             AS otpt_tranflag 
				,holdflag             AS otpt_holdflag
				,subdeptcd            AS otpt_subdeptcd
            FROM pam.pmohotpt
           WHERE pid                =   #opmi_pid#       
          ]]> 
               <isNotEmpty property="opmi_rcptdd"><![CDATA[    
               AND  rcptdd          =   #opmi_rcptdd#
               ]]>
               </isNotEmpty> 
               <isNotEmpty property="opmi_rcptno"><![CDATA[    
               AND  rcptno          =  #opmi_rcptno#
               ]]>
               </isNotEmpty>       
              <![CDATA[    
               AND  orddd           =   #opmi_orddd#
               AND  cretno          =   #opmi_cretno#
               AND  instcd          =   #sessinstcd#
               AND  ordtype         = 'O'
             ]]> 
    </statement> 
    

    <!-- 계산내역에 대한 수익정보 조회 -->
   <statement id="getEarnInfo2"><![CDATA[    
          SELECT    c.cdid                                  AS  earn_rcptcls
                   ,c.cdnm                                  AS  earn_rcptclsnm
                   ,NVL(SUM(a.payamt),0)                    AS  earn_payamt
                   ,NVL(SUM(a.nopyamt+a.allownbamt),0)      AS  earn_nopyamt
                   ,NVL(SUM(a.specamt),0)                   AS  earn_specamt
            FROM   (      SELECT a.payamt
                                ,a.nopyamt
                                ,a.allownbamt
                                ,a.specamt
                                ,a.snglearncls
                                ,b.earncls
                                ,b.earnclsstat
                                ,b.outcls
                            FROM pam.paohoscl a 
                                ,pam.pasmictp b   
                           WHERE a.pid         = #pid#
                             AND a.orddd       = #orddd#
                             AND a.cretno      = #cretno#
                             AND a.calcstat    = #calcstat#
                             AND a.instcd      = #sessinstcd#
                             AND b.earncls     = a.grupearncls
                             AND b.earnclsstat = '0'
                             AND b.instcd      = a.instcd
                        ) a RIGHT OUTER JOIN  
                        (SELECT cdid, cdnm 
                           FROM com.zbcmcode 
                          WHERE cdgrupid    =   'P0347'
                        ) c  ON (a.outcls = c.cdid)
        GROUP BY c.cdid, c.cdnm
        ORDER BY c.cdid
              ]]>
    </statement> 
    
    
    <!-- 이동재20080115 부분수납에서 수익정보 조회 -->
   <statement id="getEarnInfo3"><![CDATA[    
         SELECT   c.cdid                                  AS earn_rcptcls
                 ,c.cdnm                                  AS earn_rcptclsnm
                 ,NVL(SUM(a.payamt),0)                    AS earn_payamt
                 ,NVL(SUM(a.nopyamt+a.allownbamt),0)      AS earn_nopyamt
                 ,NVL(SUM(a.specamt),0)                   AS earn_specamt
           FROM    (SELECT a.payamt
                          ,a.nopyamt
                          ,a.allownbamt
                          ,a.specamt
                          ,a.snglearncls
                          ,b.earncls
                          ,b.earnclsstat
                          ,b.outcls
                     FROM pam.paohoscl a 
                         ,pam.pasmictp b  
                    WHERE a.pid          = #pid#
                      AND a.orddd        = #orddd#
                      AND a.cretno       = #cretno#
                      AND a.calcstat     = #calcstat#
                      AND a.instcd       = #sessinstcd#
                      AND b.earncls      = a.snglearncls
                      AND b.earnclsstat  = '0'
                    ) a LEFT OUTER JOIN (SELECT cdid, cdnm FROM com.zbcmcode WHERE cdgrupid = 'P0347') c ON (a.outcls = c.cdid)
        GROUP BY c.cdid, c.cdnm
        ORDER BY c.cdid
    ]]>
    </statement>     

    <!-- 계산내역에 대한 수익정보 SUM 조회 -->
   <statement id="getEarnInfo4"><![CDATA[    
          SELECT    c.cdid                                  AS  earn_rcptcls
                   ,c.cdnm                                  AS  earn_rcptclsnm
                   ,NVL(SUM(a.payamt),0)                    AS  earn_payamt
                   ,NVL(SUM(a.nopyamt+a.allownbamt),0)      AS  earn_nopyamt
                   ,NVL(SUM(a.specamt),0)                   AS  earn_specamt
            FROM   (      SELECT /*+ index (a PK_PAOHOSCL ) */ a.payamt
                                ,a.nopyamt
                                ,a.allownbamt
                                ,a.specamt
                                ,a.snglearncls
                                ,b.earncls
                                ,b.earnclsstat
                                ,b.outcls
                            FROM pam.paohoscl a 
                                ,pam.pasmictp b   
                           WHERE a.pid         = #pid#
                             AND a.orddd || a.cretno || a.calcstat in ('$otptkey$')  
                             AND a.instcd      = #sessinstcd#
                             AND b.earncls     = a.snglearncls
                             AND b.earnclsstat = '0'
                             AND b.instcd      = a.instcd
                        ) a RIGHT OUTER JOIN  
                        (SELECT cdid, cdnm 
                           FROM com.zbcmcode 
                          WHERE cdgrupid    =   'P0347'
                        ) c  ON (a.outcls = c.cdid)
        GROUP BY c.cdid, c.cdnm
        ORDER BY c.cdid
    ]]>
    </statement> 
    
    <!-- 계산내역 수익구분별로 합계금액 구할때 접수키별로 조회 후 합하도록 변경 -->
    <statement id="getEarnInfo4New"><![CDATA[    
          SELECT    c.cdid                                  AS  earn_rcptcls
                   ,c.cdnm                                  AS  earn_rcptclsnm
                   ,NVL(SUM(a.payamt),0)                    AS  earn_payamt
                   ,NVL(SUM(a.nopyamt+a.allownbamt),0)      AS  earn_nopyamt
                   ,NVL(SUM(a.specamt),0)                   AS  earn_specamt
            FROM   (      SELECT /*+ index (a PK_PAOHOSCL ) */ a.payamt
                                ,a.nopyamt
                                ,a.allownbamt
                                ,a.specamt
                                ,a.snglearncls
                                ,b.earncls
                                ,b.earnclsstat
                                ,b.outcls
                            FROM pam.paohoscl a 
                                ,pam.pasmictp b   
                           WHERE a.pid(+)      = #pid#
                             AND a.orddd(+)    = #orddd#
                             AND a.cretno(+)   = #cretno#
                             AND a.calcstat(+) = #calcstat#
                             AND a.instcd(+)   = b.instcd
                             AND b.earncls     = a.snglearncls(+)
                             AND b.earnclsstat = '0'
                             AND b.instcd      = #sessinstcd#
                        ) a RIGHT OUTER JOIN  
                        (SELECT cdid, cdnm 
                           FROM com.zbcmcode 
                          WHERE cdgrupid       = 'P0347'
                        ) c  ON (a.outcls = c.cdid)
        GROUP BY c.cdid, c.cdnm
        ORDER BY c.cdid
    ]]>
    </statement> 


<!-- 외래수납내역 DC 내역 생성 -->
   <statement id="insOutOrdAmtDC"><![CDATA[    
                INSERT INTO pam.paohopmi(
                            pid                   
                          , rcptdd                
                          , rcptno                
                          , rcptseqno             
                          , instcd                
                          , rcptstat              
                          , uncorcptflag          
                          , orddd                 
                          , cretno                
                          , acptseqno             
                          , orddeptcd             
                          , orddrid               
                          , ordtype               
                          , mskind                
                          , insukind              
                          , suppkind              
                          , insucd                            
                          , payamt                
                          , allownbamt            
                          , nopyamt               
                          , payownbamt            
                          , payinsubamt           
                          , handcapfund           
                          , procsubtamt           
                          , ersubtamt             
                          , specamt               
                          , discamt               
                          , reduamt               
                          , bloddiscamt           
                          , totownbamt            
                          , premdlrcptamt         
                          , precardamt            
                          , precashamt            
                          , preonlineamt          
                          , mdlrcptamt            
                          , uncoamt               
                          , cardamt               
                          , cashamt               
                          , onlineamt             
                          , restamt               
                          , hosindrugno           
                          , hosoutdrugno          
                          , calcmthdflag          
                          , remfact               
                          , paypsnflag            
                          , paydepoamt            
                          , paypsnrem             
                          , orgrcptdd             
                          , orgrcptno             
                          , orgrcptseqno          
                          , rcptexecdd            
                          , rcpttm                
                          , rcptrid               
                          , nopyinsubamt          
                          , nopyownbamt           
                          , allowninsubamt        
                          , allownownbamt         
                          , specinsubamt          
                          , specownbamt           
                          , heallifeamtclamamt 
						  						, pregdmndamt
                          , suppamt               
                          , tranflag              
                          , fstrgstrid            
                          , fstrgstdt             
                          , lastupdtrid           
                          , lastupdtdt
                          , ktrmnno
												  , refundyn
												  , prepregdmndamt
												  , centcd
												  , subdeptcd
												  , coopteamcd
												  , payinsurestamt
												  , taxamt
                         )  
                   SELECT   pid                                             AS pid                       
                           ,rcptdd                                          AS rcptdd                    
                           ,rcptno                                          AS rcptno                    
                           ,CAST(rcptseqno+100 AS NUMBER)                   AS rcptseqno                 
                           ,instcd                                          AS instcd                    
                           ,'D'                                             AS rcptstat                  
                           ,uncorcptflag                                    AS uncorcptflag              
                           ,orddd                                           AS orddd                     
                           ,cretno                                          AS cretno                    
                           ,acptseqno                                       AS acptseqno                 
                           ,orddeptcd                                       AS orddeptcd                 
                           ,orddrid                                         AS orddrid                   
                           ,ordtype                                         AS ordtype                   
                           ,mskind                                          AS mskind                    
                           ,insukind                                        AS insukind                  
                           ,suppkind                                        AS suppkind                  
                           ,insucd                                          AS insucd                    
                           ,CAST(payamt         * -1   AS NUMBER(10,0) )    AS payamt                    
                           ,CAST(allownbamt     * -1   AS NUMBER(10,0) )    AS allownbamt                
                           ,CAST(nopyamt        * -1   AS NUMBER(10,0) )    AS nopyamt                   
                           ,CAST(payownbamt     * -1   AS NUMBER(10,0) )    AS payownbamt                
                           ,CAST(payinsubamt    * -1   AS NUMBER(10,0) )    AS payinsubamt               
                           ,CAST(handcapfund    * -1   AS NUMBER(10,0) )    AS handcapfund               
                           ,CAST(procsubtamt    * -1   AS NUMBER(10,0) )    AS procsubtamt               
                           ,CAST(ersubtamt      * -1   AS NUMBER(10,0) )    AS ersubtamt                 
                           ,CAST(specamt        * -1   AS NUMBER(10,0) )    AS specamt
						   ,CAST(discamt        * -1   AS NUMBER(10,0) )    AS discamt    
                        ]]>
                        <isEqual property="otpt_histstat" compare="R"><![CDATA[
                           ,CAST(reduamt        * -1   AS NUMBER(10,0) )    AS reduamt                  
                           ,CAST(bloddiscamt    * -1   AS NUMBER(10,0) )    AS bloddiscamt              
                           ,CAST(totownbamt     * -1   AS NUMBER(10,0) )    AS totownbamt               
                           ,CAST(premdlrcptamt  * -1   AS NUMBER(10,0) )    AS premdlrcptamt            
                           ,CAST(precardamt     * -1   AS NUMBER(10,0) )    AS precardamt               
                           ,CAST(precashamt     * -1   AS NUMBER(10,0) )    AS precashamt               
                           ,CAST(preonlineamt   * -1   AS NUMBER(10,0) )    AS preonlineamt             
                           ,CAST(mdlrcptamt     * -1   AS NUMBER(10,0) )    AS mdlrcptamt               
                           ,CAST(uncoamt        * -1   AS NUMBER(10,0) )    AS uncoamt                  
                           ,CAST(cardamt        * -1   AS NUMBER(10,0) )    AS cardamt                  
                           ,CAST(cashamt        * -1   AS NUMBER(10,0) )    AS cashamt                  
                           ,CAST(onlineamt      * -1   AS NUMBER(10,0) )    AS onlineamt
                        ]]>
                        </isEqual>
                        <isEqual property="otpt_histstat" compare="X"><![CDATA[
                           ,CAST(reduamt        * -1   AS NUMBER(10,0) )    AS reduamt
                           ,CAST(bloddiscamt    * -1   AS NUMBER(10,0) )    AS bloddiscamt
                           ,CAST(totownbamt * -1   AS NUMBER(10,0) )        AS totownbamt
                           ,0                                               AS premdlrcptamt
                           ,0                                               AS precardamt
                           ,0                                               AS precashamt
                           ,0                                               AS preonlineamt
                           ,#opmi_mdlrcptamt#                               AS mdlrcptamt
                           ,CAST(uncoamt        * -1   AS NUMBER(10,0) )    AS uncoamt
                           ,DECODE(a.uncorcptflag,'2',cardamt * -1,'3',cardamt * -1,'4',cardamt * -1,
                                                                     #opmi_cardamt# + (select nvl(sum(b.cardamt),0)
                                                                                        from pam.paohopmi b
                                                                                       where b.pid = a.pid
                                                                                         and b.orddd = a.orddd
                                                                                         and b.cretno = a.cretno
                                                                                         and b.rcptstat ='Y'
                                                                                         and b.uncorcptflag = '2')) as cardamt

                           ,DECODE(a.uncorcptflag,'2',cashamt * -1,'3',cashamt * -1,'4',cashamt * -1,
                                                                    #opmi_cashamt# + (select nvl(sum(b.cashamt),0)
                                                                                        from pam.paohopmi b
                                                                                       where b.pid = a.pid
                                                                                         and b.orddd = a.orddd
                                                                                         and b.cretno = a.cretno
                                                                                         and b.rcptstat ='Y'
                                                                                         and b.uncorcptflag = '2') ) as cashamt

                           ,DECODE(a.uncorcptflag,'2',onlineamt * -1,'3',onlineamt * -1,'4',onlineamt * -1,
                                                                  #opmi_onlineamt# + (select nvl(sum(b.onlineamt),0)
                                                                                        from pam.paohopmi b
                                                                                       where b.pid = a.pid
                                                                                         and b.orddd = a.orddd
                                                                                         and b.cretno = a.cretno
                                                                                         and b.rcptstat ='Y'
                                                                                         and b.uncorcptflag = '2') ) as onlineamt
                        ]]>
                        </isEqual><![CDATA[
						   ,CAST(restamt        * -1   AS NUMBER(10,0) )    AS restamt     
                           ,hosindrugno                                     AS hosindrugno         
                           ,hosoutdrugno                                    AS hosoutdrugno        
                           ,calcmthdflag                                    AS calcmthdflag        
                           ,remfact                                         AS remfact             
                           ,paypsnflag                                      AS paypsnflag          
                           ,CAST(paydepoamt     * -1   AS NUMBER(10,0) )    AS paydepoamt          
                           ,paypsnrem                                       AS paypsnrem           
                           ,orgrcptdd                                       AS orgrcptdd           
                           ,orgrcptno                                       AS orgrcptno           
                           ,orgrcptseqno                                    AS orgrcptseqno        
                           ,CAST(#opmi_rcptexecdd# AS VARCHAR2(8))          AS rcptexecdd          
                           ,CAST(#opmi_rcpttm#     AS VARCHAR2(6))          AS rcpttm              
                           ,CAST(#opmi_rcptrid#    AS VARCHAR2(10))         AS rcptrid             
                           ,CAST(nopyinsubamt       * -1 AS NUMBER(10,0) )  AS nopyinsubamt        
                           ,CAST(nopyownbamt        * -1 AS NUMBER(10,0) )  AS nopyownbamt         
                           ,CAST(allowninsubamt     * -1 AS NUMBER(10,0) )  AS allowninsubamt      
                           ,CAST(allownownbamt      * -1 AS NUMBER(10,0) )  AS allownownbamt       
                           ,CAST(specinsubamt       * -1 AS NUMBER(10,0) )  AS specinsubamt        
                           ,CAST(specownbamt        * -1 AS NUMBER(10,0) )  AS specownbamt         
                           ,CAST(heallifeamtclamamt * -1 AS NUMBER(10,0) )  AS heallifeamtclamamt
						   ,CAST(pregdmndamt        * -1 AS NUMBER(10,0) )  AS pregdmndamt 
                           ,CAST(suppamt            * -1 AS NUMBER(10,0) )  AS suppamt             
                           ,tranflag                                        AS tranflag          
                           ,CAST(#sessuserid# AS VARCHAR2(10))              AS fstrgstrid          
                           ,SYSTIMESTAMP                                    AS fstrgstdt           
                           ,CAST(#sessuserid# AS VARCHAR2(10))              AS lastupdtrid         
                           ,SYSTIMESTAMP                                    AS lastupdtdt          
                           ,ktrmnno                                         AS ktrmnno
                           ,#opmi_refundyn#                                 AS refundyn
						   ,CAST(prepregdmndamt        * -1 AS NUMBER(10,0) )  AS prepregdmndamt 
						  , centcd
						  , subdeptcd
						  , coopteamcd
						  ,CAST(payinsurestamt        * -1 AS NUMBER(10,0) )  AS payinsurestamt 
						  ,CAST(taxamt        				* -1 AS NUMBER(10,0) )  AS taxamt
                      FROM pam.paohopmi a
                     WHERE pid       = #opmi_pid#                    
                       AND orddd     = #opmi_orddd#
                       AND cretno    = #opmi_cretno#
                       AND rcptstat  = 'Y'
                       AND instcd    = #sessinstcd#
           ]]>
    </statement> 

   <!-- 외래 계산내역  DC 내역 생성 -->
   <statement id="insOSCLDC"><![CDATA[    
                 INSERT INTO pam.paohoscl(
                         instcd
                        ,pid
                        ,orddd
                        ,cretno
                        ,calcseqno
                        ,calcscorseqno
                        ,calcstat
                        ,clamtrgtstat
                        ,acptseqno
                        ,orddeptcd
                        ,orddrid
                        ,mskind
                        ,ordtype
                        ,grupcalcscorcd
                        ,snglcalcscorcd
                        ,grupcalcscorcls
                        ,snglcalcscorcls
                        ,grupearncls
                        ,snglearncls
                        ,ordqty
                        ,ordtims
                        ,orddays
                        ,calcqty
                        ,calctims
                        ,calcdays
                        ,matractflag
                        ,calcpayflag
                        ,prcppayflag
                        ,calcscorpayflag
                        ,freeflag
                        ,opflag
                        ,ansttm
                        ,spccd
                        ,pntunitcost
                        ,calcscorpnt
                        ,estmpnt
                        ,appunitcost
                        ,estmamt
                        ,calcamt
                        ,hospaddamt
                        ,specamt
                        ,payamt
                        ,allownbamt
                        ,nopyamt
                        ,payownbrate
                        ,payinsubamt
                        ,payownbamt
                        ,paydiscamt
                        ,nopydiscamt
                        ,specdiscamt
                        ,hosoutexptresncd
                        ,hosoutdrugno
                        ,specordyn
                        ,execdeptcd
                        ,execdd
                        ,exectm
                        ,execrid
                        ,pamexecdd
                        ,earnenddd
                        ,actcnclresn
                        ,clamspclcd
                        ,clamkey
                        ,clamcretdd
                        ,clamcretyn
                        ,estmcls
                        ,estmmeancd
                        ,estmcd
                        ,readdrid
                        ,clincstdyno
                        ,exitprvntdrugyn
                        ,exitprvntdrugamt
                        ,trustaddrate
                        ,bothaddyn
                        ,prcpdd
                        ,prcpno
                        ,prcphistno
                        ,execprcpseqno
                        ,cnfmcd
                        ,cpflag
                        ,prnprcpflag
                        ,portprcpflag
                        ,anamneflag
                        ,spcljudgyn
                        ,judgflag
                        ,cvrtinprcpdeptcd
                        ,cvrtinprcpdrid
                        ,rcptdd
                        ,rcptno
                        ,rcptseqno
                        ,rcptexecdd
                        ,rcpttm
                        ,judgadjtresncd
                        ,probordyn
                        ,nopyinsubamt
                        ,nopyownbamt
                        ,allowninsubamt
                        ,allownownbamt
                        ,specinsubamt
                        ,specownbamt
                        ,judgendflag
                        ,tootfact
                        ,drugmthdspccd
                        ,rgstdeptcd
                        ,rgstdd
                        ,rgsttm
                        ,rgstrid
                        ,insukind
                        ,suppkind
                        ,rsvordgubn
                        ,brateflag
                        ,ownbflag
                        ,tranflag
                        ,edicd
                        ,fstrgstrid
                        ,fstrgstdt
                        ,lastupdtrid
                        ,lastupdtdt
						,centcd
						,subdeptcd
						,coopteamcd
						,execprcpuniqno
                         )  
                SELECT                 
                         instcd                                    AS instcd                     
                        ,pid                                       AS pid                        
                        ,orddd                                     AS orddd                      
                        ,cretno                                    AS cretno                     
                        ,CAST(calcseqno+ 100 AS NUMBER)            AS calcseqno                  
                        ,calcscorseqno                             AS calcscorseqno              
                        ,'D'                                       AS calcstat                   
                        ,'D'                                       AS clamtrgtstat               
                        ,acptseqno                                 AS acptseqno                  
                        ,orddeptcd                                 AS orddeptcd                  
                        ,orddrid                                   AS orddrid                    
                        ,mskind                                    AS mskind                     
                        ,ordtype                                   AS ordtype                    
                        ,grupcalcscorcd                            AS grupcalcscorcd             
                        ,snglcalcscorcd                            AS snglcalcscorcd             
                        ,grupcalcscorcls                           AS grupcalcscorcls            
                        ,snglcalcscorcls                           AS snglcalcscorcls            
                        ,grupearncls                               AS grupearncls                
                        ,snglearncls                               AS snglearncls                
                        ,ordqty                                    AS ordqty                     
                        ,ordtims                                   AS ordtims                    
                        ,orddays                                   AS orddays                    
                        ,calcqty   * -1                            AS calcqty                    
                        ,calctims  * -1                            AS calctims                   
                        ,calcdays  * -1                            AS calcdays                   
                        ,matractflag                               AS matractflag                
                        ,calcpayflag                               AS calcpayflag                
                        ,prcppayflag                               AS prcppayflag                
                        ,calcscorpayflag                           AS calcscorpayflag            
                        ,freeflag                                  AS freeflag                   
                        ,opflag                                    AS opflag                     
                        ,ansttm                                    AS ansttm                     
                        ,spccd                                     AS spccd                      
                        ,pntunitcost                               AS pntunitcost                
                        ,calcscorpnt                               AS calcscorpnt                
                        ,estmpnt                                   AS estmpnt                    
                        ,appunitcost  * -1                         AS appunitcost                
                        ,estmamt      * -1                         AS estmamt                    
                        ,calcamt      * -1                         AS calcamt                    
                        ,hospaddamt   * -1                         AS hospaddamt                 
                        ,specamt      * -1                         AS specamt                    
                        ,payamt       * -1                         AS payamt                     
                        ,allownbamt   * -1                         AS allownbamt                 
                        ,nopyamt      * -1                         AS nopyamt                    
                        ,payownbrate  * -1                         AS payownbrate                
                        ,payinsubamt  * -1                         AS payinsubamt                
                        ,payownbamt   * -1                         AS payownbamt                 
                        ,paydiscamt   * -1                         AS paydiscamt                 
                        ,nopydiscamt  * -1                         AS nopydiscamt                
                        ,specdiscamt  * -1                         AS specdiscamt                
                        ,hosoutexptresncd                          AS hosoutexptresncd           
                        ,hosoutdrugno                              AS hosoutdrugno               
                        ,specordyn                                 AS specordyn                  
                        ,execdeptcd                                AS execdeptcd                 
                        ,execdd                                    AS execdd                     
                        ,exectm                                    AS exectm                     
                        ,execrid                                   AS execrid                    
                        ,pamexecdd                                 AS pamexecdd                  
                        ,(CASE WHEN earnenddd = '00000000' THEN earnenddd ELSE TO_CHAR(SYSDATE, 'YYYYMMDD') END)               AS earnenddd                  
                        ,actcnclresn                               AS actcnclresn                
                        ,clamspclcd                                AS clamspclcd                 
                        ,clamkey                                   AS clamkey                    
                        ,clamcretdd                                AS clamcretdd                 
                        ,clamcretyn                                AS clamcretyn                 
                        ,estmcls                                   AS estmcls                    
                        ,estmmeancd                                AS estmmeancd                 
                        ,estmcd                                    AS estmcd                     
                        ,readdrid                                  AS readdrid                   
                        ,clincstdyno                               AS clincstdyno                
                        ,exitprvntdrugyn                           AS exitprvntdrugyn            
                        ,exitprvntdrugamt                          AS exitprvntdrugamt           
                        ,trustaddrate                              AS trustaddrate               
                        ,bothaddyn                                 AS bothaddyn                  
                        ,prcpdd                                    AS prcpdd                     
                        ,prcpno                                    AS prcpno                     
                        ,prcphistno                                AS prcphistno                 
                        ,execprcpseqno                             AS execprcpseqno              
                        ,cnfmcd                                    AS cnfmcd                     
                        ,cpflag                                    AS cpflag                     
                        ,prnprcpflag                               AS prnprcpflag                
                        ,portprcpflag                              AS portprcpflag               
                        ,anamneflag                                AS anamneflag                 
                        ,spcljudgyn                                AS spcljudgyn                 
                        ,judgflag                                  AS judgflag                   
                        ,cvrtinprcpdeptcd                          AS cvrtinprcpdeptcd           
                        ,cvrtinprcpdrid                            AS cvrtinprcpdrid             
                        ,rcptdd                                    AS rcptdd                     
                        ,rcptno                                    AS rcptno                     
                        ,CAST(rcptseqno + 100 AS NUMBER)           AS rcptseqno                  
                        ,CAST(#opmi_rcptexecdd# AS VARCHAR2(8))    AS rcptexecdd                 
                        ,CAST(#opmi_rcpttm# AS VARCHAR2(6))        AS rcpttm                     
                        ,judgadjtresncd                            AS judgadjtresncd
                        ,probordyn                                 AS probordyn        
                        ,nopyinsubamt    * -1                      AS nopyinsubamt               
                        ,nopyownbamt     * -1                      AS nopyownbamt                
                        ,allowninsubamt  * -1                      AS allowninsubamt             
                        ,allownownbamt   * -1                      AS allownownbamt              
                        ,specinsubamt    * -1                      AS specinsubamt               
                        ,specownbamt     * -1                      AS specownbamt                
                        ,judgendflag                               AS judgendflag                
                        ,tootfact                                  AS tootfact                   
                        ,drugmthdspccd                             AS drugmthdspccd              
                        ,rgstdeptcd                                AS rgstdeptcd                 
                        ,rgstdd                                    AS rgstdd                     
                        ,rgsttm                                    AS rgsttm                     
                        ,rgstrid                                   AS rgstrid                    
                        ,insukind                                  AS insukind                   
                        ,suppkind                                  AS suppkind                   
                        ,rsvordgubn                                AS rsvordgubn                 
                        ,brateflag                                 AS brateflag                  
                        ,ownbflag                                  AS ownbflag         
                        ,tranflag                                  AS tranflag                   
                        ,edicd                                     AS edicd                      
                        ,fstrgstrid                                AS fstrgstrid                 
                        ,fstrgstdt                                 AS fstrgstdt                  
                        ,CAST(#sessuserid# AS VARCHAR2(10))        AS lastupdtrid                
                        ,SYSTIMESTAMP                              AS lastupdtdt
						,centcd
						,subdeptcd
						,coopteamcd
						,execprcpuniqno
                    FROM pam.paohoscl
                   WHERE pid       = #opmi_pid#                    
                     AND orddd     = #opmi_orddd#
                     AND cretno    = #opmi_cretno#
                     AND calcstat  = 'Y'
                     AND calcseqno < 100
                     AND instcd    = #sessinstcd#
           ]]>
    </statement> 

<!-- 기존 외래수납 [변경]상태로 세팅 -->
   <statement id="setOutOrdAmtC"><![CDATA[    
     UPDATE pam.paohopmi
        SET rcptstat     = 'C'
           ,lastupdtrid  = #sessuserid# 
           ,lastupdtdt   = SYSTIMESTAMP
      WHERE pid       = #opmi_pid#                    
        AND orddd     = #opmi_orddd#
        AND cretno    = #opmi_cretno#
        AND rcptstat  = 'Y'
        AND instcd    = #sessinstcd#
		--AND uncorcptflag not in ('3')
     ]]>
    </statement> 

<!-- 기존 외래계산 [변경]상태로 세팅 -->
   <statement id="setOSCLC"><![CDATA[    
            UPDATE pam.paohoscl
               SET calcstat     = 'C'
                  ,clamtrgtstat = 'C'
                  ,lastupdtrid  = #sessuserid#
                  ,lastupdtdt   = SYSTIMESTAMP
             WHERE pid        = #opmi_pid#                    
               AND orddd      = #opmi_orddd#
               AND cretno     = #opmi_cretno#
               AND calcstat   = 'Y'
               AND calcseqno  < 100
               AND instcd     = #sessinstcd#        
           ]]>
    </statement> 


  <!-- 외래등록내역 조회(수납내역조건으로) AND  acptseqno   =   #opmi_cretno#--> 
  <!--   TXPAO00102 -->
   <statement id="getOtptInfo2"><![CDATA[    
           SELECT   
                  pid                  AS otpt_pid                    
                 ,orddd                AS otpt_orddd                  
                 ,cretno               AS otpt_cretno                 
                 ,acptseqno            AS otpt_acptseqno              
                 ,instcd               AS otpt_instcd                 
                 ,histstat             AS otpt_histstat               
                 ,orgorddd             AS otpt_orgorddd               
                 ,orgcretno            AS otpt_orgcretno              
                 ,calcbaseflag         AS otpt_calcbaseflag           
                 ,calcyn               AS otpt_calcyn                 
                 ,ordtm                AS otpt_ordtm                  
                 ,orddeptcd            AS otpt_orddeptcd              
                 ,orddrid              AS otpt_orddrid                
                 ,dutdeptcd            AS otpt_dutdeptcd              
                 ,centcd               AS otpt_centcd                 
                 ,supdeptcd            AS otpt_supdeptcd              
                 ,mskind               AS otpt_mskind                 
                 ,insukind             AS otpt_insukind               
                 ,suppkind             AS otpt_suppkind               
                 ,insucd               AS otpt_insucd                 
                 ,suppkindresn         AS otpt_suppkindresn           
                 ,specordyn            AS otpt_specordyn              
                 ,holiflag             AS otpt_holiflag               
                 ,fsexamflag           AS otpt_fsexamflag             
                 ,fsexammanlyn         AS otpt_fsexammanlyn           
                 ,ordtype              AS otpt_ordtype                
                 ,brateflag            AS otpt_brateflag              
                 ,medamtestmyn         AS otpt_medamtestmyn           
                 ,medamtpostyn         AS otpt_medamtpostyn           
                 ,medamtfreeresn       AS otpt_medamtfreeresn         
                 ,rsrvflag             AS otpt_rsrvflag               
                 ,etcordflag           AS otpt_etcordflag             
                 ,disccd               AS otpt_disccd                 
                 ,hosoutexptresncd     AS otpt_hosoutexptresncd       
                 ,clincstdyacptflag    AS otpt_clincstdyacptflag      
                 ,clincstdyno          AS otpt_clincstdyno            
                 ,chrtlendyn           AS otpt_chrtlendyn             
                 ,specorddescyn        AS otpt_specorddescyn          
                 ,ordreqdescyn         AS otpt_ordreqdescyn           
                 ,ordreqhospgrde       AS otpt_ordreqhospgrde         
                 ,insuchrgyn           AS otpt_insuchrgyn             
                 ,nursacptyn           AS otpt_nursacptyn             
                 ,nursacptdt           AS otpt_nursacptdt             
                 ,dracptyn             AS otpt_dracptyn               
                 ,dracptdt             AS otpt_dracptdt               
                 ,prcpgenryn           AS otpt_prcpgenryn             
                 ,prcpnotoccrresn      AS otpt_prcpnotoccrresn        
                 ,estmspclappyn        AS otpt_estmspclappyn          
                 ,elbulbodstat         AS otpt_elbulbodstat           
                 ,elbulbodstatdt       AS otpt_elbulbodstatdt         
                 ,calcflag             AS otpt_calcflag               
                 ,calcmthdflag         AS otpt_calcmthdflag           
                 ,dnoracptyn           AS otpt_dnoracptyn             
                 ,rqstflag             AS otpt_rqstflag               
                 ,rqsthospcd           AS otpt_rqsthospcd             
                 ,rqstdrid             AS otpt_rqstdrid               
                 ,tdayinflag           AS otpt_tdayinflag             
                 ,tranindd             AS otpt_tranindd               
                 ,rcptdd               AS otpt_rcptdd                 
                 ,rcptno               AS otpt_rcptno                 
                 ,rcptseqno            AS otpt_rcptseqno              
                 ,telrsrvrem           AS otpt_telrsrvrem             
                 ,updtcnclresn         AS otpt_updtcnclresn           
                 ,fstacptid            AS otpt_fstacptid              
                 ,fstacptdt            AS otpt_fstacptdt              
                 ,fstrgstrid           AS otpt_fstrgstrid             
                 ,fstrgstdt            AS otpt_fstrgstdt              
                 ,lastupdtrid          AS otpt_lastupdtrid            
                 ,lastupdtdt           AS otpt_lastupdtdt             
                 ,ordreqformflag       AS otpt_ordreqformflag         
                 ,handicaprbookpossnyn AS otpt_handicaprbookpossnyn   
                 ,rareobstflag         AS otpt_rareobstflag           
                 ,tranflag             AS otpt_tranflag
				 ,holdflag             AS otpt_holdflag
				 ,subdeptcd            AS otpt_subdeptcd
            FROM pam.pmohotpt
           WHERE pid        = #opmi_pid#
             AND orddd      = #opmi_orddd#
             AND cretno     = #opmi_cretno#
             AND instcd     = #sessinstcd#
             AND histstat   IN  ( 'R' , 'T')
             ]]> 
    </statement> 

  <!-- 외래등록내역 조회(정산계산한 내역이 있는지 체크) -->
  <!--   TRPAO00205 -->
  <!-- 선택한 수납내역에 대해, 이후 정산한 내역이 있는지 체크  -->
   <statement id="getOtptInfo3"><![CDATA[    
             SELECT  
                   pid                     AS otpt_pid                  
                  ,orddd                   AS otpt_orddd                
                  ,cretno                  AS otpt_cretno               
                  ,acptseqno               AS otpt_acptseqno            
                  ,instcd                  AS otpt_instcd               
                  ,histstat                AS otpt_histstat             
                  ,orgorddd                AS otpt_orgorddd             
                  ,orgcretno               AS otpt_orgcretno            
                  ,calcbaseflag            AS otpt_calcbaseflag         
                  ,calcyn                  AS otpt_calcyn               
                  ,ordtm                   AS otpt_ordtm                
                  ,orddeptcd               AS otpt_orddeptcd            
                  ,orddrid                 AS otpt_orddrid              
                  ,dutdeptcd               AS otpt_dutdeptcd            
                  ,centcd                  AS otpt_centcd               
                  ,supdeptcd               AS otpt_supdeptcd            
                  ,mskind                  AS otpt_mskind               
                  ,insukind                AS otpt_insukind             
                  ,suppkind                AS otpt_suppkind             
                  ,insucd                  AS otpt_insucd               
                  ,suppkindresn            AS otpt_suppkindresn         
                  ,specordyn               AS otpt_specordyn            
                  ,holiflag                AS otpt_holiflag             
                  ,fsexamflag              AS otpt_fsexamflag           
                  ,fsexammanlyn            AS otpt_fsexammanlyn         
                  ,ordtype                 AS otpt_ordtype              
                  ,brateflag               AS otpt_brateflag            
                  ,medamtestmyn            AS otpt_medamtestmyn         
                  ,medamtpostyn            AS otpt_medamtpostyn         
                  ,medamtfreeresn          AS otpt_medamtfreeresn       
                  ,rsrvflag                AS otpt_rsrvflag             
                  ,etcordflag              AS otpt_etcordflag           
                  ,disccd                  AS otpt_disccd               
                  ,hosoutexptresncd        AS otpt_hosoutexptresncd     
                  ,clincstdyacptflag       AS otpt_clincstdyacptflag    
                  ,clincstdyno             AS otpt_clincstdyno          
                  ,chrtlendyn              AS otpt_chrtlendyn           
                  ,specorddescyn           AS otpt_specorddescyn        
                  ,ordreqdescyn            AS otpt_ordreqdescyn         
                  ,ordreqhospgrde          AS otpt_ordreqhospgrde       
                  ,insuchrgyn              AS otpt_insuchrgyn           
                  ,nursacptyn              AS otpt_nursacptyn           
                  ,nursacptdt              AS otpt_nursacptdt           
                  ,dracptyn                AS otpt_dracptyn             
                  ,dracptdt                AS otpt_dracptdt             
                  ,prcpgenryn              AS otpt_prcpgenryn           
                  ,prcpnotoccrresn         AS otpt_prcpnotoccrresn      
                  ,estmspclappyn           AS otpt_estmspclappyn        
                  ,elbulbodstat            AS otpt_elbulbodstat         
                  ,elbulbodstatdt          AS otpt_elbulbodstatdt       
                  ,calcflag                AS otpt_calcflag             
                  ,calcmthdflag            AS otpt_calcmthdflag         
                  ,dnoracptyn              AS otpt_dnoracptyn           
                  ,rqstflag                AS otpt_rqstflag             
                  ,rqsthospcd              AS otpt_rqsthospcd           
                  ,rqstdrid                AS otpt_rqstdrid             
                  ,tdayinflag              AS otpt_tdayinflag           
                  ,tranindd                AS otpt_tranindd             
                  ,rcptdd                  AS otpt_rcptdd               
                  ,rcptno                  AS otpt_rcptno               
                  ,rcptseqno               AS otpt_rcptseqno            
                  ,telrsrvrem              AS otpt_telrsrvrem           
                  ,updtcnclresn            AS otpt_updtcnclresn         
                  ,fstacptid               AS otpt_fstacptid            
                  ,fstacptdt               AS otpt_fstacptdt            
                  ,fstrgstrid              AS otpt_fstrgstrid           
                  ,fstrgstdt               AS otpt_fstrgstdt            
                  ,lastupdtrid             AS otpt_lastupdtrid          
                  ,lastupdtdt              AS otpt_lastupdtdt           
                  ,ordreqformflag          AS otpt_ordreqformflag       
                  ,handicaprbookpossnyn    AS otpt_handicaprbookpossnyn
                  ,rareobstflag            AS otpt_rareobstflag
                  ,tranflag                AS otpt_tranflag
				  ,holdflag                AS otpt_holdflag
				  ,subdeptcd               AS otpt_subdeptcd
                FROM pam.pmohotpt
               WHERE pid       =  #opmi_pid#
                 AND orddd     =  #opmi_orddd#
                 AND cretno    =  #opmi_cretno#
                 AND calcyn    = 'Y'
                 AND histstat  = 'R'
                 AND instcd    =  #sessinstcd#
             ]]> 
    </statement> 


  <!-- 처방 조회  -->
  <!-- 외래수납화면에서 처방조회 - 홀드처리를 위한 (미수납처방확인) -->
  <!--  TRPAO00107 --> 
   <statement id="getprcpList2"><![CDATA[    
              SELECT a.pid                                                     AS prcp_pid
                    ,a.calcscorcd                                              AS prcp_calcscorcd
                    ,CASE c.precureprcpflag WHEN 'Y' THEN '[선]' || b.hngnm  
                                                     ELSE b.hngnm 
                                                      END                      AS prcp_calcscorcdnm
                    ,a.actorddd                                                AS prcp_actorddd
                    ,CASE a.rcptdd WHEN '00000000' THEN ''
                                                   ELSE a.rcptdd
                                                    END                        AS prcp_rcptdd
                    ,CASE a.execdd WHEN '00000000' THEN ''
                                                   ELSE a.execdd
                                                    END                        AS prcp_execdd
                    ,c.orddeptcd                                               AS prcp_orddeptcd
                    ,c.orddrid                                                 AS prcp_orddrid
                    ,c.orddd                                                   AS prcp_orddd
                    ,CASE WHEN c.hosinhosoutflag = 'O' then '원외'
                          WHEN c.hosinhosoutflag = 'I' then '원내'
                          ELSE ''
                           END                                                 AS prcp_hosinhosoutflag
                    ,a.prcpdd                                                  AS prcp_prcpdd
                    ,a.prcpno                                                  AS prcp_prcpno
                    ,a.prcphistno                                              AS prcp_prcphistno
                    ,a.execprcpno                                              AS prcp_execprcpno
                    ,c.payflagcd                                               AS prcp_payflagcd
                    ,c.prcphistcd                                              AS prcp_prcphistcd
                    ,a.execprcpstatcd                                          AS prcp_prcpstatcd
                    ,(SELECT cdnm FROM com.zbcmcode WHERE cdgrupid = 'M0011' AND cdid = a.execrcptstatcd) AS prcp_prcpstatcd1
                    ,a.execprcpstatcd                                          AS prcp_preprcpstatcd
                    ,a.execrcptstatcd                                          AS prcp_rcptstatcd
                    ,(SELECT cdnm FROM com.zbcmcode WHERE cdgrupid = 'M0011' AND cdid = a.execrcptstatcd) AS prcp_rcptstatcd1 
                    ,a.actcretno                                               AS prcp_actcretno
                    ,b.earncls1                                                AS prcp_earncls1
                    ,d.outcls                                                  AS prcp_outcls
					,a.rsrvdd												   AS prcp_rsrvdd
					,a.rsrvtm												   AS prcp_rsrvtm
					,a.rsrvflag												   AS prcp_rsrvflag
                    ,c.choiordflag                                             AS prcp_choiordflag
                    ,c.specdrid                                                AS prcp_specdrid
               FROM emr.mmodexop a
                   ,pam.picmmech b
                   ,emr.mmohoprc c
                   ,pam.pasmictp d
              WHERE a.pid               = #pid#
               AND  a.actorddd          = #orddd#
               AND  a.actcretno         = #cretno#
               AND  a.instcd            = #sessinstcd#
               AND  b.calcscorcd        = a.calcscorcd
               AND  b.instcd            = a.instcd
               AND  a.actorddd          BETWEEN b.fromdd AND b.todd
               AND  c.prcpdd            = a.prcpdd
               AND  c.prcpno            = a.prcpno
               AND  c.prcphistno        = a.prcphistno
               AND  c.instcd            = a.instcd
               AND  c.prcpflag          in ('1','3')
               AND  c.tempprcpflag      <> 'Y'
               AND  c.hscttempprcpflag  <> 'Y'
               AND  c.prcphistcd        in ('O','E','D')
               AND  d.EARNCLS1          = b.EARNCLS1
               AND  d.EARNCLS2          = b.EARNCLS2
               AND  d.EARNCLS3          = b.EARNCLS3
               AND  d.EARNCLSSTAT       = '0'
               AND  d.instcd            = a.instcd
               ORDER BY c.prcpno
             ]]> 
    </statement> 

  <!-- HOLD 처방일자 조회  -->
  <!-- 추후 기간조건 걸어야 함 ,아니면, 처방상태에 대해 인덱스처리 필요 -->
  <!--  TRPAO00108 
   <statement id="getholdDDList"><![CDATA[    
          SELECT  distinct
                  a.pid                   AS prcp_pid
                 ,a.actorddd              AS prcp_actorddd
                 ,a.actcretno             AS prcp_actcretno
            FROM emr.mmodexop a
                ,pam.picmmech b
                ,emr.mmohoprc c
           WHERE a.pid              = #pid#
             AND a.instcd           = #sessinstcd#       
             AND a.actorddd         BETWEEN b.fromdd AND b.todd
             AND b.calcscorcd       = a.calcscorcd             
             AND b.instcd           = a.instcd
             AND c.prcpdd           = a.prcpdd
             AND c.prcpno           = a.prcpno
             AND c.prcphistno       = a.prcphistno
             AND c.instcd           = a.instcd
             AND c.prcpflag         in ('1','3')
             AND c.tempprcpflag     <> 'Y'
             AND c.hscttempprcpflag <> 'Y'
             AND a.execrcptstatcd   = '210'
             ]]> 
    </statement> 
	-->

  <!-- HOLD 처방 조회  -->
  <!--  TRPAO00109 
   <statement id="getholdList"><![CDATA[    
        SELECT   a.pid                                  AS prcp_pid
                ,a.calcscorcd                           AS prcp_calcscorcd
                ,b.hngnm                                AS prcp_calcscorcdnm
                ,a.actorddd                             AS prcp_actorddd
                ,CASE a.rcptdd   WHEN '00000000' 
                                 THEN ''
                                 ELSE a.rcptdd
                                  END                    AS prcp_rcptdd
                ,CASE a.execdd   WHEN '00000000' 
                                 THEN ''
                                 ELSE a.execdd
                                  END                    AS prcp_execdd
                ,c.orddeptcd                             AS prcp_orddeptcd
                ,c.orddrid                               AS prcp_orddrid
                ,c.orddd                                 AS prcp_orddd
                ,c.hosinhosoutflag                       AS prcp_hosinhosoutflag
                ,a.prcpdd                                AS prcp_prcpdd
                ,a.prcpno                                AS prcp_prcpno
                ,a.prcphistno                            AS prcp_prcphistno
                ,a.execprcpno                            AS prcp_execprcpno
                ,c.payflagcd                             AS prcp_payflagcd
                ,c.prcphistcd                            AS prcp_prcphistcd
                ,a.execprcpstatcd                        AS prcp_prcpstatcd  
                ,a.actcretno                             AS prcp_actcretno
        FROM emr.mmodexop a
           , pam.picmmech b
           , emr.mmohoprc c
       WHERE a.pid           = #pid#
         AND a.actorddd      = #orddd#
         AND b.calcscorcd    = a.calcscorcd
         AND a.actorddd      BETWEEN b.fromdd AND b.todd
         AND c.prcpdd        = a.prcpdd
         AND c.prcpno        = a.prcpno
         AND c.prcphistno    = a.prcphistno
         AND c.prcpflag      in ('1','3')
         AND c.tempprcpflag      <> 'Y'
         AND c.hscttempprcpflag  <> 'Y'
         AND a.execrcptstatcd    in ('210')
         AND a.instcd        = #sessinstcd#
         AND a.instcd        = b.instcd
         AND a.instcd        = c.instcd
       ORDER BY c.prcpno
             ]]> 
    </statement> 
	--> 

<!-- 기존 외래계산의 청구대상상태 [변경] -->
   <statement id="setClamTrgtStat"><![CDATA[    
            UPDATE pam.paohoscl
               SET clamtrgtstat ='C'
                 , lastupdtrid  = #sessuserid#
                 , lastupdtdt   = SYSTIMESTAMP
             WHERE pid          = #opmi_pid#                    
               AND orddd        = #opmi_orddd#
               AND cretno       = #opmi_cretno#
               AND calcstat     = 'Y'
               AND clamtrgtstat = 'R'
               AND calcseqno    < 100
               AND instcd       = #sessinstcd#        
           ]]>
    </statement> 

   <!-- 외래선수금 수납(카드수납) --> 
   <!-- TXPAO00701  -->
   <statement id="insCardAmt"><![CDATA[    
        INSERT INTO     pam.pamhcard
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno
                            ,   seqno
                            ,   instcd
                            ,   rcptstat
                            ,   ordtype
                            ,   keyinptflag
                            ,   cardcmpycd
                            ,   cardno
                            ,   aprvflag
                            ,   aprvdd
                            ,   aprvtm
                            ,   aprvno
                            ,   vancd
                            ,   allotmm
                            ,   cardamt
                            ,   valiterm
                            ,   rcptexecdd
                            ,   rcpttm
                            ,   rcptrid
                            ,   innrtretyn
                            ,   preamtyn
                            ,   remfact
                            ,   fstrgstrid
                            ,   fstrgstdt
                            ,   lastupdtrid
                            ,   lastupdtdt
                            )  
                    SELECT                                
                                  CAST(#pid#                   AS VARCHAR2(10))
							,     CAST(#orddd#                 AS VARCHAR2(8)) 
							,     CAST(#cretno#                AS NUMBER) 
                            ,     CAST(#rcptdd#                AS VARCHAR2(8))                     
                            ,     CAST(#rcptno#                AS NUMBER)                     
                            ,     CAST(#rcptseqno#             AS NUMBER)                     
                            ,     NVL(CAST(MAX(CAST(seqno AS NUMBER))  AS NUMBER),0)+1  
                            ,     CAST(#sessinstcd#                AS VARCHAR2(3))                     
                            ,     CAST(#rcptstat#              AS VARCHAR2(1))                     
                            ,     CAST(#ordtype#               AS VARCHAR2(1))                     
                            ,     CAST(#keyinptflag#           AS VARCHAR2(1))                     
                            ,     CAST(#cardcmpycd#            AS VARCHAR2(2))                     
                            ,     CAST(#cardno#                AS VARCHAR2(20))                 
                            ,     CAST(#aprvflag#              AS VARCHAR2(2))                     
                            ,     CAST(#aprvdd#                AS VARCHAR2(8))                     
                            ,     CAST(#aprvtm#                AS VARCHAR2(6))                     
                            ,     CAST(#aprvno#                AS VARCHAR2(20))                 
                            ,     CAST(#vancd#                 AS VARCHAR2(2))                  
                            ,     CAST(#allotmm#               AS VARCHAR2(2))                     
                            ,     CAST(#cardamt#               AS NUMBER(10,0))               
                            ,     CAST(#valiterm#              AS VARCHAR2(6))      
                            ,     CAST(#rcptexecdd#            AS VARCHAR2(8))                     
                            ,     CAST(#rcpttm#                AS VARCHAR2(6))                     
                            ,     CAST(#rcptrid#               AS VARCHAR2(10))                 
                            ,     CAST(#innrtretyn#            AS VARCHAR2(1))                     
                            ,     CAST(#preamtyn#              AS VARCHAR2(1))                     
                            ,     CAST(#remfact#               AS VARCHAR2(200))                
                            ,     CAST(#sessuserid#            AS VARCHAR2(10))                 
                            ,     SYSTIMESTAMP                                        
                            ,     CAST(#sessuserid#           AS VARCHAR2(10))                 
                            ,     SYSTIMESTAMP
                            FROM  pam.pamhcard    
                           WHERE  pid        = #pid#
                             AND  rcptdd     = #rcptdd#    
                             AND  rcptno     = #rcptno#    
                             AND  rcptseqno  = #rcptseqno#    
                             AND  instcd     = #sessinstcd#  
           ]]>
    </statement> 

   <!-- 외래선수금 수납(현금영수증수납)  --> 
   <!-- TXPAO00701 -->
   <statement id="insCashAmt"><![CDATA[    
        INSERT INTO     pam.pachcash
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno
                            ,   seqno
                            ,   instcd
                            ,   rcptstat
                            ,   ordtype
                            ,   keyinptflag
                            ,   indinstflag
                            ,   qualcnfmflag
                            ,   qualcnfmno
                            ,   aprvflag
                            ,   aprvno
                            ,   aprvdd
                            ,   aprvtm
                            ,   cashamt
                            ,   rcptexecdd
                            ,   rcpttm
                            ,   rcptrid
                            ,   preamtyn
                            ,   innrtretyn
                            ,   remfact
                            ,   fstrgstrid
                            ,   fstrgstdt
                            ,   lastupdtrid
                            ,   lastupdtdt
                            )  
                SELECT                  
                               CAST(#pid#                   AS VARCHAR2(10))
							,  CAST(#orddd#                 AS VARCHAR2(8)) 
							,  CAST(#cretno#                AS NUMBER) 
                            ,  CAST(#rcptdd#                AS VARCHAR2(8))                                    
                            ,  CAST(#rcptno#                AS NUMBER)                                   
                            ,  CAST(#rcptseqno#             AS NUMBER)                                   
                            ,  NVL(CAST(MAX(CAST(seqno AS NUMBER)) AS NUMBER),0)+1  
                            ,  CAST(#sessinstcd#                AS VARCHAR2(3))                                   
                            ,  CAST(#rcptstat#              AS VARCHAR2(1))                                   
                            ,  CAST(#ordtype#               AS VARCHAR2(1))                                   
                            ,  CAST(#keyinptflag#           AS VARCHAR2(1))                                   
                            ,  CAST(#indinstflag#           AS VARCHAR2(2))                                   
                            ,  CAST(#qualcnfmflag#          AS VARCHAR2(1))                                   
                            ,  CAST(#qualcnfmno#            AS VARCHAR2(20))                               
                            ,  CAST(#aprvflag#              AS VARCHAR2(2))                                   
                            ,  CAST(#aprvno#                AS VARCHAR2(20))                               
                            ,  CAST(#aprvdd#                AS VARCHAR2(8))                                   
                            ,  CAST(#aprvtm#                AS VARCHAR2(6))                                   
                            ,  CAST(#cashamt#               AS NUMBER(10,0))                             
                            ,  CAST(#rcptexecdd#            AS VARCHAR2(8))                                    
                            ,  CAST(#rcpttm#                AS VARCHAR2(6))                                   
                            ,  CAST(#rcptrid#               AS VARCHAR2(10))                                  
                            ,  CAST(#preamtyn#              AS VARCHAR2(1))                                    
                            ,  CAST(#innrtretyn#            AS VARCHAR2(1))                                    
                            ,  CAST(#remfact#               AS VARCHAR2(100))                              
                            ,  CAST(#sessuserid#            AS VARCHAR2(10))                               
                            ,  SYSTIMESTAMP                                                   
                            ,  CAST(#sessuserid#            AS VARCHAR2(10))                                
                            ,  SYSTIMESTAMP
                    FROM    pam.pachcash                        
                  WHERE pid         = #pid#
                    AND rcptdd      = #rcptdd#    
                    AND rcptno      = #rcptno#    
                    AND rcptseqno   = #rcptseqno#    
                    AND instcd      = #sessinstcd#   
           ]]>
    </statement> 

   <!-- 외래선수금 수납취소 내역 생성 --> 
   <!-- TXPAO00702 -->
    <statement id="insMdlAmtCncl"><![CDATA[    
        INSERT INTO pam.paohbogj
                            (   pid              
                            ,   rcptdd           
                            ,   rcptno           
                            ,   rcptseqno        
                            ,   seqno            
                            ,   instcd           
                            ,   rcptstat         
                            ,   ordtype          
                            ,   rcptflag         
                            ,   cashamt          
                            ,   cardamt          
                            ,   onlineamt        
                            ,   rcptexecdd       
                            ,   rcpttm           
                            ,   rcptrid          
                            ,   remfact       
                            ,   orddeptcd   
                            ,   paypsnflag       
                            ,   paydepoamt
                            ,   paypsnrem        
                            ,   fstrgstrid       
                            ,   fstrgstdt        
                            ,   lastupdtrid      
                            ,   lastupdtdt       
                            )  
                SELECT                  
                                pid
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno + 100
                            ,   seqno
                            ,   instcd
                            ,   'D'
                            ,   ordtype
                            ,   CAST(#rcptflag#   AS VARCHAR2(3))  
                            ,   cashamt * -1
                            ,   cardamt * -1
                            ,   onlineamt * -1
                            ,   CAST(#rcptexecdd# AS VARCHAR2(8))   
                            ,   CAST(#rcpttm#     AS VARCHAR2(6))       
                            ,   CAST(#rcptrid#    AS VARCHAR2(10))      
                            ,   '[반환]'||remfact
                            ,   orddeptcd
                            ,   paypsnflag
                            ,   paydepoamt * -1
                            ,   paypsnrem
                            ,   fstrgstrid
                            ,   SYSTIMESTAMP
                            ,   CAST(#rcptrid#    AS VARCHAR2(10))      
                            ,   SYSTIMESTAMP    
                    FROM    pam.paohbogj                        
                  WHERE pid             = #pid#
                       AND  rcptdd          = #rcptdd#    
                       AND  rcptno          = #rcptno#    
                       AND  rcptseqno       = #rcptseqno#    
                       AND  instcd          = #sessinstcd#   
           ]]>
    </statement> 

   <!-- 카드 수납취소 내역 생성 --> 
   <!-- TXPAO00702 -->
    <statement id="insCardAmtCncl"><![CDATA[    
        INSERT INTO pam.pamhcard
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno
                            ,   seqno
                            ,   instcd
                            ,   rcptstat
                            ,   ordtype
                            ,   keyinptflag
                            ,   cardcmpycd
                            ,   cardno
                            ,   aprvflag
                            ,   aprvdd
                            ,   aprvtm
                            ,   aprvno
                            ,   vancd
                            ,   allotmm
                            ,   cardamt
                            ,   valiterm
                            ,   rcptexecdd
                            ,   rcpttm
                            ,   rcptrid
                            ,   innrtretyn
                            ,   preamtyn
                            ,   remfact
                            ,   fstrgstrid
                            ,   fstrgstdt
                            ,   lastupdtrid
                            ,   lastupdtdt
                            )  
                SELECT                  
                                pid
							,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno + 100
                            ,   seqno
                            ,   instcd
                            ,   'D'
                            ,   ordtype
                            ,   keyinptflag
                            ,   cardcmpycd
                            ,   cardno
                            ,   aprvflag
                            ,   aprvdd
                            ,   aprvtm
                            ,   aprvno
                            ,   vancd
                            ,   allotmm
                            ,   cardamt * -1
                            ,   valiterm
                            ,   CAST(#rcptexecdd# AS VARCHAR2(8))   
                            ,   CAST(#rcpttm#     AS VARCHAR2(6))       
                            ,   CAST(#rcptrid#    AS VARCHAR2(10))      
                            ,   innrtretyn
                            ,   preamtyn
                            ,   '[취소]'||remfact
                            ,   fstrgstrid
                            ,   SYSTIMESTAMP
                            ,   CAST(#sessinstcd# AS VARCHAR2(10)) 
                            ,   SYSTIMESTAMP    
                    FROM    pam.pamhcard
                   WHERE    pid         = #pid#
                     AND    rcptdd      = #rcptdd#    
                     AND    rcptno      = #rcptno#    
                     AND    rcptseqno   = #rcptseqno#    
                     AND    instcd      = #sessinstcd#   
           ]]>
    </statement> 

   <!-- 현금영수증승인 수납취소 내역 생성 --> 
   <!-- TXPAO00702 -->
    <statement id="insCashAmtCncl"><![CDATA[    
        INSERT INTO pam.pachcash (  
                                pid
                            ,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno
                            ,   seqno
                            ,   instcd
                            ,   rcptstat
                            ,   ordtype
                            ,   keyinptflag
                            ,   indinstflag
                            ,   qualcnfmflag
                            ,   qualcnfmno
                            ,   aprvflag
                            ,   aprvno
                            ,   aprvdd
                            ,   aprvtm
                            ,   cashamt
                            ,   rcptexecdd
                            ,   rcpttm
                            ,   rcptrid
                            ,   preamtyn
                            ,   innrtretyn
                            ,   remfact
                            ,   fstrgstrid
                            ,   fstrgstdt
                            ,   lastupdtrid
                            ,   lastupdtdt
                            )  
                        SELECT  pid
                            ,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno + 100
                            ,   seqno
                            ,   instcd
                            ,   'D'
                            ,   ordtype
                            ,   keyinptflag
                            ,   indinstflag
                            ,   qualcnfmflag
                            ,   qualcnfmno
                            ,   aprvflag
                            ,   aprvno
                            ,   aprvdd
                            ,   aprvtm
                            ,   cashamt * -1
                            ,   CAST(#rcptexecdd# AS VARCHAR2(8))   
                            ,   CAST(#rcpttm#     AS VARCHAR2(6))       
                            ,   CAST(#rcptrid#    AS VARCHAR2(10))      
                            ,   preamtyn
                            ,   innrtretyn
                            ,   '[반환]'||remfact
                            ,   fstrgstrid
                            ,   SYSTIMESTAMP
                            ,   CAST(#sessinstcd# AS VARCHAR2(10)) 
                            ,   SYSTIMESTAMP    
                    FROM    pam.pachcash
                  WHERE pid         = #pid#
                    AND rcptdd      = #rcptdd#    
                    AND rcptno      = #rcptno#    
                    AND rcptseqno   = #rcptseqno#    
                    AND instcd      = #sessinstcd#   
           ]]>
    </statement> 

<!-- 카드수납금액 수납변경 update  -->
<!-- TXPAO00702 -->
   <statement id="setCardAmt"><![CDATA[    
        UPDATE  pam.pamhcard
              SET   rcptstat            = 'C'
                   ,    lastupdtrid = #sessinstcd#
                   ,    lastupdtdt      = SYSTIMESTAMP
         WHERE  pid             = #pid#
              AND   rcptdd          = #rcptdd#
              AND   rcptno          = #rcptno#
              AND   ordtype         = #ordtype#
              AND   rcptstat            = 'Y'
              AND   instcd          = #sessinstcd#            
           ]]>
    </statement> 

<!-- 현금영수증승인 수납금액 수납변경 update  -->
<!-- TXPAO00702 -->
   <statement id="setCashAmt"><![CDATA[    
        UPDATE  pam.pachcash
              SET   rcptstat            = 'C'
                   ,    lastupdtrid = #sessinstcd#
                   ,    lastupdtdt      = SYSTIMESTAMP
         WHERE  pid             = #pid#
              AND   rcptdd          = #rcptdd#
              AND   rcptno          = #rcptno#
              AND   ordtype         = #ordtype#
              AND   rcptstat            = 'Y'
              AND   instcd          = #sessinstcd#            
           ]]>
    </statement> 

   <!-- 통장입금 수납취소 내역 생성 --> 
   <!-- TXPAO00702 -->
    <statement id="insOnlineAmtCncl"><![CDATA[    
        INSERT INTO pam.pachonln
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno
                            ,   seqno
                            ,   instcd
                            ,   rcptstat
                            ,   ordtype
                            ,   onlineamt
                            ,   bankcd
                            ,   acntno
                            ,   paydd
                            ,   paypsnnm
                            ,   rcptexecdd
                            ,   rcpttm
                            ,   rcptrid
                            ,   preamtyn
                            ,   innrtretyn
                            ,   remfact
                            ,   fstrgstrid
                            ,   fstrgstdt
                            ,   lastupdtrid
                            ,   lastupdtdt
                            )  
                SELECT  pid
						    ,   orddd
						    ,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno + 100
                            ,   seqno
                            ,   instcd
                            ,   'D'
                            ,   ordtype
                            ,   onlineamt * -1
                            ,   bankcd
                            ,   acntno
                            ,   paydd
                            ,   paypsnnm
                            ,   CAST(#rcptexecdd# AS VARCHAR2(8))   
                            ,   CAST(#rcpttm#     AS VARCHAR2(6))       
                            ,   CAST(#rcptrid#    AS VARCHAR2(10))      
                            ,   preamtyn
                            ,   innrtretyn
                            ,   '[취소]'||remfact
                            ,   fstrgstrid
                            ,   SYSTIMESTAMP
                            ,   CAST(#sessinstcd# AS VARCHAR2(10)) 
                            ,   SYSTIMESTAMP    
                    FROM    pam.pachonln
                  WHERE pid             = #pid#
                       AND  rcptdd          = #rcptdd#    
                       AND  rcptno          = #rcptno#    
                       AND  rcptseqno       = #rcptseqno#    
                       AND  instcd          = #sessinstcd#   
           ]]>
    </statement> 

       
    
  <!-- 보험정보조회(외래수납) --> 
  <!-- TXPAO00202 -->
   <statement id="getPtin1"><![CDATA[    
        SELECT pid           AS ptin_pid,                          
               pid           AS ptin_pid_org,                    
               insukind      AS ptin_insukind,                   
               insukind      AS ptin_insukind_org,               
               todd          AS ptin_todd,                       
               todd          AS ptin_todd_org,                   
               seqno         AS ptin_seqno,                      
               instcd        AS ptin_instcd,                     
               histstat      AS ptin_histstat,
			   fromdd        AS ptin_fromdd,  
               fromdd        AS ptin_fromdd_org,                     
               insucd        AS ptin_insucd,                     
               insuno        AS ptin_insuno,                     
               insdnm        AS ptin_insdnm,                     
               insdrrgstno1  AS ptin_insdrrgstno1,               
               insdrrgstno2  AS ptin_insdrrgstno2,               
               insdrela      AS ptin_insdrela,                   
               fstrgstrid    AS ptin_fstrgstrid,                 
               fstrgstdt     AS ptin_fstrgstdt,                  
               lastupdtrid   AS ptin_lastupdtrid,                
               lastupdtdt    AS ptin_lastupdtdt                  
         FROM pam.pmcmptin a    
        WHERE a.pid      = #ptin_pid#
          AND a.insukind = #ptin_insukind#
		  AND a.fromdd  <= #ptin_fromdd#
	      AND a.todd    >= #ptin_fromdd#
          AND a.instcd   = #sessinstcd#
          AND a.histstat = 'Y'
		ORDER BY a.fromdd, a.todd
     ]]>
    </statement> 
	<!--
		AND a.fromdd  <= #todd_org#
	    AND a.todd    >= #fromdd_org#
	-->

   <!-- 환자보험정보조회  키값이 같은내역-->
   <statement id="getPtin2"><![CDATA[    
        SELECT /*+ INDEX(a PK_PMCMPTIN) */ *                  
         FROM pam.pmcmptin a    
        WHERE a.pid           =  #ptin_pid#
          AND a.insukind      =  #ptin_insukind#
          AND a.insucd        =  #ptin_insucd#
          AND a.insuno        =  #ptin_insuno#
          AND a.insdrela      =  #ptin_insdrela#
          AND a.insdnm        =  #ptin_insdnm#
          AND a.insdrrgstno1  =  #ptin_insdrrgstno1#
          AND a.insdrrgstno2  =  #ptin_insdrrgstno2#
	      AND a.todd          = '99991231'
		  AND a.instcd        =  #sessinstcd#
		  AND a.histstat      = 'Y'
		ORDER BY a.fromdd, a.todd
     ]]>
    </statement> 

   <!-- 보험정보 max키구해오기-->
   <statement id="getPtin_maxseqno"><![CDATA[    
        SELECT max(a.seqno) + 1 AS maxseqno                 
         FROM pam.pmcmptin a    
        WHERE a.pid           =  #ptin_pid#
          AND a.insukind      =  #ptin_insukind#
		  AND a.instcd        =  #sessinstcd#
		ORDER BY a.fromdd, a.todd
     ]]>
    </statement> 


    <!-- 보험정보  이력추가  -->    
    <statement id="insPtinHist"><![CDATA[    
		 INSERT INTO pam.pmcmptin (
						   pid
						 , insukind
						 , todd
						 , seqno
						 , instcd
						 , histstat
						 , fromdd
						 , insucd
						 , insuno
						 , insdnm
						 , insdrrgstno1
						 , insdrrgstno2
						 , insdrela
						 , fstrgstrid
						 , fstrgstdt
						 , lastupdtrid
						 , lastupdtdt
		 
				) VALUES (
						 #ptin_pid#
						,#ptin_insukind#
						,#ptin_todd#
						,#maxseqno#
						,#sessinstcd#
						,'Y'
						,#ptin_fromdd#
						,#ptin_insucd#
						,#ptin_insuno#
						,#ptin_insdnm#
						,#ptin_insdrrgstno1#
						,#ptin_insdrrgstno2#
						,#ptin_insdrela#
						,#sessuserid#
						,SYSTIMESTAMP
						,#sessuserid#
						,SYSTIMESTAMP
			 )                                      
           ]]>         
    </statement> 

<!--
        INSERT INTO pam.pmcmptin
                          (     pid
                          ,     insukind
                          ,     todd
                          ,     seqno
                          ,     instcd
                          ,     histstat
                          ,     fromdd
                          ,     insucd
                          ,     insuno
                          ,     insdnm
                          ,     insdrrgstno1
                          ,     insdrrgstno2
                          ,     insdrela
                          ,     fstrgstrid
                          ,     fstrgstdt
                          ,     lastupdtrid
                          ,     lastupdtdt
                          )
                    SELECT  #ptin_pid#
                          , #ptin_insukind#
                          , #ptin_todd#
                          , NVL(CAST(MAX(CAST(seqno AS NUMBER)) AS NUMBER),0)+1 
                          , #sessinstcd#
                          , 'Y'
                          , #ptin_fromdd#
                          , NVL(#ptin_insucd#, '-')
                          , #ptin_insuno#
                          , #ptin_insdnm#
                          , #ptin_insdrrgstno1#
                          , #ptin_insdrrgstno2#
                          , #ptin_insdrela#
                          , #sessuserid#
                          , SYSTIMESTAMP
                          , #sessuserid#
                          , SYSTIMESTAMP
                      FROM  pam.pmcmptin
                     WHERE  pid       = #ptin_pid#
                       AND  insukind  = #ptin_insukind#
                       AND  instcd    = #sessinstcd#                    
-->

    <!-- 보험정보  HistStat update  AND insucd      =  #ptin_insucd#-->    
    <statement id="setPtinPreHist"><![CDATA[    
        UPDATE pam.pmcmptin a
           SET todd        = #bfday#
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP 
        WHERE a.pid      = #ptin_pid#
          AND a.insukind = #ptin_insukind_org#
		  AND a.todd     = #ptin_todd_org#
          AND a.instcd   = #sessinstcd#
           ]]>         
    </statement> 
    
   <!-- 미수내역 생성  
   20130116 수정
   ,   CAST(#uncocls#  AS  VARCHAR2(1)) 
   미수구분값 저장 오류로 저장시점에 최종 미수내역을 조회해여 입력하도록 수정
   --> 
   <!-- TXPAO00102 -->
   <statement id="insUncoAmt"><![CDATA[    
        INSERT INTO     pam.pamhunco
                            (   pid             
                            ,   rcptdd          
                            ,   rcptno          
                            ,   rcptseqno       
                            ,   seqno           
                            ,   instcd          
                            ,   rcptstat        
                            ,   ordtype         
                            ,   orddd 
							,   cretno
                            ,   orddeptcd       
                            ,   orddrid         
                            ,   dschdd          
                            ,   insukind        
                            ,   suppkind        
                            ,   uncorcptflag    
                            ,   uncocls         
                            ,   uncocd          
                            ,   uncoamt         
                            ,   rcptamt         
                            ,   debtamt         
                            ,   endyn           
                            ,   clincstdyno     
                            ,   empid           
                            ,   rcptexecdd      
                            ,   rcpttm          
                            ,   rcptrid         
                            ,   apprsn          
                            ,   remfact         
                            ,   fstrgstrid      
                            ,   fstrgstdt       
                            ,   lastupdtrid     
                            ,   lastupdtdt 
                            )  
                values      ( CAST(#pid# AS VARCHAR2(10))           
                            ,   CAST(#rcptdd#  AS VARCHAR2(8))     
                            ,   CAST(#rcptno#  AS  NUMBER)     
                            ,   CAST(#rcptseqno# AS  NUMBER)      
                            ,   NVL((SELECT MAX(seqno)
                            				FROM    pam.pamhunco            
							                WHERE  pid             = #pid#
							                AND  rcptdd          = #rcptdd#    
							                AND  rcptno          = #rcptno#    
							                AND  rcptseqno       = #rcptseqno#    
							                AND  instcd          = #sessinstcd#   ),0)+1
                            ,   CAST(#sessinstcd# AS  VARCHAR2(3))       
                            ,   CAST(#rcptstat#  AS  VARCHAR2(1))    
                            ,   CAST(#ordtype#  AS  VARCHAR2(1)) 
                            ,   CAST(#orddd#  AS  VARCHAR2(8)) 
							,   CAST(#cretno#  AS  NUMBER(10))   
                            ,   CAST(#orddeptcd#  AS  VARCHAR2(10)) 
                            ,   CAST(#orddrid#  AS  VARCHAR2(10)) 
                            ,   CAST(#dschdd#  AS  VARCHAR2(8)) 
                            ,   CAST(#insukind#  AS  VARCHAR2(2)) 
                            ,   CAST(#suppkind#  AS  VARCHAR2(2))
                            ,   CAST(#uncorcptflag#  AS  VARCHAR2(2))
                            ,  (SELECT discuncocls
                                FROM  pam.pmbmdcuc
                                where  instcd =  #sessinstcd#
                                and    discuncoflag = 'U'
			                    and    #rcptexecdd# between fromdd and todd
			                    and    discuncocd = #uncocd#
			                    and    histstat = 'Y'
			                    and    rownum = 1)
                            ,   CAST(#uncocd#  AS  VARCHAR2(4)) 
                            ,   CAST(#uncoamt#  AS  NUMBER(10,0))      
                            ,   CAST(#rcptamt#  AS  NUMBER(10,0))      
                            ,   CAST(#debtamt#  AS  NUMBER(10,0))      
                            ,   CAST(#endyn#  AS  VARCHAR2(1)) 
                            ,   CAST(#clincstdyno#  AS  VARCHAR2(20)) 
                            ,   CAST(#empid#  AS  VARCHAR2(10))
                            ,   CAST(#rcptexecdd# AS VARCHAR2(8))   
                            ,   CAST(#rcpttm# AS  VARCHAR2(6))       
                            ,   CAST(#rcptrid# AS  VARCHAR2(10)) 
                            ,   CAST(#apprsn#  AS  VARCHAR2(50))     
                            ,   CAST(#remfact#  AS  VARCHAR2(100))  
                            ,   CAST(#sessuserid#  AS  VARCHAR2(10))  
                            ,   SYSTIMESTAMP
                            ,   CAST(#sessuserid# AS VARCHAR2(10)) 
                            ,   SYSTIMESTAMP    )
                    
           ]]>
    </statement> 

   <!-- 미수내역 생성  --> 
   <!-- TXPAO00102 -->
   <statement id="insUncoAmtDC"><![CDATA[    
             INSERT INTO pam.pamhunco(   
                             pid             
                            ,rcptdd          
                            ,rcptno          
                            ,rcptseqno       
                            ,seqno           
                            ,instcd          
                            ,rcptstat        
                            ,ordtype         
                            ,orddd
							,cretno
                            ,orddeptcd       
                            ,orddrid         
                            ,dschdd          
                            ,insukind        
                            ,suppkind        
                            ,uncorcptflag    
                            ,uncocls         
                            ,uncocd          
                            ,uncoamt         
                            ,rcptamt         
                            ,debtamt         
                            ,endyn           
                            ,clincstdyno     
                            ,empid           
                            ,rcptexecdd      
                            ,rcpttm          
                            ,rcptrid         
                            ,apprsn          
                            ,remfact         
                            ,fstrgstrid      
                            ,fstrgstdt       
                            ,lastupdtrid     
                            ,lastupdtdt 
                            )  
                      SELECT                  
                             unco.pid
                            ,unco.rcptdd
                            ,unco.rcptno
                            ,CAST(unco.rcptseqno+100 AS  INTEGER)      
                            ,unco.seqno 
                            ,unco.instcd
                            ,'D'
                            ,unco.ordtype
                            ,unco.orddd
							,unco.cretno
                            ,unco.orddeptcd
                            ,unco.orddrid
                            ,unco.dschdd
                            ,unco.insukind
                            ,unco.suppkind
                            ,unco.uncorcptflag
                            ,unco.uncocls
                            ,unco.uncocd
                            ,unco.uncoamt * -1     
                            ,unco.rcptamt * -1     
                            ,unco.debtamt * -1      
                            ,unco.endyn
                            ,unco.clincstdyno
                            ,unco.empid
                            ,TO_CHAR(SYSDATE,'YYYYMMDD')
                            ,TO_CHAR(SYSTIMESTAMP, 'HH24MISS')
                            ,#opmi_rcptrid#
                            ,unco.apprsn
                            ,unco.remfact
                            ,#sessuserid#
                            ,SYSTIMESTAMP
                            ,#sessuserid#
                            ,SYSTIMESTAMP
                    FROM    pam.pamhunco unco
                        ,   pam.paohopmi opmi           
                  WHERE opmi.pid        = #opmi_pid#      
                    AND opmi.orddd      = #opmi_orddd#      
                    AND opmi.cretno     = #opmi_cretno#   
                    AND opmi.instcd     = #sessinstcd#        
                    AND unco.pid        = opmi.pid        
                    AND unco.rcptdd     = opmi.rcptdd     
                    AND unco.rcptno     = opmi.rcptno     
                    AND unco.rcptseqno  = opmi.rcptseqno  
                    AND unco.instcd     = opmi.instcd     
                    AND unco.rcptstat   = 'Y'
                    --AND unco.uncorcptflag not in ('2','3')
                    --AND unco.endyn      = 'N'

           ]]>
    </statement> 

   <statement id="setUncoAmtC"><![CDATA[    
     UPDATE pam.pamhunco
        SET rcptstat    ='C'
           ,lastupdtrid = #sessuserid#
           ,lastupdtdt  = SYSTIMESTAMP
      WHERE (pid,rcptdd,rcptno,rcptseqno,instcd) IN
             (SELECT opmi.pid            AS pid
					,opmi.rcptdd         AS rcptdd
					,opmi.rcptno         AS rcptno
					,opmi.rcptseqno      AS rcptseqno
					,opmi.instcd         AS instcd
                FROM pam.paohopmi opmi
                    ,pam.pamhunco unco
               WHERE opmi.pid     = #opmi_pid#
                 AND opmi.orddd   = #opmi_orddd#
                 AND opmi.cretno  = #opmi_cretno#
                 AND opmi.instcd  = #sessinstcd# 
                 AND unco.pid     = opmi.pid
                 AND unco.rcptdd  = opmi.rcptdd
                 AND unco.rcptno  = opmi.rcptno
                 AND unco.rcptseqno = opmi.rcptseqno
                 AND unco.instcd    = opmi.instcd
                 AND unco.rcptstat  = 'Y'
            )   
    ]]>
    </statement> 
    

  <!-- 임의감액내역 생성  --> 
   <!-- TXPAO00102 -->
   <statement id="insDcgmAmt"><![CDATA[    
        INSERT INTO     pam.padhdcgm
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd
                            ,   rcptno
                            ,   rcptseqno
                            ,   seqno
                            ,   instcd
                            ,   rcptstat                                    
                            ,   ordtype                                     
                            ,   discreduflag                                
                            ,   discreducd                                  
                            ,   discreduamt                                 
                            ,   apprsn                                      
                            ,   rcptexecdd                                  
                            ,   rcpttm                                      
                            ,   rcptrid                                     
                            ,   remfact                                     
                            ,   fstrgstrid                                  
                            ,   fstrgstdt                                   
                            ,   lastupdtrid                                 
                            ,   lastupdtdt                
                            ,   emplno
                            ,   famyrelcd
                            ,   empkindcd
                            ,   emplrgstno
                            ,   dutdeptnm
                            )  
                SELECT
                    sub.*
                    ,b.emplno
                    ,b.famyrelcd
                    ,b.empkindcd
                    ,b.emplrgstno
                    ,b.dutdeptnm
                FROM
                    (
                    SELECT
                               CAST(#pid#                    AS VARCHAR2(10))            AS pid
    						,  CAST(#orddd#                  AS VARCHAR2(8))             AS orddd
    						,  CAST(#cretno#                 AS NUMBER)                  AS cretno
                            ,  CAST(#rcptdd#                 AS VARCHAR2(8))             AS rcptdd
                            ,  CAST(#rcptno#                 AS NUMBER)                  AS rcptno
                            ,  CAST(#rcptseqno#              AS NUMBER)                  AS rcptseqno
                            ,  NVL(CAST(MAX(CAST(a.seqno  AS NUMBER))  AS NUMBER),0)+1   AS seqno
                            ,  CAST(#sessinstcd#             AS VARCHAR2(3))             AS instcd
                            ,  CAST(#rcptstat#               AS VARCHAR2(1))             AS rcptstat    
                            ,  CAST(#ordtype#                AS VARCHAR2(1))             AS ordtype     
                            ,  CAST(#discreduflag#           AS VARCHAR2(1))             AS discreduflag
                            ,  CAST(#discreducd#             AS VARCHAR2(4))             AS discreducd  
                            ,  CAST(#discreduamt#            AS NUMBER(10,0))            AS discreduamt 
                            ,  CAST(#apprsn#                 AS VARCHAR2(50))            AS apprsn      
                            ,  CAST(#rcptexecdd#             AS VARCHAR2(8))             AS rcptexecdd  
                            ,  CAST(#rcpttm#                 AS VARCHAR2(6))             AS rcpttm      
                            ,  CAST(#rcptrid#                AS VARCHAR2(10))            AS rcptrid     
                            ,  CAST(#remfact#                AS VARCHAR2(100))           AS remfact     
                            ,  CAST(#sessuserid#             AS VARCHAR2(10))            AS fstrgstrid  
                            ,  SYSTIMESTAMP                                              AS fstrgstdt   
                            ,  CAST(#sessuserid#             AS VARCHAR2(10))            AS lastupdtrid 
                            ,  SYSTIMESTAMP                                              AS lastupdtdt  
                        FROM   pam.padhdcgm a
                       WHERE
                               a.pid             = #pid#
                         AND   a.rcptdd          = #rcptdd#    
                         AND   a.rcptno          = #rcptno#    
                         AND   a.rcptseqno       = #rcptseqno#    
                         AND   a.instcd          = #sessinstcd#
                    ) sub, pam.pmcmfmly b
                WHERE
                    b.pid (+)         = sub.pid
                AND b.discuncocd (+)  = sub.discreducd
           ]]>
    </statement> 

   <statement id="insDcgmAmtDC"><![CDATA[    
        INSERT INTO     pam.padhdcgm
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd                                      
                            ,   rcptno                                      
                            ,   rcptseqno  
                            ,   seqno                   
                            ,   instcd                                      
                            ,   rcptstat                                    
                            ,   ordtype                                     
                            ,   discreduflag                                
                            ,   discreducd                                  
                            ,   discreduamt                                 
                            ,   apprsn                                      
                            ,   rcptexecdd                                  
                            ,   rcpttm                                      
                            ,   rcptrid                                     
                            ,   remfact                                     
                            ,   fstrgstrid                                  
                            ,   fstrgstdt                                   
                            ,   lastupdtrid                                 
                            ,   lastupdtdt                
                            ,   emplno
                            ,   famyrelcd
                            ,   empkindcd
                            ,   emplrgstno
                            ,   dutdeptnm
                            )  
                SELECT                  
                                dcgm.pid
							,   dcgm.orddd
							,   dcgm.cretno
                            ,   dcgm.rcptdd
                            ,   dcgm.rcptno
                            ,   CAST(dcgm.rcptseqno+100 AS  NUMBER)      
                            ,   dcgm.seqno
                            ,   dcgm.instcd
                            ,   'D'
                            ,   dcgm.ordtype
                            ,   dcgm.discreduflag
                            ,   dcgm.discreducd
                            ,   CAST(dcgm.discreduamt * -1 AS NUMBER(10,0))      
                            ,   dcgm.apprsn
                            ,   CAST(#opmi_rcptexecdd# AS VARCHAR2(8))
                            ,   CAST(#opmi_rcpttm#   AS VARCHAR2(6))
                            ,   CAST(#opmi_rcptrid#  AS VARCHAR2(10)) 
                            ,   dcgm.remfact
                            ,   #sessuserid# 
                            ,   SYSTIMESTAMP 
                            ,   #sessuserid# 
                            ,   SYSTIMESTAMP
                            ,   dcgm.emplno
                            ,   dcgm.famyrelcd
                            ,   dcgm.empkindcd
                            ,   dcgm.emplrgstno
                            ,   dcgm.dutdeptnm
                            
                    FROM pam.padhdcgm dcgm, pam.paohopmi opmi
                   WHERE opmi.pid         = #opmi_pid#
                     AND opmi.orddd       = #opmi_orddd#    
                     AND opmi.cretno      = #opmi_cretno#
                     AND opmi.instcd      = #sessinstcd#   
                     AND dcgm.pid         = opmi.pid
                     AND dcgm.rcptdd      = opmi.rcptdd
                     AND dcgm.rcptno      = opmi.rcptno
                     AND dcgm.rcptseqno   = opmi.rcptseqno
                     AND dcgm.instcd      = opmi.instcd
                     AND dcgm.rcptstat    = 'Y'
           ]]>
    </statement> 

   <statement id="setDcgmAmtC"><![CDATA[    
        UPDATE pam.padhdcgm
           SET rcptstat ='C'
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP
        WHERE (pid,rcptdd,rcptno,rcptseqno,instcd) IN
                                            (SELECT opmi.pid        AS pid
                                                   ,opmi.rcptdd     AS rcptdd
                                                   ,opmi.rcptno     AS rcptno
                                                   ,opmi.rcptseqno  AS rcptseqno
                                                   ,opmi.instcd     AS instcd
                                               FROM pam.paohopmi opmi
                                                   ,pam.padhdcgm dcgm
                                              WHERE opmi.pid       = #opmi_pid#
                                                AND opmi.orddd     = #opmi_orddd#
                                                AND opmi.cretno    = #opmi_cretno#
                                                AND opmi.instcd    = #sessinstcd# 
                                                AND dcgm.pid       = opmi.pid
                                                AND dcgm.rcptdd    = opmi.rcptdd
                                                AND dcgm.rcptno    = opmi.rcptno
                                                AND dcgm.rcptseqno = opmi.rcptseqno
                                                AND dcgm.instcd    = opmi.instcd
                                                AND dcgm.rcptstat  = 'Y'
                                            )   
           ]]>
    </statement> 

  <!-- 헌혈증할인감액내역 생성  --> 
   <!-- TXPAO00102 -->
   <statement id="insBldcAmt"><![CDATA[    
			INSERT INTO     pam.padhbldc                                                    
								(   pid         
								,   rcptdd                                      
								,   rcptno                                      
								,   rcptseqno  
								,   seqno                   
								,   instcd                                      
								,   rcptstat                                    
								,   ordtype    
								,   orddd
								,   orddeptcd
								,   orddrid
								,   grupcalcscorcd
								,   snglcalcscorcd
								,   appdd
								,   calcqty
								,   calctims
								,   calcdays
								,   calcamt
								,   disccnt
								,   discamt
								,   apprsn
								,   rcptexecdd
								,   rcpttm
								,   rcptrid                                     
								,   remfact                                     
								,   fstrgstrid                                  
								,   fstrgstdt                                   
								,   lastupdtrid                                 
								,   lastupdtdt 
								,   prcpdd       
								,   prcpno       
								,   prcphistno   
								,   execprcpseqno
								,   cretno
								
                    )  
                    SELECT                  
                          CAST(#pid#                                      AS VARCHAR2(10))           
                        , CAST(#rcptdd#                                   AS VARCHAR2(8))     
                        , CAST(#rcptno#                                   AS NUMBER)     
                        , CAST(#rcptseqno#                                AS NUMBER)      
                        , NVL(CAST(MAX(CAST(seqno AS INTEGER)) AS INTEGER),0)+1       
                        , CAST(#sessinstcd#                                   AS VARCHAR2(3))       
                        , CAST(#rcptstat#                                 AS VARCHAR2(1))    
                        , CAST(#ordtype#                                  AS VARCHAR2(1)) 
                        , CAST(#orddd#                                    AS VARCHAR2(8)) 
                        , CAST(#orddeptcd#                                AS VARCHAR2(10)) 
                        , CAST(#orddrid#                                  AS VARCHAR2(10)) 
                        , CAST(#grupcalcscorcd#                           AS VARCHAR2(12)) 
                        , CAST(#snglcalcscorcd#                           AS VARCHAR2(12)) 
                        , CAST(#appdd#                                    AS VARCHAR2(8)) 
                        , CAST(#calcqty#                                  AS NUMBER(11,5)) 
                        , CAST(#calctims#                                 AS NUMBER(6,2))      
                        , CAST(#calcdays#                                 AS NUMBER)      
                        , CAST(#calcamt#                                  AS NUMBER(10))      
                        , CAST(#disccnt#                                  AS NUMBER)      
                        , CAST(#discamt#                                  AS NUMBER(10))     
                        , CAST(#apprsn#                                   AS VARCHAR2(50))
                        , CAST(#rcptexecdd#                               AS VARCHAR2(8))   
                        , CAST(#rcpttm#                                   AS VARCHAR2(6))       
                        , CAST(#rcptrid#                                  AS VARCHAR2(10)) 
                        , CAST(#remfact#                                  AS VARCHAR2(100))  
                        , #sessuserid#  
                        , SYSTIMESTAMP
                        , #sessuserid# 
                        , SYSTIMESTAMP
                        , #prcpdd#       
                        , #prcpno#       
                        , #prcphistno#   
                        , #execprcpseqno#
						, #cretno#
						
                   FROM   pam.padhbldc          
                  WHERE  pid        = #pid#
                    AND  rcptdd     = #rcptdd#    
                    AND  rcptno     = #rcptno#    
                    AND  rcptseqno  = #rcptseqno#    
                    AND  instcd     = #sessinstcd#   
           ]]>
    </statement> 

   <statement id="insBldcAmtDC"><![CDATA[    
        INSERT INTO     pam.padhbldc                                          
                            (   pid
                            ,   rcptdd                                      
                            ,   rcptno                                      
                            ,   rcptseqno  
                            ,   seqno                   
                            ,   instcd                                      
                            ,   rcptstat                                    
                            ,   ordtype    
                            ,   orddd
                            ,   orddeptcd
                            ,   orddrid
                            ,   grupcalcscorcd
                            ,   snglcalcscorcd
                            ,   appdd
                            ,   calcqty
                            ,   calctims
                            ,   calcdays
                            ,   calcamt
                            ,   disccnt
                            ,   discamt
                            ,   apprsn
                            ,   rcptexecdd
                            ,   rcpttm
                            ,   rcptrid                                     
                            ,   remfact                                     
                            ,   fstrgstrid                                  
                            ,   fstrgstdt                                   
                            ,   lastupdtrid                                 
                            ,   lastupdtdt
                            ,   prcpdd       
                            ,   prcpno       
                            ,   prcphistno   
                            ,   execprcpseqno
							,   cretno
							
                            )  
                SELECT                  
                                bldc.pid     
                            ,   bldc.rcptdd
                            ,   bldc.rcptno
                            ,   CAST(bldc.rcptseqno+100 AS  INTEGER)      
                            ,   bldc.seqno
                            ,   bldc.instcd
                            ,   'D'
                            ,   bldc.ordtype
                            ,   bldc.orddd
                            ,   bldc.orddeptcd
                            ,   bldc.orddrid
                            ,   bldc.grupcalcscorcd
                            ,   bldc.snglcalcscorcd
                            ,   bldc.appdd
                            ,   bldc.calcqty * -1
                            ,   bldc.calctims * -1
                            ,   bldc.calcdays * -1
                            ,   bldc.calcamt * -1
                            ,   bldc.disccnt * -1
                            ,   bldc.discamt * -1
                            ,   bldc.apprsn
                            ,   CAST(#opmi_rcptexecdd#   AS VARCHAR2(8))
                            ,   CAST(#opmi_rcpttm#       AS VARCHAR2(6))
                            ,   CAST(#opmi_rcptrid#      AS VARCHAR2(10)) 
                            ,   bldc.remfact
                            ,   #sessuserid# 
                            ,   SYSTIMESTAMP
                            ,   #sessuserid# 
                            ,   SYSTIMESTAMP
                            ,   bldc.prcpdd       
                            ,   bldc.prcpno       
                            ,   bldc.prcphistno   
                            ,   bldc.execprcpseqno
							,   bldc.cretno
							
                    FROM    pam.padhbldc bldc
                         ,  pam.paohopmi opmi       
                   WHERE    opmi.pid            = #opmi_pid#
                     AND    opmi.orddd          = #opmi_orddd#    
                     AND    opmi.cretno         = #opmi_cretno#
                     AND    opmi.instcd         = #sessinstcd#   
                     AND    bldc.pid            = opmi.pid
                     AND    bldc.rcptdd         = opmi.rcptdd
                     AND    bldc.rcptno         = opmi.rcptno
                     AND    bldc.rcptseqno      = opmi.rcptseqno
                     AND    bldc.instcd         = opmi.instcd
                     AND    bldc.rcptstat       = 'Y'
           ]]>
    </statement> 

   <statement id="setBldcAmtC"><![CDATA[    
        UPDATE  pam.padhbldc
           SET  rcptstat ='C'
              , lastupdtrid = #sessuserid#
              , lastupdtdt  = SYSTIMESTAMP
        WHERE   (pid , rcptdd, rcptno, rcptseqno, instcd) IN
                (SELECT opmi.pid       AS pid
                     , opmi.rcptdd     AS rcptdd
                     , opmi.rcptno     AS rcptno
                     , opmi.rcptseqno  AS rcptseqno
                     , opmi.instcd     AS instcd
                   FROM pam.paohopmi opmi,  pam.padhbldc bldc
                  WHERE opmi.pid       = #opmi_pid#
                    AND opmi.orddd     = #opmi_orddd#
                    AND opmi.cretno    = #opmi_cretno#
                    AND opmi.instcd    = #sessinstcd# 
                    AND bldc.pid       = opmi.pid
                    AND bldc.rcptdd    = opmi.rcptdd
                    AND bldc.rcptno    = opmi.rcptno
                    AND bldc.rcptseqno = opmi.rcptseqno
                    AND bldc.instcd    = opmi.instcd
                    AND bldc.rcptstat  = 'Y'
                  )   
           ]]>
    </statement> 

   <!-- 카드내역 생성(정산시) 내부처리용으로 생성 --> 
   <!-- TXPAO00102 -->
   <statement id="insCardAmtDC"><![CDATA[    
        INSERT INTO     pam.pamhcard
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd          
                            ,   rcptno          
                            ,   rcptseqno       
                            ,   seqno           
                            ,   instcd          
                            ,   rcptstat        
                            ,   ordtype         
                            ,   keyinptflag           
                            ,   cardcmpycd       
                            ,   cardno         
                            ,   aprvflag          
                            ,   aprvdd        
                            ,   aprvtm        
                            ,   aprvno    
                            ,   vancd         
                            ,   allotmm          
                            ,   cardamt         
                            ,   valiterm
                            ,   rcptexecdd      
                            ,   rcpttm          
                            ,   rcptrid         
                            ,   innrtretyn
                            ,   preamtyn
                            ,   remfact         
                            ,   fstrgstrid      
                            ,   fstrgstdt       
                            ,   lastupdtrid     
                            ,   lastupdtdt 
                            )  
                SELECT                  
                                card.pid
							,   card.orddd
							,   card.cretno
                            ,   card.rcptdd
                            ,   card.rcptno
                            ,   CAST(card.rcptseqno+100 AS  NUMBER)      
                            ,   card.seqno 
                            ,   card.instcd
                            ,   'D'
                            ,   card.ordtype
                            ,   card.keyinptflag
                            ,   card.cardcmpycd
                            ,   card.cardno
                            ,   card.aprvflag
                            ,   card.aprvdd
                            ,   card.aprvtm
                            ,   card.aprvno
                            ,   card.vancd
                            ,   card.allotmm
                            ,   CAST(card.cardamt * -1  AS NUMBER(10,0))      
                            ,   card.valiterm
                            ,   CAST(#opmi_rcptexecdd#  AS VARCHAR2(8))
                            ,   CAST(#opmi_rcpttm#      AS VARCHAR2(6))
                            ,   CAST(#opmi_rcptrid#     AS VARCHAR2(10)) 
                            ,   'Y'                     --내부처리여부 
                            ,   card.preamtyn
                            ,   card.remfact
                            ,   #sessuserid# 
                            ,   SYSTIMESTAMP
                            ,   #sessuserid#
                            ,   SYSTIMESTAMP
                    FROM    pam.pamhcard  card
                        ,   pam.paohopmi  opmi          
                  WHERE opmi.pid            = #opmi_pid#      
                       AND  opmi.orddd      = #opmi_orddd#    
                       AND  opmi.cretno     = #opmi_cretno#   
                       AND  opmi.instcd     = #sessinstcd#        
                       AND  card.pid        = opmi.pid        
                       AND  card.rcptdd     = opmi.rcptdd     
                       AND  card.rcptno     = opmi.rcptno     
                       AND  card.rcptseqno  = opmi.rcptseqno  
                       AND  card.instcd     = opmi.instcd     
                       AND  card.rcptstat   = 'Y'             
           ]]>
    </statement> 

   <statement id="setCardAmtC"><![CDATA[    
        UPDATE pam.pamhcard
           SET rcptstat ='C'
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP
         WHERE  (pid,rcptdd,rcptno,rcptseqno,instcd) IN
                                            (SELECT opmi.pid        AS pid
                                                   ,opmi.rcptdd     AS rcptdd
                                                   ,opmi.rcptno     AS rcptno
                                                   ,opmi.rcptseqno  AS rcptseqno
                                                   ,opmi.instcd     AS instcd
                                              FROM  pam.paohopmi opmi
                                                   ,pam.pamhcard card
                                              WHERE opmi.pid       = #opmi_pid#
                                                AND opmi.orddd     = #opmi_orddd#
                                                AND opmi.cretno    = #opmi_cretno#
                                                AND opmi.instcd    = #sessinstcd#
                                                AND card.pid       = opmi.pid
                                                AND card.rcptdd    = opmi.rcptdd
                                                AND card.rcptno    = opmi.rcptno
                                                AND card.rcptseqno = opmi.rcptseqno
                                                AND card.instcd    = opmi.instcd
                                                AND  card.rcptstat = 'Y'
                                             )
           ]]>
    </statement> 
    
   <!-- 현금영수증내역 생성(정산시) 내부처리용으로 생성 --> 
   <!-- TXPAO00102 -->
   <statement id="insCashAmtDC"><![CDATA[    
        INSERT INTO pam.pachcash(   
                        pid 
					,   orddd
					,   cretno
                    ,   rcptdd          
                    ,   rcptno          
                    ,   rcptseqno       
                    ,   seqno           
                    ,   instcd          
                    ,   rcptstat        
                    ,   ordtype         
                    ,   keyinptflag  
                    ,   indinstflag
                    ,   qualcnfmflag
                    ,   qualcnfmno
                    ,   aprvflag          
                    ,   aprvno    
                    ,   aprvdd        
                    ,   aprvtm        
                    ,   cashamt
                    ,   rcptexecdd      
                    ,   rcpttm          
                    ,   rcptrid         
                    ,   preamtyn
                    ,   innrtretyn
                    ,   remfact         
                    ,   fstrgstrid      
                    ,   fstrgstdt       
                    ,   lastupdtrid     
                    ,   lastupdtdt 
                    )  
        SELECT                  
                        cash.pid
					,   cash.orddd
					,   cash.cretno
                    ,   cash.rcptdd
                    ,   cash.rcptno
                    ,   CAST(cash.rcptseqno+100 AS  NUMBER)      
                    ,   cash.seqno 
                    ,   cash.instcd
                    ,   'D'
                    ,   cash.ordtype
                    ,   cash.keyinptflag
                    ,   cash.indinstflag
                    ,   cash.qualcnfmflag
                    ,   cash.qualcnfmno
                    ,   cash.aprvflag
                    ,   cash.aprvno
                    ,   cash.aprvdd
                    ,   cash.aprvtm
                    ,   CAST(cash.cashamt * -1 AS NUMBER(10,0)) 
                    ,   CAST(#opmi_rcptexecdd# AS VARCHAR2(8))
                    ,   CAST(#opmi_rcpttm#     AS VARCHAR2(6))
                    ,   CAST(#opmi_rcptrid#    AS VARCHAR2(10)) 
                    ,   cash.preamtyn
                    ,   'Y'                    --내부처리여부 
                    ,   cash.remfact
                    ,   #sessuserid# 
                    ,   SYSTIMESTAMP
                    ,   #sessuserid#
                    ,   SYSTIMESTAMP
            FROM    pam.pachcash  cash
                ,   pam.paohopmi  opmi          
            WHERE opmi.pid       = #opmi_pid#     
              AND opmi.orddd     = #opmi_orddd#   
              AND opmi.cretno    = #opmi_cretno#  
              AND opmi.instcd    = #sessinstcd#       
              AND cash.pid       = opmi.pid       
              AND cash.rcptdd    = opmi.rcptdd    
              AND cash.rcptno    = opmi.rcptno    
              AND cash.rcptseqno = opmi.rcptseqno 
              AND cash.instcd    = opmi.instcd    
              AND cash.rcptstat  = 'Y'           
           ]]>
    </statement> 

   <statement id="setCashAmtC"><![CDATA[    
        UPDATE pam.pachcash
           SET rcptstat ='C'
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP
         WHERE (pid,rcptdd,rcptno,rcptseqno,instcd) IN
                                            (SELECT opmi.pid        AS pid
                                                  , opmi.rcptdd     AS rcptdd
                                                  , opmi.rcptno     AS rcptno
                                                  , opmi.rcptseqno  AS rcptseqno
                                                  , opmi.instcd     AS instcd
                                              FROM  pam.paohopmi opmi
                                                   ,pam.pachcash cash
                                              WHERE opmi.pid       = #opmi_pid#
                                                AND opmi.orddd     = #opmi_orddd#
                                                AND opmi.cretno    = #opmi_cretno#
                                                AND opmi.instcd    = #sessinstcd#
                                                AND cash.pid       = opmi.pid
                                                AND cash.rcptdd    = opmi.rcptdd
                                                AND cash.rcptno    = opmi.rcptno
                                                AND cash.rcptseqno = opmi.rcptseqno
                                                AND cash.instcd    = opmi.instcd
                                                AND cash.rcptstat  = 'Y'
                                                ) 
           ]]>
    </statement> 

   <!-- 보증금내역 생성(정산시) 내부처리용으로 생성 --> 
   <!-- TXPAO00102 -->
   <statement id="insBogjAmtDC"><![CDATA[    
        INSERT INTO pam.paohbogj (  
                    pid             
                ,   rcptdd          
                ,   rcptno          
                ,   rcptseqno       
                ,   seqno           
                ,   instcd          
                ,   rcptstat        
                ,   ordtype         
                ,   rcptflag
                ,   cashamt
                ,   cardamt
                ,   onlineamt                           
                ,   rcptexecdd      
                ,   rcpttm          
                ,   rcptrid
                ,   orddeptcd
                ,   remfact         
                ,   paypsnflag
                ,   paydepoamt
                ,   paypsnrem
                ,   fstrgstrid      
                ,   fstrgstdt       
                ,   lastupdtrid     
                ,   lastupdtdt 
          )  
           SELECT                   
                    bogj.pid
                ,   bogj.rcptdd
                ,   bogj.rcptno
                ,   CAST(bogj.rcptseqno+100 AS  NUMBER)      
                ,   bogj.seqno 
                ,   bogj.instcd
                ,   'D'
                ,   bogj.ordtype
                ,   bogj.rcptflag
                ,   CAST(bogj.cashamt * -1    AS NUMBER(10,0))   
                ,   CAST(bogj.cardamt * -1    AS NUMBER(10,0)) 
                ,   CAST(bogj.onlineamt * -1  AS NUMBER(10,0)) 
                ,   CAST(#opmi_rcptexecdd#    AS VARCHAR2(8))
                ,   CAST(#opmi_rcpttm#        AS VARCHAR2(6))
                ,   CAST(#opmi_rcptrid#       AS VARCHAR2(10))                          
                ,   bogj.orddeptcd
                ,   bogj.remfact
                ,   bogj.paypsnflag
                ,   bogj.paydepoamt
                ,   bogj.paypsnrem
                ,   CAST(#opmi_rcptrid#  AS VARCHAR2(10)) 
                ,   SYSTIMESTAMP
                ,   CAST(#opmi_rcptrid#  AS VARCHAR2(10)) 
                ,   SYSTIMESTAMP    
            FROM    pam.paohbogj bogj
                ,   pam.paohopmi opmi           
          WHERE opmi.pid    = #opmi_pid#
            AND opmi.orddd  = #opmi_orddd#    
            AND opmi.cretno = #opmi_cretno#
            AND opmi.instcd = #sessinstcd#   
            AND bogj.pid    = opmi.pid
            AND bogj.rcptdd     = opmi.rcptdd
            AND bogj.rcptno     = opmi.rcptno
            AND bogj.rcptseqno  = opmi.rcptseqno
            AND bogj.instcd     = opmi.instcd 
            AND bogj.rcptstat   = 'Y'
           ]]>
    </statement> 

   <statement id="setBogjAmtC"><![CDATA[    
        UPDATE      pam.paohbogj
              SET       rcptstat            ='C'
                    ,       lastupdtrid = #opmi_rcptrid#
                    ,       lastupdtdt      = SYSTIMESTAMP
        WHERE           (pid , rcptdd, rcptno, rcptseqno, instcd) IN
                            (SELECT     opmi.pid                AS pid
                                        ,   opmi.rcptdd         AS rcptdd
                                        ,   opmi.rcptno         AS rcptno
                                        ,   opmi.rcptseqno  AS rcptseqno
                                        ,   opmi.instcd         AS instcd
                                FROM    pam.paohopmi opmi
                                        ,   pam.paohbogj bogj
                              WHERE     opmi.pid                = #opmi_pid#
                                   AND      opmi.orddd          = #opmi_orddd#
                                   AND      opmi.cretno             = #opmi_cretno#
                                   AND      opmi.instcd             = #sessinstcd# 
                                   AND      bogj.pid                = opmi.pid
                                   AND      bogj.rcptdd         = opmi.rcptdd
                                   AND      bogj.rcptno         = opmi.rcptno
                                   AND      bogj.rcptseqno  = opmi.rcptseqno
                                   AND      bogj.instcd             = opmi.instcd
                                   AND  bogj.rcptstat           = 'Y'
                                    )   
           ]]>
    </statement> 

   <!-- 기 카드내역 생성(정산시) 내부처리용으로 생성 --> 
   <!-- TXPAO00102 -->
   <statement id="insPreCardAmt"><![CDATA[    
        INSERT INTO     pam.pamhcard
                            (   pid
							,   orddd
							,   cretno
                            ,   rcptdd          
                            ,   rcptno          
                            ,   rcptseqno       
                            ,   seqno           
                            ,   instcd          
                            ,   rcptstat        
                            ,   ordtype         
                            ,   keyinptflag           
                            ,   cardcmpycd       
                            ,   cardno         
                            ,   aprvflag          
                            ,   aprvdd        
                            ,   aprvtm        
                            ,   aprvno    
                            ,   vancd         
                            ,   allotmm          
                            ,   cardamt         
                            ,   valiterm
                            ,   rcptexecdd      
                            ,   rcpttm          
                            ,   rcptrid         
                            ,   innrtretyn
                            ,   preamtyn
                            ,   remfact         
                            ,   fstrgstrid      
                            ,   fstrgstdt       
                            ,   lastupdtrid     
                            ,   lastupdtdt 
                            )  
                SELECT                  
                                card.pid
							,   card.orddd
							,   card.cretno
                            ,   CAST(#opmi_rcptexecdd# AS VARCHAR2(8))
                            ,   CAST(#opmi_rcptno# AS NUMBER)
                            ,   CAST(#opmi_rcptseqno# AS NUMBER)
                            ,   (SELECT     NVL(MAX(seqno),0) + 1
                                FROM        pam.pamhcard
                                WHERE   pid            = #opmi_pid#
                                AND         rcptdd       = #opmi_rcptexecdd#
                                AND         rcptno       = #opmi_rcptno#
                                AND         rcptseqno = #opmi_rcptseqno#
                                AND         instcd       = #sessinstcd#                                 
                                )
                            ,   card.instcd
                            ,   'Y'
                            ,   card.ordtype
                            ,   card.keyinptflag
                            ,   card.cardcmpycd
                            ,   card.cardno
                            ,   card.aprvflag
                            ,   card.aprvdd
                            ,   card.aprvtm
                            ,   card.aprvno
                            ,   card.vancd
                            ,   card.allotmm
                            ,   CAST(card.cardamt * -1 AS  NUMBER(10,0))      
                            ,   card.valiterm
                            ,   CAST(#opmi_rcptexecdd# AS VARCHAR2(8))
                            ,   CAST(#opmi_rcpttm# AS VARCHAR2(6))
                            ,   CAST(#opmi_rcptrid#  AS VARCHAR2(10)) 
                            ,   'Y'                             --내부처리여부 
                            ,   card.preamtyn
                            ,   card.remfact
                            ,   CAST(#opmi_rcptrid#  AS VARCHAR2(10)) 
                            ,   SYSTIMESTAMP
                            ,   CAST(#opmi_rcptrid#  AS VARCHAR2(10)) 
                            ,   SYSTIMESTAMP    
                    FROM    pam.pamhcard  card
                            ,   pam.paohopmi   opmi             
                  WHERE opmi.pid                = #opmi_pid#
                       AND  opmi.orddd              = #opmi_orddd#    
                       AND  opmi.cretno             = #opmi_cretno#
                       AND  opmi.instcd             = #sessinstcd#   
                       AND  card.pid                = opmi.pid
                       AND  card.rcptdd         = opmi.rcptdd
                       AND  card.rcptno         = opmi.rcptno
                       AND  card.rcptseqno  = opmi.rcptseqno
                       AND  card.instcd         = opmi.instcd 
                       AND  card.rcptstat           = 'D'
                       AND  card.rcptexecdd = #opmi_rcptexecdd#
                       AND  card.rcpttm         = #opmi_rcpttm#
           ]]>
    </statement> 


  <!-- 자보보험정보조회(외래수납) --> 
  <!-- insuflag = 3  자보 보험자기호 -->   
  <!-- 여러건이 있을경우, 조건 확인후, 조회조건 추가(승인일자라든지)  -->   
  <!-- TRPAO00103 -->
   <statement id="getAipmInfo"><![CDATA[    
        SELECT  a.pid                           AS aipm_pid                         --등록번호         
                    ,   a.mngtno                    AS aipm_mngtno                  --관리번호         
                    ,   a.seqno                     AS aipm_seqno                       --이력일련번호     
                    ,   a.instcd                    AS aipm_instcd                      --기관코드         
                    ,   a.histstat                  AS aipm_histstat                    --이력상태         
                    ,   a.insukind                  AS aipm_insukind                    --보험유형         
                    ,   a.suppkind                  AS aipm_suppkind                --보조유형         
                    ,   a.autmbinsuseqno    AS aipm_autmbinsuseqno      --자보연번호       
                    ,   a.acddd                     AS aipm_acddd                       --사고일자         
                    ,   a.insucmpycd          AS aipm_insucmpycd        --보험회사코드     
                    ,   a.carno                     AS aipm_carno                       --차량번호         
                    ,   a.chrgrnm                   AS aipm_chrgrnm                 --담당자명         
                    ,   a.chrgrtel                  AS aipm_chrgrtel                    --담당자전화       
                    ,   a.ordopendd             AS aipm_ordopendd               --진료개시일자     
                    ,   a.aprvfromdd            AS aipm_aprvfromdd              --승인시작일자     
                    ,   a.aprvtodd                  AS aipm_aprvtodd                --승인종료일자     
                    ,   a.paylimamt                 AS aipm_paylimamt               --지불한도액       
                    ,   a.chospathcd            AS aipm_chospathcd              --내원경로         
                    ,   a.agreenddd             AS aipm_agreenddd               --합의종결일자     
                    ,   a.endflag                   AS aipm_endflag                     --종결구분         
                    ,   a.endresncd            AS aipm_endresncd            --종결사유코드     
                    ,   a.autmbinsurem       AS aipm_autmbinsurem       --자보참고사항     
                    ,   a.fstrgstrid                AS aipm_fstrgstrid                  --최초등록자ID     
                    ,   a.fstrgstdt                 AS aipm_fstrgstdt                   --최초등록일시     
                    ,   a.lastupdtrid               AS aipm_lastupdtrid             --최종수정자ID     
                    ,   a.lastupdtdt                AS aipm_lastupdtdt                  --최종수정일시 
                    ,   c.insucdnm              AS aipm_insucdnm            --보험회사코드명
            FROM    pam.pmchaipm a
                        LEFT OUTER JOIN pam.pmbmincd c on (a.insucmpycd = c.insucd AND c.histstat ='Y' AND c.insuflag ='3' AND a.instcd = c.instcd) 
        WHERE   a.pid           =   #pid#
            AND     a.histstat  ='Y'
            AND     a.instcd    =   #sessinstcd#
            AND rownum =1
                ]]>
    </statement> 

  <!-- 산재보험정보조회(외래수납) --> 
  <!-- insuflag = 4  산재 보험자기호 -->   
  <!-- 여러건이 있을경우, 조건 확인후, 조회조건 추가(승인일자라든지)  -->   
  <!-- TRPAO00103 -->
   <statement id="getIcpmInfo"><![CDATA[    
        SELECT  a.pid                       AS icpm_pid                     --등록번호    
                    ,   a.mngtno                AS icpm_mngtno              --관리번호    
                    ,   a.seqno                 AS icpm_seqno                   --일련번호    
                    ,   a.instcd                AS icpm_instcd                  --기관코드    
                    ,   a.histstat              AS icpm_histstat                --이력상태    
                    ,   a.insukind              AS icpm_insukind                --이력상태    
                    ,   a.suppkind              AS icpm_suppkind            --보조유형    
                    ,   a.acddd                 AS icpm_acddd                   --사고일자    
                    ,   a.inducsbrchcd   AS icpm_inducsbrchcd    --산재지사코드
                    ,   a.bizplcenm         AS icpm_bizplcenm           --사업장명    
                    ,   a.chrgnm                AS icpm_chrgnm              --담당자명    
                    ,   a.ordopendd        AS icpm_ordopendd       --진료개시일자
                    ,   a.ordtodd               AS icpm_ordtodd                 --진료종료일자
                    ,   a.endflag               AS icpm_endflag                 --종결구분    
                    ,   a.endcnts               AS icpm_endcnts             --종결사유    
                    ,   a.inducsrem        AS icpm_inducsrem        --산재참고사항
                    ,   a.frstrgstrid           AS icpm_frstrgstrid             --최초등록자ID
                    ,   a.frstrgstdt            AS icpm_frstrgstdt              --최초등록일시
                    ,   a.lastupdtrid           AS icpm_lastupdtrid             --최종수정자ID
                    ,   a.lastupdtdt            AS icpm_lastupdtdt              --최종수정일시
                    ,   c.insucdnm          AS icpm_insucdnm            --산재지사코드명
            FROM    pam.pmchicpm a          --산재환자관리
                        LEFT OUTER JOIN pam.pmbmincd c on (a.inducsbrchcd = c.insucd AND c.histstat ='Y' AND c.insuflag ='4' AND a.instcd = c.instcd)
        WHERE   a.pid           =   #pid#
            AND a.histstat  =   'Y'
            AND a.instcd    =   #sessinstcd#
            AND rownum =1
                ]]>
    </statement> 

    <!-- 진료의뢰내역 입력 -->
     <statement id="insCNST1">
        <![CDATA[
        INSERT INTO pam.pmcmcnst
        (
            pid,    
            orddeptcd,  
            insuflag,   
            ordreqkind, 
            todd,   
            seqno,  
            instcd, 
            histstat,   
            fromdd, 
            fstrgstrid, 
            fstrgstdt,  
            lastupdtrid,    
            lastupdtdt
        )
        VALUES
        (
            #cnst_pid#, 
            #cnst_orddeptcd#,   
            #cnst_insuflag#,    
            #cnst_ordreqkind#,  
            #cnst_todd#,    
            (
              SELECT nvl(MAX(seqno),0) + 1
                FROM pam.pmcmcnst
               WHERE pid         = #cnst_pid#
                 AND instcd      = #sessinstcd#            
                 AND orddeptcd   = #cnst_orddeptcd#
                 AND insuflag    = #cnst_insuflag#
                 AND ordreqkind  = #cnst_ordreqkind#
                 AND todd        = #cnst_todd#  
            ),  
            #sessinstcd#,   
            'Y',    
            #cnst_fromdd#,  
            ]]>     
        <isNotEmpty property="cnst_orddeptcd_before">
            <![CDATA[
            #sessuserid#,   
            nvl(#cnst_fstrgstdt#, SYSTIMESTAMP),    
            ]]>
        </isNotEmpty>
        <isEmpty property="cnst_orddeptcd_before">
            <![CDATA[
            #sessuserid#,   
            SYSTIMESTAMP,   
            ]]>
        </isEmpty>
        <![CDATA[
            #sessuserid#,   
            SYSTIMESTAMP
        )
        ]]>
    </statement>
    
    <!-- 진료의뢰내역 수정 -->
     <statement id="setCNST1">
        <![CDATA[
        UPDATE pam.pmcmcnst SET
                      histstat         = 'C',
                      lastupdtrid    = #sessuserid#,    
                      lastupdtdt     = SYSTIMESTAMP
        WHERE  pid                = #cnst_pid#
        AND       instcd              = #sessinstcd#                       
        AND       orddeptcd     = #cnst_orddeptcd_before#
        AND       insuflag         = #cnst_insuflag_before#
        AND       ordreqkind     = #cnst_ordreqkind_before#   
        AND       todd               = #cnst_todd_before#
        AND       seqno            = #cnst_seqno_before#
        ]]>                    
    </statement>
    
    <!-- 진료의뢰내역 삭제 -->
     <statement id="delCNST1">
        <![CDATA[
        DELETE FROM pam.pmcmcnst
        WHERE  pid                = #cnst_pid#
        AND       instcd              = #sessinstcd#            
        AND       orddeptcd     = #cnst_orddeptcd_before#
        AND       insuflag         = #cnst_insuflag_before#
        AND       ordreqkind     = #cnst_ordreqkind_before#   
        AND       todd               = #cnst_todd_before#
        AND       seqno            = #cnst_seqno_before#
        ]]>                    
    </statement>

<!-- 외래처방내역의 처방상태코드  MMOHOPRC update( Hold/처방 상태 210/000)  -->    
<!-- 실시일자별 수납시와 오더일자별 수납시의 조건값 확인 -->
    <statement id="setOutOprcHold"><![CDATA[    
        UPDATE emr.MMOHOPRC
           SET prcpstatcd = CASE  WHEN prcpstatcd <= '230' THEN #prcp_prcpstatcd#
                                             ELSE prcpstatcd
                                              END
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP 
         WHERE pid =   #prcp_pid#
           AND prcpdd            = #prcp_prcpdd#
           AND prcpno            = #prcp_prcpno#
           AND prcphistno        = #prcp_prcphistno#
           AND prcphistcd        = 'O'
           AND prcpcd            = #prcp_calcscorcd#
           AND prcpstatcd        = #prcp_preprcpstatcd#
           AND prcpflag          in ('1','3')
           AND tempprcpflag      <> 'Y'
           AND hscttempprcpflag  <> 'Y'
           AND instcd            = #sessinstcd#
           ]]>         
    </statement> 

<!-- 외래처방내역의 처방상태코드  MMODEXOP update(Hold/처방 상태 210/000)  -->    
<!-- 실시일자별 수납시와 오더일자별 수납시의 , 조건 값 확인 -->
    <statement id="setOutExopHold"><![CDATA[    
        UPDATE emr.mmodexop
           SET execrcptstatcd = #prcp_prcpstatcd#
              ,lastupdtrid    = #sessuserid#
              ,lastupdtdt     = SYSTIMESTAMP 
         WHERE pid            = #prcp_pid#
           AND prcpdd         = #prcp_prcpdd#
           AND prcpno         = #prcp_prcpno#
           AND prcphistno     = #prcp_prcphistno#
           AND execprcpno     = #prcp_execprcpno#
           AND execprcphistcd = 'O'
           AND calcscorcd     = #prcp_calcscorcd#
           AND execprcpstatcd = #prcp_preprcpstatcd#
           AND instcd         = #sessinstcd#
           ]]>
    </statement> 


     <!-- 외래처방에 대한 실시(Acting)처방 정보 원무용 트리거 --> 
     <statement id="InsExopTriger"><![CDATA[    
       INSERT INTO pam.paohexop (
									   prcpdd                 
									 , prcpno                 
									 , prcphistno           
									 , execprcpno         
									 , instcd 
									 , seqno
									 , pid                         
									 , orddd                   
									 , cretno
									 , acptseqno
									 , execprcphistcd    
									 , execprcpstatcd   
									 , execrcptstatcd   
									 , execprcpuniqno  
									 , calcscorcd          
									 , actorddd              
									 , actcretno            
									 , pamexecdd            
									 , pamenddd              
									 , execdd                  
									 , exectm                  
									 , execrid                 
									 , execdeptcd          
									 , fstrgstrid            
									 , fstrgstdt            
									 , lastupdtrid          
									 , lastupdtdt   

                        ) 
							select		
									   m.prcpdd                 
									 , m.prcpno                 
									 , m.prcphistno           
									 , m.execprcpno         
									 , m.instcd
									 ,NVL((select max(seqno)+1 from pam.paohexop p
														  where p.instcd = m.instcd
															 and p.prcpdd = m.prcpdd
															 and p.prcpno = m.prcpno
															 and p.prcphistno = m.prcphistno
															 and p.execprcpno = m.execprcpno),1) as seqno
									 , m.pid                         
									 , m.orddd                   
									 , m.cretno 
									 


                              ,(SELECT max(b.acptseqno)
                                 FROM pam.pmohhist b
                                WHERE b.pid      = m.pid
                                     AND b.orddd    = m.orddd
                                     AND b.cretno   = m.cretno
                                     AND b.instcd   = m.instcd
									 AND b.histstat  in ('R','T')
									 AND b.calcflag in ( 'Y','N')
                                  )



									 , m.execprcphistcd    
									 , m.execprcpstatcd   
									 , m.execrcptstatcd   
									 , m.execprcpuniqno  
									 , m.calcscorcd          
									 , m.actorddd              
									 , m.actcretno            
									 , m.pamexecdd            
									 , m.pamenddd              
									 , m.execdd                  
									 , m.exectm                  
									 , m.execrid                 
									 , m.execdeptcd          
									 , m.fstrgstrid            
									 , SYSTIMESTAMP          
									 , m.lastupdtrid          
									 , SYSTIMESTAMP
		  FROM emr.mmodexop m  
        WHERE m.pid                = #prcp_pid#
             AND m.prcpdd           = #prcp_prcpdd#
             AND m.prcpno           = #prcp_prcpno#
             AND m.prcphistno       = #prcp_prcphistno#
             AND m.execprcpno     = #prcp_execprcpno#
             AND m.execprcphistcd = 'O'
             AND m.calcscorcd      = #prcp_calcscorcd#
             AND m.execrcptstatcd = #prcp_preprcpstatcd#
             AND m.instcd             = #sessinstcd#
                     
     ]]>
    </statement> 

<!--
	 AND b.calcflag = (select decode(t.calcflag,'S','Y',t.calcflag)
						   from pam.pmohotpt t 
						 where t.pid = b.pid 
							and t.instcd = b.instcd 
							and t.orddd = b.orddd
							and t.cretno = b.cretno 
							and rownum = 1)
-->

<!-- 홀드처방 Release 시, 외래등록내역 추가   -->
    <statement id="setAddOTPTFromHold"><![CDATA[    
        INSERT INTO pam.pmohotpt (
             pid                  --환자의 고유ID                                                                                                                                                           
            ,orddd                --외래등록일자:접수일자,예약일자                                                                                                                                    
            ,cretno               --외래등록 생성번호(환자의 진료일자별 생성번호)                                                                                                                     
            ,acptseqno            --외래등록 생성번호별 이력 일련번호                                                                                                                             
            ,instcd               --병원별 기관코드                                                                                                                                                       
            ,histstat             --이력상태(코드군 P0029참조)                                                                                                                                            
            ,orgorddd             --원 진료(처방)일자-실시일자 정산을 한 경우,키정보 진료일자는 실시일자가 되고,원 진료일자는 변경되지 않는다.                                                        
            ,orgcretno            --원 외래등록 생성번호-실시일자별 정산한 경우, 실시일자별 외래등록내역에 원 외래등록 생성번호 관리(최초 생성시에는 생성번호,원생성번호가 같음)                      
            ,calcbaseflag         --계산기준구분(1:오더일자,2:실시일자)                                                                                                                           
            ,calcyn               --정산여부(N:건별수납 Y:정산)                                                                                                                                       
            ,ordtm                --진료시간                                                                                                                                                              
            ,orddeptcd            --진료과코드                                                                                                                                                        
            ,orddrid              --진료의ID                                                                                                                                                          
            ,dutdeptcd            --근무부서코드(의사의 인사발령 부서코드:의사가 센터와 독립과 모두 진료볼 경우 보통 독립과가 근무부서 코드가 됨)                                                     
            ,centcd               --센터코드(진료과코드가 센터코드 하위개념일 경우 사용할 예정)                                                                                                       
            ,supdeptcd            --상위부서코드                                                                                                                                                  
            ,mskind               --주부유형:자보환자가 같은 진료일자에 다른 보험유형의 치료를 받을 경우(기왕증)(주유형 M, 그 밖에 부유형)                                                            
            ,insukind             --보험유형(건강보험,의료급여,산재,자보 등)(코드군 P0008 참조)                                                                                                       
            ,suppkind             --보조유형(정상급여,본인부담100% 등)(코드군 P0010 참조)                                                                                                             
            ,insucd               --보험자코드(보험자기호)                                                                                                                                            
            ,suppkindresn         --보조유형에 대한 사유코드(코드군 P0032 참조)                                                                                                                  
            ,specordyn            --선택진료여부(Y:선택진료산정, N:선택진료미산정, S:진찰료만 선택진료 미산정)                                                                                    
            ,holiflag             --공휴일구분                                                                                                                                                            
            ,fsexamflag           --초재진구분(코드군 P0021 참조)                                                                                                                                     
            ,fsexammanlyn         --초재진구분 수동부여여부(수동부여:Y, 디폴트:N)                                                                                                                 
            ,ordtype              --진료형태(외래 O, 응급 E ,입원 I)                                                                                                                                  
            ,brateflag            --외래는 O /응급진료 6시간이하일 경우,외래부담률 O/응급진료 6시간이상일 경우,입원부담률 I                                                                           
            ,medamtestmyn         --진찰료산정여부(Y:산정, N:미산정=무료)                                                                                                                         
            ,medamtpostyn         --진찰료 후불여부(진찰료 산정을 선택시 선후불구분) N:디폴트(선불) , Y:후불                                                                                      
            ,medamtfreeresn       --진찰료 면제 사유(진찰료 산정여부가 N=미산정,무료일때 미산정 사유(코드군 P0342 참조))                                                                          
            ,rsrvflag             --예약구분(코드군 P0341 참조) C.진료의뢰 D.과예약 I.인터넷 K.RC N.- T.전화 U.followup)                                                                                  
            ,etcordflag           --(코드군 P0022 참조)F:보호자대진,N:가정간호,M:물리치료,J:주사                                                                                                      
            ,disccd               --할인코드                                                                                                                                                          
            ,hosoutexptresncd     --원외예외사유코드                                                                                                                                          
            ,clincstdyacptflag    --N:임상시험접수아님, P:사람임상 A:동물임상                                                                                                                    
            ,clincstdyno          --임상시험번호(과제번호)                                                                                                                                            
            ,chrtlendyn           --챠트대출여부                                                                                                                                                      
            ,specorddescyn        --전화예약 부가정보-선택진료설명여부                                                                                                                        
            ,ordreqdescyn         --전화예약 부가정보-진료의뢰서 설명여부                                                                                                                       
            ,ordreqhospgrde       --전화예약 부가정보-진료의뢰서 설명병원 등급(1차,2차)                                                                                                           
            ,insuchrgyn           --전화예약 부가정보-보험회사담당자여부                                                                                                                              
            ,nursacptyn           --간호사접수여부                                                                                                                                                    
            ,nursacptdt           --간호사접수일시                                                                                                                                                    
            ,dracptyn             --의사접수여부                                                                                                                                                      
            ,dracptdt             --의사접수일시                                                                                                                                                      
            ,prcpgenryn           --처방발생여부(진료파트에서 입력)(코드군 P0036 참조)                                                                                                            
            ,prcpnotoccrresn      --처방미발생사유코드(진료파트에서 입력)(코드군 등록신청중)                                                                                                      
            ,estmspclappyn        --산정특례적용여부(진료부에서 입력)Y:산정특례 적용(적용시, 유형보조도 변경)/N:산정특례 미적용                                                                   
            ,elbulbodstat         --전광판 상태(진료파트에서 입력)                                                                                                                                           
            ,elbulbodstatdt       --전광판상태입력일시-진료파트에서 입력                                                                                                                                   
            ,calcflag             --Y : 필요, S : 수가계산 후 미수납, N : 수납완료 및 계산 불필요 Y -> S -> N                                                                                                
            ,calcmthdflag         --계산방법구분(P:정액,D:DRG,N:개별계산,산, O:인공신장)                                                                                                                   
            ,dnoracptyn           --공여자접수여부-공여자 관련 검사를 위한 접수여부                                                                                                                        
            ,rqstflag             --협력의뢰구분-협력의뢰 외래예약일 경우, 협력의뢰/검사의뢰 구분(디폴트는 1:협력의뢰,자애병원은 2:검사의뢰를 별도 구분함)(코드군 P0329 참조)                                    
            ,rqsthospcd           --협력의뢰병원코드                                                                                                                                                       
            ,rqstdrid             --협력의뢰의ID                                                                                                                                                                                                                                                                                                            
            ,tdayinflag           --당일입원구분(M:주유형입원,S:부유형입원)                                                                                                                                  
            ,tranindd             --전환입원일자(재원기간중 실시한 오더접수내역 전환 후 입원일자 세팅)                                                                                                       
            ,rcptdd               --영수일자                                                                                                                                                                 
            ,rcptno               --영수증번호                                                                                                                                                               
            ,rcptseqno            --영수증일련번호
            ,telrsrvrem           --전화예약참고사항
            ,updtcnclresn         --변경취소사유
            ,fstacptid            --최조접수자ID                                                                                                                                                             
            ,fstacptdt            --최초접수일시                                                                                                                                                             
            ,fstrgstrid           --최초등록자ID                                                                                                                                                                 
            ,fstrgstdt            --최초등록일시                                                                                                                                                                 
            ,lastupdtrid          --최종수정자ID                                                                                                                                                             
            ,lastupdtdt           --최종수정일시                                                                                                                                                             
            ,ordreqformflag       --진료의뢰서구분(코드군 P0380 참조 )                                                                                                                                     
            ,prcplockid           --처방 LOCK ID                                                                                                                                                             
            ,dschjudgprcsstat     --퇴원심사진행 상태                                                                                                                                                      
            ,judgmdlid            --심사중인 심사자 ID                                                                                                                                                       
            ,lastjudgdt           --최종심사 일자                                                                                                                                                            
            ,mainjudgid           --주심사자                                                                                                                                                                 
            ,probjudgflag         --재원 심사시 문제환자 체크 '-' : 해당사항 없음, 'G': 문제 중요 하(grren), 'R': 문제 중요 상(red)                                                                        
            ,spcljudgflag         --선별심사여부('-':default 해당없음, 'A':선별심사(자동체크), 'B':선별심사(심사자체크), 'C':선별심사(실시간체크))                                                           
            ,handicaprbookpossnyn --장애인수첩제출여부                                                                                                                                                                          
            ,outercdrgstyn        -- 외부CD등록여부                                                                                                                                                                             
            ,undersixageyn        -- 6세미만여부                                                                                                                                                           
            ,remfact              -- 재진예약참고사항                                                                                                                                                      
            ,spclcd                                                                                                                                                                      
            ,onestop              -- 원스탑                                                                                                                                                                
            ,ownbflag             -- 본인부담구분(코드군 P0365 참조)                                                                                                                     
            ,ordpatyn             -- 진료환자여부                                                                                                                                                          
            ,uncocd               -- 미수코드                                                                                                                                                              
            ,pmflag               -- 오후진료 FLAG                                                                                                                                                         
            ,emplno               -- 계정감면 직원사번                            
            ,suppkindsubyn        -- 보조유형의 부과 여부 주과 N, 부과 Y
            ,earnendyn                                                        
            ,rareobstflag         --희귀난치대상자구분                            
            ,tranflag             --입원외래덤프
            ,onlnno
            ,inetproxyrrgstno
            ,holdflag
			,subdeptcd
            --,mig
            )                                                                     
    SELECT   pid                  --환자의 고유ID                                                                                                                                    
            ,orddd                --외래등록일자:접수일자,예약일자                                                                                                                   
            ,cretno               --외래등록 생성번호(환자의 진료일자별 생성번호)                                                                                                    
            ,1                                                                                                   
            ,instcd               --병원별 기관코드                                                                                                                                  
            ,'R'                  --이력상태(코드군 P0029참조)                                                                                                                       
            ,orgorddd             --원 진료(처방)일자-실시일자 정산을 한 경우,키정보 진료일자는 실시일자가 되고,원 진료일자는 변경되지 않는다.                                       
            ,orgcretno            --원 외래등록 생성번호-실시일자별 정산한 경우, 실시일자별 외래등록내역에 원 외래등록 생성번호 관리(최초 생성시에는 생성번호,원생성번호가 같음)     
            ,calcbaseflag         --계산기준구분(1:오더일자,2:실시일자)                                                                                                              
            ,calcyn               --정산여부(N:건별수납 Y:정산)                                                                                                                      
            ,ordtm                --진료시간                                                                                                                                         
            ,orddeptcd            --진료과코드                                                                                                                                       
            ,orddrid              --진료의ID                                                                                                                                         
            ,dutdeptcd            --근무부서코드(의사의 인사발령 부서코드:의사가 센터와 독립과 모두 진료볼 경우 보통 독립과가 근무부서 코드가 됨)                                    
            ,centcd               --센터코드(진료과코드가 센터코드 하위개념일 경우 사용할 예정)                                                                                      
            ,supdeptcd            --상위부서코드                                                                                                                                     
            ,mskind               --주부유형:자보환자가 같은 진료일자에 다른 보험유형의 치료를 받을 경우(기왕증)(주유형 M, 그 밖에 부유형)                                           
            ,insukind             --보험유형(건강보험,의료급여,산재,자보 등)(코드군 P0008 참조)                                                                                      
            ,suppkind             --보조유형(정상급여,본인부담100% 등)(코드군 P0010 참조)                                                                                            
            ,insucd               --보험자코드(보험자기호)                                                                                                                           
            ,suppkindresn         --보조유형에 대한 사유코드(코드군 P0032 참조)                                                                                                      
            ,specordyn            --선택진료여부(Y:선택진료산정, N:선택진료미산정, S:진찰료만 선택진료 미산정)                                                                       
            ,holiflag             --공휴일구분                                                                                                                                       
            ,fsexamflag           --초재진구분(코드군 P0021 참조)                                                                                                                    
            ,fsexammanlyn         --초재진구분 수동부여여부(수동부여:Y, 디폴트:N)                                                                                                    
            ,ordtype              --진료형태(외래 O, 응급 E ,입원 I)                                                                                                                 
            ,brateflag            --외래는 O /응급진료 6시간이하일 경우,외래부담률 O/응급진료 6시간이상일 경우,입원부담률 I                                                          
            ,medamtestmyn         --진찰료산정여부(Y:산정, N:미산정=무료)                                                                                                            
            ,medamtpostyn         --진찰료 후불여부(진찰료 산정을 선택시 선후불구분) N:디폴트(선불) , Y:후불                                                                         
            ,medamtfreeresn       --진찰료 면제 사유(진찰료 산정여부가 N=미산정,무료일때 미산정 사유(코드군 P0342 참조))                                                             
            ,rsrvflag             --예약구분(코드군 P0341 참조) C.진료의뢰 D.과예약 I.인터넷 K.RC N.- T.전화 U.followup)                                                             
            ,etcordflag           --(코드군 P0022 참조)F:보호자대진,N:가정간호,M:물리치료,J:주사                                                                                     
            ,disccd               --할인코드                                                                                                                                         
            ,hosoutexptresncd     --원외예외사유코드                                                                                                                                 
            ,clincstdyacptflag    --N:임상시험접수아님, P:사람임상 A:동물임상                                                                                                        
            ,clincstdyno          --임상시험번호(과제번호)                                                                                                                           
            ,chrtlendyn           --챠트대출여부                                                                                                                                     
            ,specorddescyn        --전화예약 부가정보-선택진료설명여부                                                                                                               
            ,ordreqdescyn         --전화예약 부가정보-진료의뢰서 설명여부                                                                                                            
            ,ordreqhospgrde       --전화예약 부가정보-진료의뢰서 설명병원 등급(1차,2차)                                                                                              
            ,insuchrgyn           --전화예약 부가정보-보험회사담당자여부                                                                                                             
            ,nursacptyn           --간호사접수여부                                                                                                                                   
            ,nursacptdt           --간호사접수일시                                                                                                                                   
            ,dracptyn             --의사접수여부                                                                                                                                     
            ,dracptdt             --의사접수일시                                                                                                                                     
            ,prcpgenryn           --처방발생여부(진료파트에서 입력)(코드군 P0036 참조)                                                                                               
            ,prcpnotoccrresn      --처방미발생사유코드(진료파트에서 입력)(코드군 등록신청중)                                                                                         
            ,estmspclappyn        --산정특례적용여부(진료부에서 입력)Y:산정특례 적용(적용시, 유형보조도 변경)/N:산정특례 미적용                                                      
            ,elbulbodstat         --전광판 상태(진료파트에서 입력)                                                                                                                   
            ,elbulbodstatdt       --전광판상태입력일시-진료파트에서 입력                                                                                                             
            ,'Y'                  --Y : 필요, S : 수가계산 후 미수납, N : 수납완료 및 계산 불필요 Y -> S -> N                                                                        
            ,calcmthdflag         --계산방법구분(P:정액,D:DRG,N:개별계산,산, O:인공신장)                                                                                             
            ,dnoracptyn           --공여자접수여부-공여자 관련 검사를 위한 접수여부                                                                                                  
            ,rqstflag             --협력의뢰구분-협력의뢰 외래예약일 경우, 협력의뢰/검사의뢰 구분(디폴트는 1:협력의뢰,자애병원은 2:검사의뢰를 별도 구분함)(코드군 P0329 참조)        
            ,rqsthospcd           --협력의뢰병원코드                                                                                                                                 
            ,rqstdrid             --협력의뢰의ID                                                                                                                                     
            ,tdayinflag           --당일입원구분(M:주유형입원,S:부유형입원)                                                                                                          
            ,tranindd             --전환입원일자(재원기간중 실시한 오더접수내역 전환 후 입원일자 세팅)                                                                               
            ,'00000000'           --영수일자                                                                                                                                         
            ,0                    --영수증번호                                                                                                                                       
            ,0                    --영수증일련번호                                                                                                                                   
            ,telrsrvrem           --전화예약참고사항                                                                                                                                 
            ,updtcnclresn         --변경취소사유                                                                                                                                     
            ,fstacptid            --최조접수자ID                                                                                                                                     
            ,fstacptdt            --최초접수일시                                                                                                                                     
            ,CAST(#sessuserid# AS VARCHAR2(10))               --최초등록자ID                                                                                                        
            ,SYSTIMESTAMP         --최초등록일시                                                                                                                                     
            ,CAST(#sessuserid# AS VARCHAR2(10))              --최종수정자ID                                                                                                         
            ,SYSTIMESTAMP         --최종수정일시                                                                                                                                     
            ,ordreqformflag          --진료의뢰서구분(코드군 P0380 참조 )                                                                                                            
            ,prcplockid              --처방 LOCK ID                                                                                                                                  
            ,dschjudgprcsstat        --퇴원심사진행 상태                                                                                                                             
            ,judgmdlid               --심사중인 심사자 ID                                                                                                                            
            ,lastjudgdt              --최종심사 일자                                                                                                                                 
            ,mainjudgid              --주심사자                                                                                                                                      
            ,probjudgflag            --재원 심사시 문제환자 체크 '-' : 해당사항 없음, 'G': 문제 중요 하(grren), 'R': 문제 중요 상(red)                                               
            ,spcljudgflag            --선별심사여부('-':default 해당없음, 'A':선별심사(자동체크), 'B':선별심사(심사자체크), 'C':선별심사(실시간체크))                                
            ,handicaprbookpossnyn                                                                                                                                                    
            ,outercdrgstyn                                                                                                                                                       
            ,undersixageyn                                                                                                                                                           
            ,remfact                                                                                                                                                                 
            ,spclcd                                                                                                                                                                  
            ,onestop                                                                                                                                                                 
            ,ownbflag                                                                                                                                                                
            ,ordpatyn                                                                                                                                                                
            ,uncocd                                                                                                                                                                  
            ,pmflag                                                                                                                                                                  
            ,emplno                                                                                                                                                                  
            ,suppkindsubyn
            ,earnendyn                                                                                                                                                               
            ,rareobstflag            --희귀난치대상자구분                                                                                                                            
            ,tranflag                --입원외래덤프
            ,onlnno
            ,inetproxyrrgstno
            ,holdflag
			,subdeptcd
            --,mig 
      FROM   pam.pmohotpt a
     WHERE    a.pid       = CAST(#prcp_pid#       AS VARCHAR2(10))
       AND    a.orddd     = CAST(#prcp_actorddd#  AS VARCHAR2(8))
       AND    a.cretno    = CAST(#prcp_actcretno# AS NUMBER)
       AND    a.histstat  in ('R','T')  
       AND    a.instcd = #sessinstcd#
       
    ]]>
    </statement> 

    <!-- Release 시, 외래등록내역 생성후, 기존 외래등록내역 상태 수정 -->
     <statement id="setCOTPTFromHold">
        <![CDATA[
        UPDATE  pam.pmohotpt a
           SET  a.histstat      = 'C',
                a.lastupdtrid   = #sessuserid#, 
                a.lastupdtdt    = SYSTIMESTAMP
         WHERE  a.pid  = #prcp_pid#
           AND  a.orddd    = #prcp_actorddd#
           AND  a.cretno   = #prcp_actcretno#
           AND  a.histstat  in ('R','T')  
           AND  a.instcd = #sessinstcd#
        ]]>                    
    </statement>


  <!-- 외래등록조회(외래수납) --> 
    <statement id="getOtptList"><![CDATA[    
            SELECT  DISTINCT
                  a.pid
                 ,a.orddd
                 ,a.cretno
                 ,a.acptseqno
                 ,a.instcd
                 ,a.histstat
                 ,a.orgorddd
                 ,a.orgcretno
                 ,a.calcbaseflag
                 ,a.calcyn
                 ,a.ordtm
                 ,a.orddeptcd
                 ,a.orddrid
                 ,a.dutdeptcd
                 ,a.centcd
                 ,a.supdeptcd
                 ,a.mskind
                 ,a.insukind
                 ,a.suppkind
                 ,a.insucd
                 ,a.suppkindresn
                 ,a.specordyn
                 ,a.holiflag
                 ,a.fsexamflag
                 ,a.fsexammanlyn
                 ,a.ordtype
                 ,a.brateflag
                 ,a.medamtestmyn
                 ,a.medamtpostyn
                 ,a.medamtfreeresn
                 ,a.rsrvflag
                 ,a.etcordflag
                 ,a.disccd
                 ,a.hosoutexptresncd
                 ,a.clincstdyacptflag
                 ,a.clincstdyno
                 ,a.chrtlendyn
                 ,a.specorddescyn
                 ,a.ordreqdescyn
                 ,a.ordreqhospgrde
                 ,a.insuchrgyn
                 ,a.nursacptyn
                 ,a.nursacptdt
                 ,a.dracptyn
                 ,a.dracptdt
                 ,a.prcpgenryn
                 ,a.prcpnotoccrresn
                 ,a.estmspclappyn
                 ,a.elbulbodstat
                 ,a.elbulbodstatdt
                 ,a.calcflag
                 ,a.calcmthdflag
                 ,a.dnoracptyn
                 ,a.rqstflag
                 ,a.rqsthospcd
                 ,a.rqstdrid
                 ,a.tdayinflag
                 ,a.tranindd
                 ,a.rcptdd
                 ,a.rcptno
                 ,a.rcptseqno
                 ,a.telrsrvrem
                 ,a.updtcnclresn
                 ,a.fstacptid
                 ,a.fstacptdt
                 ,a.fstrgstrid
                 ,a.fstrgstdt
                 ,a.lastupdtrid
                 ,a.lastupdtdt
                 ,a.handicaprbookpossnyn             --장애인수첩소지자여부
                 ,a.undersixageyn                    --6세미만여부
                 ,a.ordreqformflag                   --진료의뢰서구분(수급절차)
                 ,a.rareobstflag                     --희귀난치대상자구분
                 ,a.tranflag  
				 ,a.holdflag
				 ,a.subdeptcd
           FROM pam.pmohotpt a
               ,pam.paohopmi b        
          WHERE a.pid               =   #pid#
               AND  a.histstat      =   'R'     --IN ('R','T') 정산에서 조회하므로, 수납된것만 조회(추후 실시정산에서 조회하는 조건도 추가예정
               AND  a.ordtype       = 'O'
               AND  a.instcd        = #sessinstcd#
               AND  b.pid           = a.pid
               AND  b.orddd         = a.orgorddd
               AND  b.cretno        = a.orgcretno
               AND  b.instcd        = a.instcd
           ]]>
           <isEqual property="srchcond" compare="1"><![CDATA[
               AND  b.rcptdd        BETWEEN #fromdd# AND #todd# ]]>
           </isEqual>  
           <isEqual property="srchcond" compare="2"><![CDATA[
               AND  b.orddd         BETWEEN #fromdd# AND #todd# ]]>
           </isEqual> 
           <isNotEmpty property="orddeptcd">
               AND  a.orddeptcd =   #orddeptcd#
           </isNotEmpty> 
           <isNotEmpty property="orddrid">
               AND  a.orddrid   =   #orddrid#
           </isNotEmpty> 
           <isNotEmpty property="insukind">
               AND  a.insukind  =   #insukind#
           </isNotEmpty> 
           ORDER BY orddd DESC
    </statement> 

<!-- 아래 로직들은   -->
<!-- 수납조회 쪽으로 이동 예정  -->

    <statement id="getOutRcptSpec"><![CDATA[
            SELECT        orddd               , 
                                (select d.depthngnm from com.zsdddept d where orddeptcd  = d.deptcd  and rownum = 1) as orddeptcd	, 
                                cretno            , 
                                acptseqno     , 
                                orddrid          , 
                                insukind        , 
                                suppkind       , 
                                payamt          , 
                                allownbamt    , 
                                nopyamt        , 
                                specamt        , 
                                payinsubamt + payinsurestamt AS payinsubamt, 
                                payownbamt  - payinsurestamt AS payownbamt, 
                                discamt         , 
                                reduamt         ,
                                bloddiscamt  ,
                                mdlrcptamt    ,
                                uncoamt       , 
                                cardamt        , 
                                cashamt       , 
                                onlineamt      , 
                                rcptexecdd   , 
                                rcptrid           , 
                                rcptno           , 
                                rcptseqno    , 
                                rcptstat         , 
                                uncorcptflag , 
                                ordtype       , 
                                mskind        , 
                                insucd        , 
                                restamt        , 
                                hosindrugno    , 
                                hosoutdrugno  , 
                                calcmthdflag  , 
                                remfact           , 
                                paypsnflag     , 
                                paypsnrem    , 
                                orgrcptdd      , 
                                orgrcptno        , 
                                orgrcptseqno  , 
                                rcpttm            , 
                                fstrgstrid      , 
                                fstrgstdt        , 
                                lastupdtrid    , 
                                lastupdtdt     ,
                                payinsurestamt	,
                                taxamt,
                                totownbamt - payinsurestamt AS totownbamt,
                                pid 
        FROM      pam.paohopmi
        WHERE    pid        =           #pid#
        AND         rcptdd  =           #rcptdd#
        AND         rcptno  =           #rcptno#
        AND         rcptseqno =     #rcptseqno#
        
        AND         rcptstat     in     ('Y','C','D')
        AND         instcd  =           #sessinstcd#    
              ]]>
    </statement>    


<!-- 수납시점의 액팅 처리 - 혈액은행 혈액료(수혈,헌혈)-->    
    <statement id="setActing"><![CDATA[    
        UPDATE emr.mmodexop
           SET execdd  = CASE WHEN execdd != '00000000' THEN execdd
                              ELSE #opmi_rcptdd#
                               END
              ,exectm  = CASE WHEN exectm != '000000'  THEN exectm
                              ELSE #opmi_rcpttm#
                               END
              ,execrid = CASE WHEN execrid != '-' THEN execrid
                              ELSE #opmi_rcptrid#
                               END
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP 
         WHERE (prcpdd, prcpno, prcphistno, execprcpno , instcd) IN (SELECT DISTINCT 
                                                                   oscl.prcpdd
                                                                 , oscl.prcpno
                                                                 , oscl.prcphistno
                                                                 , oscl.execprcpseqno
                                                                 , oscl.instcd
                                                              FROM pam.paohoscl oscl
                                                             WHERE oscl.pid        = #opmi_pid#            
                                                               AND oscl.rcptdd     = #opmi_rcptdd#
                                                               AND oscl.rcptno     = #opmi_rcptno#
                                                               AND oscl.rcptseqno= #opmi_rcptseqno#
                                                               AND (oscl.snglearncls = PAM.FN_GET_EARNCLSCD('EN_P006','06A',0) 
															     or oscl.snglearncls = PAM.FN_GET_EARNCLSCD('EN_P006','06B',0)) --수혈,헌혈
                                                               AND oscl.instcd     = #sessinstcd# )     
           ]]>         
    </statement>      

<!-- 수납시점의 계산내역에 액팅 처리 - 혈액은행 혈액료(수혈,헌혈)
-->    
    <statement id="setActingOscl"><![CDATA[    
        UPDATE pam.paohoscl
           SET execdd    = #opmi_rcptdd#    --처방에 대한 실시일자                                                                         
             , exectm    = #opmi_rcpttm#    --처방에 대한 실시시간                                                                   
             , execrid   = #opmi_rcptrid#   --처방에 대한 실시자ID                                                                   
             , pamexecdd = #opmi_rcptdd#    --원무실시일자  -> 진료지원,간호등 Part는 위의 '처방에 대한 실시일자'와 동일한 값 Setting
             , earnenddd = #opmi_rcptdd#    --수익마감일자  -> 시스템 일자(YYYYMMDD)를 Setting  
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP 
         WHERE pid = #opmi_pid#
           AND rcptdd        = #opmi_rcptdd# 
           AND rcptno        = #opmi_rcptno#
           AND rcptseqno     = #opmi_rcptseqno#
           AND (snglearncls  = '060601' or snglearncls = '060602')  --수혈,헌혈
           AND instcd        = #sessinstcd#
           ]]>         
    </statement>      

    <!-- 카드승인,취소 VAN처리만 되고 수납처리 누락된 내역 -->
     <statement id="getonlycvanList">
        <![CDATA[
          SELECT cvan.pid            AS pid          
               , ptbs.hngnm          AS hngnm     
               , cvan.aprvflag       AS aprvflag    
               , cvan.aprvdd         AS aprvdd      
               , cvan.aprvtm         AS aprvtm      
               , cvan.aprvno         AS aprvno      
               , cvan.instcd         AS instcd      
               , cvan.keyinptflag    AS keyinptflag       
               , cvan.cardcmpycd     AS cardcmpycd  
               , cvan.cardno         AS cardno      
               , cvan.vancd          AS vancd       
               , cvan.allotmm        AS allotmm     
               , cvan.cardamt        AS cardamt     
               , cvan.valiterm       AS valiterm    
               , cvan.trmnno         AS trmnno      
               , cvan.rcptexecdd     AS rcptexecdd  
               , cvan.rcpttm         AS rcpttm      
               , cvan.rcptrid        AS rcptrid     
               , cvan.remfact        AS remfact     
               , cvan.fstrgstrid     AS fstrgstrid  
               , cvan.fstrgstdt      AS fstrgstdt   
               , cvan.lastupdtrid    AS lastupdtrid 
               , cvan.lastupdtdt     AS lastupdtdt  
               , cvan.elctsignkey    AS elctsignkey 
               , cvan.elctsigncnts   AS elctsigncnts
               , cvan.deporid        AS deporid     
               , cvan.depodd         AS depodd      
               , cvan.depotm         AS depotm      
               , cvan.carddepoamt    AS carddepoamt 
               , cvan.coms           AS coms                                       
            FROM pam.PAMHCVAN cvan
                 LEFT OUTER JOIN pam.PAMHCARD card ON (cvan.pid = card.pid AND cvan.aprvflag = card.aprvflag  
                                                                           AND cvan.aprvno = card.aprvno AND cvan.aprvdd = card.aprvdd  
                                                                           AND cvan.aprvtm = card.aprvtm AND cvan.instcd = card.instcd 
                                                         )
               , pam.pmcmptbs ptbs                                                                         
            WHERE cvan.instcd = #sessinstcd#
            ]]> 
              <isNotEmpty property="pid">
                AND cvan.pid = #pid#
              </isNotEmpty> 
              <isNotEmpty property="rcptdd">
                AND cvan.aprvdd = #rcptdd#
               </isNotEmpty><![CDATA[
                AND card.rcptdd IS NULL
                AND ptbs.pid    = cvan.pid
                AND ptbs.instcd = cvan.instcd
            ]]> 
    </statement>


    <!-- 인공신장투석 환자 - 요율변경내역 조회 AND   otpt2.suppkind   < '04' 정상,본인부담 -->
     <statement id="getupdtrateList">
        <![CDATA[
        SELECT distinct 'Y'                 AS chkgubn
                    ,   otpt2.pid           AS pid
                    ,   otpt2.orddd         AS orddd    
                    ,   otpt2.insukind      AS insukind
                    ,   otpt2.suppkind      AS suppkind
                    ,   otpt2.insucd        AS insucd
                    ,   otpt2.cretno        AS cretno
                    ,   otpt2.acptseqno     AS acptseqno
                    ,   otpt2.orddeptcd     AS orddeptcd
                    ,   otpt2.orddrid       AS orddrid
                    ,   otpt2.histstat      AS histstat
                    ,   otpt1.insukind      AS toinsukind
                    ,   otpt1.suppkind      AS tosuppkind
					,   otpt1.spclcd        AS spclcd
            FROM    pam.pmohotpt otpt1
                ,   pam.pmohotpt otpt2
            WHERE   otpt1.pid        = #pid#                                                                  
              AND   otpt1.orddd      = #orddd#    
              AND   otpt1.instcd     = #sessinstcd#
			  AND   otpt1.insukind  = '11'
              AND   otpt1.suppkind   in ('02','03','04','34','35','36')  --인공신장투석, 복막관류술, 장기이식 (차상위2종 포함)
              AND   otpt1.histstat   in ('R','T')                                                                    
              AND   otpt2.pid        = otpt1.pid                      
              AND   otpt2.orddd     = otpt1.orddd      
              AND   otpt2.orddd      = otpt1.orddd    
              AND   otpt2.instcd     = otpt1.instcd                                                        
              AND   otpt2.histstat   in ('R','T')                                    
              AND   otpt2.insukind   = otpt1.insukind                                                         
              AND   otpt2.suppkind   <> otpt1.suppkind
			  AND   otpt2.suppkind   = '00'               --정상
            ]]> 
    </statement>

    
    <!-- 인공신장투석 환자 - 당일투석진료내역 -->
     <statement id="getupdtrateList1">
        <![CDATA[
        SELECT   otpt1.pid                AS pid
               , otpt1.orddd              AS orddd    
               , otpt1.insukind           AS insukind
               , otpt1.suppkind           AS suppkind
               , otpt1.insucd             AS insucd
               , otpt1.cretno             AS cretno
               , otpt1.acptseqno          AS acptseqno
               , otpt1.orddeptcd          AS orddeptcd
               , otpt1.orddrid            AS orddrid
               , otpt1.histstat           AS histstat
               , case when otpt1.calcflag = 'S' then '미수납' 
                      when otpt1.calcflag = 'Y' then '미계산'            
                      when otpt1.calcflag = 'N' then '수  납'                                                 
                       END                AS calcflaggubn
			   , otpt1.spclcd             AS spclcd
            FROM pam.pmohotpt otpt1
           WHERE otpt1.pid    = #pid#
             AND otpt1.orddd  = #orddd#
             AND otpt1.orddd  in (SELECT distinct otpt2.ORDDD
                                          FROM pam.pmohotpt otpt2
                                              ,pam.pmohotpt otpt3
                                         WHERE otpt2.pid = #pid#
                                           AND otpt2.suppkind  in ('02','03','04','34','35','36') --인공신장투석, 복막관류술, 장기이식 (차상위2종 포함)
                                           AND otpt2.histstat  in ('R','T')
                                           AND otpt3.orddd     = otpt2.orddd
                                           AND otpt3.pid       = otpt2.pid
                                           AND otpt3.orddd     = otpt2.orddd
                                           AND otpt3.histstat  = otpt2.histstat
                                           AND otpt3.insukind  = otpt2.insukind
                                           AND otpt3.instcd    = otpt2.instcd
                                           AND otpt3.suppkind  <> otpt2.suppkind
                                           AND otpt3.suppkind  in ('00','01','02','03','33','34','35')  --정상,본인부담
              
                                                        )
              AND   otpt1.suppkind      in ('02','03','04','34','35','36')                 --인공신장투석, 복막관류술, 장기이식
              AND   otpt1.histstat      in ('R','T')
              AND   otpt1.instcd        = #sessinstcd#
            ]]> 
    </statement>    


    <!-- 인공신장투석 환자 - 요율변경내역 변경 -->
     <statement id="setupdtrateList"><![CDATA[
            UPDATE pam.pmohotpt
               SET suppkind      = #tosuppkind#
                  ,calcflag      = 'Y'
				  ,spclcd        = #spclcd#
                  ,suppkindsubyn = 'Y'
                  ,lastupdtrid   = #sessuserid#       
                  ,lastupdtdt    = SYSTIMESTAMP      
             WHERE pid       = #pid#
               AND orddd     = #orddd#
               AND cretno    = #cretno#
               AND histstat  in ('R', 'T')
               AND instcd    = #sessinstcd#
    ]]> 
    </statement>
  
  
   <statement id="getEarnOsclInfo"><![CDATA[    
    SELECT DECODE(a.payownbrate_org,9999,'',a.payownbrate_org) AS payownbrate 
          ,a.* 
     FROM (

    SELECT         DECODE((SELECT count(t.grupcalcscorcd)
                             FROM pam.paohoscl t
                            WHERE t.pid             = a.pid
                              AND t.orddd           = a.orddd
                              AND t.cretno          = a.cretno
                              AND t.instcd          = a.instcd
                              AND t.calcstat        = a.calcstat
                              AND t.grupcalcscorcd  != t.snglcalcscorcd
                              AND t.grupcalcscorcd  = a.grupcalcscorcd
                           ) ,0,'1','2')        AS hidden
                   ,    a.pid                   AS pid
                   ,    a.orddd                 AS orddd
                   ,    a.cretno                AS cretno
                   ,    a.calcseqno             AS calcseqno
                   ,    a.calcscorseqno         AS calcscorseqno
                   ,    a.instcd                AS instcd
                   ,    a.calcstat              AS calcstat
                   ,    a.clamtrgtstat          AS clamtrgtstat
                   ,    a.acptseqno             AS acptseqno
                   ,    a.orddeptcd             AS orddeptcd
                   ,    a.orddrid               AS orddrid
                   ,    a.mskind                AS mskind
                   ,    a.ordtype               AS ordtype
                   ,    a.grupcalcscorcd        AS grupcalcscorcd
                   ,    a.snglcalcscorcd        AS snglcalcscorcd
                   ,    a.grupcalcscorcls       AS grupcalcscorcls
                   ,    a.snglcalcscorcls       AS snglcalcscorcls
                   ,    a.grupearncls           AS grupearncls
                   ,    a.snglearncls           AS snglearncls
                   ,    a.ordqty                AS ordqty
                   ,    a.ordtims               AS ordtims
                   ,    a.orddays               AS orddays
                   ,    a.calcqty               AS calcqty
                   ,    a.calctims              AS calctims
                   ,    a.calcdays              AS calcdays
                   ,    a.matractflag           AS matractflag
                   ,    a.calcpayflag           AS calcpayflag
                   ,    a.prcppayflag           AS prcppayflag
                   ,    a.calcscorpayflag       AS calcscorpayflag
                   ,    a.ansttm                AS ansttm
                   ,    a.spccd                 AS spccd
                   ,    a.pntunitcost           AS pntunitcost
                   ,    a.calcscorpnt           AS calcscorpnt
                   ,    a.estmpnt               AS estmpnt
                   ,    a.calcamt               AS calcamt
                   ,    a.hospaddamt            AS hospaddamt
                   ,    a.specamt               AS specamt
                   ,    a.payamt                AS payamt
                   ,    a.allownbamt            AS allownbamt
                   ,    a.nopyamt               AS nopyamt
                   ,    a.payownbrate           AS payownbrate_org
                   ,    a.payinsubamt           AS payinsubamt
                   ,    a.payownbamt            AS payownbamt
                   ,    a.paydiscamt            AS paydiscamt
                   ,    a.nopydiscamt           AS nopydiscamt
                   ,    a.specdiscamt           AS specdiscamt
                   ,    a.hosoutexptresncd      AS hosoutexptresncd
                   ,    a.hosoutdrugno          AS hosoutdrugno
                   ,    a.specordyn             AS specordyn
                   ,    a.execdeptcd            AS execdeptcd
                   ,    a.execdd                AS execdd
                   ,    a.exectm                AS exectm
                   ,    a.execrid               AS execrid
                   ,    a.pamexecdd             AS pamexecdd
                   ,    a.earnenddd             AS earnenddd
                   ,    a.actcnclresn           AS actcnclresn
                   ,    a.clamspclcd            AS clamspclcd
                   ,    a.clamkey               AS clamkey
                   ,    a.clamcretdd            AS clamcretdd
                   ,    a.clamcretyn            AS clamcretyn
                   ,    a.estmcls               AS estmcls
                   ,    a.estmmeancd            AS estmmeancd
                   ,    a.estmcd                AS estmcd
                   ,    a.readdrid              AS readdrid
                   ,    a.clincstdyno           AS clincstdyno
                   ,    a.exitprvntdrugyn       AS exitprvntdrugyn
                   ,    a.exitprvntdrugamt      AS exitprvntdrugamt
                   ,    a.trustaddrate          AS trustaddrate
                   ,    a.bothaddyn             AS bothaddyn
                   ,    a.prcpdd                AS prcpdd
                   ,    a.prcpno                AS prcpno
                   ,    a.prcphistno            AS prcphistno
                   ,    a.execprcpseqno         AS execprcpseqno
                   ,    a.cvrtinprcpdeptcd      AS cvrtinprcpdeptcd
                   ,    a.cvrtinprcpdrid        AS cvrtinprcpdrid
                   ,    a.rcptdd                AS rcptdd
                   ,    a.rcptno                AS rcptno
                   ,    a.rcptseqno             AS rcptseqno
                   ,    a.rcptexecdd            AS rcptexecdd
                   ,    a.rcpttm                AS rcpttm
                   ,    a.fstrgstrid            AS fstrgstrid
                   ,    a.fstrgstdt             AS fstrgstdt
                   ,    a.lastupdtrid           AS lastupdtrid
                   ,    a.lastupdtdt            AS lastupdtdt
                   , decode( d.precureprcpflag , 'Y', '[선]' ,'') ||
                    (Select m.hngnm From pam.picmmech m
                                   where m.calcscorcd = a.snglcalcscorcd
                                     AND a.orddd BETWEEN  m.fromdd AND m.todd
                                     AND m.instcd = a.instcd)                    AS snglcalcscorcdnm
                   ,    CASE a.grupcalcscorcd   WHEN a.snglcalcscorcd THEN ''
                                                                      ELSE 'G'
                                                                       END       AS grupflag
                   ,    a.specownbamt + a.allownownbamt + a.nopyownbamt + a.payownbamt      AS ownbamt
                   ,    CASE a.matractflag  WHEN '0' THEN 'Y'
                                                     ELSE ' '
                                                      END                        AS outordyn
                   ,    CASE a.clincstdyno  WHEN ''  THEN ' '
                                                     WHEN '-'   THEN ' '
                                                     WHEN ' '   THEN ' '
                                                     WHEN '00'  THEN ' '
                                                     ELSE 'Y'
                                                      END                        AS clincstdyyn
                   ,     DECODE(d.prcphistcd, 'E',d.prcphistcd, d.prcpstatcd)    AS execprcpstatcd
                   ,     d.prcphistcd AS execprcphistcd

                   ,     (select e.rsrvdd
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvdd

                   ,     (select e.rsrvtm
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvtm

           FROM pam.paohoscl a LEFT OUTER JOIN emr.mmohoprc d on (d.pid = a.pid
                                                              AND d.orddd  = a.orddd
                                                              AND d.cretno = a.cretno
                                                              AND d.prcpdd = a.prcpdd
                                                              AND d.prcpno = a.prcpno
                                                              AND d.instcd = a.instcd
                                                              AND d.prcpflag IN ('1', '3')
                                                              AND d.tempprcpflag = 'N'
                                                              AND d.hscttempprcpflag = 'N'
                                                              AND d.prcphistcd in ('O','E'))
               ,pam.pasmictp b                                               
         WHERE a.pid               = #pid#
		]]>
		<isEmpty property="otptkey">  
		   AND a.orddd           = #orddd#
		   AND a.cretno          = #cretno#
		   AND a.calcstat        = #calcstat#
		</isEmpty>
		<isNotEmpty property="otptkey">  
		   AND a.orddd || a.cretno || a.calcstat in ('$otptkey$')  
		</isNotEmpty>
           AND a.instcd          = #sessinstcd#
           AND b.instcd          = a.instcd
           AND b.earncls         = a.grupearncls
           AND b.earnclsstat     = '0'
            <isNotEqual property="outcls" compare="-"><![CDATA[
              AND b.outcls = #outcls# 
            ]]>                  
            </isNotEqual><![CDATA[  
   UNION
        SELECT      '1'                                  AS hidden
                   ,    MAX(a.pid)                   AS pid
                   ,    MAX(a.orddd)                 AS orddd
                   ,    MAX(a.cretno)                AS cretno
                   ,    MAX(a.calcseqno)             AS calcseqno
                   ,    MAX(a.calcscorseqno)         AS calcscorseqno
                   ,    MAX(a.instcd)                AS instcd
                   ,    MAX(a.calcstat)              AS calcstat
                   ,    MAX(a.clamtrgtstat)          AS clamtrgtstat
                   ,    MAX(a.acptseqno)             AS acptseqno
                   ,    MAX(a.orddeptcd)             AS orddeptcd
                   ,    MAX(a.orddrid)               AS orddrid
                   ,    MAX(a.mskind)                AS mskind
                   ,    MAX(a.ordtype)               AS ordtype
                   ,    MAX(a.grupcalcscorcd)        AS grupcalcscorcd
                   ,    MAX(a.grupcalcscorcd)        AS snglcalcscorcd
                   ,    MAX(a.grupcalcscorcls)       AS grupcalcscorcls
                   ,    MAX(a.grupcalcscorcls)       AS snglcalcscorcls
                   ,    MAX(a.grupearncls)           AS grupearncls
                   ,    MAX(a.grupearncls)           AS snglearncls
                   ,    0                            AS ordqty
                   ,    0                            AS ordtims
                   ,    0                            AS orddays
                   ,    0                            AS calcqty
                   ,    0                            AS calctims
                   ,    0                            AS calcdays
                   ,    ''                           AS matractflag
                   ,    ''                           AS calcpayflag
                   ,    ''                           AS prcppayflag
                   ,    ''                           AS calcscorpayflag
                   ,    ''                           AS ansttm
                   ,    ''                           AS spccd
                   ,    SUM(a.pntunitcost)           AS pntunitcost
                   ,    SUM(a.calcscorpnt)           AS calcscorpnt
                   ,    SUM(a.estmpnt)               AS estmpnt
                   ,    SUM(a.calcamt)               AS calcamt
                   ,    SUM(a.hospaddamt)            AS hospaddamt
                   ,    SUM(a.specamt)               AS specamt
                   ,    SUM(a.payamt)                AS payamt
                   ,    SUM(a.allownbamt)            AS allownbamt
                   ,    SUM(a.nopyamt)               AS nopyamt
                   ,    9999                         AS payownbrate_org
                   ,    SUM(a.payinsubamt)           AS payinsubamt
                   ,    SUM(a.payownbamt)            AS payownbamt
                   ,    SUM(a.paydiscamt)            AS paydiscamt
                   ,    SUM(a.nopydiscamt)           AS nopydiscamt
                   ,    SUM(a.specdiscamt)           AS specdiscamt
                   ,    ''                           AS hosoutexptresncd
                   ,    0                            AS hosoutdrugno
                   ,    ''                           AS specordyn
                   ,    ''                           AS execdeptcd
                   ,    ''                           AS execdd
                   ,    ''                           AS exectm
                   ,    ''                           AS execrid
                   ,    ''                           AS pamexecdd
                   ,    ''                           AS earnenddd
                   ,    ''                           AS actcnclresn
                   ,    ''                           AS clamspclcd
                   ,    ''                           AS clamkey
                   ,    ''                           AS clamcretdd
                   ,    ''                           AS clamcretyn
                   ,    ''                           AS estmcls
                   ,    ''                           AS estmmeancd
                   ,    ''                           AS estmcd
                   ,    ''                           AS readdrid
                   ,    ''                           AS clincstdyno
                   ,    ''                           AS exitprvntdrugyn
                   ,    0                            AS exitprvntdrugamt
                   ,    0                            AS trustaddrate
                   ,    ''                           AS bothaddyn
                   ,    ''                           AS prcpdd
                   ,    MIN(a.prcpno)                AS prcpno
                   ,    0                            AS prcphistno
                   ,    0                            AS execprcpseqno
                   ,    ''                           AS cvrtinprcpdeptcd
                   ,    ''                           AS cvrtinprcpdrid
                   ,    ''                           AS rcptdd
                   ,    0                            AS rcptno
                   ,    0                            AS rcptseqno
                   ,    ''                           AS rcptexecdd
                   ,    ''                           AS rcpttm
                   ,    ''                           AS fstrgstrid
                   ,    MAX(a.fstrgstdt)             AS fstrgstdt
                   ,    ''                           AS lastupdtrid
                   ,    MAX(a.lastupdtdt)            AS lastupdtdt
                   ,
                    (Select m.hngnm From pam.picmmech m
                                   where m.calcscorcd = a.grupcalcscorcd
                                     AND a.orddd BETWEEN  m.fromdd AND m.todd
                                     AND m.instcd = a.instcd)                    AS snglcalcscorcdnm
                   ,    'G'                          AS grupflag
                   ,    SUM(a.specownbamt + a.allownownbamt + a.nopyownbamt + a.payownbamt)  AS ownbamt
                   ,    ''                           AS outordyn
                   ,    ''                           AS clincstdyyn
                   ,     DECODE(d.prcphistcd, 'E',d.prcphistcd, d.prcpstatcd)    AS execprcpstatcd
                   ,     d.prcphistcd                                            AS execprcphistcd

                   ,     (select e.rsrvdd
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvdd

                   ,     (select e.rsrvtm
                            from emr.mmodexop e
                           where a.pid = e.pid
                             and a.orddd = e.orddd
                             and a.cretno = e.cretno
                             and a.instcd = e.instcd
                         	 AND a.prcpdd = e.prcpdd
							 AND a.prcpno = e.prcpno
							 AND a.prcphistno = e.prcphistno
							 AND a.EXECPRCPSEQNO = e.EXECPRCPNO
							 and rownum =1
                             )  as rsrvtm
           FROM pam.paohoscl a LEFT OUTER JOIN emr.mmohoprc d on (d.pid = a.pid
                                                              AND d.orddd  = a.orddd
                                                              AND d.cretno = a.cretno
                                                              AND d.prcpdd = a.prcpdd
                                                              AND d.prcpno = a.prcpno
                                                              AND d.instcd = a.instcd
                                                              AND d.prcpflag IN ('1', '3')
                                                              AND d.tempprcpflag = 'N'
                                                              AND d.hscttempprcpflag = 'N'
                                                              AND d.prcphistcd in ('O','E'))
                ,pam.pasmictp b
         WHERE a.pid            = #pid#
		 ]]>
		<isEmpty property="otptkey">  
		   AND a.orddd           = #orddd#
		   AND a.cretno          = #cretno#
		   AND a.calcstat        = #calcstat#
		</isEmpty>
		<isNotEmpty property="otptkey">  
		   AND a.orddd || a.cretno || a.calcstat in ('$otptkey$')  
		</isNotEmpty>
		<![CDATA[
           AND a.instcd          = #sessinstcd#
           AND b.instcd          = a.instcd
           AND b.earncls         = a.grupearncls
           AND b.earnclsstat     = '0'
           AND a.grupcalcscorcd  IN (SELECT k.grupcalcscorcd
                                       FROM pam.paohoscl k
                                     WHERE k.pid             = a.pid
                                       AND k.orddd           = a.orddd
                                       AND k.cretno          = a.cretno
                                       AND k.instcd          = a.instcd
                                       AND k.calcstat        = a.calcstat
                                       AND k.grupcalcscorcd != k.snglcalcscorcd
                                     GROUP BY k.grupcalcscorcd
                                     HAVING count(*) > 0   )
             ]]>
            <isNotEqual property="outcls" compare="-"><![CDATA[
              AND b.outcls = #outcls# 
            ]]>                  
            </isNotEqual>
         GROUP BY  a.grupcalcscorcd , a.pid,a.orddd ,a.cretno, a.instcd ,a.prcpdd,a.prcpno,a.prcphistno,a.execprcpseqno, d.prcphistcd  ,d.prcpstatcd ,d.inclprcpno
         ORDER BY  prcpno ,grupcalcscorcd, hidden  ,prcpdd desc,calcscorseqno desc
         ) a
    </statement>   

   <!-- 계산취소시 계산내역에 있는 calcstat = Y 인 접수건을 insert  한다. --> 
   <statement id="insOtptHistCancel"><![CDATA[    
        INSERT INTO pam.pmohotpt (  
                                pid 
                            ,   orddd   
                            ,   cretno  
                            ,   acptseqno   
                            ,   instcd  
                            ,   histstat    
                            ,   orgorddd    
                            ,   orgcretno   
                            ,   calcbaseflag    
                            ,   calcyn  
                            ,   ordtm   
                            ,   orddeptcd   
                            ,   orddrid 
                            ,   dutdeptcd   
                            ,   centcd  
                            ,   supdeptcd   
                            ,   mskind  
                            ,   insukind    
                            ,   suppkind    
                            ,   insucd  
                            ,   suppkindresn    
                            ,   specordyn   
                            ,   holiflag    
                            ,   fsexamflag  
                            ,   fsexammanlyn    
                            ,   ordtype 
                            ,   brateflag   
                            ,   medamtestmyn    
                            ,   medamtpostyn    
                            ,   medamtfreeresn  
                            ,   rsrvflag    
                            ,   etcordflag  
                            ,   disccd  
                            ,   hosoutexptresncd    
                            ,   clincstdyacptflag   
                            ,   clincstdyno 
                            ,   chrtlendyn  
                            ,   specorddescyn   
                            ,   ordreqdescyn    
                            ,   ordreqhospgrde  
                            ,   insuchrgyn  
                            ,   nursacptyn  
                            ,   nursacptdt  
                            ,   dracptyn    
                            ,   dracptdt    
                            ,   prcpgenryn  
                            ,   prcpnotoccrresn 
                            ,   estmspclappyn   
                            ,   elbulbodstat    
                            ,   elbulbodstatdt  
                            ,   calcflag    
                            ,   calcmthdflag
                            ,   dnoracptyn  
                            ,   rqstflag    
                            ,   rqsthospcd  
                            ,   rqstdrid        
                            ,   tdayinflag  
                            ,   tranindd    
                            ,   rcptdd  
                            ,   rcptno  
                            ,   rcptseqno   
                            ,   telrsrvrem  
                            ,   updtcnclresn
                            ,   fstacptid   
                            ,   fstacptdt   
                            ,   fstrgstrid  
                            ,   fstrgstdt   
                            ,   lastupdtrid 
                            ,   lastupdtdt  
                            ,   ordreqformflag
                            ,   handicaprbookpossnyn
                            ,   outercdrgstyn
                            ,   undersixageyn
                            ,   remfact
                            ,   spclcd
                            ,   onestop
                            ,   ownbflag
                            ,   ordpatyn
                            ,   uncocd
                            ,   pmflag
                            ,   emplno
                            ,   suppkindsubyn
                            ,   earnendyn
                            ,   rareobstflag
                            ,   tranflag
                            ,   onlnno
                            ,   inetproxyrrgstno
                            ,   holdflag
							,   subdeptcd
                            )
                SELECT  pid 
                            ,   orddd   
                            ,   cretno  
                            ,   1  
                            ,   instcd  
                            ,   'R'
                            ,   orgorddd    
                            ,   orgcretno   
                            ,   calcbaseflag    
                            ,   calcyn
                            ,   ordtm   
                            ,   orddeptcd   
                            ,   orddrid 
                            ,   dutdeptcd   
                            ,   centcd  
                            ,   supdeptcd   
                            ,   mskind  
                            ,   insukind
                            ,   suppkind
                            ,   insucd
                            ,   suppkindresn
                            ,   specordyn
                            ,   holiflag    
                            ,   fsexamflag
                            ,   fsexammanlyn
                            ,   ordtype 
                            ,   brateflag   
                            ,   medamtestmyn
                            ,   medamtpostyn
                            ,   medamtfreeresn
                            ,   rsrvflag    
                            ,   etcordflag
                            ,   disccd
                            ,   hosoutexptresncd    
                            ,   clincstdyacptflag
                            ,   clincstdyno 
                            ,   chrtlendyn  
                            ,   specorddescyn   
                            ,   ordreqdescyn    
                            ,   ordreqhospgrde  
                            ,   insuchrgyn  
                            ,   nursacptyn  
                            ,   nursacptdt  
                            ,   dracptyn    
                            ,   dracptdt    
                            ,   prcpgenryn  
                            ,   prcpnotoccrresn 
                            ,   estmspclappyn   
                            ,   elbulbodstat    
                            ,   elbulbodstatdt  
                            ,   'Y'
                            ,   calcmthdflag
                            ,   dnoracptyn  
                            ,   rqstflag    
                            ,   rqsthospcd  
                            ,   rqstdrid    
                            ,   tdayinflag  
                            ,   tranindd    
                            ,   rcptdd  
                            ,   rcptno  
                            ,   rcptseqno   
                            ,   telrsrvrem      
                            ,   updtcnclresn
                            ,   fstacptid   
                            ,   fstacptdt   
                            ,   CAST(#sessinstcd#    AS VARCHAR2(10))
                            ,   SYSTIMESTAMP
                            ,   CAST(#sessinstcd#   AS VARCHAR2(10))
                            ,   SYSTIMESTAMP
                            ,   ordreqformflag
                            ,   handicaprbookpossnyn
                            ,   outercdrgstyn
                            ,   undersixageyn
                            ,   remfact
                            ,   spclcd
                            ,   onestop
                            ,   ownbflag
                            ,   ordpatyn
                            ,   uncocd
                            ,   pmflag
                            ,   emplno
                            ,   suppkindsubyn   
                            ,   earnendyn
                            ,   rareobstflag
                            ,   tranflag
                            ,   onlnno
                            ,   inetproxyrrgstno
                            ,   holdflag
							,   subdeptcd
                FROM pam.pmohotpt                   
               WHERE pid     = #pid#
                 AND orddd   = #orddd#    
                 AND cretno  = #cretno#    
                 AND instcd  = #sessinstcd#
           ]]>       
    </statement> 
    

   <!-- 수납소시 의처방테이 처방상로 RolBac -->  
   <statement id="seOutOprStatCacel"><![CDATA[     
      UPDATE emr.MOHOPRC
         SET prcpsatcd = '000' 
            ,lastupdtrid = #sessuserid#
            ,lastupdtdt  = SYSTIMESTAMP 
       WHERE pid       =   #emr_pid#
         AND orddd     =  #emr_orddd#
         AND cretno    =  #emr_cretno#
         AND instcd    =   #sessinstcd#              
         AND prcphistcd  = 'O'
         AND tempprcpflag     <> 'Y'
         AND hscttempprcpflag <> 'Y'
         AND prcpflag  IN ('1','3')
         AND  (prcpdd,prcpno)  IN (SELECT DISTINCT prcpdd, prcpno
                                     FROM pam.paohoscl
                                    WHERE pid       = #emr_pid#
                                      AND orddd     = #emr_orddd#
                                      AND cretno    = #emr_cretno#
                                      AND calcstat  = 'D'
                                      AND prcpno      > 0
                                      AND prcphistno  > 0
                                      AND instcd    = #sessinstcd#
                                   )
           ]]>         
    </statement> 


<!-- 외래처방내역의 처방급비정보 변경  MMOHOPRC update  -->    
    <statement id="setOprcPayFlag"><![CDATA[    
        UPDATE emr.MMOHOPRC
           SET payflagcd = #prcp_payflagcd#
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP
        WHERE       pid                     =   #prcp_pid#
              AND   prcpdd                  =   #prcp_prcpdd#
              AND   prcpno                  =   #prcp_prcpno#
              AND   prcphistno          =   #prcp_prcphistno#
              AND   prcphistcd              =   'O'
              AND   prcpcd                  =   #prcp_calcscorcd#
              AND   prcpflag                in ('1','3')
              AND   tempprcpflag        <> 'Y'
              AND   hscttempprcpflag    <> 'Y'
              AND   instcd                  =   #sessinstcd#
           ]]>         
    </statement> 


    <!--  멀티건 보험유형, 할인내역, 외래등록내역(초재진구분,선택진료구분,진찰료산정구분 등) -->    
    <!--  등의 유형변경 사항 체크하여 정산구분 조회(return) -->
    <!--  비교하는 것 중에, 변경사항이 하나라도 있을 경우, 정산 calcyn = Y  -->
    <!-- 보험유형, 유형보조, 수급절차, 감면계정이 다른경우 유형변경한다.  -->
    <!--
    <statement id="getMultiChangelist"><![CDATA[    
        SELECT 'N' AS calcyn
          FROM pam.pmohotpt
         WHERE pid             = #pid#
           AND orddd           = #orddd#
           AND cretno          = #cretno#
           AND instcd          = #sessinstcd#
           AND histstat        in ('R','T')
           AND insukind        = #insukind#        
           AND suppkind        = #suppkind#        
           AND disccd          = #disccd#          
           AND ordreqformflag  = #ordreqformflag#  
           AND ordtype         = 'O'
           ]]>
    </statement> 
    -->
    
  <!-- 멀티건일경우 외래등록 내역 이력 추가 (계산 수행시, 유형변경된 내역 있을 경우) --> 
   <!-- TXPAO00101 -->
   <!-- CAST(#pid# AS VARCHAR2(10))  -->
   <statement id="insMultiOtptHist"><![CDATA[    
        INSERT INTO     pam.pmohotpt
                            (   pid 
                            ,   orddd   
                            ,   cretno  
                            ,   acptseqno   
                            ,   instcd  
                            ,   histstat    
                            ,   orgorddd    
                            ,   orgcretno   
                            ,   calcbaseflag    
                            ,   calcyn  
                            ,   ordtm   
                            ,   orddeptcd   
                            ,   orddrid 
                            ,   dutdeptcd   
                            ,   centcd  
                            ,   supdeptcd   
                            ,   mskind  
                            ,   insukind    
                            ,   suppkind    
                            ,   insucd  
                            ,   suppkindresn    
                            ,   specordyn   
                            ,   holiflag    
                            ,   fsexamflag  
                            ,   fsexammanlyn    
                            ,   ordtype 
                            ,   brateflag   
                            ,   medamtestmyn    
                            ,   medamtpostyn    
                            ,   medamtfreeresn  
                            ,   rsrvflag    
                            ,   etcordflag  
                            ,   disccd  
                            ,   hosoutexptresncd    
                            ,   clincstdyacptflag   
                            ,   clincstdyno 
                            ,   chrtlendyn  
                            ,   specorddescyn   
                            ,   ordreqdescyn    
                            ,   ordreqhospgrde  
                            ,   insuchrgyn  
                            ,   nursacptyn  
                            ,   nursacptdt  
                            ,   dracptyn    
                            ,   dracptdt    
                            ,   prcpgenryn  
                            ,   prcpnotoccrresn 
                            ,   estmspclappyn   
                            ,   elbulbodstat    
                            ,   elbulbodstatdt  
                            ,   calcflag    
                            ,   calcmthdflag
                            ,   dnoracptyn  
                            ,   rqstflag    
                            ,   rqsthospcd  
                            ,   rqstdrid        
                            ,   tdayinflag  
                            ,   tranindd    
                            ,   rcptdd  
                            ,   rcptno  
                            ,   rcptseqno   
                            ,   telrsrvrem      
                            ,   updtcnclresn
                            ,   fstacptid   
                            ,   fstacptdt   
                            ,   fstrgstrid  
                            ,   fstrgstdt   
                            ,   lastupdtrid 
                            ,   lastupdtdt  
                            ,   ordreqformflag
                            ,   handicaprbookpossnyn
                            ,   outercdrgstyn
                            ,   undersixageyn
                            ,   remfact
                            ,   spclcd
                            ,   onestop
                            ,   ownbflag
                            ,   ordpatyn
                            ,   uncocd
                            ,   pmflag
                            ,   emplno
                            ,   suppkindsubyn   
                            ,   earnendyn
                            ,   rareobstflag
                            ,   tranflag
                            ,   onlnno
                            ,   inetproxyrrgstno
                            ,   holdflag
							,   subdeptcd
                            )
                SELECT  pid 
                            ,   orddd   
                            ,   cretno  
                            ,   1  
                            ,   instcd  
                            ,   histstat--'R'
                            ,   orgorddd    
                            ,   orgcretno   
                            ,   calcbaseflag    
                            ,   'Y'
                            ,   ordtm   
                            ,   orddeptcd   
                            ,   orddrid 
                            ,   dutdeptcd   
                            ,   centcd  
                            ,   supdeptcd   
                            ,   mskind  
                            ,   CAST(#insukind#  AS VARCHAR2(2))
                            ,   CAST(#suppkind#  AS VARCHAR2(2))
                            ,   insucd
                            ,   suppkindresn
                            ,   specordyn
                            ,   holiflag    
                            ,   fsexamflag
                            ,   fsexammanlyn
                            ,   ordtype 
                            ,   brateflag   
                            ,   medamtestmyn
                            ,   medamtpostyn
                            ,   medamtfreeresn
                            ,   rsrvflag    
                            ,   etcordflag
                            ,   CAST(#disccd#    AS VARCHAR2(3))
                            ,   hosoutexptresncd
                            ,   clincstdyacptflag
                            ,   clincstdyno 
                            ,   chrtlendyn  
                            ,   specorddescyn   
                            ,   ordreqdescyn    
                            ,   ordreqhospgrde  
                            ,   insuchrgyn  
                            ,   nursacptyn  
                            ,   nursacptdt  
                            ,   dracptyn    
                            ,   dracptdt    
                            ,   prcpgenryn  
                            ,   prcpnotoccrresn 
                            ,   estmspclappyn   
                            ,   elbulbodstat    
                            ,   elbulbodstatdt  
                            ,   calcflag    
                            ,   calcmthdflag
                            ,   dnoracptyn  
                            ,   rqstflag    
                            ,   rqsthospcd  
                            ,   rqstdrid    
                            ,   tdayinflag  
                            ,   tranindd    
                            ,   rcptdd  
                            ,   rcptno  
                            ,   rcptseqno   
                            ,   telrsrvrem  
                            ,   updtcnclresn
                            ,   fstacptid   
                            ,   fstacptdt   
                            ,   CAST(#sessinstcd#       AS VARCHAR2(10))
                            ,   SYSTIMESTAMP
                            ,   CAST(#sessinstcd#       AS VARCHAR2(10))
                            ,   SYSTIMESTAMP
                            ,   CAST(#ordreqformflag#   AS VARCHAR2(1))
                            ,   handicaprbookpossnyn
                            ,   outercdrgstyn
                            ,   undersixageyn
                            ,   remfact
                            ,   spclcd
                            ,   onestop
                            ,   ownbflag
                            ,   ordpatyn
                            ,   uncocd
                            ,   pmflag
                            ,   emplno
                            ,   suppkindsubyn   
                            ,   earnendyn
                            ,   rareobstflag
                            ,   tranflag
                            ,   onlnno
                            ,   inetproxyrrgstno
                            ,   holdflag
							,   subdeptcd
               FROM  pam.pmohotpt                
              WHERE  pid             = #pid#
                AND  orddd           = #orddd#    
                AND  cretno          = #cretno#    
                AND  instcd          = #sessinstcd#   
           ]]>         
    </statement>     
    
    
    <!--  정산에서 재계산후 RollBack처리(삭제) -->
     <statement id="delOtptJudg"><![CDATA[
        DELETE FROM pam.pmohotpt
         WHERE pid    = #pid#
           AND orddd  = #orddd#   
           AND cretno = #cretno#  
           AND instcd = #sessinstcd#
    ]]>                    
    </statement>    
    
    
    <!-- 외래등록내역 HistStat update  -->    
    <statement id="setOtptJudgHistCancel"><![CDATA[    
        UPDATE pam.pmohotpt a
           SET histstat    = 'R'
              ,calcflag    = 'N'
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP
         WHERE pid    = #pid#
           AND orddd  = #orddd#
           AND cretno = #cretno#
           AND instcd = #sessinstcd#
     ]]>
    </statement>     
    
    
    <!-- 정산에서 재계산후 RollBack처리(삭제) -->
     <statement id="delOsclJudg"><![CDATA[
        DELETE FROM pam.paohoscl
         WHERE pid    = #pid#
           AND orddd  = #orddd#   
           AND cretno = #cretno#  
           AND instcd = #sessinstcd#             
           AND calcstat != 'Y'
           AND acptseqno > (SELECT MAX(acptseqno)
                              FROM pam.paohoscl
                             WHERE pid      = #pid#
                               AND orddd    = #orddd#   
                               AND cretno   = #cretno#  
                               AND instcd   = #sessinstcd#    
                               AND calcstat = 'Y')
    ]]>                    
    </statement>          


    <!-- 기감면내역생성(실시정산시) 2008/03/19 조영상 -->   
    <statement id="insPreCashAmt"><![CDATA[ 
        INSERT INTO pam.pachcash (
               pid
			,  orddd
			,  cretno
            ,  rcptdd  
            ,  rcptno  
            ,  rcptseqno       
            ,  seqno   
            ,  instcd  
            ,  rcptstat        
            ,  ordtype 
            ,  keyinptflag     
            ,  indinstflag     
            ,  qualcnfmflag    
            ,  qualcnfmno      
            ,  aprvflag        
            ,  aprvno  
            ,  aprvdd  
            ,  aprvtm  
            ,  cashamt 
            ,  rcptexecdd      
            ,  rcpttm  
            ,  rcptrid 
            ,  preamtyn        
            ,  innrtretyn      
            ,  remfact 
            ,  fstrgstrid      
            ,  fstrgstdt       
            ,  lastupdtrid     
            ,  lastupdtdt
            )
         SELECT             
               cash.pid
			,  cash.orddd
			,  cash.cretno
            ,  CAST(#opmi_rcptexecdd# AS VARCHAR2(8))   --cash.rcptdd   
            ,  CAST(#opmi_rcptno# AS INTEGER)       --cash.rcptno   
            ,  CAST(#opmi_rcptseqno# AS INTEGER)    --cash.rcptseqno    
            ,  (SELECT NVL(MAX(seqno),0) + 1
                           FROM pam.padhdcgm
                          WHERE pid    = #opmi_pid#
                            AND rcptdd = #opmi_rcptexecdd#
                            AND rcptno = #opmi_rcptno#
                            AND rcptseqno = #opmi_rcptseqno#
                            AND instcd  =   #sessinstcd#  
               )                                    --cash.seqno    
            ,  cash.instcd  
            ,  'Y'                                  --cash.rcptstat 
            ,  cash.ordtype 
            ,  cash.keyinptflag 
            ,  cash.indinstflag 
            ,  cash.qualcnfmflag    
            ,  cash.qualcnfmno  
            ,  cash.aprvflag    
            ,  cash.aprvno  
            ,  cash.aprvdd  
            ,  cash.aprvtm  
            ,  CAST(cash.cashamt * -1 AS  NUMBER(10,0)) 
            ,  CAST(#opmi_rcptexecdd# AS VARCHAR2(8))   --cash.rcptexecdd   
            ,  CAST(#opmi_rcpttm# AS VARCHAR2(6))       --cash.rcpttm   
            ,  CAST(#opmi_rcptrid#  AS VARCHAR2(10))    --cash.rcptrid  
            ,  cash.preamtyn    
            ,  cash.innrtretyn  
            ,  cash.remfact 
            ,  CAST(#opmi_rcptrid#  AS VARCHAR2(10))    --cash.fstrgstrid   
            ,  SYSTIMESTAMP
            ,  CAST(#opmi_rcptrid#  AS VARCHAR2(10))    --cash.lastupdtrid  
            ,  SYSTIMESTAMP
       FROM pam.pachcash cash
           ,pam.paohopmi opmi           
      WHERE opmi.pid         = #opmi_pid#           
        AND opmi.orddd       = #opmi_orddd#       
        AND opmi.cretno      = #opmi_cretno#      
        AND opmi.instcd      = #sessinstcd#           
        AND cash.pid         = opmi.pid           
        AND cash.rcptdd      = opmi.rcptdd        
        AND cash.rcptno      = opmi.rcptno        
        AND cash.rcptseqno   = opmi.rcptseqno     
        AND cash.instcd      = opmi.instcd        
        AND cash.rcptstat    = 'D'                
        AND cash.rcptexecdd  = #opmi_rcptexecdd#  
        AND cash.rcpttm      = #opmi_rcpttm#      

     ]]>
    </statement>  



   <!-- 보증금내역 생성(정산시) 내부처리용으로 생성 --> 
   <!-- TXPAO00102 -->
   <statement id="insPreBogjAmt"><![CDATA[    
      INSERT INTO pam.paohbogj(   
                  pid             
                , rcptdd          
                , rcptno          
                , rcptseqno       
                , seqno           
                , instcd          
                , rcptstat        
                , ordtype         
                , rcptflag
                , cashamt
                , cardamt
                , onlineamt                           
                , rcptexecdd      
                , rcpttm          
                , rcptrid
                , orddeptcd
                , remfact         
                , paypsnflag
                , paydepoamt
                , paypsnrem
                , fstrgstrid      
                , fstrgstdt       
                , lastupdtrid     
                , lastupdtdt 
          )  
          SELECT                  
                  bogj.pid             
                , CAST(#opmi_rcptexecdd# AS VARCHAR2(8))   --bogj.rcptdd          
                , CAST(#opmi_rcptno# AS INTEGER)       --bogj.rcptno          
                , CAST(#opmi_rcptseqno# AS INTEGER)    --bogj.rcptseqno       
                , (SELECT NVL(MAX(seqno),0) + 1
                           FROM pam.paohbogj
                          WHERE pid    = #opmi_pid#
                            AND rcptdd = #opmi_rcptexecdd#
                            AND rcptno = #opmi_rcptno#
                            AND rcptseqno = #opmi_rcptseqno#
                            AND instcd  =   #sessinstcd#  
                  )                                    --bogj.seqno 
                , bogj.instcd          
                , 'Y'                                  --bogj.rcptstat        
                , bogj.ordtype         
                , bogj.rcptflag
                , bogj.cashamt
                , bogj.cardamt
                , bogj.onlineamt                           
                , CAST(#opmi_rcptexecdd# AS VARCHAR2(8))   --bogj.rcptexecdd      
                , CAST(#opmi_rcpttm# AS VARCHAR2(6))       --bogj.rcpttm          
                , CAST(#opmi_rcptrid#  AS VARCHAR2(10))    --bogj.rcptrid
                , bogj.orddeptcd
                , bogj.remfact         
                , bogj.paypsnflag
                , bogj.paydepoamt
                , bogj.paypsnrem
                , CAST(#opmi_rcptrid#  AS VARCHAR2(10))    --bogj.fstrgstrid      
                , SYSTIMESTAMP
                , CAST(#opmi_rcptrid#  AS VARCHAR2(10))    --bogj.lastupdtrid     
                , SYSTIMESTAMP
            FROM pam.paohbogj bogj
                ,pam.paohopmi opmi             
           WHERE opmi.pid        = #opmi_pid#
             AND opmi.orddd      = #opmi_orddd#    
             AND opmi.cretno     = #opmi_cretno#
             AND opmi.instcd     = #sessinstcd#   
             AND bogj.pid        = opmi.pid
             AND bogj.rcptdd     = opmi.rcptdd
             AND bogj.rcptno     = opmi.rcptno
             AND bogj.rcptseqno  = opmi.rcptseqno
             AND bogj.instcd     = opmi.instcd 
             AND bogj.rcptstat   = 'C'
           ]]>
    </statement> 


  <!-- cnst테이블 중복체크 TXPAO00107 -->
   <statement id="getOutOrdCnst"><![CDATA[    
       SELECT * from pam.pmcmcnst  
        WHERE pid        = #pid#
          AND orddeptcd  = #orddeptcd#
          AND insuflag   = #insuflag#
          AND ordreqkind = #ordreqkind#
          AND instcd    =   #sessinstcd#  
             ]]> 
    </statement> 


  <!-- 환자진료의뢰서 입력 TXPAO00107. -->
   <statement id="insOutOrdCnst"><![CDATA[    
        INSERT INTO pam.pmcmcnst (
                    pid
                   ,orddeptcd
                   ,insuflag
                   ,ordreqkind
                   ,todd
                   ,seqno
                   ,instcd
                   ,histstat
                   ,fromdd
                   ,reqformhospnm
                   ,reqformdrnm
                   --,remfact
                   ,fstrgstrid
                   ,fstrgstdt
                   ,lastupdtrid
                   ,lastupdtdt
                   --,mig
           )VALUES (  
                    #pid#
                   ,#orddeptcd#
                   ,#insuflag#
                   ,#ordreqkind#
                   ,'99991231'
                   ,
                    (
                      SELECT nvl(MAX(seqno),0) + 1
                        FROM pam.pmcmcnst
                       WHERE pid         = #pid#
                         AND instcd        = #sessinstcd#            
                         AND orddeptcd   = #orddeptcd#
                         AND insuflag      = #insuflag#
                         AND ordreqkind  = #ordreqkind#
                         AND todd          = '99991231' 
                    ) 
                   ,#sessinstcd#
                   ,'Y'
                   ,#orddd#
                   ,nvl(#reqformhospnm#, '-')
                   ,nvl(#reqformdrnm#, '-')
                   --,remfact
                   ,#sessuserid#
                   ,SYSTIMESTAMP
                   ,#sessuserid#
                   ,SYSTIMESTAMP
                   --,mig
           )
    ]]> 
    </statement> 


    <!-- 외래급비변경 외래미시행처방 미시행 오더 조회 TRPAO00401 -->
    <statement id="getoutunexecprcpordref">
             SELECT distinct c.prcpcd
                        , c.grupsnglyn
                        , c.calcscorcd
                        , c.edicd                       AS edicd
                        , c.hngnm                       AS ordnm
                        , c.payflagcd
                        , c.execprcpqty
                        , c.execprcptims
                        , c.execprcpdayno
                        , c.orddd
                        , c.cretno
                        , c.prcphopedd                  -- 2.실시희망일
                        , c.actorddd                    -- 1.실시처방일
                        , (CASE WHEN c.exectm   = '00000000000000' THEN ' ' ELSE c.exectm END) AS exectm    -- 3.실시일시
                        , c.execprcpstatcd              -- 실시상태
                        , c.orddrid                     
                        , c.judgendflag
                        , c.ioflag
                        , c.orddeptcd
                        , (CASE 
                                (SELECT COUNT(d.pid)
                                   FROM pam.piohdiag d
                                  WHERE d.pid      = c.pid
                                    AND d.orddd    = c.orddd
                                    AND d.instcd   = c.instcd
                                    AND d.rowstat  != 'D')
                            WHEN 0 then 'N' ELSE 'Y' END )           AS diagyn
                        , (CASE COALESCE(e.spclcd,'N') WHEN 'N' then 'N' ELSE 'Y' END )      AS spclyn
                        , e.unitflag
                        , e.spclcd
                        , (CASE e.spclcd
                                WHEN 'JX999' THEN PAM.FN_PI_GETJUDGMEMO2(e.pid, e.orddd, e.cretno, e.instcd, 'E', e.edicd, 'JX999')
                        <!--    WHEN 'MX999' THEN (CASE e.spclmemoflag
                                                                        WHEN 'U' THEN PAM.FN_PI_GETJUDGMEMO2(e.pid, e.orddd, e.cretno, e.instcd, 'U', e.edicd, 'MX999')
                                                                        ELSE PAM.FN_PI_GETJUDGMEMO2(e.pid, e.orddd, e.cretno, e.instcd, 'E', e.edicd, 'MX999')
                                                                        END) -->
                                ELSE ''
                            END) AS spclspec
                        , c.prcpdd                      -- 처방일시
                        , c.prcptm
                        , c.prcpno
                        , c.prcphistno  
                        , c.execprcpno           AS execprcpseqno
                        , c.pid
                        , c.instcd
                        , e.spclmemoflag                            -- 특정메모구분_U:사용자메모, E:EDI메모
                        , e.remfact
                        , 0 as seqno
                        , (SELECT f.insukind 
                              FROM pam.pmohotpt f
                            WHERE f.pid = c.pid
                                 AND f.orddd = c.orddd
                                 AND f.cretno = c.cretno
                                 AND f.instcd = c.instcd
                                 AND f.histstat = 'R'
                                 AND f.dracptyn = 'Y') AS insukind
                        , (CASE WHEN c.rsrvtm   = '00000000000000' THEN ' ' ELSE c.rsrvtm END) AS rsrvtm
                        , 'N' AS payflagyn
                        , CASE c.hosinhosoutflag WHEN '-' THEN 'I' ELSE c.hosinhosoutflag END AS hosinhosoutflag
                        , c.choiordflag										-- 선택진료구분
                        , c.specdrid											-- 선택진료의
                        , c.calcflag											-- no charge 여부 Y산정/D미산정/N미계산
                        , COM.FN_ZS_GETUSERNM(c.specdrid, c.orddd) AS specdrnm
              FROM ( SELECT a.pid
                                    , a.instcd              
                                    , a.prcpcd
                                    , a.prcpdd
                                    , a.prcptm                                      
                                    , CASE b.grupsnglflag 
                                        WHEN 'G' THEN 'G'
                                        WHEN 'M' THEN 'M'
                                        ELSE ''
                                     End grupsnglyn
                                    , b.calcscorcd
                                    , (CASE COALESCE(#insukind#, '11')
                                                WHEN '11' THEN b.insuedicd
                                                WHEN '21' THEN b.procedicd
                                                WHEN '22' THEN b.procedicd 
                                                WHEN '31' THEN b.autmbedicd
                                                WHEN '41' THEN b.inducsedicd
                                                WHEN '51' THEN b.gnrledicd
                                                WHEN '61' THEN b.forgnedicd
                                                WHEN '71' THEN b.mouedicd
                                                ELSE b.insuedicd
                                        END)                     AS edicd
                                    , b.hngnm
                                    , a.payflagcd
                                    , a.execprcpqty
                                    , a.execprcptims
                                    , a.execprcpdayno
                                    , a.orddd
                                    , a.cretno
                                    , a.prcphopedd
                                    , a.actorddd
                                   <!--     , 'true' AS sytsjudg    --> 
                                    , a.judgendflag             -- 통합심사
                                    , 'O' AS ioflag
                                    , a.orddeptcd
                                    , a.orddrid                                     
                                    , a.prcpno
                                    , a.prcphistno
                                    , a.execprcpno
                                    , a.exectm                      -- 실시시간
                                    , a.execprcpstatcd          -- 실시상태
                                    , a.rsrvtm                          -- 예약일시
                                    , a.hosinhosoutflag         -- 원내/원외구분
                                    , a.choiordflag										-- 선택진료 구분
                                    , a.specdrid											-- 선택진료의
                                    , a.calcflag											-- no charge 여부 Y산정/D미산정/N미계산
                              FROM (SELECT x.pid
                                                    , x.instcd
                                                    , x.prcpcd
                                                    , x.prcpdd
                                                    , x.rgstdd || x.rgsttm AS prcptm    -- 처방시간
                                                    , x.prcpno
                                                    , x.prcphistno
                                                    , x.orddeptcd
                                                    , x.orddrid
                                                    , x.payflagcd           -- M0029(급여구분코드 0:급여, 1:본인부담, 2:일반)
                                                    , y.execprcpqty
                                                    , y.execprcptims
                                                    , y.execprcpdayno
                                                    , x.orddd
                                                    , x.cretno
                                                    , x.prcphopedd
                                                    , y.actorddd
                                                    , y.rsrvflag
                                                    , y.execdd
                                                    , y.execprcphistcd  
                                                    , y.execprcpno  
                                                --  , y.judgendflag
                                                    , 'N' as  judgendflag
                                                    , y.execdd || y.exectm  AS exectm                       -- 실시시간
                                                    , (SELECT    cdnm 
                                                          FROM   com.zbcmcode 
                                                        WHERE    cdgrupid = 'M0011' 
                                                             AND     cdid = y.execprcpstatcd)  AS execprcpstatcd    -- 실시상태
                                                    , y.rsrvdd || y.rsrvtm AS rsrvtm                    -- 예약일시
                                                    , x.hosinhosoutflag                                 -- 원내/원외 구분
                                                    , x.choiordflag										-- 선택진료 구분
                                                    , x.specdrid											-- 선택진료의
                                                    , y.calcflag											-- no charge 여부 Y산정/D미산정/N미계산
                                            FROM emr.mmohoprc x, emr.mmodexop y
                                          WHERE x.pid                   = #pid#
                                               AND x.orddd              = #orddd#       
                                               AND x.instcd             = #sessinstcd#
                                               AND x.orddeptcd          = #orddeptcd#       
                                               AND x.orddrid            = #orddrid#
                                               AND x.tempprcpflag       = 'N'                   -- 임시처방여부
                                               AND x.hscttempprcpflag   = 'N'                   -- HSCT임시처방여부 
                                               AND x.prcpsetcd          = '-'                   -- MSET 풀린 처방은 보여주지 않음
                                               AND y.prcpdd             = x.prcpdd
                                               AND y.prcpno             = x.prcpno
                                               AND y.prcphistno         = x.prcphistno
                                               AND y.instcd             = x.instcd
                                               AND y.pid                = x.pid
                                               AND y.orddd              = x.orddd
                                               AND y.calcflag           = 'Y' ) a
                                        , pam.picmmech b
                                WHERE 
                                <!-- a.pid                      = #pid#
                                     AND a.instcd               = #sessinstcd#
                                     AND a.orddeptcd            = #orddeptcd#       
                                     AND a.prcphopedd           = #prcphopedd# 
                                     AND a.orddrid              = #orddrid#             
                                     AND a.orddd                = #orddd#
                                     AND -->
--                                   a.rsrvflag                 = 'N'       -- 검사처방에 대한 예약구분(Y:예약, N:예약안함, R:지원부서예약Table과관련 없는 예약)
                                     <isEmpty  property="chk2">
                                     <![CDATA[
                                     a.execdd      = '00000000' 
                                     AND a.execprcphistcd   = 'O'           -- 실시처방에 대한 변경 이력(O:처방, C:DC된원처방, D:DC된처방, E:의사반납, H:수정처방, L:삭제처방)
                                     AND b.calcscorcd       = a.prcpcd
                                     AND b.todd             >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                                     AND b.instcd           = a.instcd
                                     AND b.fromdd           <= TO_CHAR(SYSDATE, 'YYYYMMDD')) c
                                     ]]>
                                     </isEmpty>
                                     <isNotEmpty  property="chk2">
                                     <![CDATA[
                                     a.execprcphistcd   = 'O'           -- 실시처방에 대한 변경 이력(O:처방, C:DC된원처방, D:DC된처방, E:의사반납, H:수정처방, L:삭제처방)
                                     AND b.calcscorcd   = a.prcpcd
                                     AND b.todd         >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                                     AND b.instcd       = a.instcd
                                     AND b.fromdd       <= TO_CHAR(SYSDATE, 'YYYYMMDD')) c
                                     ]]>
                                     </isNotEmpty>
                    
                    ,(SELECT 
                              spclcd
                            , unitflag
                            , pid
                            , orddd
                            , cretno
                            , instcd
                            , edicd
                            , spclmemoflag
                            , remfact
                            , prcpdd
                            , prcpno
                            , prcphistno
                            , execprcpseqno        
                         FROM pam.piohclcj 
                       WHERE pid      = #pid#
                         AND orddd    = #orddd#
                         AND instcd   = #sessinstcd#
                         AND spclcd   = 'JX999'
                         AND rowstat != 'D'
                       GROUP BY spclcd, unitflag, pid, orddd, cretno, instcd, edicd, spclmemoflag, remfact, prcpdd, prcpno, prcphistno, execprcpseqno
                      ) e
        WHERE c.prcpdd    = e.prcpdd(+)
          AND  c.pid      = e.pid(+)
          AND c.orddd     = e.orddd(+)
          AND c.edicd     = e.edicd(+)
        ORDER BY c.calcscorcd, c.edicd
    </statement>
    
    
    <!-- 입원급비변경 입원 오더 조회 TRPAO00421 -->
    <statement id="getInUnExecPrcpOrdRef">
             SELECT distinct c.prcpcd
                        , c.grupsnglyn
                        , c.calcscorcd
                        , c.edicd                       AS edicd
                        , c.hngnm                       AS ordnm
                        , c.payflagcd
                        , c.execprcpqty
                        , c.execprcptims
                        , c.execprcpdayno
                        , c.orddd
                        , c.cretno
                        , c.prcphopedd                  -- 2.실시희망일
                        , c.actorddd                    -- 1.실시처방일
                        , (CASE WHEN c.exectm   = '00000000000000' THEN ' ' ELSE c.exectm END) AS exectm    -- 3.실시일시
                        , c.execprcpstatcd              -- 실시상태
                        , c.orddrid                     
                        , c.judgendflag
                        , c.ioflag
                        , c.orddeptcd
                        , (CASE 
                                (SELECT COUNT(d.pid)
                                   FROM pam.piohdiag d
                                  WHERE d.pid      = c.pid
                                    AND d.orddd    = c.orddd
                                    AND d.instcd   = c.instcd
                                    AND d.rowstat  != 'D')
                            WHEN 0 then 'N' ELSE 'Y' END )           AS diagyn
                        , (CASE COALESCE(e.spclcd,'N') WHEN 'N' then 'N' ELSE 'Y' END )      AS spclyn
                        , e.unitflag
                        , e.spclcd
                        , (CASE e.spclcd
                                WHEN 'JX999' THEN PAM.FN_PI_GETJUDGMEMO2(e.pid, e.orddd, e.cretno, e.instcd, 'E', e.edicd, 'JX999')
                        <!--    WHEN 'MX999' THEN (CASE e.spclmemoflag
                                                                        WHEN 'U' THEN PAM.FN_PI_GETJUDGMEMO2(e.pid, e.orddd, e.cretno, e.instcd, 'U', e.edicd, 'MX999')
                                                                        ELSE PAM.FN_PI_GETJUDGMEMO2(e.pid, e.orddd, e.cretno, e.instcd, 'E', e.edicd, 'MX999')
                                                                        END) -->
                                ELSE ''
                            END) AS spclspec
                        , c.prcpdd                      -- 처방일시
                        , c.prcptm
                        , c.prcpno
                        , c.prcphistno  
                        , c.execprcpno           AS execprcpseqno
                        , c.pid
                        , c.instcd
                        , e.spclmemoflag                            -- 특정메모구분_U:사용자메모, E:EDI메모
                        , e.remfact
                        , 0 as seqno
                        , (SELECT f.insukind 
                              FROM pam.pmihiphs f
                            WHERE f.pid = c.pid
                                 AND f.indd = c.orddd
                                 AND f.cretno = c.cretno
                                 AND f.instcd = c.instcd
                                 AND f.histstat = 'Y'
                                 AND c.prcpdd between f.fromdd and f.todd ) AS insukind
                        , (CASE WHEN c.rsrvtm   = '00000000000000' THEN ' ' ELSE c.rsrvtm END) AS rsrvtm
                        , 'N' AS payflagyn
                        , CASE c.hosinhosoutflag WHEN '-' THEN 'I' ELSE c.hosinhosoutflag END AS hosinhosoutflag
              FROM ( SELECT a.pid
                                    , a.instcd              
                                    , a.prcpcd
                                    , a.prcpdd
                                    , a.prcptm                                      
                                    , CASE b.grupsnglflag 
                                        WHEN 'G' THEN 'G'
                                        WHEN 'M' THEN 'M'
                                        ELSE ''
                                     End grupsnglyn
                                    , b.calcscorcd
                                    , (CASE COALESCE(#insukind#, '11')
                                                WHEN '11' THEN b.insuedicd
                                                WHEN '21' THEN b.procedicd
                                                WHEN '22' THEN b.procedicd 
                                                WHEN '31' THEN b.autmbedicd
                                                WHEN '41' THEN b.inducsedicd
                                                WHEN '51' THEN b.gnrledicd
                                                WHEN '61' THEN b.forgnedicd
                                                WHEN '71' THEN b.mouedicd
                                                ELSE b.insuedicd
                                        END)                     AS edicd
                                    , b.hngnm
                                    , a.payflagcd
                                    , a.execprcpqty
                                    , a.execprcptims
                                    , a.execprcpdayno
                                    , a.orddd
                                    , a.cretno
                                    , a.prcphopedd
                                    , a.actorddd
                                   <!--     , 'true' AS sytsjudg    --> 
                                    , a.judgendflag             -- 통합심사
                                    , 'O' AS ioflag
                                    , a.orddeptcd
                                    , a.orddrid                                     
                                    , a.prcpno
                                    , a.prcphistno
                                    , a.execprcpno
                                    , a.exectm                      -- 실시시간
                                    , a.execprcpstatcd          -- 실시상태
                                    , a.rsrvtm                          -- 예약일시
                                    , a.hosinhosoutflag         -- 원내/원외구분
                              FROM (SELECT x.pid
                                                    , x.instcd
                                                    , x.prcpcd
                                                    , x.prcpdd
                                                    , x.rgstdd || x.rgsttm AS prcptm    -- 처방시간
                                                    , x.prcpno
                                                    , x.prcphistno
                                                    , x.orddeptcd
                                                    , x.orddrid
                                                    , x.payflagcd           -- M0029(급여구분코드 0:급여, 1:본인부담, 2:일반)
                                                    , y.execprcpqty
                                                    , y.execprcptims
                                                    , y.execprcpdayno
                                                    , x.orddd
                                                    , x.cretno
                                                    , x.prcphopedd
                                                    , y.actorddd
                                                    , y.rsrvflag
                                                    , y.execdd
                                                    , y.execprcphistcd  
                                                    , y.execprcpno  
                                                --  , y.judgendflag
                                                    , 'N' as  judgendflag
                                                    , y.execdd || y.exectm  AS exectm                       -- 실시시간
                                                    , (SELECT    cdnm 
                                                          FROM   com.zbcmcode 
                                                        WHERE    cdgrupid = 'M0011' 
                                                             AND     cdid = y.execprcpstatcd)  AS execprcpstatcd    -- 실시상태
                                                    , y.rsrvdd || y.rsrvtm AS rsrvtm                    -- 예약일시
                                                    , x.hosinhosoutflag                                 -- 원내/원외 구분
                                            FROM emr.mmohiprc x, emr.mmodexip y
                                          WHERE x.pid                   = #pid#
                                               AND x.orddd              = #orddd# 
                                               AND x.prcpdd				= #prcpdd#      
                                               AND x.instcd             = #sessinstcd#
                                               AND x.orddeptcd          = #orddeptcd#       
                                               AND x.orddrid            = #orddrid#
                                               AND y.execdd				= #execdd#
                                               AND x.tempprcpflag       = 'N'                   -- 임시처방여부
                                               AND x.hscttempprcpflag   = 'N'                   -- HSCT임시처방여부 
                                               AND x.prcpsetcd          = '-'                   -- MSET 풀린 처방은 보여주지 않음
                                               AND y.prcpdd             = x.prcpdd
                                               AND y.prcpno             = x.prcpno
                                               AND y.prcphistno         = x.prcphistno
                                               AND y.instcd             = x.instcd
                                               AND y.pid                = x.pid
                                               AND y.orddd              = x.orddd
                                               AND y.calcflag           = 'Y' ) a
                                        , pam.picmmech b
                                WHERE
                                     <isEmpty  property="chk2">
                                     <![CDATA[
                                     a.execdd      = '00000000' 
                                     AND a.execprcphistcd   = 'O'           -- 실시처방에 대한 변경 이력(O:처방, C:DC된원처방, D:DC된처방, E:의사반납, H:수정처방, L:삭제처방)
                                     AND b.calcscorcd       = a.prcpcd
                                     AND b.todd             >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                                     AND b.instcd           = a.instcd
                                     AND b.fromdd           <= TO_CHAR(SYSDATE, 'YYYYMMDD')) c
                                     ]]>
                                     </isEmpty>
                                     <isNotEmpty  property="chk2">
                                     <![CDATA[
                                     a.execprcphistcd   = 'O'           -- 실시처방에 대한 변경 이력(O:처방, C:DC된원처방, D:DC된처방, E:의사반납, H:수정처방, L:삭제처방)
                                     AND b.calcscorcd   = a.prcpcd
                                     AND b.todd         >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                                     AND b.instcd       = a.instcd
                                     AND b.fromdd       <= TO_CHAR(SYSDATE, 'YYYYMMDD')) c
                                     ]]>
                                     </isNotEmpty>
                    
                    ,(SELECT 
                              spclcd
                            , unitflag
                            , pid
                            , orddd
                            , cretno
                            , instcd
                            , edicd
                            , spclmemoflag
                            , remfact
                            , prcpdd
                            , prcpno
                            , prcphistno
                            , execprcpseqno        
                         FROM pam.piohclcj 
                       WHERE pid      = #pid#
                         AND orddd    = #orddd#
                         AND instcd   = #sessinstcd#
                         AND spclcd   = 'JX999'
                         AND rowstat != 'D'
                       GROUP BY spclcd, unitflag, pid, orddd, cretno, instcd, edicd, spclmemoflag, remfact, prcpdd, prcpno, prcphistno, execprcpseqno
                      ) e
        WHERE c.prcpdd    = e.prcpdd(+)
          AND  c.pid      = e.pid(+)
          AND c.orddd     = e.orddd(+)
          AND c.edicd     = e.edicd(+)
        ORDER BY c.calcscorcd, c.edicd
    </statement>


    <!--외래급비변경 외래미시행 환자조회 TRPID21403 -->         
    <statement id="getPayPatInfo"><![CDATA[    
        SELECT  a.pid,
                a.instcd,
                a.hngnm as patnm
        FROM  ( SELECT  * FROM PAM.PMCMPTBS
                 WHERE pid    = #pid# 
                   AND instcd = #sessinstcd#    ) a                 
                LEFT OUTER JOIN
                        (   SELECT  mohotpt.pid, 
                                            mohotpt.orddeptcd AS lastorddeptcd, 
                                            c.lastorddd AS lastorddd
                            FROM        pam.pmohotpt mohotpt,
                                            (   SELECT  otpt.pid,
                                                                max (otpt.ordtm) AS lastordtm,
                                                                max (b.lastorddd) AS lastorddd
                                                FROM        pam.pmohotpt otpt,
                                                                (   SELECT  pid, 
                                                                                    max (orddd) AS lastorddd
                                                                    FROM        pam.pmohotpt
                                                                    WHERE   pid in (    SELECT  pid
                                                                                                FROM        pam.pmcmptbs 
                                                                                               WHERE  pid = #pid# 
                                                                                                AND  instcd = #instcd#  )
                                                                    AND instcd = #sessinstcd#
                                                                    AND histstat = 'R'
                                                                    AND dracptyn = 'Y'
                                                                GROUP BY PID    ) b
                                                WHERE   otpt.pid = b.pid
                                                     AND    otpt.orddd = b.lastorddd
                                                     AND    otpt.instcd = #sessinstcd#
                                                     AND    otpt.histstat = 'R'
                                                     AND    otpt.dracptyn = 'Y'
                                               group by otpt.pid    ) c
                            WHERE   mohotpt.pid = c.pid
                                 AND    mohotpt.orddd = c.lastorddd
                                 AND    mohotpt.instcd = #sessinstcd#
                                 AND    mohotpt.histstat = 'R'
                                 AND    mohotpt.ordtm = c.lastordtm
                                 AND    mohotpt.dracptyn = 'Y'  
                                 AND    rownum = 1)  d
                ON  a.pid = d.pid
                ORDER BY lastorddd desc
    ]]> 
    </statement>    



    <!-- [TRPID21401] 외래미시행처방 조회 -->
    <statement id="getoutunexecprcpref"><![CDATA[   
          SELECT distinct a.orddd
                     , a.instcd
                     , a.pid
                     , a.orddeptcd
                     , (SELECT DISTINCT deptengabbr FROM com.zsdddept WHERE deptcd = a.orddeptcd AND instcd = a.instcd AND orduseyn = 'Y' AND valifromdd <= a.orddd AND valitodd     >= a.orddd) AS orddeptnm
                     , a.orddrid
                     , (SELECT DISTINCT usernm 
                           FROM com.zsumusrb 
                         WHERE userid = a.orddrid
                          AND a.orddd BETWEEN userfromdd AND usertodd ) AS orddrnm
                     , (SELECT DISTINCT c.insukind 
                        FROM pam.pmohotpt c 
                        WHERE c.pid  = a.pid
                        AND c.orddd      = a.prcpdd
                        AND c.cretno     = a.cretno
                        AND c.instcd     = a.instcd
                        AND c.histstat   IN('R', 'T')               -- P0029 (X: 취소, C: 변경, R: 접수, T: 가예약)
                     ) AS insukind
                     , a.cretno
            FROM emr.mmohoprc a
         WHERE a.pid        = #pid#
           AND a.instcd     = #sessinstcd#
        ]]>     
             <isEmpty  property="chk">
                <isNotEmpty  property="orddeptcd"><![CDATA[
                 AND a.orddeptcd = #orddeptcd# 
                ]]>
                </isNotEmpty>
            </isEmpty>     
              AND a.tempprcpflag = 'N'          -- 임시처방여부
              AND a.hscttempprcpflag = 'N'      -- HSCT임시처방여부 
            <isNotEmpty  property="fromdd"><![CDATA[
              AND a.orddd   >= #fromdd#
            ]]>
            </isNotEmpty>
            <isNotEmpty  property="todd"><![CDATA[
              AND a.orddd   <= #todd# 
            ]]>
            </isNotEmpty>
       ORDER BY  a.orddd desc        
    </statement>
    
    
    <!-- [TRPID21401] 입원 처방 조회 -->
    <statement id="getInUnExecPrcpRef"><![CDATA[   
          SELECT distinct a.prcpdd
                     , a.instcd
                     , a.pid
                     , a.orddeptcd
                     , (SELECT DISTINCT deptengabbr FROM com.zsdddept WHERE deptcd = a.orddeptcd AND instcd = a.instcd AND orduseyn = 'Y' AND valifromdd <= a.prcpdd AND valitodd     >= a.orddd) AS orddeptnm
                     , a.orddrid
                     , (SELECT DISTINCT usernm 
                           FROM com.zsumusrb 
                         WHERE userid = a.orddrid
                          AND a.prcpdd BETWEEN userfromdd AND usertodd ) AS orddrnm
                     , (SELECT DISTINCT c.insukind 
                        FROM pam.pmihiphs c 
                        WHERE c.pid  	 = a.pid
                        AND c.indd       = a.orddd
                        AND c.cretno     = a.cretno
                        AND c.instcd     = a.instcd
                        AND c.histstat   = 'Y'
                        AND a.prcpdd	 BETWEEN c.fromdd AND c.todd
                     ) AS insukind   
                     , (SELECT c.indschacptstat 
                        FROM pam.pmihinpt c 
                        WHERE c.pid  	 = a.pid
                        AND c.indd       = a.orddd
                        AND c.cretno     = a.cretno
                        AND c.instcd     = a.instcd
                        AND c.histstat   = 'Y'
                     ) AS indschacptstat   
                     , b.execdd 
                     , a.orddd
                     , a.cretno
            FROM emr.mmohiprc a, emr.mmodexip b
         WHERE a.pid        = #pid#
           AND  a.instcd     = #sessinstcd#
           AND  a.prcphistcd = 'O'
        ]]>     
             <isEmpty  property="chk">
                <isNotEmpty  property="orddeptcd"><![CDATA[
           AND  a.orddeptcd = #orddeptcd# 
                ]]>
                </isNotEmpty>
            </isEmpty>     
           AND  a.tempprcpflag = 'N'          -- 임시처방여부
           AND  a.hscttempprcpflag = 'N'      -- HSCT임시처방여부 
            <isNotEmpty  property="fromdd"><![CDATA[
           AND  a.prcpdd   >= #fromdd#
            ]]>
            </isNotEmpty>
            <isNotEmpty  property="todd"><![CDATA[
           AND  a.prcpdd   <= #todd# 
            ]]>
            </isNotEmpty>
           AND b.prcpdd       = a.prcpdd
           AND b.prcpno     = a.prcpno
           AND b.instcd     = a.instcd
           AND b.prcphistno   = a.prcphistno
           --AND b.execprcphistcd = a.prcphistcd
           AND b.execprcphistcd IN ('O', 'E') 
       ORDER BY  a.prcpdd desc        
    </statement>


    <!-- [TXPID21402] 외래미시행처방  통합심사 완료 여부를 변경  -->            
    <statement id="setjudgend">
        <isNotEmpty property="prcpdd"><![CDATA[ 
            UPDATE emr.mmodexop 
               SET  judgendflag  = #judgendflag#    
                   ,lastupdtrid  = #sessuserid#
                   ,lastupdtdt   = SYSDATE
            WHERE prcpdd     = #prcpdd#         
              AND prcpno     = #prcpno#     
              AND prcphistno = #prcphistno# 
              AND execprcpno = #execprcpseqno#  
              AND instcd     = #sessinstcd#     
              AND calcflag   = 'Y'       -- 실시처방에 대한 원무계산 여부
            ]]>  
        </isNotEmpty>       
    </statement>
    
    
    <statement id="setInPatInfoHist">
    <![CDATA[ 
            INSERT INTO PAM.PMIHIPSC (
            										PID
            										,INDD
            										,CRETNO
            										,RECALDD
            										,SEQNO
            										,INSTCD
            										,MSKIND
            										,HISTSTAT
            										,GENRDD
            										,TRETRSLT
            										,ERRCNTS
            										,RETCGENRPLCE
            										,FSTRGSTRID
            										,FSTRGSTDT
            										,LASTUPDTRID
            										,LASTUPDTDT )
			SELECT		pid
							,indd
							,cretno
							,#execdd#
							,NVL( ( SELECT	max(seqno)+1 AS seqno 
				                     FROM	pam.pmihipsc 
				                     WHERE	pid     = a.pid 
				                     AND		cretno = a.cretno 
				                     AND		indd    = a.indd 
				                     AND		instcd = a.instcd), 1)
							,instcd
							,mskind
							,'Y'
							,TO_CHAR(SYSDATE, 'YYYYMMDD')
							,'M'
							,''
							,'W'
							,#sessuserid#
							,SYSTIMESTAMP
							,#sessuserid#
							,SYSTIMESTAMP
			FROM			PAM.PMIHINPT a
			WHERE		instcd = #sessinstcd#
			AND			pid = #pid#
			AND			indd = #orddd#
			AND			cretno = #cretno#
			AND			histstat = 'Y'
			
    ]]>       
    </statement>


    <!-- [TXPID21403] 1.EMR.MMOHOPRC 원데이터를 PAM.PIJHOPRC 히스토리테이블에 백업저장한다.  -->    
    <statement id="setordpayflag3"><![CDATA[    
            INSERT INTO pam.pijhoprc(
                       prcpdd                                           
                     , prcpno                        
                     , prcphistno                        
                     , instcd                        
                     , pid                           
                     , orddd                         
                     , cretno                        
                     , orddeptcd                         
                     , orddrid                       
                     , prcpgenrflag                      
                     , prcphistcd                        
                     , prcpstatcd                        
                     , prcpkindcd                        
                     , prcpclscd                         
                     , prcpflag                      
                     , tempprcpflag                      
                     , hscttempprcpflag                  
                     , prcpcd                        
                     , inclprcpcd                        
                     , inclprcpno                        
                     , prcpsetcd                         
                     , prcpexecdeptcd                    
                     , prcphopedd                        
                     , prcpvol                       
                     , prcpvolunitflag                   
                     , prcpqty                       
                     , prcpqtyunitflag                   
                     , prcptims                      
                     , prcpdayno                         
                     , drugspd                       
                     , drugspdunitflag                   
                     , powdflag                      
                     , prnprcpflag                       
                     , prepprcpflag                      
                     , selfprcpflag                      
                     , selfdrugflag                      
                     , asttestflag                       
                     , drugpackflag                      
                     , drugindependpackflag                  
                     , lowdrugresncd                     
                     , prcpmixno                         
                     , payflagcd                         
                     , erprcpflag                        
                     , precureprcpflag                   
                     , nigtprcpflag                      
                     , portprcpflag                      
                     , fixprcpflag                       
                     , choiordflag                       
                     , specdrid                      
                     , anamneflag                        
                     , fastprcpflag                      
                     , erreadflag                        
                     , prcpdirecflag                     
                     , rehbprcpcurefreqflag                  
                     , tnsuseflag                        
                     , tnsfiltflag                       
                     , trnptbftestflag                   
                     , offictourhealexamflag                 
                     , stemcellflag                      
                     , angioflagcd                       
                     , opansflagcd                       
                     , ansttm                        
                     , mealcalrcnts                      
                     , mealprotcnts                      
                     , mealupdtflag                      
                     , dietprcpgenrflag                  
                     , procerdietflag                    
                     , tfdtlcd                       
                     , hosinhosoutflag                   
                     , hosinprcpresncd                   
                     , hsctdelivepos                     
                     , hsctlnkno                         
                     , irpayflag                         
                     , irflag                        
                     , diagtestconttestintvlflag                 
                     , diagtestconttestbasetm                
                     , diagtestconttestorgtims               
                     , spynpy1                       
                     , subcretno                         
                     , etcprcpflag                       
                     , issdeptcd                         
                     , prcpauthflag                      
                     , prcpinptflag                      
                     , prcpsignflag                      
                     , aftcertflag                       
                     , aftcertdrid                       
                     , prcprefseq                        
                     , wardcd                        
                     , roomcd                        
                     , cvrtbforddd                       
                     , cvrtbfcretno                      
                     , cvrtbfprcpgenrflag                    
                     , ordreqlnkno                       
                     , testreqlnkno                      
                     , dnorreqlnkno                      
                     , prcplnkdd                         
                     , prcplnkno                         
                     , oprsrvno                      
                     , prtlno                        
                     , anticncrprtlno                    
                     , anticncrdayno                     
                     , druglnkno                         
                     , cpno                          
                     , clincstdycd                       
                     , prcpvalidd                        
                     , rgstdeptcd                        
                     , rgstdd                        
                     , rgsttm                        
                     , rgstrid                       
                     , updtdeptcd                        
                     , updtdd                        
                     , updttm                        
                     , updtrid                       
                     , drprcpetc1                        
                     , drprcpetc2                        
                     , drprcpetc3                        
                     , drprcpetc4                        
                     , drprcpetc5                        
                     , drprcpetc6                        
                     , drprcpetc7                        
                     , drprcpetc8                        
                     , drprcpetc9                        
                     , drprcpetc10                       
                     , ermediscmngtresncd                    
                     , rehbprcpenddd                     
                     , etcprcpresncd                     
                     , matrallsizespecid                     
                     , rehbprcpcurepartcd                    
                     , drugmthdspccd                     
                     , optermcd                      
                     , lowdrugresnetcfact                    
                     , drugrateqty                       
                     , exptmthdfact                      
                     , prcpnm                        
                     , fstrgstrid                        
                     , fstrgstdt                         
                     , lastupdtrid                       
                     , lastupdtdt                        
                )                                

                SELECT
                      a.prcpdd
                     ,a.prcpno
                     ,a.prcphistno
                     ,a.instcd
                     ,a.pid
                     ,a.orddd
                     ,a.cretno
                     ,a.orddeptcd
                     ,a.orddrid
                     ,a.prcpgenrflag
                     ,a.prcphistcd
                     ,a.prcpstatcd
                     ,a.prcpkindcd
                     ,a.prcpclscd
                     ,a.prcpflag
                     ,a.tempprcpflag
                     ,a.hscttempprcpflag
                     ,a.prcpcd
                     ,a.inclprcpcd
                     ,a.inclprcpno
                     ,a.prcpsetcd
                     ,a.prcpexecdeptcd
                     ,a.prcphopedd
                     ,a.prcpvol
                     ,a.prcpvolunitflag
                     ,a.prcpqty
                     ,a.prcpqtyunitflag
                     ,a.prcptims
                     ,a.prcpdayno
                     ,a.drugspd
                     ,a.drugspdunitflag
                     ,a.powdflag
                     ,a.prnprcpflag
                     ,a.prepprcpflag
                     ,a.selfprcpflag
                     ,a.selfdrugflag
                     ,a.asttestflag
                     ,a.drugpackflag
                     ,a.drugindependpackflag
                     ,a.lowdrugresncd
                     ,a.prcpmixno
                     ,a.payflagcd
                     ,a.erprcpflag
                     ,a.precureprcpflag
                     ,a.nigtprcpflag
                     ,a.portprcpflag
                     ,a.fixprcpflag
                     ,a.choiordflag
                     ,a.specdrid
                     ,a.anamneflag
                     ,a.fastprcpflag
                     ,a.erreadflag
                     ,a.prcpdirecflag
                     ,a.rehbprcpcurefreqflag
                     ,a.tnsuseflag
                     ,a.tnsfiltflag
                     ,a.trnptbftestflag
                     ,a.offictourhealexamflag
                     ,a.stemcellflag
                     ,a.angioflagcd
                     ,a.opansflagcd
                     ,a.ansttm
                     ,a.mealcalrcnts
                     ,a.mealprotcnts
                     ,a.mealupdtflag
                     ,a.dietprcpgenrflag
                     ,a.procerdietflag
                     ,a.tfdtlcd
                     ,a.hosinhosoutflag
                     ,a.hosinprcpresncd
                     ,a.hsctdelivepos
                     ,a.hsctlnkno
                     ,a.irpayflag
                     ,a.irflag
                     ,a.diagtestconttestintvlflag
                     ,a.diagtestconttestbasetm
                     ,a.diagtestconttestorgtims
                     ,a.spynpy1
                     ,a.subcretno
                     ,a.etcprcpflag
                     ,a.issdeptcd
                     ,a.prcpauthflag
                     ,a.prcpinptflag
                     ,a.prcpsignflag
                     ,a.aftcertflag
                     ,a.aftcertdrid
                     ,a.prcprefseq
                     ,a.wardcd
                     ,a.roomcd
                     ,a.cvrtbforddd
                     ,a.cvrtbfcretno
                     ,a.cvrtbfprcpgenrflag
                     ,a.ordreqlnkno
                     ,a.testreqlnkno
                     ,a.dnorreqlnkno
                     ,a.prcplnkdd
                     ,a.prcplnkno
                     ,a.oprsrvno
                     ,a.prtlno
                     ,a.anticncrprtlno
                     ,a.anticncrdayno
                     ,a.druglnkno
                     ,a.cpno
                     ,a.clincstdycd
                     ,a.prcpvalidd
                     ,a.rgstdeptcd
                     ,a.rgstdd
                     ,a.rgsttm
                     ,a.rgstrid
                     ,a.updtdeptcd
                     ,a.updtdd
                     ,a.updttm
                     ,a.updtrid
                     ,a.drprcpetc1
                     ,a.drprcpetc2
                     ,a.drprcpetc3
                     ,a.drprcpetc4
                     ,a.drprcpetc5
                     ,a.drprcpetc6
                     ,a.drprcpetc7
                     ,a.drprcpetc8
                     ,a.drprcpetc9
                     ,a.drprcpetc10
                     ,a.ermediscmngtresncd
                     ,a.rehbprcpenddd
                     ,a.etcprcpresncd
                     ,a.matrallsizespecid
                     ,a.rehbprcpcurepartcd
                     ,a.drugmthdspccd
                     ,a.optermcd
                     ,a.lowdrugresnetcfact
                     ,a.drugrateqty
                     ,a.exptmthdfact
                     ,a.prcpnm
                     ,#sessuserid#
                     ,SYSTIMESTAMP
                     ,#sessuserid#
                     ,SYSTIMESTAMP
                FROM emr.mmohoprc a 
               WHERE a.prcpdd       = #payprcpdd#
                 AND a.prcpno       = #payprcpno#
                 AND a.prcphistno   = #payprcphistno#
                 AND a.instcd       = #sessinstcd#
    ]]>
    </statement>

    
    <!-- [TXPID21403] 2.EMR.MMODEXOP 원데이터 no charge 처리한다. -->
    <statement id="setordpayflag4"><![CDATA[
            UPDATE emr.mmodexop
               SET calcflag  = #calcflag#
               		, lastupdtdt = systimestamp
               		, lastupdtrid = #sessuserid#
             WHERE prcpdd     = #payprcpdd#
               AND prcpno     = #payprcpno#
               AND prcphistno = #payprcphistno#
               AND instcd     = #sessinstcd#
               AND execprcpno = #execprcpno#
    ]]>
    </statement>
    
    <!-- [TXPID21403] 2.EMR.MMOHOPRC 원데이터의 급비구분코드를 수정한다. -->
    <statement id="setordpayflag2"><![CDATA[
            UPDATE emr.mmohoprc
               SET payflagcd  = #paypayflagcd#
               		, choiordflag = #choiordflag#
               		, lastupdtdt = systimestamp
               		, lastupdtrid = #sessuserid#
             WHERE prcpdd     = #payprcpdd#
               AND prcpno     = #payprcpno#
               AND prcphistno = #payprcphistno#
               AND instcd     = #sessinstcd#
    ]]>
    </statement>
    
    <!-- [TXPID21403] 2.EMR.MMOHOPRC 원데이터의 급비구분코드를 수정한다. -->
    <statement id="delordpayflag1"><![CDATA[
            DELETE FROM pam.pijhoprc
             WHERE prcpdd     = #payprcpdd#
               AND prcpno     = #payprcpno#
               AND prcphistno = #payprcphistno#
               AND instcd     = #sessinstcd#
    ]]>
    </statement>
    
    
    <statement id="delInordpayflag1"><![CDATA[
            DELETE FROM pam.pijhiprc
             WHERE prcpdd     = #payprcpdd#
               AND prcpno     = #payprcpno#
               AND prcphistno = #payprcphistno#
               AND instcd     = #sessinstcd#
    ]]>
    </statement>

	<statement id="setInordpayflag2"><![CDATA[
            UPDATE emr.mmohiprc
               SET payflagcd  = #paypayflagcd#
             WHERE prcpdd     = #payprcpdd#
               AND prcpno     = #payprcpno#
               AND prcphistno = #payprcphistno#
               AND instcd     = #sessinstcd#
    ]]>
    </statement>
    
    <statement id="setInordpayflag3"><![CDATA[    
            INSERT INTO pam.pijhiprc(
                       prcpdd                                           
                     , prcpno                        
                     , prcphistno           
                     , seqno             
                     , instcd                        
                     , histflag
                     , pid                           
                     , orddd                         
                     , cretno                        
                     , orddeptcd                         
                     , orddrid                       
                     , prcpgenrflag                      
                     , prcphistcd                        
                     , prcpstatcd                        
                     , prcpkindcd                        
                     , prcpclscd                         
                     , prcpflag                      
                     , tempprcpflag                      
                     , hscttempprcpflag                  
                     , prcpcd                        
                     , inclprcpcd                        
                     , inclprcpno                        
                     , prcpsetcd                         
                     , prcpexecdeptcd                    
                     , prcphopedd                        
                     , prcpvol                       
                     , prcpvolunitflag                   
                     , prcpqty                       
                     , prcpqtyunitflag                   
                     , prcptims                      
                     , prcpdayno                         
                     , drugspd                       
                     , drugspdunitflag                   
                     , powdflag                      
                     , prnprcpflag                       
                     , prepprcpflag                      
                     , selfprcpflag                      
                     , selfdrugflag                      
                     , asttestflag                       
                     , drugpackflag                      
                     , drugindependpackflag                  
                     , lowdrugresncd                     
                     , prcpmixno                         
                     , payflagcd                         
                     , erprcpflag                        
                     , precureprcpflag                   
                     , nigtprcpflag                      
                     , portprcpflag                      
                     , fixprcpflag                       
                     , choiordflag                       
                     , specdrid                      
                     , anamneflag                        
                     , fastprcpflag                      
                     , erreadflag                        
                     , prcpdirecflag                     
                     , rehbprcpcurefreqflag                  
                     , tnsuseflag                        
                     , tnsfiltflag                       
                     , trnptbftestflag                   
                     , offictourhealexamflag                 
                     , stemcellflag                      
                     , angioflagcd                       
                     , opansflagcd                       
                     , ansttm                        
                     , mealcalrcnts                      
                     , mealprotcnts                      
                     , mealupdtflag                      
                     , dietprcpgenrflag                  
                     , procerdietflag                    
                     , tfdtlcd                       
                     , hosinhosoutflag                   
                     , hosinprcpresncd                   
                     , hsctdelivepos                     
                     , hsctlnkno                         
                     , irpayflag                         
                     , irflag                        
                     , diagtestconttestintvlflag                 
                     , diagtestconttestbasetm                
                     , diagtestconttestorgtims               
                     , spynpy1                       
                     , subcretno                         
                     , etcprcpflag                       
                     , issdeptcd                         
                     , prcpauthflag                      
                     , prcpinptflag                      
                     , prcpsignflag                      
                     , aftcertflag                       
                     , aftcertdrid                       
                     , prcprefseq                        
                     , wardcd                        
                     , roomcd                        
                     , cvrtbforddd                       
                     , cvrtbfcretno                      
                     , cvrtbfprcpgenrflag                    
                     , ordreqlnkno                       
                     , testreqlnkno                      
                     , dnorreqlnkno                      
                     , prcplnkdd                         
                     , prcplnkno                         
                     , oprsrvno                      
                     , prtlno                        
                     , anticncrprtlno                    
                     , anticncrdayno                     
                     , druglnkno                         
                     , cpno                          
                     , clincstdycd                       
                     , prcpvalidd                        
                     , rgstdeptcd                        
                     , rgstdd                        
                     , rgsttm                        
                     , rgstrid                       
                     , updtdeptcd                        
                     , updtdd                        
                     , updttm                        
                     , updtrid                       
                     , drprcpetc1                        
                     , drprcpetc2                        
                     , drprcpetc3                        
                     , drprcpetc4                        
                     , drprcpetc5                        
                     , drprcpetc6                        
                     , drprcpetc7                        
                     , drprcpetc8                        
                     , drprcpetc9                        
                     , drprcpetc10                       
                     , ermediscmngtresncd                    
                     , rehbprcpenddd                     
                     , etcprcpresncd                     
                     , matrallsizespecid                     
                     , rehbprcpcurepartcd                    
                     , drugmthdspccd                     
                     , optermcd                      
                     , lowdrugresnetcfact                    
                     , drugrateqty                       
                     , exptmthdfact                      
                     , prcpnm                        
                     , fstrgstrid                        
                     , fstrgstdt                         
                     , lastupdtrid                       
                     , lastupdtdt                        
                )                                

                SELECT
                      a.prcpdd
                     ,a.prcpno
                     ,a.prcphistno
                     ,NVL( ( SELECT MAX(SEQNO)
                     		  FROM	pam.pijhiprc
                     		  WHERE prcpdd = a.prcpdd
                     		  AND    prcpno = a.prcpno
                     		  AND    prcphistno = a.prcphistno ), 1)	
                     ,a.instcd
                     ,'A' --수정후데이터
                     ,a.pid
                     ,a.orddd
                     ,a.cretno
                     ,a.orddeptcd
                     ,a.orddrid
                     ,a.prcpgenrflag
                     ,a.prcphistcd
                     ,a.prcpstatcd
                     ,a.prcpkindcd
                     ,a.prcpclscd
                     ,a.prcpflag
                     ,a.tempprcpflag
                     ,a.hscttempprcpflag
                     ,a.prcpcd
                     ,a.inclprcpcd
                     ,a.inclprcpno
                     ,a.prcpsetcd
                     ,a.prcpexecdeptcd
                     ,a.prcphopedd
                     ,a.prcpvol
                     ,a.prcpvolunitflag
                     ,a.prcpqty
                     ,a.prcpqtyunitflag
                     ,a.prcptims
                     ,a.prcpdayno
                     ,a.drugspd
                     ,a.drugspdunitflag
                     ,a.powdflag
                     ,a.prnprcpflag
                     ,a.prepprcpflag
                     ,a.selfprcpflag
                     ,a.selfdrugflag
                     ,a.asttestflag
                     ,a.drugpackflag
                     ,a.drugindependpackflag
                     ,a.lowdrugresncd
                     ,a.prcpmixno
                     ,a.payflagcd
                     ,a.erprcpflag
                     ,a.precureprcpflag
                     ,a.nigtprcpflag
                     ,a.portprcpflag
                     ,a.fixprcpflag
                     ,a.choiordflag
                     ,a.specdrid
                     ,a.anamneflag
                     ,a.fastprcpflag
                     ,a.erreadflag
                     ,a.prcpdirecflag
                     ,a.rehbprcpcurefreqflag
                     ,a.tnsuseflag
                     ,a.tnsfiltflag
                     ,a.trnptbftestflag
                     ,a.offictourhealexamflag
                     ,a.stemcellflag
                     ,a.angioflagcd
                     ,a.opansflagcd
                     ,a.ansttm
                     ,a.mealcalrcnts
                     ,a.mealprotcnts
                     ,a.mealupdtflag
                     ,a.dietprcpgenrflag
                     ,a.procerdietflag
                     ,a.tfdtlcd
                     ,a.hosinhosoutflag
                     ,a.hosinprcpresncd
                     ,a.hsctdelivepos
                     ,a.hsctlnkno
                     ,a.irpayflag
                     ,a.irflag
                     ,a.diagtestconttestintvlflag
                     ,a.diagtestconttestbasetm
                     ,a.diagtestconttestorgtims
                     ,a.spynpy1
                     ,a.subcretno
                     ,a.etcprcpflag
                     ,a.issdeptcd
                     ,a.prcpauthflag
                     ,a.prcpinptflag
                     ,a.prcpsignflag
                     ,a.aftcertflag
                     ,a.aftcertdrid
                     ,a.prcprefseq
                     ,a.wardcd
                     ,a.roomcd
                     ,a.cvrtbforddd
                     ,a.cvrtbfcretno
                     ,a.cvrtbfprcpgenrflag
                     ,a.ordreqlnkno
                     ,a.testreqlnkno
                     ,a.dnorreqlnkno
                     ,a.prcplnkdd
                     ,a.prcplnkno
                     ,a.oprsrvno
                     ,a.prtlno
                     ,a.anticncrprtlno
                     ,a.anticncrdayno
                     ,a.druglnkno
                     ,a.cpno
                     ,a.clincstdycd
                     ,a.prcpvalidd
                     ,a.rgstdeptcd
                     ,a.rgstdd
                     ,a.rgsttm
                     ,a.rgstrid
                     ,a.updtdeptcd
                     ,a.updtdd
                     ,a.updttm
                     ,a.updtrid
                     ,a.drprcpetc1
                     ,a.drprcpetc2
                     ,a.drprcpetc3
                     ,a.drprcpetc4
                     ,a.drprcpetc5
                     ,a.drprcpetc6
                     ,a.drprcpetc7
                     ,a.drprcpetc8
                     ,a.drprcpetc9
                     ,a.drprcpetc10
                     ,a.ermediscmngtresncd
                     ,a.rehbprcpenddd
                     ,a.etcprcpresncd
                     ,a.matrallsizespecid
                     ,a.rehbprcpcurepartcd
                     ,a.drugmthdspccd
                     ,a.optermcd
                     ,a.lowdrugresnetcfact
                     ,a.drugrateqty
                     ,a.exptmthdfact
                     ,a.prcpnm
                     ,#sessuserid#
                     ,SYSTIMESTAMP
                     ,#sessuserid#
                     ,SYSTIMESTAMP
                FROM emr.mmohiprc a 
               WHERE a.prcpdd       = #payprcpdd#
                 AND a.prcpno       = #payprcpno#
                 AND a.prcphistno   = #payprcphistno#
                 AND a.instcd       = #sessinstcd#
    ]]>
    </statement>

    <!-- [TXPID21401] 외래미시행처방 특정 내역 삭제 -->         
    <statement id="deloutclcj"><![CDATA[    
            DELETE FROM pam.piohclcj
             WHERE pid      = #delpid#  
               AND orddd    = #delorddd#    
               AND cretno   = #delcretno#
               AND instcd   = #sessinstcd#
               AND edicd    = #deledicd#
               AND spclcd   = #delspclcd#
    ]]>
    </statement>


    <!-- [TXPID21401] 외래미시행처방 특정 내역 추가  -->            
    <statement id="insoutclcj"><![CDATA[
            INSERT INTO pam.piohclcj (
                  PID
                , ORDDD
                , CRETNO
                , SEQNO
                , INSTCD
                , UNITFLAG
                , SPCLMEMOFLAG
                , EDICDFLAG
                , EDICD
                , SPCLCD
                , SPCLSPEC
                , PRCPDD
                , PRCPNO
                , PRCPHISTNO
                , EXECPRCPSEQNO
                , REMFACT
                , ROWSTAT
                , FSTRGSTRID
                , FSTRGSTDT
                , LASTUPDTRID
                , LASTUPDTDT
            )
            VALUES (
                      #inspid#
                    , #insorddd#
                    , #inscretno#
                    , (SELECT (COALESCE(MAX(a1.seqno), 0) + 1) 
                        FROM pam.piohclcj a1 
                        WHERE pid           = #inspid# 
                            AND orddd       = #insorddd#    
                            AND cretno      = #inscretno#
                            AND instcd      = #sessinstcd#          --AND rowstat != 'D'
                        )                -- seqno
                    , #sessinstcd#
                    , #unitflag#
                    , #spclmemoflag#                -- spclmemoflag(특정메모구분_U:사용자메모, E:EDI메모)
         ]]>
                    <isNotEqual property="grupsnglyn" compare="G">
                        <isNotEqual property="calcscorcd" compare="-">
                        <![CDATA[   
                            , (SELECT NVL(edicdflag, '-')
                                  FROM pam.picmmech
                                WHERE calcscorcd = #calcscorcd#
                                     AND todd >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                                     AND instcd = #sessinstcd#
                                     AND insuedicd = #edicd#
                             )
                        ]]>
                        </isNotEqual>
                        <isEqual property="calcscorcd" compare="-">     
                            , '-'
                        </isEqual>
                    </isNotEqual>
                    <isEqual property="grupsnglyn" compare="G">
                        <isNotEqual property="calcscorcd" compare="-">
                        <![CDATA[   
                        ,   (SELECT NVL(s1.edicdflag, '-') 
                               FROM 
                                    (SELECT p2.calcscorcd, p2.insuedicd, p2.edicdflag 
                                       FROM pam.picmmech p2, 
                                             (SELECT snglcd 
                                                FROM pam.picmgrup 
                                               WHERE calcscorcdgrup = #calcscorcd#
                                                 AND instcd = #sessinstcd#) s2
                                       WHERE p2.calcscorcd = s2.snglcd
                                         AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN fromdd AND todd
                                         AND instcd = #sessinstcd#) s1
                                    ,(SELECT insuedicd
                                        FROM pam.picmmech 
                                       WHERE calcscorcd = #calcscorcd#
                                         AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN fromdd AND todd
                                         AND instcd = #sessinstcd#) p1
                                WHERE TRIM(p1.insuedicd) = TRIM(s1.insuedicd))   
                        ]]>
                        </isNotEqual>
                        <isEqual property="calcscorcd" compare="-">     
                            , '-'
                        </isEqual>
                    </isEqual>
                    , #edicd#
                    , #spclcd#
                    , #spclspec#
                    , #prcpdd#
                    , #prcpno#
                    , #prcphistno#
                    , #execprcpseqno#                                                                       
                    , #remfact# 
                    , 'I'
                    , #sessuserid#    
                    , SYSTIMESTAMP
                    , #sessuserid#    
                    , SYSTIMESTAMP       
            )   
    </statement>


    <!-- [TXPID21401] 3.PAM.PMOHOTPT 원데이터를 수정한다. -->
    <statement id="setoutpatinfohist3"><![CDATA[    
       UPDATE pam.pmohotpt a
          SET   calcflag   = 'Y', 
                lastupdtrid = #sessuserid#,     
                lastupdtdt  = SYSTIMESTAMP
        WHERE   pid         = #pid#
          AND   orddd       = #orddd#
          AND   cretno      = #cretno#
          AND   instcd      = #sessinstcd#
          AND   histstat        in ('R','T')
          AND   acptseqno   = 1
    ]]>
    </statement>


    <!--외래수납 계산취소시 마지막 otpt를 hist테이블에서 구한다-->    
    <statement id="getPreOtptHist"><![CDATA[    
        SELECT   pid                    AS  otpt_pid                           
                ,orddd                  AS  otpt_orddd                         
                ,cretno                 AS  otpt_cretno                        
                ,instcd                 AS  otpt_instcd                        
                ,histstat               AS  otpt_histstat                      
                ,orgorddd               AS  otpt_orgorddd                      
                ,orgcretno              AS  otpt_orgcretno                     
                ,calcbaseflag           AS  otpt_calcbaseflag                  
                ,calcyn                 AS  otpt_calcyn                        
                ,ordtm                  AS  otpt_ordtm                         
                ,orddeptcd              AS  otpt_orddeptcd                     
                ,orddrid                AS  otpt_orddrid                       
                ,dutdeptcd              AS  otpt_dutdeptcd                     
                ,nvl(centcd, '-')       AS  otpt_centcd                        
                ,supdeptcd              AS  otpt_supdeptcd                     
                ,mskind                 AS  otpt_mskind                        
                ,insukind               AS  otpt_insukind                      
                ,suppkind               AS  otpt_suppkind                      
                ,insucd                 AS  otpt_insucd                        
                ,suppkindresn           AS  otpt_suppkindresn                  
                ,specordyn              AS  otpt_specordyn                     
                ,holiflag               AS  otpt_holiflag                      
                ,fsexamflag             AS  otpt_fsexamflag                    
                ,fsexammanlyn           AS  otpt_fsexammanlyn                  
                ,ordtype                AS  otpt_ordtype                       
                ,brateflag              AS  otpt_brateflag                     
                ,medamtestmyn           AS  otpt_medamtestmyn                  
                ,medamtpostyn           AS  otpt_medamtpostyn                  
                ,medamtfreeresn         AS  otpt_medamtfreeresn                
                ,rsrvflag               AS  otpt_rsrvflag                      
                ,etcordflag             AS  otpt_etcordflag                    
                ,disccd                 AS  otpt_disccd                        
                ,hosoutexptresncd       AS  otpt_hosoutexptresncd              
                ,clincstdyacptflag      AS  otpt_clincstdyacptflag             
                ,clincstdyno            AS  otpt_clincstdyno                   
                ,chrtlendyn             AS  otpt_chrtlendyn                    
                ,specorddescyn          AS  otpt_specorddescyn                 
                ,ordreqdescyn           AS  otpt_ordreqdescyn                  
                ,ordreqhospgrde         AS  otpt_ordreqhospgrde                
                ,insuchrgyn             AS  otpt_insuchrgyn                    
                ,nursacptyn             AS  otpt_nursacptyn                    
                ,nursacptdt             AS  otpt_nursacptdt                    
                ,dracptyn               AS  otpt_dracptyn                      
                ,dracptdt               AS  otpt_dracptdt                      
                ,prcpgenryn             AS  otpt_prcpgenryn                    
                ,prcpnotoccrresn        AS  otpt_prcpnotoccrresn               
                ,estmspclappyn          AS  otpt_estmspclappyn                 
                ,elbulbodstat           AS  otpt_elbulbodstat                  
                ,elbulbodstatdt         AS  otpt_elbulbodstatdt                
                ,calcflag               AS  otpt_calcflag                      
                ,calcmthdflag           AS  otpt_calcmthdflag                  
                ,dnoracptyn             AS  otpt_dnoracptyn                    
                ,rqstflag               AS  otpt_rqstflag                      
                ,rqsthospcd             AS  otpt_rqsthospcd                    
                ,rqstdrid               AS  otpt_rqstdrid                      
                ,tdayinflag             AS  otpt_tdayinflag                    
                ,tranindd               AS  otpt_tranindd                      
                ,rcptdd                 AS  otpt_rcptdd                        
                ,rcptno                 AS  otpt_rcptno                        
                ,rcptseqno              AS  otpt_rcptseqno                     
                ,telrsrvrem             AS  otpt_telrsrvrem                    
                ,updtcnclresn           AS  otpt_updtcnclresn                  
                ,ordreqformflag         AS  otpt_ordreqformflag                
                ,prcplockid             AS  otpt_prcplockid                    
                ,dschjudgprcsstat       AS  otpt_dschjudgprcsstat              
                ,judgmdlid              AS  otpt_judgmdlid                     
                ,lastjudgdt             AS  otpt_lastjudgdt                    
                ,probjudgflag           AS  otpt_probjudgflag                  
                ,spcljudgflag           AS  otpt_spcljudgflag                  
                ,handicaprbookpossnyn   AS  otpt_handicaprbookpossnyn          
                ,outercdrgstyn          AS  otpt_outercdrgstyn                 
                ,undersixageyn          AS  otpt_undersixageyn                 
                ,remfact                AS  otpt_remfact                       
                ,spclcd                 AS  otpt_spclcd                        
                ,onestop                AS  otpt_onestop                       
                ,ownbflag               AS  otpt_ownbflag                      
                ,ordpatyn               AS  otpt_ordpatyn                      
                ,uncocd                 AS  otpt_uncocd                        
                ,pmflag                 AS  otpt_pmflag                        
                ,emplno                 AS  otpt_emplno                        
                ,suppkindsubyn          AS  otpt_suppkindsubyn                 
                ,earnendyn              AS  otpt_earnendyn                     
                ,rareobstflag           AS  otpt_rareobstflag
                ,tranflag               AS  otpt_tranflag
              --,onlnno                 AS  otpt_onlnno             
              --,inetproxyrrgstno       AS  otpt_inetproxyrrgstno   
                ,holdflag               AS  otpt_holdflag
				,subdeptcd              AS  otpt_subdeptcd
                ,''                     AS  otpt_drcmtmngtno                   
                ,lastupdtrid            AS  otpt_lastupdtrid                   
                ,lastupdtdt             AS  otpt_lastupdtdt 
                ,acptseqno              AS  otpt_acptseqno
				,rcptvipresncd          AS  otpt_rcptvipresncd
				,rcptvipetcresn         AS  otpt_rcptvipetcresn
				,prcptdayaftrcptyn      AS  otpt_prcptdayaftrcptyn
				,nvl(coopteamcd,'-')    AS  otpt_coopteamcd
           FROM pam.pmohhist a
          WHERE a.pid       = #otpt_pid#
            AND a.orddd     = #otpt_orddd#
            AND a.cretno    = #otpt_cretno#
            AND a.instcd    = #sessinstcd#
            AND a.histstat  = 'R'
            AND a.acptseqno = (SELECT max(b.acptseqno)
                                 FROM pam.pmohhist b
                                WHERE b.pid      = a.pid
                                  AND b.orddd    = a.orddd
                                  AND b.cretno   = a.cretno
                                  AND b.instcd   = a.instcd
                                --AND b.calcflag = a.calcflag
                                  AND b.calcflag = #otpt_calcflag#
                                  AND b.histstat = 'R'
                                  )
     ]]>
    </statement> 
    <!-- AND a.calcflag  = #otpt_calcflag# -->


    <!-- 외래수납 계산취소 OTPT에 계산구분 변경 -->
    <statement id="setOtptCalcflag"><![CDATA[    
       UPDATE pam.pmohotpt
          SET calcflag   =  #otpt_calcflag#, 
              lastupdtrid = #sessuserid#,     
              lastupdtdt  = SYSTIMESTAMP
        WHERE pid         = #otpt_pid#
          AND orddd       = #otpt_orddd#
          AND cretno      = #otpt_cretno#
          AND instcd      = #sessinstcd#
          AND histstat    in ('R','T')
    ]]>
    </statement>


    <!-- 외래수납 계산취소 OSCL 삭제 -->
    <statement id="delOsclCancel"><![CDATA[    
       DELETE FROM pam.paohoscl 
        WHERE pid       = #otpt_pid#
          AND orddd     = #otpt_orddd#
          AND cretno    = #otpt_cretno#         
         
          AND instcd    = #sessinstcd#
          AND calcstat  = 'R'
    ]]>
    </statement>
<!--
 AND acptseqno >= #otpt_acptseqno#     

       UPDATE pam.paohoscl
          SET calcstat    =  'X', 
              lastupdtrid = #sessuserid#,     
              lastupdtdt  = SYSTIMESTAMP
        WHERE pid       = #otpt_pid#
          AND orddd     = #otpt_orddd#
          AND cretno    = #otpt_cretno#         
          AND acptseqno >= #otpt_acptseqno#     
          AND instcd    = #sessinstcd#
          AND calcstat  = 'R'
-->


     <!-- 환자별 현금영수증 기준 조회. -->    
     <statement id="getPidInfoCshb"><![CDATA[
        SELECT  pid                 AS cshb_pid
               ,seqno               AS cshb_seqno
               ,instcd              AS cshb_instcd
               ,histstat            AS cshb_histstat
               ,qualcnfmflag        AS cshb_qualcnfmflag
               ,qualcnfmno          AS cshb_qualcnfmno
               ,remfact             AS cshb_remfact
               ,fstrgstrid          AS cshb_fstrgstrid
               ,fstrgstdt           AS cshb_fstrgstdt
               ,lastupdtrid         AS cshb_lastupdtrid
               ,lastupdtdt          AS cshb_lastupdtdt
           FROM pam.pacmcshb
          WHERE pid       = #pid#
            AND instcd    = #sessinstcd#
            AND histstat  = 'Y'   
      ]]>
     </statement> 


     <!-- 의사소견서관리 조회 -->    
     <statement id="getDrcmList"><![CDATA[
        SELECT 
              a.pid             AS drcm_pid          
            , a.orddd           AS drcm_orddd        
            , a.cretno          AS drcm_cretno       
            , a.instcd          AS drcm_instcd       
            , a.ordtype         AS drcm_ordtype      
            , a.mngtno          AS drcm_mngtno       
            , a.qualflag        AS drcm_qualflag     
            , a.fstrgstrid      AS drcm_fstrgstrid   
            , a.fstrgstdt       AS drcm_fstrgstdt    
            , a.lastupdtrid     AS drcm_lastupdtrid  
            , a.lastupdtdt      AS drcm_lastupdtdt 
            , a.issuedt         AS drcm_issuedt
            , a.claimstat       AS drcm_claimstat
			,(SELECT count(*) FROM emr.mmodexop b WHERE a.pid = b.pid AND a.orddd =b.actorddd AND a.cretno = b.actcretno AND a.instcd = b.instcd) as drcm_exop_cnt
          FROM pam.pmohdrcm a
         WHERE a.pid     = #pid#
           AND a.orddd   = #orddd#
           AND a.cretno  = #cretno#
           AND a.instcd  = #sessinstcd# 
           AND a.ordtype = #ordtype#
      ]]>
     </statement> 

     <!-- 의사소견서관리 저장 --> 
     <statement id="insDrcmList"><![CDATA[    
        INSERT INTO pam.pmohdrcm (
                      pid        
                    , orddd      
                    , cretno     
                    , instcd     
                    , ordtype    
                    , mngtno     
                    , qualflag   
                    , fstrgstrid 
                    , fstrgstdt  
                    , lastupdtrid
                    , lastupdtdt 
                    , issuedt
                    , claimstat
                ) VALUES (
                      #pid#        
                    , #orddd#      
                    , #cretno#     
                    , #sessinstcd#     
                    , #ordtype#    
                    , #mngtno#     
                    , #qualflag#   
                    , #sessuserid#
                    , SYSTIMESTAMP  
                    , #sessuserid#
                    , SYSTIMESTAMP 
                    , #issuedt#
                    , #claimstat#
            )           
     ]]>
    </statement> 

     <!-- 의사소견서관리 삭제 --> 
     <statement id="delDrcmList"><![CDATA[    
        DELETE FROM pam.pmohdrcm
         WHERE pid     = #pid#
           AND orddd   = #orddd#
           AND cretno  = #cretno#
           AND instcd  = #sessinstcd# 
           AND ordtype = #ordtype#
     ]]>
    </statement> 


     <!-- 환자처방내역조회 --> 
     <statement id="getExopList"><![CDATA[    
        SELECT a.prcpcd AS calcscorcd ,a.*  
          FROM emr.mmohoprc a
         WHERE a.instcd      = #sessinstcd# 
             AND a.pid          = #pid#
             AND a.orddd      = #orddd#
             AND a.cretno     = #cretno#
             AND a.prcpflag   = 1
             AND a.prcpcd    != 'ACD0002'
             AND a.prcphistcd = 'O'
     ]]>
    </statement> 

     <!-- 계산내역 조회 -->    
     <statement id="getOsclList"><![CDATA[
       SELECT * 
         FROM pam.paohoscl 
        WHERE instcd = #sessinstcd# 
          AND pid    = #pid#
          AND orddd  = #orddd#
          AND cretno = #cretno#
          AND calcstat = 'Y'
      ]]>
     </statement> 

     <!-- 외래수납시 등록내역조회 -->    
     <statement id="getRcptOtptList"><![CDATA[
       SELECT * 
         FROM pam.pmohotpt 
        WHERE instcd = #sessinstcd# 
          AND pid    = #opmi_pid#
          AND orddd  = #opmi_orddd#
          AND cretno = #opmi_cretno#
          AND histstat in ('R','T')
      ]]>
     </statement> 


     <!-- 방문간호지시서 조회 -->    
     <statement id="getHocmList"><![CDATA[
        SELECT
                a.instcd         AS hocm_instcd
              , a.pid             AS hocm_pid
              , a.orddd         AS hocm_orddd
              , a.cretno        AS hocm_cretno
              , a.ordtype       AS hocm_ordtype
              , a.mngtno       AS hocm_mngtno
              , a.qualflag      AS hocm_qualflag
              , a.licnsno       AS hocm_licnsno
              , a.inhosflag     AS hocm_inhosflag
              , a.claimstat     AS hocm_claimstat
              , a.fstrgstrid      AS hocm_fstrgstrid
              , a.fstrgstdt       AS hocm_fstrgstdt
              , a.lastupdtrid    AS hocm_lastupdtrid
              , a.lastupdtdt     AS hocm_lastupdtdt
			  , a.vitcareflag    AS hocm_vitcareflag
			  , a.issuedt        AS hocm_issuedt
              ,(SELECT count(*) FROM emr.mmodexop b WHERE a.pid = b.pid AND a.orddd =b.actorddd AND a.cretno = b.actcretno AND a.instcd = b.instcd) as hocm_exop_cnt
          FROM pam.pmohhocm a
         WHERE a.pid     = #pid#
           AND a.orddd   = #orddd#
           AND a.cretno  = #cretno#
           AND a.instcd  = #sessinstcd# 
           AND a.ordtype = #ordtype#
      ]]>
     </statement> 

     <!-- 방문간호지시서 저장 --> 
     <statement id="insHocmList"><![CDATA[    
       INSERT INTO pam.pmohhocm (
                              instcd      
                            , pid         
                            , orddd       
                            , cretno      
                            , ordtype     
                            , mngtno      
                            , qualflag    
                            , licnsno     
                            , inhosflag   
                            , claimstat   
                            , fstrgstrid  
                            , fstrgstdt   
                            , lastupdtrid 
                            , lastupdtdt  
							, vitcareflag
							, issuedt
                        ) VALUES (
                              #instcd#    
                            , #pid#       
                            , #orddd#     
                            , #cretno#    
                            , #ordtype#   
                            , #mngtno#    
                            , #qualflag#  
                            , #licnsno#   
                            , #inhosflag# 
                            , #claimstat# 
                            , #sessuserid#
                            , SYSTIMESTAMP
                            , #sessuserid#
                            , SYSTIMESTAMP
							, #vitcareflag#
							, #issuedt#
            )          
     ]]>
    </statement> 

     <!-- 방문간호지시서 삭제 --> 
     <statement id="delHocmList"><![CDATA[    
        DELETE FROM pam.pmohhocm
         WHERE pid     = #pid#
           AND orddd   = #orddd#
           AND cretno  = #cretno#
           AND instcd  = #sessinstcd# 
           AND ordtype = #ordtype#
     ]]>
    </statement>
    
     <!-- 의사면허번호조회 -->    
     <statement id="getUsrdlicnsno"><![CDATA[
        SELECT a.*  
          FROM com.ZSUMUSRD a
         WHERE a.userid    = #orddrid#
           AND a.dutplcecd = #orddeptcd#
           AND to_char(sysdate,'YYYYMMDD') BETWEEN a.fromdd AND a.todd
           AND rownum      = 1
      ]]>
     </statement> 

     <!-- 임상연구번호 가져오기 -->    
     <statement id="getOscl_clincstdyno"><![CDATA[
       SELECT MAX(clincstdyno) as clincstdyno
         FROM pam.paohoscl
        WHERE instcd    = #sessinstcd# 
          AND pid       = #pid#
          AND orddd     = #orddd#
          AND rcptdd    = #rcptdd#
          AND rcptno    = #rcptno#
          AND rcptseqno = #rcptseqno#
          AND calcstat  = 'Y'
          AND clincstdyno not in ('00','-','P')
      ]]>
     </statement> 


     <!-- 계산시 홀드처방 유무 확인 -->    
     <statement id="getHoldExop"><![CDATA[
       SELECT * 
         FROM emr.mmodexop 
        WHERE pid            = #pid# 
          AND actorddd          = #orddd#
          AND actcretno         = #cretno#
		  AND execprcphistcd  = 'O'
          AND execrcptstatcd ='210'
     ]]>
     </statement> 

     <!-- 계산시 미수납 처방 유무 확인 -->    
     <statement id="getUnRcptExop"><![CDATA[
       SELECT * 
         FROM emr.mmodexop 
        WHERE instcd        = #sessinstcd#
		     AND pid            = #pid# 
             AND actorddd    = #orddd#
             AND actcretno   = #cretno#
			 AND execprcphistcd = 'O'
             AND execrcptstatcd  < '210'
			 AND prcpclscd not in ('00', '01', '02', '03', '04', '09')
     ]]>
     </statement> 

   <!-- 외래수납 계산시점 체크 B형 수직감염 처리   미수코드 pmbmdcuc 참고할것!--> 
   <statement id="getVtcltrsCheck"><![CDATA[    
     SELECT sum(vtclck_uncoamt) as vtclck_uncoamt
           ,vtclck_uncocd
           ,vtclck_unconm
      FROM (

                        SELECT
                                   sum(a.payownbamt  + a.allownownbamt + a.nopyownbamt + a.specownbamt)  AS vtclck_uncoamt
                                  ,(SELECT c.cdnm
                                          FROM pam.pmcmcode c
                                         WHERE c.instcd = b.instcd
                                           AND c.cdgrupid ='P0081'
                                           AND c.cdid like substr(b.cdid, 0, 1)
                                           AND ROWNUM = 1)                                               AS vtclck_uncocd
                                  ,b.detldesc                                                            AS vtclck_unconm
                          FROM pam.paohoscl a,pam.pmcmcode b
                         WHERE a.instcd   = #sessinstcd#
                           AND a.pid      = #pid#
                           AND a.orddd    = #orddd#
                           AND a.cretno   = #cretno#
                           AND a.calcstat ='R'
                           AND a.instcd   = b.instcd
                           AND a.grupcalcscorcd = b.cdnm
                           AND b.cdgrupid ='P0005'
                         GROUP BY b.detldesc,b.instcd  ,b.cdid
         )
 GROUP by vtclck_uncocd , vtclck_unconm
 ORDER BY vtclck_uncocd
     ]]>
    </statement> 


	<!-- 자보한도환자분리팝업 등록내역조회 08/08/28 조영상-->
	<statement id="getOtptCarInsu"><![CDATA[    
        SELECT distinct a.pid
                    ,   a.orddd
                    ,   a.cretno
                    ,   a.acptseqno
                    ,   a.instcd
                    ,   a.histstat
                    ,   a.orgorddd
                    ,   a.orgcretno
                    ,   a.calcbaseflag
                    ,   a.calcyn
                    ,   a.ordtm
                    ,   a.orddeptcd
                    ,   COM.FN_ZS_GETDEPTNAME(a.instcd, a.orddeptcd, a.orddd) AS orddeptcdnm
                    ,   a.orddrid
                    ,   COM.FN_ZS_GETUSERNM(a.orddrid, a.orddd) AS orddridnm
                    ,   a.dutdeptcd
                    ,   a.centcd
                    ,   a.supdeptcd
                    ,   a.mskind
                    ,   a.insukind
                    ,   a.suppkind
                    ,   a.insucd
                    ,   a.suppkindresn
                    ,   a.specordyn
                    ,   a.holiflag
                    ,   a.fsexamflag
                    ,   a.fsexammanlyn
                    ,   a.ordtype
                    ,   a.brateflag
                    ,   a.medamtestmyn
                    ,   a.medamtpostyn
                    ,   a.medamtfreeresn
                    ,   a.rsrvflag
                    ,   a.etcordflag
                    ,   a.disccd
                    ,   a.hosoutexptresncd
                    ,   a.clincstdyacptflag
                    ,   a.clincstdyno
                    ,   a.chrtlendyn
                    ,   a.specorddescyn
                    ,   a.ordreqdescyn
                    ,   a.ordreqhospgrde
                    ,   a.insuchrgyn
                    ,   a.nursacptyn
                    ,   a.nursacptdt
                    ,   a.dracptyn
                    ,   a.dracptdt
                    ,   a.prcpgenryn
                    ,   a.prcpnotoccrresn
                    ,   a.estmspclappyn                 --산정특례적용여부(진료부에서입력)
                    ,   a.elbulbodstat
                    ,   a.elbulbodstatdt
                    ,   a.calcflag
                    ,   a.calcmthdflag
                    ,   a.dnoracptyn
                    ,   a.rqstflag
                    ,   a.rqsthospcd
                    ,   a.rqstdrid
                    ,   a.tdayinflag
                    ,   a.tranindd
                    ,   a.rcptdd
                    ,   a.rcptno
                    ,   a.rcptseqno
                    ,   a.telrsrvrem
                    ,   a.updtcnclresn
                    ,   a.fstacptid
                    ,   a.fstacptdt
                    ,   a.fstrgstrid
                    ,   a.fstrgstdt
                    ,   a.lastupdtrid
                    ,   a.lastupdtdt
                    ,   a.handicaprbookpossnyn              --장애인수첩소지자여부
                    ,   a.undersixageyn                     --6세미만여부
                    ,   a.ordreqformflag                    --진료의뢰서구분(수급절차)
                    ,   case when (a.orddd >= b.indd and a.orddd <= SUBSTR(TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'), 1, 8)) then 'N' else 'Y' 
                        end as inddflag
                    ,   a.ownbflag
                    ,   a.uncocd
					,   a.pmflag
                    ,   a.emplno
                    ,   a.suppkindsubyn
                    ,   a.earnendyn
                    ,   a.rareobstflag                       --희귀난치대상자구분
                    ,   a.tranflag
                    ,   a.onlnno
                    ,   a.inetproxyrrgstno
                    ,   a.holdflag
					,   a.subdeptcd
                    ,   (select c.insuno from pam.pmcmptin c where c.pid = a.pid AND c.insukind = a.insukind AND c.fromdd <= a.orddd AND c.todd >= a.orddd AND c.instcd = a.instcd AND c.histstat = 'Y' AND rownum =1) as insuno
                    --,   (select dcgm.discreducd from pam.PADHDCGM dcgm where dcgm.pid = a.pid AND dcgm.instcd = a.instcd AND dcgm.rcptdd = a.rcptdd AND dcgm.rcptno = a.rcptno AND dcgm.rcptseqno = a.rcptseqno AND dcgm.discreduflag ='G' AND rownum =1) as discreducd
                    ,   CASE when a.orddd < TO_CHAR(sysdate,'YYYYMMDD') then 'P'
                             when a.orddd = TO_CHAR(sysdate,'YYYYMMDD') then 'T'
                             when a.orddd > TO_CHAR(sysdate,'YYYYMMDD') then 'R'
                              END AS srchcond
              FROM  pam.pmohotpt  a 
                    LEFT OUTER JOIN pam.pmihinpt b ON (b.pid = #pid# AND b.indschacptstat = 'A' AND b.HISTSTAT = 'Y' AND b.instcd = a.instcd)
             WHERE a.pid         = #pid#
               AND (a.histstat   = 'R' or (a.histstat = 'T' and a.etcordflag <> 'H'))
               AND a.ordtype     = 'O'
               AND a.instcd      = #sessinstcd#
               AND (a.tranindd   = '00000000' OR a.tranindd  = '-' OR a.tdayinflag = '-')
		   ]]>
           <isEqual property="msflag" compare="M"><![CDATA[
               AND a.mskind ='M'
			   AND a.orddd BETWEEN #fromdd# AND #todd#
               ]]>
           </isEqual> 
           <isEqual property="msflag" compare="S"><![CDATA[
               AND a.mskind ='S'
			   AND a.orddd = #orddd#
			   AND a.orddeptcd = #orddeptcd#
               ]]>
           </isEqual> 
         ORDER BY a.orddd desc, a.ordtm
    </statement> 

	<!-- 자보한도환자분리팝업 처방내역조회 08/08/28 조영상-->
	<statement id="getOprcCarInsu"><![CDATA[   
		SELECT a.subcretno
			  ,decode(a.subcretno, 0, 'false' , 'true') as ckflag
		      ,(SELECT m.hngnm 
			      FROM pam.picmmech m
                 WHERE m.calcscorcd = a.prcpcd
                   AND a.orddd BETWEEN  m.fromdd AND m.todd
                   AND m.instcd = a.instcd
				   AND rownum =1
		       ) AS prcpcdnm
		       ,a.* 
		  FROM emr.mmohoprc a 
		 WHERE a.pid              = #pid#
		   AND a.orddd            = #orddd#
		   AND a.cretno           = #cretno#
		   AND a.instcd           = #sessinstcd#
		   AND a.prcpflag IN ('1', '3')
		   AND a.tempprcpflag     = 'N'
		   AND a.hscttempprcpflag = 'N'
		   AND a.prcphistcd       = 'O'
		   ORDER BY a.prcpno
	]]>
    </statement> 

	<!-- 자보한도환자분리팝업 처방내역조회 08/08/28 조영상-->
	<statement id="setOprcCarInsu"><![CDATA[   
        UPDATE emr.mmohoprc
           SET subcretno    = #subcretno# 
	          ,lastupdtrid  = #sessuserid# 
	          ,lastupdtdt   = SYSTIMESTAMP
         WHERE pid          = #pid#
           AND orddd        = #orddd#
           AND prcpdd       = #prcpdd#
           AND prcpno       = #prcpno#
           AND prcphistno   = #prcphistno#
           AND instcd       = #sessinstcd#
	]]>
    </statement> 

	<!-- 자보한도환자분리팝업 처방내역조회 08/08/28 조영상 -->
	<statement id="setOtptCarFlag"><![CDATA[   
        UPDATE pam.pmohotpt
           SET calcflag    = 'Y'
	          ,lastupdtrid  = #sessuserid# 
	          ,lastupdtdt   = SYSTIMESTAMP
         WHERE pid         = #pid#
           AND orddd       = #orddd#
           AND orddeptcd   = #orddeptcd#
           AND orddrid     = #orddrid#
           AND instcd      = #sessinstcd#

	]]>
    </statement> 
    
    <!-- 외래수납시 문자메세지 이력테이블 삭제 -->
     <statement id="delOutOrdSmsq">
        <![CDATA[
        DELETE FROM pam.pmohsmsq
         WHERE pid      = #opmi_pid#
           AND orddd    = #opmi_orddd#            
           AND cretno   = #opmi_cretno#
           AND instcd   = #sessinstcd#
        ]]>                    
    </statement>
	


   <!-- 외래수납 정산 수납내역 클릭시 수납내역조회 2008/1/23 조영상 AND a.cretno = #cretno# AND a.acptseqno = #acptseqno#--> 
   <statement id="getOutJOpmiList"><![CDATA[    
        SELECT                                      
                 CASE a.rcptstat  WHEN 'Y' THEN '1'              
                                           ELSE '2'  END                            AS  opmi_hidden  
             ,   a.pid                                                              AS  opmi_pid                          
             ,   b.hngnm                                                            AS  opmi_hngnm                        
             ,   a.rcptdd                                                           AS  opmi_rcptdd                       
             ,   a.rcptno                                                           AS  opmi_rcptno                       
             ,   a.rcptseqno                                                        AS  opmi_rcptseqno                    
             ,   a.instcd                                                           AS  opmi_instcd                       
             ,   a.rcptstat                                                         AS  opmi_rcptstat                     
             ,   a.uncorcptflag                                                     AS  opmi_uncorcptflag                 
             ,   a.orddd                                                            AS  opmi_orddd                        
             ,   a.cretno                                                           AS  opmi_cretno                       
             ,   a.acptseqno                                                        AS  opmi_acptseqno                    
             ,   a.orddeptcd                                                        AS  opmi_orddeptcd                    
             ,   a.orddrid                                                          AS  opmi_orddrid                      
             ,   a.ordtype                                                          AS  opmi_ordtype                      
             ,   a.mskind                                                           AS  opmi_mskind                       
             ,   a.insukind                                                         AS  opmi_insukind                     
             ,   a.suppkind                                                         AS  opmi_suppkind                     
             ,   a.insucd                                                           AS  opmi_insucd                       
             ,   a.payamt + a.allownbamt + a.nopyamt + a.specamt                    AS  opmi_totamt                       
             ,   a.payamt                                                           AS  opmi_payamt                       
             ,   a.allownbamt + a.nopyamt                                           AS  opmi_totnopyamt                   
             ,   a.allownbamt                                                       AS  opmi_allownbamt                   
             ,   a.nopyamt                                                          AS  opmi_nopyamt                      
             ,   a.payownbamt                                                       AS  opmi_payownbamt                   
             ,   a.payinsubamt                                                      AS  opmi_payinsubamt                  
             ,   a.nopyownbamt                                                      AS  opmi_nopyownbamt                  
             ,   a.nopyinsubamt                                                     AS  opmi_nopyinsubamt                 
             ,   a.allownownbamt                                                    AS  opmi_allownownbamt                
             ,   a.allowninsubamt                                                   AS  opmi_allowninsubamt               
             ,   a.specownbamt                                                      AS  opmi_specownbamt                  
             ,   a.specinsubamt                                                     AS  opmi_specinsubamt                 
             ,   a.nopyownbamt + allownownbamt                                      AS  opmi_totnopyownbamt               
             ,   a.nopyinsubamt + allowninsubamt                                    AS  opmi_totnopyinsubamt              
             ,   a.handcapfund                                                      AS  opmi_handcapfund                  
             ,   a.procsubtamt + a.ersubtamt                                        AS  opmi_subtamt                      
             ,   a.procsubtamt                                                      AS  opmi_procsubtamt                  
             ,   a.ersubtamt                                                        AS  opmi_ersubtamt                    
             ,   a.specamt                                                          AS  opmi_specamt                      
             ,   a.discamt + a.reduamt                                              AS  opmi_discreduamt                  
             ,   a.discamt                                                          AS  opmi_discamt                      
             ,   a.reduamt                                                          AS  opmi_reduamt                      
             ,   a.bloddiscamt                                                      AS  opmi_bloddiscamt                  
             ,   a.payownbamt + a.nopyownbamt + a.allownownbamt + a.specownbamt     AS  opmi_totownbamt   --본인부담                
             ,   a.premdlrcptamt                                                    AS  opmi_premdlrcptamt                
             ,   a.precardamt                                                       AS  opmi_precardamt                   
             ,   a.precashamt                                                       AS  opmi_precashamt                   
             ,   a.preonlineamt                                                     AS  opmi_preonlineamt                 
             ,   a.premdlrcptamt + a.precardamt + a.precashamt+ a.preonlineamt      AS  opmi_totpreamt                   
             ,   a.mdlrcptamt                                                       AS  opmi_mdlrcptamt                   
             ,   a.uncoamt                                                          AS  opmi_uncoamt                      
             ,   a.cardamt + a.cashamt + a.onlineamt                                AS  opmi_rcptexptamt                  
             ,   a.cardamt                                                          AS  opmi_cardamt                      
             ,   a.cashamt                                                          AS  opmi_cashamt                      
             ,   a.onlineamt                                                        AS  opmi_onlineamt                    
             ,   a.restamt                                                          AS  opmi_restamt                      
             ,   a.hosindrugno                                                      AS  opmi_hosindrugno                  
             ,   a.hosoutdrugno                                                     AS  opmi_hosoutdrugno                 
             ,   a.calcmthdflag                                                     AS  opmi_calcmthdflag                 
             ,   a.remfact                                                          AS  opmi_remfact                      
             ,   a.paypsnflag                                                       AS  opmi_paypsnflag                   
             ,   a.paydepoamt                                                       AS  opmi_paydepoamt                   
             ,   a.paypsnrem                                                        AS  opmi_paypsnrem                    
             ,   a.orgrcptdd                                                        AS  opmi_orgrcptdd                    
             ,   a.orgrcptno                                                        AS  opmi_orgrcptno                    
             ,   a.orgrcptseqno                                                     AS  opmi_orgrcptseqno                 
             ,   a.rcptexecdd                                                       AS  opmi_rcptexecdd                   
             ,   a.rcpttm                                                           AS  opmi_rcpttm                       
             ,   a.rcptrid                                                          AS  opmi_rcptrid                      
             ,   a.fstrgstrid                                                       AS  opmi_fstrgstrid                   
             ,   a.fstrgstdt                                                        AS  opmi_fstrgstdt                    
             ,   a.lastupdtrid                                                      AS  opmi_lastupdtrid                  
             ,   a.lastupdtdt                                                       AS  opmi_lastupdtdt                         
             ,   a.heallifeamtclamamt                                               AS  opmi_heallifeamtclamamt
			 ,   a.pregdmndamt                                                      AS  opmi_pregdmndamt
			 ,   a.suppamt                                                          AS  opmi_suppamt 
			 ,   a.refundyn                                                          AS  opmi_refundyn
			 ,   a.prepregdmndamt                                                AS  opmi_prepregdmndamt
			 ,   a.centcd                                                             AS  opmi_centcd
			 ,   a.subdeptcd                                                        AS  opmi_subdeptcd
			 ,   a.coopteamcd                                                      AS  opmi_coopteamcd
			 ,   a.payinsurestamt                                                      AS  opmi_payinsurestamt
			 ,	 a.taxamt																															AS opmi_taxamt
             ,  (select count(*) from pam.paohopmi k where k.pid = a.pid and k.rcptdd = a.rcptdd
                and k.rcptrid = a.rcptrid and k.rcpttm = a.rcpttm and k.rcptstat = a.rcptstat and k.rcptstat ='Y' and k.instcd = a.instcd) AS    opmi_cnt

			,(select usernm from  COM.ZSUMUSRB where userid =a.rcptrid and rownum =1) as opmi_rcptridnm

            FROM  pam.paohopmi a, pam.pmcmptbs b
           WHERE  a.pid        = #pid#
             AND  a.orddeptcd  = #orddeptcd#
             AND  a.instcd     = #sessinstcd#
            ]]> 
        <isNotEmpty property="OtptKey"><![CDATA[   
             AND  a.orddd || a.orddrid in ('$OtptKey$')
         ]]> 
        </isNotEmpty>
        <isEmpty property="OtptKey">
             AND  a.orddd      = #orddd#
             AND  a.orddrid    = #orddrid#
        </isEmpty>
             AND  b.pid        = a.pid     
             AND  b.instcd     = a.instcd
          ORDER BY a.orddd desc , a.rcptdd desc, a.rcptno desc, a.rcptseqno desc    
    </statement> 


	<!-- 외래수납 최대생성순번구하기 08/09/07 조영상-->
	<statement id="getOtptMaxAcptseqno"><![CDATA[   
	      SELECT max(a.acptseqno)           AS otpt_acptseqno
            FROM pam.pmohotpt a                
           WHERE a.pid        = #otpt_pid#
             AND a.orddd      = #otpt_orddd# 
             AND a.cretno     = #otpt_cretno# 
             AND a.histstat   in ('R','T')
             AND a.instcd     = #sessinstcd#
	]]>
    </statement> 

	<!-- 외래수납 건강생활유지비 수납화면에서 불러오기-->
	<statement id="getMsg4LifeAmt"><![CDATA[   
		SELECT 
			NVL(sum( heallifeamtclamamt),0) AS heallifeamtclamamt
		   ,NVL(sum( pregdmndamt),0) AS pregdmndamt
		  FROM pam.pmcmmsg4
		 WHERE pid      = #pid#
		   AND orddd || '_' ||cretno in ('$otptkey$')  
		   AND instcd   = #sessinstcd#
		   AND histstat = 'R'
	]]>
    </statement>

	<!-- 외래수납 건강생활유지비 수납서버에서 불러오기-->
	<statement id="getPreLifeAmt"><![CDATA[   
      SELECT NVL(SUM(m4.heallifeamtclamamt),0) as heallifeamtclamamt
	    FROM pam.pmcmmsg4 m4
       WHERE m4.pid      = #pid#
         AND m4.instcd   = #sessinstcd#
         AND m4.orddd    = #orddd#
         AND m4.cretno   = #cretno#
         AND m4.histstat = 'R'
	]]>
    </statement>
    
    <!-- 실시정산 지원금 조회 -->
    <statement id="getExeSuppAmt"><![CDATA[   
    select rareobstflag, sum(suppamt) as suppamt
	from (
			--미실시건 지원금액
			select CASE  WHEN a.rareobstflag = 'H' 								 THEN sum(b.payownbamt)
							WHEN a.rareobstflag = 'L' and a.suppkind in ('50', '51') THEN sum(b.payownbamt)
						    ELSE 0 END as suppamt, a.insukind, a.suppkind, a.rareobstflag
			from   pam.pmohactr a
				  ,pam.paohoscl b
			where  a.instcd = #sessinstcd#
			and    a.pid    = #pid#
			and    a.orddd  = #orddd#
			and    a.cretno = #cretno#
			and    a.histstat = 'Y'
			and    a.calcbaseflag = '2'
			and    a.pid = b.pid
			and    a.orddd = b.orddd
			and    a.cretno = b.cretno
			and    b.calcstat = 'R'
			and    NVL(b.execdd,'00000000') = '00000000'
			and    a.actfromdd = NVL(( select 	max(actfromdd)
											  from		pam.pmohactr c
											  where	c.pid = a.pid
											  and		c.instcd = a.instcd
											  and		c.orddd = a.orddd
											  and		c.cretno = a.cretno
											  and		c.histstat = 'Y'
											  and		c.calcbaseflag = '2' ), b.orddd)
			group by a.insukind, a.suppkind, a.rareobstflag
	
			union all
	
			--실시일자 기준 지원금액
			select CASE  WHEN a.rareobstflag = 'H' 								 THEN sum(b.payownbamt)
							WHEN a.rareobstflag = 'L' and a.suppkind in ('50', '51') THEN sum(b.payownbamt)
							ELSE 0 END as suppamt, a.insukind, a.suppkind, a.rareobstflag
			from   pam.pmohactr a
				  ,pam.paohoscl b
			where  a.instcd = #sessinstcd#
			and    a.pid    = #pid#
			and    a.orddd  = #orddd#
			and    a.cretno = #cretno#
			and    a.histstat = 'Y'
			and    a.calcbaseflag = '2'
			and    a.pid = b.pid
			and    a.orddd = b.orddd
			and    a.cretno = b.cretno
			and    b.calcstat = 'R'
			and    NVL(b.execdd,'00000000') = a.actfromdd
			group by a.insukind, a.suppkind, a.rareobstflag
		)
	group by rareobstflag
	]]>
    </statement>
    
    <!-- 장애기금  조회 -->
    <statement id="getExeHandcapFund"><![CDATA[   
	    select insukind, suppkind, sum(handcapfund) as handcapfund
		  from (
				--미실시건 지원금액
				select a.insukind, a.suppkind, sum(b.payownbamt) as handcapfund
				  from pam.pmohactr a,
				  	   pam.paohoscl b
				 where a.instcd 		= b.instcd
				   and a.pid 			= b.pid
				   and a.orddd 			= b.orddd
				   and a.cretno 		= b.cretno
				   and a.instcd 		= #sessinstcd#
				   and a.pid    		= #pid#
				   and a.orddd 			= #orddd#
				   and a.cretno 		= #cretno#
				   and a.histstat 		= 'Y'
				   and a.calcbaseflag 	= '2'
				   and a.handicaprbookpossnyn 	= 'Y'
				   and b.calcstat 				= 'R'
				   and NVL(b.execdd,'00000000') = '00000000'
				   and a.actfromdd = NVL(( select max(actfromdd)
				   							 from pam.pmohactr c
				   							where c.pid 		= a.pid
				   							  and c.instcd 		= a.instcd
				   							  and c.orddd 		= a.orddd
				   							  and c.cretno 		= a.cretno
				   							  and c.histstat 	= 'Y'
				   							  and c.calcbaseflag = '2' ), b.orddd)
				 group by a.insukind, a.suppkind								   							  
				 union all
				--실시일자 기준 지원금액
				select a.insukind, a.suppkind, sum(b.payownbamt) as handcapfund
				  from pam.pmohactr a,
				  	   pam.paohoscl b
				 where a.instcd 		= b.instcd
				   and a.pid 			= b.pid
				   and a.orddd 			= b.orddd
				   and a.cretno 		= b.cretno
				   and a.instcd 		= #sessinstcd#
				   and a.pid    		= #pid#
				   and a.orddd 			= #orddd#
				   and a.cretno 		= #cretno#
				   and a.histstat 		= 'Y'
				   and a.calcbaseflag 	= '2'
				   and a.handicaprbookpossnyn 	= 'Y'
				   and b.calcstat 				= 'R'
				   and NVL(b.execdd,'00000000') = a.actfromdd
				 group by a.insukind, a.suppkind
			)
		 group by insukind, suppkind
	]]>
    </statement>

    <!-- 카드수납 내역 조회 -->
    <!-- TRPAO01701 -->
    <statement id="getcardList"><![CDATA[    
          SELECT c.pid            AS pid
		       , c.orddd          AS orddd
			   , c.cretno         AS cretno
               , c.rcptdd         AS rcptdd                     
               , c.rcptno         AS rcptno                     
               , c.rcptseqno      AS rcptseqno                  
               , c.seqno          AS seqno                      
               , c.instcd         AS instcd                     
               , c.rcptstat       AS rcptstat                   
               , c.ordtype        AS ordtype                    
               , c.keyinptflag    AS keyinptflag                
               , c.cardcmpycd     AS cardcmpycd                 
               , c.cardno         AS cardno                     
               , c.aprvflag       AS aprvflag                   
               , c.aprvdd         AS aprvdd                     
               , c.aprvtm         AS aprvtm                     
               , c.aprvno         AS aprvno                     
               , c.vancd          AS vancd                      
               , c.allotmm        AS allotmm                    
               , c.cardamt        AS cardamt                    
               , c.valiterm       AS valiterm                   
               , c.rcptexecdd     AS rcptexecdd                 
               , c.rcpttm         AS rcpttm                     
               , c.rcptrid        AS rcptrid                    
               , 'Y'              AS innrtretyn                 
               , c.preamtyn       AS preamtyn                   
               , c.remfact        AS remfact                    
               , c.fstrgstrid     AS fstrgstrid                 
               , c.fstrgstdt      AS fstrgstdt                     
               , c.lastupdtrid    AS lastupdtrid                
               , c.lastupdtdt     AS lastupdtdt 
               , #orddd#          AS orddd_org       -- _org는 기opmi찾아가기위해설정(수납시에쓰임)                   
               , #cretno#      AS cretno_org   
			   , #orddeptcd#      AS orddeptcd_org                     
               , #orddrid#        AS orddrid_org
               , c.rcptdd         AS rcptdd_org                     
               , c.rcptno         AS rcptno_org                     
               , c.rcptseqno      AS rcptseqno_org
           FROM pam.paohopmi a, pam.pamhcard c
          WHERE a.pid = #pid#              
		  ]]>
               <isNotEmpty property="cardno"><![CDATA[
                 AND a.cardno = #cardno#
               ]]>
               </isNotEmpty><![CDATA[  
               AND a.orddd      = #orddd#
               AND a.cretno     = #cretno#                
               AND a.instcd     = #sessinstcd#
	           AND a.pid        = c.pid
	           AND a.instcd     = c.instcd
               AND a.rcptdd     = c.rcptdd
               AND a.rcptno     = c.rcptno
               AND a.rcptseqno  = c.rcptseqno
			   AND a.rcptstat   = c.rcptstat
			   AND a.rcptstat   = 'Y'
               ]]>
    </statement> 
    <!--조회시 어차피 한번 수납한것이므로 정산개념인 innrtretyn를 Y로 고정한다 2008/06/09 조영상 
	   FROM pam.pamhcard a
		  , pam.pmcmptbs b        
	  WHERE a.rcptstat = 'Y'
		   AND a.pid = #pid#               
		   AND a.rcptdd     = #rcptdd#
		   AND a.rcptno     = #rcptno# 
		   AND a.rcptseqno  = #rcptseqno#                
		   AND a.instcd     = #sessinstcd#
		   AND b.pid        = a.pid
		   AND b.instcd     = a.instcd
	-->

    <!-- 현금영수증승인 수납내역 조회 --> 
    <!-- TRPAO01701 -->   
    <statement id="getcashList"><![CDATA[    
        SELECT  a.pid                     AS pid          
              , b.hngnm                   AS hngnm
			  , a.orddd                   AS orddd
			  , a.cretno                  AS cretno
              , a.rcptdd                  AS rcptdd       
              , a.rcptno                  AS rcptno       
              , a.rcptseqno               AS rcptseqno    
              , a.seqno                   AS seqno        
              , a.instcd                  AS instcd       
              , a.rcptstat                AS rcptstat     
              , a.ordtype                 AS ordtype      
              , a.keyinptflag             AS keyinptflag  
              , a.indinstflag             AS indinstflag  
              , a.qualcnfmflag            AS qualcnfmflag 
              , a.qualcnfmno              AS qualcnfmno   
              , a.aprvflag                AS aprvflag     
              , a.aprvno                  AS aprvno       
              , a.aprvdd                  AS aprvdd       
              , a.aprvtm                  AS aprvtm       
              , a.cashamt                 AS cashamt      
              , a.rcptexecdd              AS rcptexecdd   
              , a.rcpttm                  AS rcpttm       
              , a.rcptrid                 AS rcptrid        
              , a.preamtyn                AS preamtyn     
              , 'Y'                       AS innrtretyn   
              , a.remfact                 AS remfact      
              , a.fstrgstrid              AS fstrgstrid   
              , a.fstrgstdt               AS fstrgstdt    
              , a.lastupdtrid             AS lastupdtrid  
              , a.lastupdtdt              AS lastupdtdt
              , #orddd#                   AS orddd_org       -- _org는 기opmi찾아가기위해설정(수납시에쓰임)                   
              , #cretno#               AS cretno_org
			  , #orddeptcd#               AS orddeptcd_org                     
              , #orddrid#                 AS orddrid_org
              , a.rcptdd                  AS rcptdd_org                     
              , a.rcptno                  AS rcptno_org                     
              , a.rcptseqno               AS rcptseqno_org
          FROM pam.pachcash a    
              ,pam.pmcmptbs b
         WHERE a.rcptstat = 'Y'
         ]]>
               <isNotEmpty property="pid"><![CDATA[
                AND a.pid = #pid#
               ]]>
               </isNotEmpty>
               <isNotEmpty property="cardno">   <![CDATA[
                AND a.qualcnfmno = #cardno#
               ]]>
               </isNotEmpty><![CDATA[   
                AND a.rcptdd     = #rcptdd#
                AND a.rcptno     = #rcptno#     
                AND a.rcptseqno  = #rcptseqno#            
                AND a.instcd     = #sessinstcd#    
                AND b.pid        = a.pid        
                AND b.instcd     = a.instcd				
               ]]>
    </statement> 
    
    <!-- 온라인입금 수납내역 조회 -->        
    <!-- TRPAO01701 -->
    <statement id="getonlnList"><![CDATA[    
          SELECT a.pid           AS pid         
               , b.hngnm         AS hngnm
			   , a.orddd         AS orddd
			   , a.cretno        AS cretno
               , a.rcptdd        AS rcptdd      
               , a.rcptno        AS rcptno      
               , a.rcptseqno     AS rcptseqno   
               , a.seqno         AS seqno       
               , a.instcd        AS instcd      
               , a.rcptstat      AS rcptstat    
               , a.ordtype       AS ordtype     
               , a.onlineamt     AS onlineamt   
               , a.bankcd        AS bankcd      
               , a.acntno        AS acntno      
               , a.paydd         AS paydd       
               , a.paypsnnm      AS paypsnnm    
               , a.rcptexecdd    AS rcptexecdd  
               , a.rcpttm        AS rcpttm      
               , a.rcptrid       AS rcptrid     
               , a.preamtyn      AS preamtyn    
               , 'Y'             AS innrtretyn  
               , a.remfact       AS remfact     
               , a.fstrgstrid    AS fstrgstrid  
               , a.fstrgstdt     AS fstrgstdt   
               , a.lastupdtrid   AS lastupdtrid 
               , a.lastupdtdt    AS lastupdtdt
               , #orddd#         AS orddd_org       -- _org는 기opmi찾아가기위해설정(수납시에쓰임)                   
               , #cretno#     AS cretno_org
			   , #orddeptcd#     AS orddeptcd_org                     
               , #orddrid#       AS orddrid_org
               , a.rcptdd        AS rcptdd_org                     
               , a.rcptno        AS rcptno_org                     
               , a.rcptseqno     AS rcptseqno_org
            FROM pam.pachonln a
                ,pam.pmcmptbs b       
           WHERE a.rcptstat = 'Y'
           ]]>
               <isNotEmpty property="pid"><![CDATA[
                 AND a.pid = #pid#
               ]]>
               </isNotEmpty>
               <isNotEmpty property="cardno"><![CDATA[
                 AND a.paypsnnm = #cardno#
               ]]>
               </isNotEmpty><![CDATA[  
                 AND a.rcptdd     = #rcptdd#
                 AND a.rcptno     = #rcptno#     
                 AND a.rcptseqno  = #rcptseqno# 
                 AND a.instcd     = #sessinstcd#
                 AND b.pid        = a.pid
                 AND b.instcd     = a.instcd
               ]]>
    </statement>  

    <!-- 수혈대체 수납내역 조회 -->        
    <!-- TRPAO01701 -->
    <statement id="getbldcList"><![CDATA[    
            SELECT
                   a.pid               AS pid            
                 , b.hngnm             AS hngnm          
                 , a.rcptdd            AS rcptdd         
                 , a.rcptno            AS rcptno         
                 , a.rcptseqno         AS rcptseqno      
                 , a.seqno             AS seqno          
                 , a.instcd            AS instcd         
                 , a.rcptstat          AS rcptstat       
                 , a.ordtype           AS ordtype        
                 , a.orddd             AS orddd          
                 , a.orddeptcd         AS orddeptcd      
                 , a.orddrid           AS orddrid        
                 , a.grupcalcscorcd    AS grupcalcscorcd 
                 , a.snglcalcscorcd    AS snglcalcscorcd 
                 , a.appdd             AS appdd          
                 , a.calcqty           AS calcqty        
                 , a.calctims          AS calctims       
                 , a.calcdays          AS calcdays       
                 , a.calcamt           AS calcamt        
                 , a.disccnt           AS disccnt        
                 , a.discamt           AS discamt        
                 , a.apprsn            AS apprsn         
                 , a.rcptexecdd        AS rcptexecdd     
                 , a.rcpttm            AS rcpttm         
                 , a.rcptrid           AS rcptrid        
                 , a.remfact           AS remfact        
                 , a.fstrgstrid        AS fstrgstrid     
                 , a.fstrgstdt         AS fstrgstdt      
                 , a.lastupdtrid       AS lastupdtrid    
                 , a.lastupdtdt        AS lastupdtdt
                 , a.prcpdd            AS prcpdd
                 , a.prcpno            AS prcpno
                 , a.prcphistno        AS prcphistno
                 , a.execprcpseqno     AS execprcpseqno
				 , a.orddd             AS orddd
				 , a.cretno            AS cretno
                 , #orddd#             AS orddd_org       -- _org는 기opmi찾아가기위해설정(수납시에쓰임)                   
                 , #cretno#            AS cretno_org
				 , #orddeptcd#         AS orddeptcd_org                     
                 , #orddrid#           AS orddrid_org
                 , a.rcptdd            AS rcptdd_org                     
                 , a.rcptno            AS rcptno_org                     
                 , a.rcptseqno         AS rcptseqno_org
             FROM pam.padhbldc a
                , pam.pmcmptbs b 
             WHERE a.pid        = #pid#
               AND a.instcd     = #sessinstcd# 
               AND a.rcptstat   = 'Y'
               AND a.rcptdd     = #rcptdd#
               AND a.rcptno     = #rcptno# 
               AND a.rcptseqno  = #rcptseqno#                
               AND a.instcd     = #sessinstcd#
               AND b.pid        = a.pid
               AND b.instcd     = a.instcd
      ]]>
    </statement>  
	

    <!-- 임의감면 수납내역 조회 -->        
    <!-- TRPAO01701 -->
    <statement id="getdcgmList"><![CDATA[   
		SELECT
			   a.pid               AS pid            
			 , b.hngnm             AS hngnm 
			 , a.orddd             AS orddd
			 , a.cretno            AS cretno
			 , a.rcptdd            AS rcptdd       
			 , a.rcptno            AS rcptno       
			 , a.seqno             AS seqno        
			 , a.rcptseqno         AS rcptseqno    
			 , a.instcd            AS instcd       
			 , a.rcptstat          AS rcptstat     
			 , a.ordtype           AS ordtype      
			 , a.discreduflag      AS discreduflag 
			 , a.discreducd        AS discreducd   
			 , a.discreduamt       AS discreduamt  
			 , a.apprsn            AS apprsn       
			 , a.rcptexecdd        AS rcptexecdd   
			 , a.rcpttm            AS rcpttm       
			 , a.rcptrid           AS rcptrid      
			 , a.remfact           AS remfact      
			 , a.fstrgstrid        AS fstrgstrid   
			 , a.fstrgstdt         AS fstrgstdt    
			 , a.lastupdtrid       AS lastupdtrid  
			 , a.lastupdtdt        AS lastupdtdt        
			 , #orddd#             AS orddd_org       -- _org는 기opmi찾아가기위해설정(수납시에쓰임)                   
			 , #cretno#            AS cretno_org
			 , #orddeptcd#         AS orddeptcd_org                     
			 , #orddrid#           AS orddrid_org
			 , a.rcptdd            AS rcptdd_org                     
			 , a.rcptno            AS rcptno_org                     
			 , a.rcptseqno         AS rcptseqno_org
		 FROM pam.padhdcgm a
			, pam.pmcmptbs b 
		 WHERE a.pid        = #pid#
		   AND a.instcd     = #sessinstcd# 
		   AND a.rcptstat   = 'Y'
		   AND a.rcptdd     = #rcptdd#
		   AND a.rcptno     = #rcptno# 
		   AND a.rcptseqno  = #rcptseqno#
		   AND b.pid        = a.pid
		   AND b.instcd     = a.instcd
		   AND a.discreduflag = 'G'
      ]]>
    </statement>  

    <!-- 임의감면 수납내역 조회 0원수납용 사용안함 20091016 CYS -->        
    <!-- TRPAO01701 -->
	<!--
    <statement id="getdcgmList_zero"><![CDATA[   
		SELECT
			   a.pid               AS pid            
			 , b.hngnm             AS hngnm
			 , a.orddd             AS orddd
			 , a.cretno            AS cretno
			 , a.rcptdd            AS rcptdd       
			 , a.rcptno            AS rcptno       
			 , a.seqno             AS seqno        
			 , a.rcptseqno         AS rcptseqno    
			 , a.instcd            AS instcd       
			 , a.rcptstat          AS rcptstat     
			 , a.ordtype           AS ordtype      
			 , a.discreduflag      AS discreduflag 
			 , a.discreducd        AS discreducd   
			 , decode(a.discreduflag,'D',#opmi_discamt#,'G',#opmi_reduamt#,a.discreduamt)      AS discreduamt  
			 , a.apprsn            AS apprsn       
			 , #opmi_rcptexecdd#   AS rcptexecdd   
			 , #opmi_rcpttm#       AS rcpttm       
			 , a.rcptrid           AS rcptrid      
			 , a.remfact           AS remfact      
			 , a.fstrgstrid        AS fstrgstrid   
			 , a.fstrgstdt         AS fstrgstdt    
			 , a.lastupdtrid       AS lastupdtrid  
			 , a.lastupdtdt        AS lastupdtdt        
			 , #orddd#             AS orddd_org
			 , #cretno#            AS cretno_org
			 , #orddeptcd#         AS orddeptcd_org                     
			 , #orddrid#           AS orddrid_org
			 , a.rcptdd            AS rcptdd_org                     
			 , a.rcptno            AS rcptno_org                     
			 , a.rcptseqno         AS rcptseqno_org
		 FROM pam.padhdcgm a
			, pam.pmcmptbs b 
		 WHERE a.pid        = #pid#
		   AND a.instcd     = #sessinstcd# 
		   AND a.rcptstat   = 'Y'
		   AND a.rcptdd     = #rcptdd#
		   AND a.rcptno     = #rcptno# 
		   AND a.rcptseqno  = #rcptseqno#
		   AND b.pid        = a.pid
		   AND b.instcd     = a.instcd
      ]]>
    </statement>
	-->

    <!-- 미수 수납내역 조회 -->        
    <!-- TRPAO01701 -->
    <statement id="getuncoList"><![CDATA[   
        SELECT
                   a.pid                 AS pid         
                 , a.rcptdd              AS rcptdd      
                 , a.rcptno              AS rcptno      
                 , a.rcptseqno           AS rcptseqno   
                 , a.seqno               AS seqno       
                 , a.instcd              AS instcd      
                 , a.rcptstat            AS rcptstat    
                 , a.ordtype             AS ordtype     
                 , a.orddd               AS orddd
				 , a.cretno              AS cretno
                 , a.orddeptcd           AS orddeptcd   
                 , a.orddrid             AS orddrid     
                 , a.dschdd              AS dschdd      
                 , a.insukind            AS insukind    
                 , a.suppkind            AS suppkind    
                 , a.uncorcptflag        AS uncorcptflag
                 , a.uncocls             AS uncocls     
                 , a.uncocd              AS uncocd      
                 , a.uncoamt             AS uncoamt     
                 , a.rcptamt             AS rcptamt     
                 , a.debtamt             AS debtamt     
                 , a.endyn               AS endyn       
                 , a.clincstdyno         AS clincstdyno 
                 , a.empid               AS empid       
                 , a.rcptexecdd          AS rcptexecdd  
                 , a.rcpttm              AS rcpttm      
                 , a.rcptrid             AS rcptrid     
                 , a.apprsn              AS apprsn      
                 , a.remfact             AS remfact     
                 , a.fstrgstrid          AS fstrgstrid  
                 , a.fstrgstdt           AS fstrgstdt   
                 , a.lastupdtrid         AS lastupdtrid 
                 , a.lastupdtdt          AS lastupdtdt  
                 , a.mig                 AS mig         
                 , #orddd#               AS orddd_org       -- _org는 기opmi찾아가기위해설정(수납시에쓰임)                   
                 , #cretno#              AS cretno_org
				 , #orddeptcd#           AS orddeptcd_org                     
                 , #orddrid#             AS orddrid_org
                 , a.rcptdd              AS rcptdd_org                     
                 , a.rcptno              AS rcptno_org                     
                 , a.rcptseqno           AS rcptseqno_org
          FROM pam.pamhunco a, pam.pmcmptbs b 
         WHERE a.pid        = #pid#
           AND a.instcd     = #sessinstcd# 
           AND a.rcptstat   = 'Y'
           AND a.rcptdd     = #rcptdd#
           AND a.rcptno     = #rcptno# 
           AND a.rcptseqno  = #rcptseqno#
           AND b.pid        = a.pid
           AND b.instcd     = a.instcd
		   AND a.endyn     != 'Y'
      ]]>
    </statement>  

	<!-- 일반의-특진의 변경 -->    
    <statement id="setSpecOrdChng"><![CDATA[    
        UPDATE pam.pmohotpt
           SET specordyn   = #specordyn#
             , calcflag    = 'Y'
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP
         WHERE pid       = #pid#
           AND orddd     = #orddd#
           AND cretno    = #cretno#
           AND instcd    = #sessinstcd#
           AND histstat  in ('R','T')
           ]]>         
    </statement>

    <!-- 외래수납 환자재원정보 -->    
    <statement id="getInptInfo"><![CDATA[
      SELECT  pid
             ,ordtype
             ,brateflag
             ,dschnotiyn
        FROM pam.pmihinpt
       WHERE pid            = #pid# 
         AND instcd         = #sessinstcd#
         AND indschacptstat ='A'
         AND dschdd         = '99991231'
         AND histstat       ='Y'
         AND mskind         ='M'
    ]]>
    </statement> 

    <!-- 외래수납 환자 가퇴원정보 -->    
    <statement id="getInptInfo_c"><![CDATA[
      SELECT  pid
             ,ordtype
             ,brateflag
             ,dschjudgprcsstat
             ,indd
             ,dschdd
        FROM pam.pmihinpt
       WHERE pid            = #pid# 
         AND instcd         = #sessinstcd#
         AND indschacptstat ='T'
         AND dschdd         != '99991231'
         AND histstat       ='Y'
    ]]>
    </statement> 

	<!-- 외래수납 중증시 보조유형변경 -->    
    <statement id="setOtptSrdg"><![CDATA[    
        UPDATE pam.pmohotpt
           SET suppkind    = #suppkind#
		     , spclcd      = 'V193'
             , calcflag    = 'Y'
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP
         WHERE pid       = #pid#
           AND orddd     = #orddd#
           AND cretno    = #cretno#
           AND instcd    = #sessinstcd#
           AND histstat  in ('R','T')
    ]]>         
    </statement>

	<!-- 외래수납 산정특례시 보조유형변경 -->    
    <statement id="setOtptEstm"><![CDATA[    
        UPDATE pam.pmohotpt
           SET suppkind    = #suppkind#
             , calcflag    = 'Y'
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP
         WHERE pid       = #pid#
           AND orddd     = #orddd#
           AND cretno    = #cretno#
           AND instcd    = #sessinstcd#
           AND histstat  in ('R','T')
    ]]>         
    </statement>

	<!-- 의사소견서,방문간호지시서 단일처방시 진찰료 면제  -->
	<statement id="setOtpt_drcm"><![CDATA[   
        UPDATE pam.pmohotpt
           SET medamtestmyn   = #medamtestmyn#
              ,medamtfreeresn = #medamtfreeresn#
			  ,calcflag     = 'Y'
	          ,lastupdtrid  = #sessuserid# 
	          ,lastupdtdt   = SYSTIMESTAMP
         WHERE pid         = #pid#
           AND orddd       = #orddd#
           AND cretno      = #cretno#
           AND instcd      = #sessinstcd#
	]]>
    </statement> 

    <!-- VAN 이중승인 여부 체크 -->    
    <statement id="getEmtyVanCk"><![CDATA[
        SELECT
             (select p.hngnm from pam.pmcmptbs p where a.pid = p.pid AND p.instcd = #sessinstcd# AND rownum =1)    AS hngnm
            ,(select cdnm from COM.ZBCMCODE where cdgrupid ='P0076' AND cdid = a.cardcmpycd AND rownum =1)         AS cardcmpycdnm
            ,(select usernm from  COM.ZSUMUSRB where userid =a.rcptrid AND rownum =1)                              AS rcptrnm
            ,a.*
          FROM pam.pamhcvan a
         WHERE a.instcd    = #sessinstcd#
           AND a.pid       = #pid# 
           AND a.aprvdd    = TO_CHAR(SYSDATE, 'YYYYMMDD')
		   AND a.aprvflag  = '12'
		   AND a.ordtype  in ('O','E')
		   AND a.etcflag !='Y'
           AND 0 =      (SELECT count(*) 
                           FROM pam.pamhcard b
                         WHERE a.pid = b.pid
                           AND a.aprvdd = b.rcptexecdd
                           AND a.aprvno = b.aprvno
                           AND b.innrtretyn = 'N'
                           AND a.rcptrid = b.rcptrid)

           AND 0 =      (SELECT count(*)
		                   FROM pam.pamhcvan c
		                  WHERE a.pid = c.pid
		                    AND a.aprvdd = c.aprvdd
		                    AND a.aprvno = c.aprvno
		                    AND c.aprvflag = '22')
    ]]>
    </statement> 

     <!-- 환자연속처방내역조회 --> 
     <statement id="getExopActList"><![CDATA[    
        SELECT calcscorcd 
          FROM emr.mmodexop
         WHERE instcd    = #sessinstcd# 
           AND pid       = #pid#
           AND actorddd     = #orddd#
           AND actcretno    = #cretno#
		   AND execprcphistcd = 'O'
     ]]>
    </statement> 
    
    <!-- 장기이식환자정보 조회 --> 
     <statement id="getTranInfo"><![CDATA[    
        SELECT	a1.trnptdd
                    , a1.pid       AS rsvpid
		FROM 	ast.abomtrif a1
		WHERE 	a1.trnptdd 	!= '00000000' AND a1.trnptdd IS NOT NULL
		AND		a1.trnptdd	< #orddd#
		AND 		a1.instcd 		= #sessinstcd#
		AND		a1.pid			= #pid#
		
		UNION ALL
		
		SELECT	a1.trnptdd
                  	, a1.rsvpid
		FROM 	pam.picmtrpt a1
		WHERE 	a1.trnptdd	< #orddd#
		AND 		a1.instcd 		= #sessinstcd#
        AND 		a1.rowstat 	!= 'D'
        AND		a1.rsvpid		= #pid#
     ]]>
    </statement> 

    <statement id="setPtinUpdate"><![CDATA[    
        UPDATE pam.pmcmptin a
           SET a.insucd        =  #ptin_insucd#
			  ,a.insuno        =  #ptin_insuno#
			  ,a.insdrela      =  #ptin_insdrela#
			  ,a.insdnm        =  #ptin_insdnm#
			  ,a.insdrrgstno1  =  #ptin_insdrrgstno1#
			  ,a.insdrrgstno2  =  #ptin_insdrrgstno2#
              ,a.lastupdtrid   = #sessuserid#
              ,a.lastupdtdt    = SYSTIMESTAMP 
        WHERE a.pid      = #ptin_pid#
          AND a.insukind = #ptin_insukind_org#
		  AND a.todd     = #ptin_todd_org#
          AND a.instcd   = #sessinstcd#
           ]]>         
    </statement>

	<!-- 외래등록정보 홀드상태로 변경 -->    
    <statement id="setOtptHoldFlag"><![CDATA[    
        UPDATE pam.pmohotpt
           SET holdflag    = #holdflag#
             , lastupdtrid = #sessuserid#
             , lastupdtdt  = SYSTIMESTAMP
         WHERE pid       = #pid#
           AND orddd     = #orddd#
           AND cretno    = #cretno#
           AND instcd    = #sessinstcd#
           AND histstat  in ('R','T')
    ]]>         
    </statement>

   <!-- 외래보험내역 상태변경--> 
   <statement id="getLastPtin"><![CDATA[    
	      SELECT a.*
            FROM pam.pmcmptin a                
           WHERE a.pid        = #pid#
             AND a.insukind   = #insukind# 
             AND a.todd       = '99991231' 
             AND a.histstat   = 'Y'
             AND a.instcd     = #sessinstcd#
		   ORDER BY a.seqno
           ]]>         
    </statement> 

    <!-- 기수납금 처리된 미수건 사유정보에 업데이트 -->    
    <statement id="setUncoEndApprsn"><![CDATA[    
    	UPDATE pam.pamhunco u
           SET u.apprsn = '기수납금처리완료'
             , u.lastupdtrid = #sessuserid#
             , u.lastupdtdt  = SYSTIMESTAMP
         WHERE u.pid      = #opmi_pid#
           AND u.orddd    = #opmi_orddd#
           AND u.cretno   = #opmi_cretno#
           AND u.endyn    = 'Y'
           AND u.instcd   = #sessinstcd#
    ]]>         
    </statement>

	<!-- 외래수납 환자 인적정보 변경 -->    
    <statement id="setPtbsInfo"><![CDATA[    
        UPDATE pam.pmcmptbs
			SET    sex             = #sex#      
					,hngnm         = REPLACE(#hngnm#, '★', '')
					,engnm         = #engnm#
					,rrgstno1       = #rrgstno1#
					,rrgstno2       = #rrgstno2#
					,brthdd          = #brthdd#
					,recmyn        = #recmyn#
					,recmerid      = #recmerid#
					,recmerrela    = #recmerrela#
					,vipyn          = #vipyn#
					,viprem        = #viprem#
					,forgeryn      = #forgeryn#
					,remfact       = #remfact#
				    ,lastupdtrid    = #sessuserid#
                    ,lastupdtdt     = SYSTIMESTAMP
         WHERE pid        = #pid#
              AND instcd    = #sessinstcd#

    ]]>         
    </statement>

   <!-- 외래수납 예약건 계산호출--> 
   <statement id="getCallCalc_Otpt"><![CDATA[    
	     
	      SELECT	'2' as calcactflag
					,'-'   as  batchflag
					,'Y' as calcflag
					,(select p.brthdd from pam.pmcmptbs p where p.pid = a.pid AND p.instcd =a.instcd and rownum = 1) brthdd
					,(select p.rrgstno1 from pam.pmcmptbs p where p.pid = a.pid AND p.instcd =a.instcd and rownum = 1) rrgstno1
					,(select p.rrgstno2 from pam.pmcmptbs p where p.pid = a.pid AND p.instcd =a.instcd and rownum = 1) rrgstno2
					,'Y' as calcyn
					,'Y' as calcgubn
					,'Y' as workgubn
					,CASE WHEN a.orddd < TO_CHAR(sysdate,'YYYYMMDD') THEN CASE WHEN (	SELECT count(*) 
																												FROM pam.pmohopcg k 
																						                        WHERE k.pid = a.pid
																						                        AND    k.orddd = a.orddd
																						                        AND    k.cretno = a.cretno
																						                        AND    k.instcd = a.instcd
																						                        AND	  k.genrdd = TO_CHAR(sysdate,'YYYYMMDD')
																						                        AND    k.histstat = 'Y') = 0 	THEN 'P' 
																						              ELSE 'T' END
                             WHEN a.orddd = TO_CHAR(sysdate,'YYYYMMDD') THEN 'T'
                             WHEN a.orddd > TO_CHAR(sysdate,'YYYYMMDD') THEN 'R'
                             END AS dayflag
					,a.*
            FROM pam.pmohotpt a
            WHERE a.pid     = #pid#
            AND a.calcflag   != 'N'
            AND a.instcd     = #sessinstcd#
			AND a.histstat    != 'X'
			AND a.orddd     >= TO_CHAR(SYSDATE - 365, 'YYYYMMDD')
			AND a.ordtype   != 'S'
           ]]>         
    </statement> 


   <!-- 처방변경내역 조회 --> 
   <statement id="getOsclRY"><![CDATA[    

SELECT * FROM(
    SELECT        decode(min(a.calcstat) , 'R', '추가','삭제') as  hidden
                   ,    min(a.payownbrate)       as payownbrate
                   ,    min(a.pid)                   AS pid
                   ,    min(a.orddd)                 AS orddd
                   ,    min(a.cretno)                AS cretno
                   ,    min(a.calcseqno)             AS calcseqno
                   ,    min(a.calcscorseqno)         AS calcscorseqno
                   ,    min(a.instcd)                AS instcd
                   ,    min(a.calcstat)              AS calcstat
                   ,    min(a.clamtrgtstat )         AS clamtrgtstat
                   ,    min(a.acptseqno )            AS acptseqno
                   ,    min(a.orddeptcd )            AS orddeptcd
                   ,    min(a.orddrid  )             AS orddrid
                   ,    min(a.mskind   )             AS mskind
                   ,    min(a.ordtype  )             AS ordtype
                   ,    min(a.grupcalcscorcd )       AS grupcalcscorcd
                   ,    min(a.snglcalcscorcd  )      AS snglcalcscorcd
                   ,    min(a.grupcalcscorcls )      AS grupcalcscorcls
                   ,    min(a.snglcalcscorcls  )     AS snglcalcscorcls
                   ,    min(a.grupearncls  )         AS grupearncls
                   ,    min(a.snglearncls  )         AS snglearncls
                   ,    min(a.ordqty  )              AS ordqty
                   ,    min(a.ordtims  )             AS ordtims
                   ,    min(a.orddays  )             AS orddays
                   ,    min(a.calcqty  )             AS calcqty
                   ,    min(a.calctims )             AS calctims
                   ,    min(a.calcdays  )            AS calcdays
                   ,    min(a.matractflag )          AS matractflag
                   ,    min(a.calcpayflag )          AS calcpayflag
                   ,    min(a.prcppayflag )          AS prcppayflag
                   ,    min(a.calcscorpayflag  )     AS calcscorpayflag
                   ,    min(a.ansttm   )             AS ansttm
                   ,    min(a.spccd    )             AS spccd
                   ,    min(a.pntunitcost  )         AS pntunitcost
                   ,    min(a.calcscorpnt  )         AS calcscorpnt
                   ,    min(a.estmpnt    )           AS estmpnt
                   ,    min(a.calcamt    )           AS calcamt
                   ,    min(a.hospaddamt  )          AS hospaddamt
                   ,    min(a.specamt   )            AS specamt
                   ,    min(a.payamt    )            AS payamt
                   ,    min(a.allownbamt )           AS allownbamt
                   ,    min(a.nopyamt    )           AS nopyamt
                   ,    min(a.payownbrate  )         AS payownbrate_org
                   ,    min(a.payinsubamt )          AS payinsubamt
                   ,    min(a.payownbamt  )          AS payownbamt
                   ,    min(a.paydiscamt  )          AS paydiscamt
                   ,    min(a.nopydiscamt )          AS nopydiscamt
                   ,    min(a.specdiscamt   )        AS specdiscamt
                   ,    min(a.hosoutexptresncd  )    AS hosoutexptresncd
                   ,    min(a.hosoutdrugno   )       AS hosoutdrugno
                   ,    min(a.specordyn   )          AS specordyn
                   ,    min(a.execdeptcd  )          AS execdeptcd
                   ,    min(a.execdd)                AS execdd
                   ,    min(a.exectm  )              AS exectm
                   ,    min(a.execrid  )             AS execrid
                   ,    min(a.pamexecdd   )          AS pamexecdd
                   ,    min(a.earnenddd   )          AS earnenddd
                   ,    min(a.actcnclresn )          AS actcnclresn
                   ,    min(a.clamspclcd  )          AS clamspclcd
                   ,    min(a.clamkey   )            AS clamkey
                   ,    min(a.clamcretdd   )         AS clamcretdd
                   ,    min(a.clamcretyn  )          AS clamcretyn
                   ,    min(a.estmcls  )             AS estmcls
                   ,    min(a.estmmeancd  )          AS estmmeancd
                   ,    min(a.estmcd  )              AS estmcd
                   ,    min(a.readdrid  )            AS readdrid
                   ,    min(a.clincstdyno  )         AS clincstdyno
                   ,    min(a.exitprvntdrugyn)       AS exitprvntdrugyn
                   ,    min(a.exitprvntdrugamt )     AS exitprvntdrugamt
                   ,    min(a.trustaddrate    )      AS trustaddrate
                   ,    min(a.bothaddyn  )           AS bothaddyn
                   ,    min(a.prcpdd   )             AS prcpdd
                   ,    min(a.prcpno   )             AS prcpno
                   ,    min(a.prcphistno )           AS prcphistno
                   ,    min(a.execprcpseqno  )       AS execprcpseqno
                   ,    min(a.cvrtinprcpdeptcd )     AS cvrtinprcpdeptcd
                   ,    min(a.cvrtinprcpdrid )       AS cvrtinprcpdrid
                   ,    min(a.rcptdd    )            AS rcptdd
                   ,    min(a.rcptno    )            AS rcptno
                   ,    min(a.rcptseqno  )           AS rcptseqno
                   ,    min(a.rcptexecdd )           AS rcptexecdd
                   ,    min(a.rcpttm  )              AS rcpttm
                   ,    min(a.fstrgstrid  )          AS fstrgstrid
                   ,    min(a.fstrgstdt    )         AS fstrgstdt
                   ,    min(a.lastupdtrid   )        AS lastupdtrid
                   ,    min(a.lastupdtdt    )        AS lastupdtdt
                   ,    min(decode( d.precureprcpflag , 'Y', '[선]' ,'') ||
                       (Select m.hngnm From pam.picmmech m
                                   where m.calcscorcd = a.snglcalcscorcd
                                     AND a.orddd BETWEEN  m.fromdd AND m.todd
                                     AND m.instcd = a.instcd)        )            AS snglcalcscorcdnm
                   ,    min(CASE a.grupcalcscorcd   WHEN a.snglcalcscorcd THEN ''
                                                                      ELSE 'G'
                                                                       END   )    AS grupflag
                   ,    min(a.specownbamt + a.allownownbamt + a.nopyownbamt + a.payownbamt )    AS ownbamt
                   ,    min(CASE a.matractflag  WHEN '0' THEN 'Y'
                                                     ELSE ' '
                                                      END                   )     AS outordyn
                   ,    min(CASE a.clincstdyno  WHEN ''  THEN ' '
                                                     WHEN '-'   THEN ' '
                                                     WHEN ' '   THEN ' '
                                                     WHEN '00'  THEN ' '
                                                     ELSE 'Y'
                                                      END                 )       AS clincstdyyn
                   ,     min(DECODE(d.prcphistcd, 'E',d.prcphistcd, d.prcpstatcd) )   AS execprcpstatcd
                   ,     min(d.prcphistcd) AS execprcphistcd
           FROM pam.paohoscl a LEFT OUTER JOIN emr.mmohoprc d on (d.pid = a.pid
                                                              AND d.orddd  = a.orddd
                                                              AND d.cretno = a.cretno
                                                              AND d.prcpdd = a.prcpdd
                                                              AND d.prcpno = a.prcpno
                                                              AND d.instcd = a.instcd
                                                              AND d.prcpflag IN ('1', '3')
                                                              AND d.tempprcpflag = 'N'
                                                              AND d.hscttempprcpflag = 'N'
                                                              AND d.prcphistcd in ('O','E'))
         WHERE a.pid             = #pid#
           AND a.orddd || a.cretno  in ('$otptkey$')  
           AND a.instcd          = #sessinstcd#                             
           AND a.calcstat        in ( 'R' , 'Y')
           AND a.SNGLCALCSCORCD not in ('AA157' , 'AA222', 'AA257')
           group by a.orddd  , a.prcpno , a.snglcalcscorcd , a.execprcpseqno , a.payownbamt, a.paydiscamt ,a.specdiscamt ,   A.nopyownbamt  , a.allownownbamt
          having count(a.prcpno) != 2
          
union ALL
 
 SELECT        decode(min(a.calcstat) , 'Y','삭제', '추가') as  hidden --진료비는 개념이 반대 
                   ,    min(a.payownbrate)       as payownbrate
                   ,    min(a.pid)                   AS pid
                   ,    min(a.orddd)                 AS orddd
                   ,    min(a.cretno)                AS cretno
                   ,    min(a.calcseqno)             AS calcseqno
                   ,    min(a.calcscorseqno)         AS calcscorseqno
                   ,    min(a.instcd)                AS instcd
                   ,    min(a.calcstat)              AS calcstat
                   ,    min(a.clamtrgtstat )         AS clamtrgtstat
                   ,    min(a.acptseqno )            AS acptseqno
                   ,    min(a.orddeptcd )            AS orddeptcd
                   ,    min(a.orddrid  )             AS orddrid
                   ,    min(a.mskind   )             AS mskind
                   ,    min(a.ordtype  )             AS ordtype
                   ,    min(a.grupcalcscorcd )       AS grupcalcscorcd
                   ,    min(a.snglcalcscorcd  )      AS snglcalcscorcd
                   ,    min(a.grupcalcscorcls )      AS grupcalcscorcls
                   ,    min(a.snglcalcscorcls  )     AS snglcalcscorcls
                   ,    min(a.grupearncls  )         AS grupearncls
                   ,    min(a.snglearncls  )         AS snglearncls
                   ,    min(a.ordqty  )              AS ordqty
                   ,    min(a.ordtims  )             AS ordtims
                   ,    min(a.orddays  )             AS orddays
                   ,    min(a.calcqty  )             AS calcqty
                   ,    min(a.calctims )             AS calctims
                   ,    min(a.calcdays  )            AS calcdays
                   ,    min(a.matractflag )          AS matractflag
                   ,    min(a.calcpayflag )          AS calcpayflag
                   ,    min(a.prcppayflag )          AS prcppayflag
                   ,    min(a.calcscorpayflag  )     AS calcscorpayflag
                   ,    min(a.ansttm   )             AS ansttm
                   ,    min(a.spccd    )             AS spccd
                   ,    min(a.pntunitcost  )         AS pntunitcost
                   ,    min(a.calcscorpnt  )         AS calcscorpnt
                   ,    min(a.estmpnt    )           AS estmpnt
                   ,    min(a.calcamt    )           AS calcamt
                   ,    min(a.hospaddamt  )          AS hospaddamt
                   ,    min(a.specamt   )            AS specamt
                   ,    min(a.payamt    )            AS payamt
                   ,    min(a.allownbamt )           AS allownbamt
                   ,    min(a.nopyamt    )           AS nopyamt
                   ,    min(a.payownbrate  )         AS payownbrate_org
                   ,    min(a.payinsubamt )          AS payinsubamt
                   ,    min(a.payownbamt  )          AS payownbamt
                   ,    min(a.paydiscamt  )          AS paydiscamt
                   ,    min(a.nopydiscamt )          AS nopydiscamt
                   ,    min(a.specdiscamt   )        AS specdiscamt
                   ,    min(a.hosoutexptresncd  )    AS hosoutexptresncd
                   ,    min(a.hosoutdrugno   )       AS hosoutdrugno
                   ,    min(a.specordyn   )          AS specordyn
                   ,    min(a.execdeptcd  )          AS execdeptcd
                   ,    min(a.execdd)                AS execdd
                   ,    min(a.exectm  )              AS exectm
                   ,    min(a.execrid  )             AS execrid
                   ,    min(a.pamexecdd   )          AS pamexecdd
                   ,    min(a.earnenddd   )          AS earnenddd
                   ,    min(a.actcnclresn )          AS actcnclresn
                   ,    min(a.clamspclcd  )          AS clamspclcd
                   ,    min(a.clamkey   )            AS clamkey
                   ,    min(a.clamcretdd   )         AS clamcretdd
                   ,    min(a.clamcretyn  )          AS clamcretyn
                   ,    min(a.estmcls  )             AS estmcls
                   ,    min(a.estmmeancd  )          AS estmmeancd
                   ,    min(a.estmcd  )              AS estmcd
                   ,    min(a.readdrid  )            AS readdrid
                   ,    min(a.clincstdyno  )         AS clincstdyno
                   ,    min(a.exitprvntdrugyn)       AS exitprvntdrugyn
                   ,    min(a.exitprvntdrugamt )     AS exitprvntdrugamt
                   ,    min(a.trustaddrate    )      AS trustaddrate
                   ,    min(a.bothaddyn  )           AS bothaddyn
                   ,    min(a.prcpdd   )             AS prcpdd
                   ,    min(a.prcpno   )             AS prcpno
                   ,    min(a.prcphistno )           AS prcphistno
                   ,    min(a.execprcpseqno  )       AS execprcpseqno
                   ,    min(a.cvrtinprcpdeptcd )     AS cvrtinprcpdeptcd
                   ,    min(a.cvrtinprcpdrid )       AS cvrtinprcpdrid
                   ,    min(a.rcptdd    )            AS rcptdd
                   ,    min(a.rcptno    )            AS rcptno
                   ,    min(a.rcptseqno  )           AS rcptseqno
                   ,    min(a.rcptexecdd )           AS rcptexecdd
                   ,    min(a.rcpttm  )              AS rcpttm
                   ,    min(a.fstrgstrid  )          AS fstrgstrid
                   ,    min(a.fstrgstdt    )         AS fstrgstdt
                   ,    min(a.lastupdtrid   )        AS lastupdtrid
                   ,    min(a.lastupdtdt    )        AS lastupdtdt
                   ,    min(decode( d.precureprcpflag , 'Y', '[선]' ,'') ||
                       (Select m.hngnm From pam.picmmech m
                                   where m.calcscorcd = a.snglcalcscorcd
                                     AND a.orddd BETWEEN  m.fromdd AND m.todd
                                     AND m.instcd = a.instcd)        )            AS snglcalcscorcdnm
                   ,    min(CASE a.grupcalcscorcd   WHEN a.snglcalcscorcd THEN ''
                                                                      ELSE 'G'
                                                                       END   )    AS grupflag
                   ,    min(a.specownbamt + a.allownownbamt + a.nopyownbamt + a.payownbamt )    AS ownbamt
                   ,    min(CASE a.matractflag  WHEN '0' THEN 'Y'
                                                     ELSE ' '
                                                      END                   )     AS outordyn
                   ,    min(CASE a.clincstdyno  WHEN ''  THEN ' '
                                                     WHEN '-'   THEN ' '
                                                     WHEN ' '   THEN ' '
                                                     WHEN '00'  THEN ' '
                                                     ELSE 'Y'
                                                      END                 )       AS clincstdyyn
                   ,     min(DECODE(d.prcphistcd, 'E',d.prcphistcd, d.prcpstatcd) )   AS execprcpstatcd
                   ,     min(d.prcphistcd) AS execprcphistcd
           FROM pam.paohoscl a LEFT OUTER JOIN emr.mmohoprc d on (d.pid = a.pid
                                                              AND d.orddd  = a.orddd
                                                              AND d.cretno = a.cretno
                                                              AND d.prcpdd = a.prcpdd
                                                              AND d.prcpno = a.prcpno
                                                              AND d.instcd = a.instcd
                                                              AND d.prcpflag IN ('1', '3')
                                                              AND d.tempprcpflag = 'N'
                                                              AND d.hscttempprcpflag = 'N'
                                                              AND d.prcphistcd in ('O','E'))
         WHERE a.pid             = #pid#
          AND a.orddd || a.cretno  in ('$otptkey$')  
           AND a.instcd         = #sessinstcd#               
           AND a.calcstat        in ( 'R' , 'Y')
           and a.SNGLCALCSCORCD in ('AA157' , 'AA222', 'AA257')
           group by a.orddd  , a.prcpno , a.snglcalcscorcd , a.execprcpseqno , a.payownbamt, a.paydiscamt ,a.specdiscamt ,   A.nopyownbamt  , a.allownownbamt
           having count(a.prcpno) != 2       
          )
          order by orddd , 1 desc , grupcalcscorcd , snglcalcscorcd
           ]]>         
    </statement> 

   <!-- 0원 수납 인터페이스  대상 otpt가져오기--> 
   <statement id="getIFOAmtZeroOtpt"><![CDATA[    
          SELECT 
                     pid           as  otpt_pid
                    ,orddd         as  otpt_orddd
                    ,cretno        as  otpt_cretno
                    ,calcbaseflag  as otpt_calcbaseflag
                    ,instcd        as  sessinstcd
                    ,'2'           as calcactflag
                    ,'-'           as  batchflag
                    ,'Y'           as calcflag
                    ,(select p.brthdd from pam.pmcmptbs p where p.pid = a.pid AND p.instcd =a.instcd and rownum = 1)   brthdd
                    ,(select p.rrgstno1 from pam.pmcmptbs p where p.pid = a.pid AND p.instcd =a.instcd and rownum = 1) rrgstno1
                    ,(select p.rrgstno2 from pam.pmcmptbs p where p.pid = a.pid AND p.instcd =a.instcd and rownum = 1) rrgstno2
                    ,'Y'           as calcyn
                    ,'Y'           as calcgubn
                    ,'Y'           as workgubn
                    ,'R'           as calcstat
                    ,a.*
            FROM pam.pmohotpt a                
           WHERE a.pid         = #pid#
                AND TRIM(TO_CHAR(a.orddd)) || '_' || TRIM(TO_CHAR(a.cretno))   in ('$otptkey$')  
                AND a.instcd     = #sessinstcd#
                AND a.histstat   != 'X'
           ]]>         
    </statement>

   <!-- 0원 수납 인터페이스  대상 otpt가져오기--> 
   <statement id="getIFOAmtZeroOscl"><![CDATA[  
		SELECT sum(payownbamt + nopyownbamt + allownownbamt + specownbamt) as oscl_ownamt
		  FROM pam.paohoscl a
		 WHERE a.pid = #pid#
		      AND TRIM(TO_CHAR(a.orddd)) || '_' || TRIM(TO_CHAR(a.cretno))   in ('$otptkey$')  
		      AND a.calcstat = 'R'
		      AND a.instcd = #sessinstcd#
     ]]>         
    </statement>

	<!-- 0원수납 대상 물리치료 리스트 가져오기 -->
   <statement id="getMjquList"><![CDATA[    
       SELECT a.* 
	     FROM pam.pmohmjqu a 
	   WHERE a.pid         = #pid# 
	        AND a.instcd     = #sessinstcd#
			AND a.acptdd    = #acptdd#
			AND a.grouppid = #grouppid# 
			AND a.histstat   = 'Y'
			AND a.rcptyn    ='N'
           ]]>
    </statement> 

	<!-- 0원 수납 인터페이스 - 0원수납 대상 테이블 종료처리 -->    
    <statement id="setOutOrdEndMjqu"><![CDATA[    
        UPDATE pam.pmohmjqu
			SET    rcptyn         = 'Y'
				    ,lastupdtrid    = #sessuserid#
                    ,lastupdtdt     = SYSTIMESTAMP
         WHERE pid        = #pid#
              AND instcd    = #sessinstcd#
			  AND orddd     = #orddd#
			  AND cretno    = #cretno#
    ]]>         
    </statement>

	<!-- 과거처방반환, 대체처방 내역 table 수납 여부 상태 처리  -->    
    <statement id="setOPCGStat"><![CDATA[    
        UPDATE pam.pmohopcg
			SET    rcptyn         = 'Y'
				    ,lastupdtrid    = #sessuserid#
                    ,lastupdtdt     = SYSTIMESTAMP
         WHERE pid        = #pid#
              AND instcd    = #sessinstcd#
			  AND orddd     = #orddd#
			  AND cretno    = #cretno#
    ]]>         
    </statement>
    
   <!-- 연속처방 수납대상 팝업 - 조회 -->
   <statement id="getPopupMjquList"><![CDATA[    
		SELECT 
		
		a.* 

        ,   COM.FN_ZS_GETDEPTNAME(a.instcd, a.orddeptcd, a.orddd) AS orddeptcdnm
        ,   COM.FN_ZS_GETUSERNM(a.orddrid, a.orddd) AS orddridnm
	    ,  'true'   AS  ckbox
		  FROM pam.pmohotpt a
		 WHERE a.histstat IN('R','T')
			  AND a.instcd = #sessinstcd#
			  AND (a.pid , a.orddd , a.cretno ) in ( SELECT m.pid , m.orddd ,m.cretno
																 FROM pam.pmohmjqu m
															   WHERE m.histstat  = 'Y'
																	AND m.instcd   = #sessinstcd#
																	AND m.pid       = #pid#
																	AND m.rcptyn   ='N'
															   )
		   ORDER BY a.orddd desc ,a.cretno
           ]]>
    </statement> 


   <!-- 환자별 중증 조회 -->
   <statement id="getSrdg"><![CDATA[    
        SELECT  pid                     AS srdg_pid
              , insukind                AS srdg_insukind                  
              , CASE WHEN rtrim(serdiagfromdd) = '00000000' THEN '0'   
                     WHEN rtrim(serdiagfromdd) IS NULL      THEN '0'   
                     WHEN rtrim(serdiagfromdd) = '-'        THEN '0'   
                     ELSE serdiagfromdd                      END                AS srdg_fromdd     --중증번호시작일자
              , CASE WHEN rtrim(serdiagtodd) = '00000000'   THEN '0'   
                     WHEN rtrim(serdiagtodd) IS NULL        THEN '0'   
                     WHEN rtrim(serdiagtodd) = '-'          THEN '0'   
                     ELSE serdiagtodd                             END           AS srdg_todd       --중증번호종료일자  
              , CASE WHEN rtrim(serdiagno) = '0000000000'   THEN '0' 
                     WHEN rtrim(serdiagno) = '0'            THEN '0' 
                     WHEN rtrim(serdiagno) = '-'            THEN '0'
                     WHEN rtrim(serdiagno) IS NULL          THEN '0'
                     WHEN rtrim(serdiagno) = '신청서작성'   THEN '0'
                     ELSE serdiagno                          END                AS srdg_seridiagno  --중증번호
              ,   anohosprgstflag         AS srdg_anohosprgstflag     --타병원등록구분
              ,   cncrdiagcnfmdd          AS srdg_cncrdiagcnfmdd      --암진단확정일
              ,   genrdd                  AS srdg_genrdd              --발생일자
              ,   signyn                  AS srdg_signyn              --서명여부
              ,   signdt                  AS srdg_signdt              --서명일시
         FROM (
           SELECT a.*
             FROM emr.mmohsdoa a
            WHERE a.pid        = #pid#
              AND a.instcd     = #sessinstcd# 
              AND a.histcd     = 'O'
              AND a.serdiagno != '-'
              AND #orddd# between a.serdiagfromdd AND a.serdiagtodd
            ]]>
            <isNotEqual property="checkflag" compare="1">
              AND a.insukind = #insukind#            
            </isNotEqual><![CDATA[    
     UNION ALL

           SELECT a.*
             FROM emr.mmohsdoa a
            WHERE a.pid       = #pid#
              AND a.instcd    = #sessinstcd# 
              AND a.histcd    = 'O'
              AND a.serdiagno in ('-' ,'0','0000000000',NULL)
              AND a.genrdd   <= #orddd#
            ]]>
            <isNotEqual property="checkflag" compare="1">
              AND a.insukind = #insukind#            
            </isNotEqual>

    )                    
    </statement> 

    <!-- 0원수납용 미수 수납내역 조회 -->
    <statement id="getuncoList2"><![CDATA[
	SELECT * FROM (
					 SELECT
							  unco.pid
							, unco.rcptdd
							, unco.rcptno
							, unco.rcptseqno
							, unco.seqno
							, unco.instcd
							, unco.rcptstat
							, unco.ordtype
							, unco.orddd
							, unco.cretno
							, unco.orddeptcd
							, unco.orddrid
							, unco.dschdd
							, unco.insukind
							, unco.suppkind
							, unco.uncorcptflag
							, unco.uncocls
							, unco.uncocd
							,(SELECT sum(b.uncoamt - b.rcptamt) as uncoamt FROM pam.pamhunco b 
							                                                                   WHERE unco.pid = b.pid 
																							        AND unco.orddd = b.orddd 
																									AND unco.orddeptcd = b.orddeptcd 
																									AND unco.uncocd = b.uncocd
																									AND unco.instcd = b.instcd)            AS UNCOAMT
							, unco.rcptamt
							, unco.debtamt
							, unco.endyn
							, unco.clincstdyno
							, unco.empid
							, unco.rcptexecdd
							, unco.rcpttm
							, unco.rcptrid
							, unco.apprsn
							, unco.remfact
							, unco.fstrgstrid
							, unco.fstrgstdt
							, unco.lastupdtrid
							, unco.lastupdtdt
					FROM  pam.pamhunco unco
					     ,pam.paohopmi opmi
				   WHERE opmi.pid          = #opmi_pid#      
					   AND opmi.orddd      = #opmi_orddd#      
					   AND opmi.cretno     = #opmi_cretno#   
					   AND opmi.instcd     = #sessinstcd#   
					   AND unco.pid        = opmi.pid
					   AND unco.rcptdd     = opmi.rcptdd
					   AND unco.rcptno     = opmi.rcptno
					   AND unco.rcptseqno  = opmi.rcptseqno
					   AND unco.instcd     = opmi.instcd
					   AND unco.rcptstat   = 'Y'
					   AND unco.uncorcptflag = 1
		   ) WHERE uncoamt != 0
      ]]>
    </statement>  

     <!-- 의사면허번호조회 -->    
     <statement id="getHospcd"><![CDATA[
		    SELECT proccorpcd || substr(to_char(sysdate,'YYYYMMDD'),3,4)  as hocm_mngtno_hosp
			  FROM pam.pmbmhosp h
			 WHERE instcd = #sessinstcd#  
			     AND to_char(sysdate,'YYYYMMDD') BETWEEN h.fromdd AND h.todd
			     AND rownum =1
      ]]>
     </statement> 

	<!-- 수납vip 대기자조회 -->
   <statement id="getVipStandList"><![CDATA[    
       SELECT 
               a.pid
               , (select p.hngnm from pam.pmcmptbs p where a.pid = p.pid AND p.instcd = a.instcd AND rownum =1)    AS hngnm
               , (select p.rrgstno1 || '-' || p.rrgstno2 from pam.pmcmptbs p where a.pid = p.pid AND p.instcd = a.instcd AND rownum =1)    AS rrgstno
               ,  COM.FN_ZS_GETDEPTNAME(a.instcd, a.orddeptcd, a.orddd) AS orddeptcdnm
               ,  COM.FN_ZS_GETUSERNM(a.orddrid, a.orddd) AS orddridnm
               ,a.orddd
               ,a.prcpgenryn
               , (select p.mpphontel from pam.pmcmptbs p where a.pid = p.pid AND p.instcd = a.instcd AND rownum =1)    AS mpphontel             
               , nvl((select sum(decode(rcptflag,'A41',cashamt + cardamt + onlineamt,'A42',cashamt + cardamt + onlineamt,'A43',cashamt + cardamt + onlineamt))
                        from pam.paohbogj b
                      where b.pid  = a.pid
                         and b.instcd = a.instcd) , 0)  as mdlrcptamt
                , disccd
                ,rcptvipresncd
                ,rcptvipetcresn
                ,cretno
                ,rcptdd
                ,rcptno
                ,rcptseqno
                ,  COM.FN_ZS_GETUSERNM(a.fstrgstrid, a.orddd) AS fstrgstrid
         FROM pam.pmohotpt a 
       WHERE a.instcd     = #sessinstcd#
            AND a.medamtpostyn = 'V'
            
            AND a.histstat  in ('R','T')
			AND rownum < 800
             ]]>
            <isNotEmpty property="pid">
              AND a.pid =#pid#   
            </isNotEmpty>
            <isEqual property="rcptyn" compare="N">
            AND a.calcflag != 'N'
            </isEqual>
            <isEqual property="pidyn" compare="N">
              AND a.orddd between #fromdd# and #todd#
            </isEqual>
            <isNotEqual property="orddeptcd" compare="all">
              AND a.orddeptcd = #orddeptcd#            
            </isNotEqual>
            <isNotEqual property="rcptvipresncd" compare="all">
              AND a.rcptvipresncd = #rcptvipresncd#            
            </isNotEqual>			
    </statement> 

     <!-- 당일 자격조회 유무 체크 -->    
     <statement id="getMmsg2Check"><![CDATA[
		    select a.*
			  from pam.pmcmmsg2 a,pam.pmcmptbs b
			where  b.instcd = #sessinstcd#
			   and b.pid     = #pid#
			   and b.rrgstno1 || b.rrgstno2 = a.rrgstno
			   and a.instcd = b.instcd
			   and a.datainptdt >= to_char(sysdate,'YYYYMMDD')
      ]]>
     </statement> 

   <!-- 연속처방 수납대상 팝업 - 처방리스트 -->
   <statement id="getPopupMjexList"><![CDATA[
		SELECT
				 a.pid                    as pid
				,a.bforddd              as orddd
				,a.bfcretno             as cretno
				,a.execprcpuniqno   as execprcpuniqno
				,(select e.calcscorcd 
					from emr.mmodexop e 
				  where e.instcd              = a.instcd 
					 and e.pid                  = a.pid 
					 and e.execprcpuniqno = a.execprcpuniqno 
					 and rownum               = 1) as calcscorcd
				,(select m.hngnm 
					 from pam.picmmech m
				   where m.calcscorcd = (select e.calcscorcd from emr.mmodexop e where e.instcd =a.instcd and e.pid = a.pid and e.execprcpuniqno = a.execprcpuniqno and rownum = 1)
					  and to_char(sysdate, 'yyyymmdd') between  m.fromdd and m.todd
					  and m.instcd = a.instcd
					  and rownum  = 1)  as calcscorcddnm
				,'→'             as stat
				,(select e.execprcphistcd 
					from emr.mmodexop e 
				  where e.instcd              = a.instcd 
					 and e.pid                  = a.pid 
					 and e.execprcpuniqno = a.execprcpuniqno 
					 and e.actorddd           = a.bforddd 
					 and rownum               = 1) as execprcphistcd
				,a.fstrgstdt    as fstrgstdt
				,a.aftorddd              as mvorddd
		  FROM pam.pmohmjex a 
		WHERE a.instcd = #sessinstcd#
		   AND (a.pid , a.bforddd , a.bfcretno ) in ( select m.pid , m.orddd ,m.cretno
																  from pam.pmohmjqu m
																 where m.histstat  = 'Y'
																	and m.instcd   = #sessinstcd#
																	and m.pid       = #pid#
																	and m.rcptyn   ='N')
			]]>
            <isEqual property="mjqu_stat" compare="R">
              AND (select t.histstat from pam.pmohotpt t where t.pid = a.pid and t.orddd = a.bforddd and t.cretno = a.bfcretno) in ('R','T')
            </isEqual>
            <isEqual property="mjqu_stat" compare="SELECT">
              AND a.bforddd = #mjqu_orddd#
			  AND a.bfcretno = #mjqu_cretno#
            </isEqual>			
			
			<![CDATA[

		UNION ALL

		SELECT
				 b.pid                    as pid
				,b.aftorddd             as orddd
				,b.aftcretno            as cretno
				,b.execprcpuniqno   as execprcpuniqno
				,(select e.calcscorcd 
					 from emr.mmodexop e 
				   where e.instcd              = b.instcd 
					  and e.pid                  = b.pid 
					  and e.execprcpuniqno = b.execprcpuniqno 
					  and rownum               = 1) as calcscorcd
				,(select m.hngnm 
					from pam.picmmech m
				  where m.calcscorcd = (select e.calcscorcd from emr.mmodexop e where e.instcd =b.instcd and e.pid = b.pid and e.execprcpuniqno = b.execprcpuniqno and rownum = 1)
					 and to_char(sysdate, 'yyyymmdd') between  m.fromdd and m.todd
					 and m.instcd = b.instcd
					 and rownum  = 1)  as calcscorcddnm
				,'←'             as stat
				,(select e.execprcphistcd 
					from emr.mmodexop e 
				  where e.instcd              = b.instcd 
					 and e.pid                  = b.pid 
					 and e.execprcpuniqno = b.execprcpuniqno 
					 and e.actorddd          = b.aftorddd 
					 and rownum              = 1) as execprcphistcd
				,b.fstrgstdt    as fstrgstdt
				,b.bforddd              as mvorddd
		  FROM pam.pmohmjex b 
		WHERE b.instcd = #sessinstcd#
		   AND (b.pid , b.aftorddd , b.aftcretno ) in ( select m.pid , m.orddd ,m.cretno
																	from pam.pmohmjqu m
																  where m.histstat  = 'Y'
																	 and m.instcd   = #sessinstcd#
																	 and m.pid       = #pid#
																	 and m.rcptyn   ='N')
		]]>
		<isEqual property="mjqu_stat" compare="R">
		  AND (select t.histstat from pam.pmohotpt t where t.pid = b.pid and t.orddd = b.aftorddd and t.cretno = b.aftcretno) in ('R','T')
		</isEqual>
		<isEqual property="mjqu_stat" compare="SELECT">
		  AND b.aftorddd = #mjqu_orddd#
		  AND b.aftcretno = #mjqu_cretno#
		</isEqual>	
		 ORDER BY orddd desc,mvorddd,stat desc ,execprcpuniqno
    </statement> 

     <!-- 연속처방 유무 체크 -->    
     <statement id="getChkOtptMJ"><![CDATA[
            SELECT a.pid,a.orddd,a.cretno
              FROM emr.mmodexop a
            WHERE a.pid     = #pid#
                 AND a.instcd = #instcd#
                 AND (a.pid , a.actorddd ,a.actcretno) in (
                                                                          SELECT b.pid , b.orddd , b.cretno
                                                                            FROM pam.pmohotpt b
                                                                           WHERE b.pid       = #pid#
                                                                                AND b.orddd   = #orddd#
                                                                                AND b.cretno  = #cretno#
                                                                                AND b.instcd   = #instcd#
                                                                                AND b.histstat in ('R','T')
                                                                                AND b.etcordflag in ('M','J'))
                 AND rownum = 1
      ]]>
     </statement> 

     <!-- 원무공통코드 (desc조회) -->    
     <statement id="getPmcmCode"><![CDATA[
       SELECT cdgrupid,cdid,cdnm 
         FROM pam.pmcmcode 
        WHERE detldesc = #detldesc#
          AND instcd   = #sessinstcd#
      ]]>
     </statement> 

     <!-- 원무공통코드 (cdid조회) -->    
     <statement id="getPmcmCodeNm">
       SELECT cdgrupid,cdid,cdnm,detldesc 
         FROM pam.pmcmcode 
        WHERE instcd     = #sessinstcd#
          <isNotEmpty property="cdgrupid">
            AND cdgrupid = #cdgrupid#
          </isNotEmpty><![CDATA[             
            AND cdid     like #cdid#
          ]]>
         order by cdgrupid,dispseq,cdid
     </statement> 

     <!-- ZBCMCODE 공통코드조회 -->    
     <statement id="getZbcmCode"><![CDATA[
          SELECT
                    code.cdgrupid,
                    code.cdid,
                    code.cdnm,
                    code.detldesc,
                    code.dispseq,
                    code.valifromdd as fromd,
                    code.valitodd    as todd
            FROM com.zbcmcode code
           WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN code.valifromdd AND code.valitodd
               AND code.cdgrupid = #cdgrupid#
            ]]>
            <isNotEmpty property="cdid"><![CDATA[
               AND code.cdid = #cdid#
             ]]>
            </isNotEmpty>
            ORDER BY cdgrupid,dispseq,cdid
     </statement> 

  	<!-- 1주일 이내 응급실 내원환자 체크 map : TRPAO00120
  	        AND  brateflag = 'O'  6시간 미만 내역 전현주 삭제 요청 -->     
    <statement id="getCheckERInfo">
    <![CDATA[
	SELECT *
	FROM
		(SELECT '[주과:' || (SELECT depthngnm FROM com.zsdddept WHERE deptcd = b.erorddeptcd AND orduseyn='Y' 
																										AND b.indd between valifromdd AND valitodd AND instcd = b.instcd AND rownum =1) 
				|| '] [부과:' ||
				(SELECT substr(max(sys_connect_by_path(erorddeptcd, '/')),2) as alias
	    		FROM ( SELECT rownum rnum,  (SELECT depthngnm FROM com.zsdddept WHERE deptcd = erorddeptcd AND orduseyn='Y' 
		    																													AND indd between valifromdd AND valitodd AND instcd = instcd AND rownum =1) as erorddeptcd 
					            FROM 
							            (SELECT c.erorddeptcd, c.indd, c.instcd 
								            FROM pam.pmihinpt a, emr.mnehercd c 
					            			WHERE a.pid =#pid#
					            			AND 		a.indd  >= to_char(sysdate - 7, 'YYYYMMDD') 
					            			AND 		a.instcd =#sessinstcd#
					            			AND 		a.histstat='Y' 
					            			AND 		a.ordtype ='E' 
					            			AND 		a.indschacptstat ='D' 
					            			AND 		a.pid = c.pid 
					            			AND 		a.indd = c.indd 
					            			AND 		a.cretno = c.cretno 
					            			AND 		a.instcd = c.instcd 
					            			AND 		c.histcd = 'O' 
					            			AND 		c.mainyn ='S'
					            			GROUP BY c.erorddeptcd, c.indd, c.instcd)
					            )
				start with rnum = 1
				connect by prior rnum = rnum - 1) || ']' as erorddeptcd,
		b.pid, 
		substr(b.indd, 1,4) || '년 ' || substr(b.indd, 5,2) || '월 ' || substr(b.indd, 7,2) || '일 'as orddd
		FROM pam.pmihinpt b
		WHERE b.pid =#pid#
		AND 		b.indd  >= to_char(sysdate - 7, 'YYYYMMDD')
		AND 		b.ordtype ='E' 
		AND 		b.instcd =#sessinstcd#
		AND 		b.histstat='Y'
		AND 		b.indschacptstat ='D'
		ORDER BY b.indd desc)
	WHERE rownum = 1
    ]]>  
    </statement>

 <!-- 검진환자조회 map : TRPAO00120 -->     
     <statement id="getCheckMediExamInfo">
        <![CDATA[
		  select * from (
		        SELECT a.pid as pid, 
		            b.hopedd as orddd,
		            a.histstat as histstat, 
		            a.rsrvflag as rsrvflag, 
		            b.statflag as statflag
		            
			  FROM  pam.pmohotpt a, 
						 ast.ahamacpt b
			  WHERE  a.pid = #pid#
			  AND   a.pid = b.pid
			  AND   a.orddd = b.orddd
			  AND   a.cretno = b.cretno
			  AND   a.instcd = #sessinstcd#
			  AND   a.instcd = b.instcd
			  AND   a.histstat = 'R'
			  AND   b.STATFLAG in ('E', 'G', 'H', 'I')
			  AND   a.ordtype = 'S'
			  order by hopedd desc
		)
		where rownum = 1
  
      ]]>   
    </statement>

     <!-- view인 대상 수가코드 체크[_,= 문자포함]  -->    
     <statement id="getViewCalcChk"><![CDATA[
	  SELECT *
		FROM emr.mmodexop
	  WHERE instcd       = #instcd#
		   AND pid          = #pid#
		   AND actorddd  = #orddd#
		   AND actcretno = #cretno#
		   AND execprcphistcd = 'O'
		   AND calcflag != 'N'
		   AND SUBSTR(calcscorcd,1,1) IN ('_','=') 
       ]]>
     </statement> 


	<!-- oscl이 Y인건 조회해서 R로 만든다 -->
   <statement id="setOsclY_dump"><![CDATA[    
                 INSERT INTO pam.paohoscl(
                         instcd
                        ,pid
                        ,orddd
                        ,cretno
                        ,calcseqno
                        ,calcscorseqno
                        ,calcstat
                        ,clamtrgtstat
                        ,acptseqno
                        ,orddeptcd
                        ,orddrid
                        ,mskind
                        ,ordtype
                        ,grupcalcscorcd
                        ,snglcalcscorcd
                        ,grupcalcscorcls
                        ,snglcalcscorcls
                        ,grupearncls
                        ,snglearncls
                        ,ordqty
                        ,ordtims
                        ,orddays
                        ,calcqty
                        ,calctims
                        ,calcdays
                        ,matractflag
                        ,calcpayflag
                        ,prcppayflag
                        ,calcscorpayflag
                        ,freeflag
                        ,opflag
                        ,ansttm
                        ,spccd
                        ,pntunitcost
                        ,calcscorpnt
                        ,estmpnt
                        ,appunitcost
                        ,estmamt
                        ,calcamt
                        ,hospaddamt
                        ,specamt
                        ,payamt
                        ,allownbamt
                        ,nopyamt
                        ,payownbrate
                        ,payinsubamt
                        ,payownbamt
                        ,paydiscamt
                        ,nopydiscamt
                        ,specdiscamt
                        ,hosoutexptresncd
                        ,hosoutdrugno
                        ,specordyn
                        ,execdeptcd
                        ,execdd
                        ,exectm
                        ,execrid
                        ,pamexecdd
                        ,earnenddd
                        ,actcnclresn
                        ,clamspclcd
                        ,clamkey
                        ,clamcretdd
                        ,clamcretyn
                        ,estmcls
                        ,estmmeancd
                        ,estmcd
                        ,readdrid
                        ,clincstdyno
                        ,exitprvntdrugyn
                        ,exitprvntdrugamt
                        ,trustaddrate
                        ,bothaddyn
                        ,prcpdd
                        ,prcpno
                        ,prcphistno
                        ,execprcpseqno
                        ,cnfmcd
                        ,cpflag
                        ,prnprcpflag
                        ,portprcpflag
                        ,anamneflag
                        ,spcljudgyn
                        ,judgflag
                        ,cvrtinprcpdeptcd
                        ,cvrtinprcpdrid
                        ,rcptdd
                        ,rcptno
                        ,rcptseqno
                        ,rcptexecdd
                        ,rcpttm
                        ,judgadjtresncd
                        ,probordyn
                        ,nopyinsubamt
                        ,nopyownbamt
                        ,allowninsubamt
                        ,allownownbamt
                        ,specinsubamt
                        ,specownbamt
                        ,judgendflag
                        ,tootfact
                        ,drugmthdspccd
                        ,rgstdeptcd
                        ,rgstdd
                        ,rgsttm
                        ,rgstrid
                        ,insukind
                        ,suppkind
                        ,rsvordgubn
                        ,brateflag
                        ,ownbflag
                        ,tranflag
                        ,edicd
                        ,fstrgstrid
                        ,fstrgstdt
                        ,lastupdtrid
                        ,lastupdtdt
                        ,centcd
                        ,subdeptcd
                        ,coopteamcd
                        ,execprcpuniqno
                         )  
                SELECT                 
                        instcd                                                                                                                                                              
                        ,pid                                                                                                                                                         
                        ,orddd                                                                                                                                                    
                        ,cretno                                                                                                                                                   
                        ,CAST(calcseqno+ 1 AS NUMBER)      AS calcseqno         
                        ,calcscorseqno                                                                                                                                        
                        ,'R'                                               AS calcstat                          
                        ,clamtrgtstat                                                                                                                                              
                        ,acptseqno                                                                                                                                                 
                        ,orddeptcd                                                                                                                                                
                        ,orddrid                                                                                                                                                 
                        ,mskind                                                                                                                                                  
                        ,ordtype                                                                                                                                                 
                        ,grupcalcscorcd                                                                                                                                      
                        ,snglcalcscorcd                                                                                                                                       
                        ,grupcalcscorcls                                                                                                                                      
                        ,snglcalcscorcls                                                                                                                                         
                        ,grupearncls                                                                                                                                             
                        ,snglearncls                                                                                                                                              
                        ,ordqty                                                                                                                                                   
                        ,ordtims                                                                                                                                                  
                        ,orddays                                                                                                                                                  
                        ,calcqty                                                                                                                                                  
                        ,calctims                                                                                                                                                 
                        ,calcdays                                                                                                                                                  
                        ,matractflag                                                                                                                                              
                        ,calcpayflag                                                                                                                                             
                        ,prcppayflag                                                                                                                                              
                        ,calcscorpayflag                                                                                                                                      
                        ,freeflag                                                                                                                                                 
                        ,opflag                                                                                                                                                   
                        ,ansttm                                                                                                                                                   
                        ,spccd                                                                                                                                                   
                        ,pntunitcost                                                                                                                                              
                        ,calcscorpnt                                                                                                                                              
                        ,estmpnt                                                                                                                                                  
                        ,appunitcost                                                                                                                                             
                        ,estmamt                                                                                                                                                   
                        ,calcamt                                                                                                                                                 
                        ,hospaddamt                                                                                                                                          
                        ,specamt                                                                                                                                                 
                        ,payamt                                                                                                                                                   
                        ,allownbamt                                                                                                                                               
                        ,nopyamt                                                                                                                                                   
                        ,payownbrate                                                                                                                                           
                        ,payinsubamt                                                                                                                                           
                        ,payownbamt                                                                                                                                           
                        ,paydiscamt                                                                                                                                                
                        ,nopydiscamt                                                                                                                                          
                        ,specdiscamt                                                                                                                                         
                        ,hosoutexptresncd                                                                                                                                     
                        ,hosoutdrugno                                                                                                                                         
                        ,specordyn                                                                                                                                                 
                        ,execdeptcd                                                                                                                                           
                        ,execdd                                                                                                                                                    
                        ,exectm                                                                                                                                                   
                        ,execrid                                                                                                                                                  
                        ,pamexecdd                                                                                                                                            
                        ,(CASE WHEN earnenddd = '00000000' THEN earnenddd ELSE TO_CHAR(SYSDATE, 'YYYYMMDD') END)               AS earnenddd                  
                        ,actcnclresn                                                                                                      
                        ,clamspclcd                                                                                                        
                        ,clamkey                                                                                                            
                        ,clamcretdd                                                                                                        
                        ,clamcretyn                                                                                                        
                        ,estmcls                                                                                                            
                        ,estmmeancd                                                                                                    
                        ,estmcd                                                                                                            
                        ,readdrid                                                                                                          
                        ,clincstdyno                                                                                                      
                        ,exitprvntdrugyn                                                                                                  
                        ,exitprvntdrugamt                                                                                              
                        ,trustaddrate                                                                                                      
                        ,bothaddyn                                                                                                        
                        ,prcpdd                                                                                                           
                        ,prcpno                                                                                                            
                        ,prcphistno                                                                                                        
                        ,execprcpseqno                                                                                                 
                        ,cnfmcd                                                                                                            
                        ,cpflag                                                                                                           
                        ,prnprcpflag                                                                                                       
                        ,portprcpflag                                                                                                      
                        ,anamneflag                                                                                                       
                        ,spcljudgyn                                                                                                       
                        ,judgflag                                                                                                          
                        ,cvrtinprcpdeptcd                                                                                              
                        ,cvrtinprcpdrid                                                                                                    
                        ,'-'                                 AS rcptdd                                                                                                             
                        ,0                                   AS rcptno                                                                                                             
                        ,0                                   AS rcptseqno                                                                                                          
                        ,'-'                                 AS rcptexecdd                                                                                                     
                        ,rcpttm                                                                                                           
                        ,judgadjtresncd                                                                                                     
                        ,probordyn                                                                                                         
                        ,nopyinsubamt                                                                                                 
                        ,nopyownbamt                                                                                                    
                        ,allowninsubamt                                                                                                 
                        ,allownownbamt                                                                                                
                        ,specinsubamt                                                                                                   
                        ,specownbamt                                                                                                  
                        ,judgendflag                                                                                                      
                        ,tootfact                                                                                                          
                        ,drugmthdspccd                                                                                                  
                        ,rgstdeptcd                                                                                                        
                        ,rgstdd                                                                                                           
                        ,rgsttm                                                                                                             
                        ,rgstrid                                                                                                                
                        ,insukind                                                                                                          
                        ,suppkind                                                                                                          
                        ,rsvordgubn                                                                                                        
                        ,brateflag                                                                                                         
                        ,ownbflag                                                                                                           
                        ,tranflag                                                                                                          
                        ,edicd                                                                                                             
                        ,fstrgstrid                                                                                                             
                        ,fstrgstdt                                                                                                         
                        ,lastupdtrid                                        AS lastupdtrid
                        ,lastupdtdt                                       AS lastupdtdt                                                                                                                           
                        ,centcd
                        ,subdeptcd
                        ,coopteamcd
                        ,execprcpuniqno         
                    FROM pam.paohoscl
                   WHERE pid      = #pid#                    
                     AND orddd     = #orddd#
                     AND cretno    = #cretno#
                     AND calcstat  = 'Y'
                     AND calcseqno < 100
                     AND instcd    = #sessinstcd#
           ]]>
    </statement>

	<!-- 실시정산 테이블 입력 -->
    <statement id="setOutOrdActr"><![CDATA[    
        INSERT INTO pam.pmohactr (   
                          instcd
                        , pid
                        , actfromdd
                        , orddd
                        , cretno
                        , seqno
                        , histstat
                        , calcbaseflag
                        , insukind
                        , suppkind
                        , ordtype
                        , fstacptid
                        , fstacptdt
                        , handicaprbookpossnyn
                        , remfact
                        , ownbflag
                        , rareobstflag
                        , fstrgstrid
                        , fstrgstdt
                        , lastupdtrid
                        , lastupdtdt 
                    
                    ) VALUES(
                    
                           #actr_instcd#
                        ,  #actr_pid#
                        ,  #actr_actfromdd#
                        ,  #actr_orddd#
                        ,  #actr_cretno#

					   ,(SELECT nvl(max(seqno),0) + 1
						   FROM pam.pmohactr a
						  WHERE a.pid     = #actr_pid#
							AND a.instcd  = #actr_instcd#
							AND a.orddd   = #actr_orddd#
							AND a.cretno  = #actr_cretno#
						 )

                        ,  #actr_histstat#
                        ,  #actr_calcbaseflag#
                        ,  #actr_insukind#
                        ,  #actr_suppkind#
                        ,  #actr_ordtype#
                        ,  #actr_fstacptid#
                        ,  #actr_fstacptdt#
                        ,  #actr_handicaprbookpossnyn#
                        ,  #actr_remfact#
                        ,  #actr_ownbflag#
                        ,  #actr_rareobstflag#
                        ,  #actr_fstrgstrid#
                        ,  SYSTIMESTAMP
                        ,  #actr_lastupdtrid#
                        ,  SYSTIMESTAMP
                    )
           ]]>
     </statement> 
	 <!-- #actr_seqno# -->


     <!-- 실시정산 테이블 삭제  -->    
     <statement id="delOutOrdActr"><![CDATA[
        UPDATE pam.pmohactr
           SET histstat = 'N'
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP 
         WHERE pid   = #actr_pid# 
           AND orddd = #actr_orddd#
           AND cretno = #actr_cretno#
           AND instcd = #sessinstcd#
      ]]>
     </statement> 
	 <!--
	  DELETE FROM pam.pmohactr 
       WHERE pid   = #actr_pid# 
         AND orddd = #actr_orddd#
         AND cretno = #actr_cretno#
         AND instcd = #sessinstcd#
	  -->


     <!-- 실시정산 대상환자 조회 --> 
     <statement id="getPopupActrList"><![CDATA[    
        SELECT                
               COM.FN_ZS_GETDEPTNAME(a.instcd, a.orddeptcd, a.orddd) AS orddeptcdnm
              ,COM.FN_ZS_GETUSERNM(a.orddrid, a.orddd) AS orddridnm
              ,#ckbox#                                 AS ckbox
              ,a.*
          FROM pam.pmohotpt a
         WHERE a.instcd = #sessinstcd#
           AND a.pid    = #pid#
           -- AND a.orddd between '20081003' and '20090630'
           AND a.orddd between '20081003' and '20091130'
           AND a.histstat in ('R','T')
		   AND a.insukind = '11'
		   -- AND a.suppkind in ('00','02','03','04','07')
		   AND a.suppkind in ('06', '11', '38', '40')
           AND exists (SELECT e.*
                         FROM emr.mmodexop e
                        WHERE e.instcd    = a.instcd
                          AND e.pid       = a.pid
                          AND e.actorddd  = a.orddd
                          AND e.actcretno = a.cretno
                          -- AND e.execdd >= '20090701'
                          AND e.execdd >= '20091201'
                          AND e.execprcphistcd ='O'
                          AND e.calcscorcd != 'ACD0002'
                        )

           AND not exists (SELECT e.*
                         FROM emr.mmodexop e
                        WHERE e.instcd    = a.instcd
                          AND e.pid       = a.pid
                          AND e.actorddd  = a.orddd
                          AND e.actcretno = a.cretno
                          AND e.execprcphistcd ='O'
                          AND substr(e.calcscorcd,1,1) = '_'
                        )

           AND 'Y' = (SELECT c.cdnm FROM PAM.pmcmcode c where c.cdgrupid ='P0068' AND c.cdid ='20' AND c.instcd = a.instcd AND rownum = 1)
		   AND a.calcbaseflag ='1'
     ]]>
    </statement> 


     <!-- 실시정산 대상환자 팝업 - 처방리스트 --> 
     <statement id="getPopupActrExopList"><![CDATA[ 
      SELECT 
            (select m.hngnm 
                 from pam.picmmech m
               where m.calcscorcd = (select e.calcscorcd from emr.mmodexop e where e.instcd =a.instcd and e.pid = a.pid and e.execprcpuniqno = a.execprcpuniqno and rownum = 1)
                  and to_char(sysdate, 'yyyymmdd') between  m.fromdd and m.todd
                  and m.instcd = a.instcd
                  and rownum  = 1)  as calcscorcddnm
               ,a.*
          FROM emr.mmodexop a
         WHERE a.instcd    = #sessinstcd#
           AND a.pid       = #pid#
           AND a.actorddd  = #orddd#
           AND a.actcretno = #cretno#
           AND a.execprcphistcd = 'O'
		 order by a.execdd,a.prcpno
     ]]>
    </statement>

     <!-- 성가병원 예방접종미수 체크 
	     SELECT sum(b.cdnm) as discamt
        FROM pam.paohoscl a,pam.pmcmcode b
       WHERE a.pid      = #pid#
         AND a.instcd   = #sessinstcd#
		 AND a.orddd    = #orddd#
		 AND a.cretno   = #cretno#
         AND a.calcstat = decode(#calcflag# ,'N','Y','R')
         AND a.insukind != '61'
         AND b.cdgrupid = 'P0072'
		 AND a.instcd   = b.instcd
         AND a.snglcalcscorcd = b.cdid
         AND a.orddd between b.fromdd and b.todd
         --> 
     <statement id="getPrvntMedc"><![CDATA[ 
        SELECT calcownbamt, discamt, ownbamt, floor((ownbamt * z.reduamt) / 10) * 10 AS reduamt
		FROM (
		SELECT 
		nvl(sum(a.payownbamt + a.nopyownbamt + a.allownownbamt + a.specownbamt), 0) AS calcownbamt, 
		nvl(sum(b.cdnm), 0) AS discamt,
		nvl(sum(a.payownbamt + a.nopyownbamt + a.allownownbamt + a.specownbamt) - sum(b.cdnm), 0) AS ownbamt,
		nvl(max((SELECT c.outnopyapprate * 0.01 
						FROM pam.pmbmdcuc c 
						WHERE c.discuncoflag = 'D' 
						AND c.discuncocd = #disccd#
						AND c.instcd = #sessinstcd# 
						AND histstat ='Y' 
						AND a.orddd BETWEEN c.fromdd AND c.todd 
						AND rownum = 1)), 0) AS reduamt
		FROM pam.paohoscl a,pam.pmcmcode b
		WHERE a.pid      = #pid#
		AND a.instcd   = #sessinstcd#
		AND a.orddd    = #orddd#
		AND a.cretno   = #cretno#
		AND a.calcstat = decode(#calcflag# ,'N','Y','R')
		AND a.insukind != '61'
		AND b.cdgrupid = 'P0072'
		AND a.instcd   = b.instcd
		AND a.snglcalcscorcd = b.cdid
		AND a.orddd between b.fromdd and b.todd
		--20121228 원무 이선희 선생님 요청으로 12세 미만까지만 적용되도록 수정
        AND (SELECT to_number(com.FN_ZZ_GETAGE(p.rrgstno1,p.rrgstno2, TO_CHAR(SYSDATE, 'YYYYMMDD'),'A',p.brthdd)) AS  age FROM pam.pmcmptbs p WHERE p.pid =a.pid AND p.instcd = a.instcd) < to_number(b.remark)
        ) z

     ]]>
    </statement>
    
    <!-- 선천성대사이상검사 선천성대사이상 [inborn errors of metabolism] 미수 평생1회  -->
    <statement id="getInbornError"><![CDATA[ 
        SELECT calcownbamt, discamt, ownbamt, floor((ownbamt * z.reduamt) / 10) * 10 AS reduamt
		FROM (
		SELECT 
		nvl(sum(a.payownbamt + a.nopyownbamt + a.allownownbamt + a.specownbamt), 0) AS calcownbamt, 
		nvl(max(b.cdnm), 0) AS discamt,
		nvl(sum(a.payownbamt + a.nopyownbamt + a.allownownbamt + a.specownbamt) - max(b.cdnm), 0) AS ownbamt,
		nvl(max((SELECT c.outnopyapprate * 0.01 
						FROM pam.pmbmdcuc c 
						WHERE c.discuncoflag = 'D' 
						AND c.discuncocd = #disccd#
						AND c.instcd = #sessinstcd# 
						AND histstat ='Y' 
						AND a.orddd BETWEEN c.fromdd AND c.todd 
						AND rownum = 1)), 0) AS reduamt
		FROM pam.paohoscl a,pam.pmcmcode b
		WHERE a.pid      = #pid#
		AND a.instcd   = #sessinstcd#
		AND a.orddd    = #orddd#
		AND a.cretno   = #cretno#
		AND a.calcstat = decode(#calcflag# ,'N','Y','R')
		AND a.insukind != '61'
		AND b.cdgrupid = 'P0104'
		AND a.instcd   = b.instcd
		--AND a.grupcalcscorcd = b.cdid
		AND a.snglcalcscorcd = b.cdid
		AND a.orddd between b.fromdd and b.todd
        AND  NOT EXISTS(		--평생 1번 체크 미수내역을 체크함.
     						SELECT 'X'
     						FROM		PAM.PAMHUNCO unco, pam.pmcmcode cd
     						WHERE	unco.INSTCD = A.INSTCD
     						AND      unco.PID = A.PID
     						AND		( unco.RCPTSTAT = 'Y' OR (unco.ENDYN = 'Y' AND unco.RCPTSTAT IN ('C', 'D', 'Y')) )
     						AND		unco.UNCOCD = cd.CDNM
     						AND		cd.CDID = '10'
     						AND		cd.cdgrupid = 'P0104'
        				)
        ) z

     ]]>
    </statement>
    
    <!-- 타과 유형변경 관련 otpt 조회 -->    
	<statement id="getOrdOTPTRef"><![CDATA[
    SELECT * 
    FROM pam.pmohotpt 
    WHERE instcd = #sessinstcd# 
    AND pid    = #pid#
    AND orddd  = #orddd#
	AND histstat in ('R','T')
	AND ordtype = 'O'
	AND insukind ='11'
--	AND suppkind in ('02','03','04','34','35','36')
    ]]>
    </statement> 

    <!-- 장애인수첩소지여부 체크-->
    <statement id="getHndcCnt"><![CDATA[   
        SELECT 
            a.*
          FROM pam.pmcmhndc a
         WHERE a.pid      = #pid# 
           AND a.instcd   = #sessinstcd#
           AND a.histstat = 'Y'
           AND TO_CHAR(sysdate,'YYYYMMDD') between a.fromdd and a.todd
    ]]>
    </statement>

    <!-- 미수 입금여부 체크-->
    <statement id="getUncoStatYCnt"><![CDATA[    
     SELECT count(*) as cnt
       FROM pam.paohopmi a
      WHERE a.pid        = #opmi_pid#
        AND a.instcd     = #sessinstcd#
        AND a.rcptstat   = 'Y' 
        AND a.orddd      = #opmi_orddd#
        AND a.cretno     = #opmi_cretno#
		AND a.uncorcptflag in ('2','3','4')
	]]>
    </statement> 

    <!-- 수납할 재증명 유무 체크 -->
    <statement id="getChkCertList"><![CDATA[    
		SELECT *
		  FROM emr.mmrmprofcert
		 WHERE instcd = #sessinstcd#
		   AND fstrgstdt >= to_date(TO_CHAR(sysdate,'YYYYMMDD'), 'YYYYMMDD')
		   AND issflag = 10                   -- 발급안된것
		   AND deluserid IS NULL              -- 삭제되지 않은것
		   AND deldt IS NULL                  -- 삭제되지 않은것
		   AND issstat = 'I'                  -- 인증저장
		   AND pid = #pid#
	]]>
    </statement> 


   <!-- 수납시 ONLN 통장입금액 CD생성 --> 
   <!-- TXPAO00102 -->
   <statement id="insOnlnAmtDC"><![CDATA[    
          INSERT INTO pam.pachonln (   
                          pid
						, orddd
						, cretno
                        , rcptdd
                        , rcptno
                        , rcptseqno
                        , seqno
                        , instcd
                        , rcptstat
                        , ordtype
                        , onlineamt
                        , bankcd
                        , acntno
                        , paydd
                        , paypsnnm
                        , rcptexecdd
                        , rcpttm
                        , rcptrid
                        , preamtyn
                        , innrtretyn
                        , remfact
                        , fstrgstrid
                        , fstrgstdt
                        , lastupdtrid
                        , lastupdtdt
                    )  
                 SELECT                  
                          onln.pid
						, onln.orddd
						, onln.cretno
                        , onln.rcptdd
                        , onln.rcptno
                        , CAST(onln.rcptseqno+100 AS  NUMBER)
                        , onln.seqno
                        , onln.instcd
                        , 'D'
                        , onln.ordtype
						 ]]>
						<isEqual property="otpt_histstat" compare="R"><![CDATA[
                        , CAST(onln.onlineamt * -1 AS NUMBER(10,0)) 
                        ]]>
                        </isEqual>
                        <isEqual property="otpt_histstat" compare="X"><![CDATA[
						, #opmi_onlineamt#
                        ]]>
                        </isEqual><![CDATA[

                        , onln.bankcd
                        , onln.acntno
                        , onln.paydd
                        , onln.paypsnnm
                        ,  CAST(#opmi_rcptexecdd# AS VARCHAR2(8))
                        ,  CAST(#opmi_rcpttm#     AS VARCHAR2(6))
                        ,  CAST(#opmi_rcptrid#    AS VARCHAR2(10)) 
                        , onln.preamtyn
                        , 'Y'
                        , onln.remfact
                        , #sessuserid#
                        , SYSTIMESTAMP
                        , #sessuserid# 
                        , SYSTIMESTAMP
            FROM pam.pachonln onln
                ,pam.paohopmi opmi          
            WHERE opmi.pid       = #opmi_pid#     
              AND opmi.orddd     = #opmi_orddd#   
              AND opmi.cretno    = #opmi_cretno#  
              AND opmi.instcd    = #sessinstcd#       
              AND onln.pid       = opmi.pid       
              AND onln.rcptdd    = opmi.rcptdd    
              AND onln.rcptno    = opmi.rcptno    
              AND onln.rcptseqno = opmi.rcptseqno 
              AND onln.instcd    = opmi.instcd    
              AND onln.rcptstat  = 'Y'          
          ]]>
    </statement> 

   <!-- 수납시 ONLN 통장입금액 CD생성 --> 
   <!-- TXPAO00102 -->	
   <statement id="setOnlnAmtC"><![CDATA[    
        UPDATE pam.pachonln
           SET rcptstat ='C'
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP
         WHERE (pid , rcptdd, rcptno, rcptseqno, instcd) IN
                    (SELECT opmi.pid            AS pid
                           ,opmi.rcptdd         AS rcptdd
                           ,opmi.rcptno         AS rcptno
                           ,opmi.rcptseqno      AS rcptseqno
                           ,opmi.instcd         AS instcd
                       FROM pam.paohopmi opmi
                           ,pam.pachonln onln
                      WHERE opmi.pid        = #opmi_pid#
                        AND opmi.orddd      = #opmi_orddd#
                        AND opmi.cretno     = #opmi_cretno#
                        AND opmi.instcd     = #sessinstcd# 
                        AND onln.pid        = opmi.pid
                        AND onln.rcptdd     = opmi.rcptdd
                        AND onln.rcptno     = opmi.rcptno
                        AND onln.rcptseqno  = opmi.rcptseqno
                        AND onln.instcd     = opmi.instcd
                        AND onln.rcptstat  = 'Y'
                     )   
           ]]>
    </statement> 
	<!-- 외국인 환자 일 경우 국가코드 체크 oecd --> 
   <statement id="getPatOectChk"><![CDATA[    
	SELECT a.pid, b.oecdyn, '[' || b.naticd ||'.' || b.natinm || ']' AS natinm
	FROM pam.pmcmptbs a, pam.pmcmntmg b 
	WHERE a.pid = #pid#
	AND a.instcd = b.instcd
	AND a.nati = b.naticd
	AND b.histstat = 'Y'
	    ]]>
    </statement> 


    <!-- 진료의뢰내역 조회 -->
     <statement id="getCNST1">
        <![CDATA[
        SELECT pid AS cnst_pid,	
					 orddeptcd AS cnst_orddeptcd,	
					 insuflag AS cnst_insuflag,	
					 ordreqkind AS cnst_ordreqkind,	
					 todd AS cnst_todd,	
					 seqno AS cnst_seqno,	
					 instcd AS cnst_instcd,	
					 histstat AS cnst_histstat,	
					 fromdd AS cnst_fromdd,	
					 reqformhospnm AS cnst_reqformhospnm,
					 reqformdrnm AS cnst_reqformdrnm,
					 remfact AS cnst_remfact,
					 fstrgstrid AS cnst_fstrgstrid,	
					 fstrgstdt AS cnst_fstrgstdt,	
					 lastupdtrid AS cnst_lastupdtrid,	
					 lastupdtdt AS cnst_lastupdtdt
		FROM    pam.pmcmcnst
		WHERE  pid          = #pid#
		AND		 to_char(sysdate, 'YYYYMMDD') BETWEEN fromdd and todd
		AND	  	 instcd = #%dutplceinstcd# 
		AND       histstat    = 'Y'
        ]]>                    
    </statement>

    <!-- 원외처방전조회 -->
     <statement id="getHosoOutOrderList"><![CDATA[
		SELECT  drug.drugdd
			   ,drug.drugno
			   ,drug.prntdt
		  FROM pam.pmohotpt otpt, 
			   ast.adtddrug drug 
		 WHERE otpt.instcd    = #sessinstcd# 
		   AND otpt.pid       = #pid#
		   AND otpt.orddd     = #orddd#
		   AND otpt.cretno    = #cretno#
		   AND otpt.histstat  = 'R'
		   AND otpt.calcflag  = 'N'
		   AND drug.instcd    = otpt.instcd
		   AND drug.pid       = otpt.pid
		   AND drug.orddd     = otpt.orddd
		   AND drug.cretno    = otpt.cretno
		   AND drug.drugflag  = 'Y'	
		 ORDER BY drugno desc
        ]]>			
    </statement>
    
   <!-- TXPAO00112 타병원 투석 처리 -->
   <statement id="setSuppkindsubyn"><![CDATA[
        UPDATE pam.pmohotpt
           SET suppkindsubyn = 'Y'
              ,lastupdtrid   = #sessuserid#
              ,lastupdtdt    = SYSTIMESTAMP
        WHERE pid    = #pid#
          AND orddd  = #orddd#
          AND cretno = #cretno#
          AND instcd = #sessinstcd#
          AND histstat in ('R','T')
    ]]>
    </statement>

    <!-- 처방특진여부 N으로 변경 20110401 cys -->
    <statement id="setChngSpecN"><![CDATA[    
        UPDATE emr.mmohoprc
           SET choiordflag = '-'
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP 
         WHERE pid               = #prcp_pid#
           AND prcpdd            = #prcp_prcpdd#
           AND prcpno            = #prcp_prcpno#
           AND prcphistcd        = 'O'
           AND prcpcd            = #prcp_calcscorcd#
           AND instcd            = #sessinstcd#
           AND choiordflag       = 'Y'
           ]]>         
    </statement> 

    <!-- 처방특진여부 원복 20110401 cys -->
    <statement id="setChngSpecR"><![CDATA[    
        UPDATE emr.mmohoprc
           SET choiordflag = 'Y'
              ,lastupdtrid = #sessuserid#
              ,lastupdtdt  = SYSTIMESTAMP 
         WHERE pid               = #prcp_pid#
           AND prcpdd            = #prcp_prcpdd#
           AND prcpno            = #prcp_prcpno#
           AND prcphistcd        = 'O'
           AND prcpcd            = #prcp_calcscorcd#
           AND instcd            = #sessinstcd#
           AND choiordflag       = '-'
           ]]>         
    </statement>

    <!-- 특진여부 원복시 취소대장 삭제20110415 cys -->
    <statement id="setDelSpltList1"><![CDATA[    
        UPDATE pam.paohsplt a
           SET a.histstat     = 'X'
              ,a.lastupdtrid  = #sessuserid#
              ,a.lastupdtdt   = SYSTIMESTAMP  
         WHERE a.instcd = #sessinstcd#
           AND a.pid    = #prcp_pid#
           AND a.orddd  = #prcp_actorddd#
           AND a.histstat = 'Y'
           AND exists (select * 
                         from emr.mmohoprc p
                        where p.instcd = a.instcd
                          and p.pid    = a.pid
                          and p.orddd  = a.orddd
                          and p.prcpdd = a.prcpdd
                          and p.prcpno = a.prcpno
                          and p.choiordflag = 'Y'
                          and p.prcphistcd  = 'O')


    ]]>         
    </statement> 

    <!-- 재활의학과 미예약환자 경고메세지 체크 20110426 cys -->    
    <statement id="getChkEtcM"><![CDATA[
       SELECT exop.actorddd
             ,oprc.prcpdd
         FROM emr.mmohoprc oprc
            , emr.mmodexop exop
        WHERE  oprc.instcd    = #sessinstcd#
          AND  oprc.pid       = #pid#
          AND  oprc.prcpclscd = 'F2'                   -- M0005: 재활
          AND  oprc.prcpexecdeptcd = '2220200000'      -- 재활치료실
          AND  oprc.prcphistcd     = 'O'
          AND  oprc.prcpdd         = exop.prcpdd
          AND  oprc.prcpno         = exop.prcpno
          AND  oprc.instcd         = exop.instcd
          AND  exop.execprcphistcd = 'O'
          AND  exop.actorddd       = #orddd#
          AND  exop.rsrvdd         = '00000000'
        GROUP BY exop.actorddd,oprc.prcpdd
    ]]>
    </statement>
    <!-- 2220200000 부서 하드코딩 제거해야할것으로 판단됨 확인후 삭제하겠음 -->
    
    
    <!-- M006 본인부담의 경우 상병이 중증/희귀가 아닐경우 '-'로 업데이트 -->
    <!-- M005의 경우 희귀난치성질병 이외의 상병도 적용가능하도록 수정 by 조중래 20130605 -->
    <statement id="setOwnbflagCheck"><![CDATA[
       UPDATE	PAM.PMOHOTPT a
       SET			ownbflag 		= '-'
       				, lastupdtrid 		= 'PAM004'
       				, lastupdtdt 		= systimestamp
       WHERE 	a.pid     		= #pid#
	   AND 		a.calcflag   	!= 'N'
	   AND 		a.instcd     	= #sessinstcd#
	   AND 		a.histstat    	!= 'X'
	   AND 		a.orddd     	>= TO_CHAR(SYSDATE - 365, 'YYYYMMDD')
	   AND 		a.ordtype   	!= 'S'
	   AND		a.ownbflag	IN ('M006')
	   AND		( a.dracptyn = 'Y' OR a.etcordflag in ('M', 'J', 'T') )		--물리치료, 주사, 치료방사선은 진료완료 아니더라도 체크함.
	   AND		EXISTS (
	   							SELECT	'X'
	   							FROM		PAM.PMCMCODE
	   							WHERE	CDGRUPID = 'P0032'
	   							AND		CDID = '310'
	   							AND		INSTCD = a.instcd
	   							AND		CDNM = 'Y'		--체크여부 적용
	   						 )	   
	   AND		NOT EXISTS ( 	
	   									select	 'x'
							            from    emr.mmohdiag b
											  	, emr.mrtddiagattr c
											  	, emr.mrtmterm d
											  	, pam.picmessc e
										WHERE  b.pid        = a.pid
										   AND  b.orddd      = a.orddd
										   AND  b.cretno     = a.cretno
										   AND  b.orddeptcd  = a.orddeptcd
										   AND  b.diaghistcd = 'O'
										   AND  b.diagtypecd = 'D'
										   AND  b.diagkindcd ='C'
										   AND  b.diagkindcdflag = 'M'
										   AND  d.termcd = b.diagcd 
										   AND  d.termflag   = '0'    
										   AND  b.diagdd between d.termfromdd AND d.termtodd
										   AND  c.diagattrcd = d.attrcd 
										   AND  b.diagdd between c.DIAGATTRFROMDD and c.DIAGATTRTODD
										   AND  a.instcd = b.instcd
										   AND  a.instcd = c.instcd
										   AND  a.instcd = d.instcd
										   AND  e.instcd = a.instcd
										   AND  e.insukind = a.insukind
										   AND  a.orddd between e.fromdd and e.todd
										   AND  e.spclflag in (	'3', '8', '10', '12', '14' ) --3 중증환자, 8 희귀난치, 10 희귀난치성산정특례, 12 등록중증화상, 14 결핵지원(P0490)  
										   AND  decode(e.diagkind, '1', c.icd10cd, d.attrcd) BETWEEN e.diagcdfrom AND e.diagcdto
							        )
    ]]>
    </statement>
    
    
    <!-- M005, M006 본인부담의 경우 상병이 중증/희귀가 아닐경우 체크 -->    
    <statement id="getOwnbflagCheckInfo"><![CDATA[
       SELECT		PID, ORDDD, CRETNO
       FROM		PAM.PMOHOTPT a
       WHERE 	a.pid     		= #otpt_pid#
	   AND 		a.instcd     	= #sessinstcd#
	   AND 		a.histstat    	!= 'X'
	   AND 		a.orddd     	= #otpt_orddd#
	   AND		a.cretno		= #otpt_cretno#
	   AND 		a.ordtype   	!= 'S'
	   --AND		a.ownbflag	IN ('M005', 'M006') -- 로직에서 체크하도록 수정 by 조중래 20130603
	   AND		( a.dracptyn = 'Y' OR a.etcordflag in ('M', 'J', 'T') )		--물리치료, 주사, 치료방사선은 진료완료 아니더라도 체크함.
	   AND		EXISTS (
	   							SELECT	'X'
	   							FROM		PAM.PMCMCODE
	   							WHERE	CDGRUPID = 'P0032'
	   							AND		CDID = '310'
	   							AND		INSTCD = a.instcd
	   							AND		CDNM = 'Y'		--체크여부 적용
	   						 )	   
	   AND		NOT EXISTS ( 	
	   									select	 'x'
							            from    emr.mmohdiag b
											  	, emr.mrtddiagattr c
											  	, emr.mrtmterm d
											  	, pam.picmessc e
										WHERE  b.pid        = a.pid
										   AND  b.orddd      = a.orddd
										   AND  b.cretno     = a.cretno
										   AND  b.orddeptcd  = a.orddeptcd
										   AND  b.diaghistcd = 'O'
										   AND  b.diagtypecd = 'D'
										   AND  b.diagkindcd ='C'
										   AND  b.diagkindcdflag = 'M'
										   AND  d.termcd = b.diagcd 
										   AND  d.termflag   = '0'    
										   AND  b.diagdd between d.termfromdd AND d.termtodd
										   AND  c.diagattrcd = d.attrcd 
										   AND  b.diagdd between c.DIAGATTRFROMDD and c.DIAGATTRTODD
										   AND  a.instcd = b.instcd
										   AND  a.instcd = c.instcd
										   AND  a.instcd = d.instcd
										   AND  e.instcd = a.instcd
										   AND  e.insukind = a.insukind
										   AND  a.orddd between e.fromdd and e.todd
										   AND  e.spclflag in (	'3', '8', '10', '12', '14' ) --3 중증환자, 8 희귀난치, 10 희귀난치성산정특례, 12 등록중증화상, 14 결핵지원(P0490)  
										   AND  decode(e.diagkind, '1', c.icd10cd, d.attrcd) BETWEEN e.diagcdfrom AND e.diagcdto
							        )
    ]]>
    </statement>
    
    <!-- TRPAO03303 -->
    <statement id="getUncoAmtSMSMsg">
        <![CDATA[
        SELECT * FROM com.zmsmmsgf WHERE msgfrmtid='sms.pam.0004' -- 후불수납 메세지
        ]]>
    </statement>
    
    <!-- TRPAO03301 -->
    <statement id="getUncoAmtSMSSpec">
        <![CDATA[
        SELECT
            NVL(a.smstrsmyn, 'N') AS smstrsmyn,
            a.pid,
            b.hngnm,
            a.orddd,   
            a.rcptexecdd as execdd,
            b.mpphontel,
            a.uncoamt,
            a.instcd, 
            a.pid, 
            a.rcptdd, 
            a.rcptno, 
            a.rcptseqno, 
            a.seqno 
            
        FROM
            PAM.PAMHUNCO a,
            PAM.PMCMPTBS b
        WHERE
            a.instcd       = b.instcd
        AND a.pid          = b.pid
        AND a.instcd       = #%dutplceinstcd#
        AND a.rcptstat     = 'Y'
        AND a.rcptdd       BETWEEN #searchfromdd# AND #searchtodd#
        AND a.uncorcptflag = '1'   --발생분만 체크
        AND a.uncocd       = 'V01' --VIP후수납 미수코드
        AND a.endyn       != 'Y'   --입금된 내역은 제외 ]]>
        <isEqual property="searchflag" compare="2"> <![CDATA[
        AND a.smstrsmyn    = 'Y' ]]>
        </isEqual>
        <isEqual property="searchflag" compare="3"> <![CDATA[
        AND NVL(a.smstrsmyn, 'N') != 'Y' ]]>
        </isEqual> 
        <isNotEmpty property="pid"> <![CDATA[
        AND a.pid = #pid# ]]>
        </isNotEmpty>
    </statement>
    
    <statement id="setUncoAmtSMSTrsm"> <![CDATA[
        UPDATE  pam.pamhunco
        SET     smstrsmyn = 'Y',
                lastupdtrid = #%userid#,
                lastupdtdt = SYSTIMESTAMP
        WHERE       
            pid        = #pid#
        AND instcd     = #%dutplceinstcd#
        AND rcptdd     = #rcptdd#
        AND rcptno     = #rcptno#
        AND rcptseqno  = #rcptseqno#
        AND seqno      = #seqno# ]]>
    </statement>

    <statement id="getUncoAmtSMSTrsmSpec">
        <![CDATA[
        SELECT
            a.pid,
            b.hngnm,
            a.orddd,
            b.mpphontel,
            a.uncoamt,
            c.trsmreqdt,
            COM.FN_ZS_GETUSERNM(c.fstrgstrid, TO_CHAR(c.trsmreqdt, 'YYYYMMDD')) AS trsmid,
            c.msgcnts
            
        FROM
            pam.pamhunco a, 
            pam.pmcmptbs b, 
            com.zmshmsgt c
            
        WHERE
        
            a.pid          = b.pid
        AND a.instcd       = b.instcd
        AND a.instcd       = #%dutplceinstcd#
        AND a.rcptstat     = 'Y'
        AND a.uncorcptflag = '1'   --발생분만 체크
        AND a.uncocd       = 'V01' --VIP후수납 미수코드
        AND a.endyn       != 'Y'   --입금된 내역은 제외
        AND a.pid          = c.pid
        AND c.msgfrmtid    = 'sms.pam.0004'
        AND SUBSTR(TO_CHAR(c.trsmreqdt, 'YYYYMMDD'), 1, 8) >= #smsfromdd#
        AND SUBSTR(TO_CHAR(c.trsmreqdt, 'YYYYMMDD'), 1, 8) <= #smstodd#
        
        ORDER BY c.trsmreqdt desc
        ]]>                    
    </statement>
    
    <statement id="getdisclistchk">
    	select	discuncocd as disccd
    	  from	pam.pmcmfmly
    	 where	pid = #pid#
    	   and	#orddd# between fromdd and todd
    </statement>
    
    <!-- 경증상병환자 수납시 자동 특례코드 입력 로직 -->
    <statement id="getSpclcd">
    	<![CDATA[
    	
				  SELECT	 e.spclcd
		           FROM   pam.pmcmcode a
		            		, emr.mmohdiag b
						  	, emr.mrtddiagattr c
						  	, emr.mrtmterm d
						  	, pam.picmessc e
				   WHERE   b.pid        = #pid#
					   AND  b.orddd      = #orddd#
					   AND  b.cretno     = #cretno#
					   AND  b.orddeptcd  = #orddeptcd#
					   AND  a.instcd = #instcd#
					   AND  a.cdgrupid = 'PK009'
					   AND  a.cdnm = #insukind#
					   AND  a.detldesc = #suppkind#
					   AND  b.diaghistcd = 'O'
					   AND  b.diagtypecd = 'D'
					   AND  b.diagkindcd ='C'
					   AND  b.diagkindcdflag = 'M'
					   AND  d.termcd = b.diagcd 
					   AND  d.termflag   = '0'    
					   AND  b.diagdd between d.termfromdd AND d.termtodd
					   AND  c.diagattrcd = d.attrcd 
					   AND  b.diagdd between c.DIAGATTRFROMDD and c.DIAGATTRTODD
					   AND  a.instcd = b.instcd
					   AND  a.instcd = c.instcd
					   AND  a.instcd = d.instcd
					   AND  e.instcd = a.instcd
					   AND  e.insukind = #insukind#
					   AND  #orddd# between e.fromdd and e.todd
					   AND  e.spclflag = '16' --경증환자
					   AND  e.ioflag IN ('A', 'O')
					   AND  decode(e.diagkind, '1', c.icd10cd, d.attrcd) BETWEEN e.diagcdfrom AND e.diagcdto 
					   AND  rownum < 2
	 ]]>         
    </statement>
    
    <!-- 경증상병 특례코드 업데이트 -->
    <statement id="setSpclcd">
    	update	pam.pmohotpt
    	set			spclcd = #spclcd#
    	where		instcd = #instcd#
    	and		pid = #pid#
    	and		orddd = #orddd#
    	and		cretno = #cretno#
    	and		histstat IN ('R', 'T')
    </statement>
    
    <!-- 장기기증 WorkUp 상병체크 -->
    <statement id="getCheckWorkUpDiag"> <![CDATA[
        SELECT 
            COUNT(*) AS cnt
        FROM
            emr.mmohdiag a,
            emr.mmbvdiag b,
            emr.mmbdhrcd c
        WHERE 
            a.instcd     = #%dutplceinstcd#
        AND a.pid        = #pid#
        AND a.orddd      = #orddd#
        AND a.cretno     = #cretno#
        AND a.diaghistcd = 'O' -- C:DC전, D:DC, E:반납, H:수정, L:삭제, M:전환, O:처방, T:Temp, X:임시
        AND a.diagkindcd = 'C' -- C:확정, R:RuleOut
        AND a.diagkindcdflag = 'M' -- M:주상병, S:부상병
        AND a.diagtypecd = 'D'  -- D:진료진단, O:입원의뢰서 수술, R:입원의뢰서 진단 
        
        AND a.instcd   = b.instcd
        AND a.diagcd   = b.orgdiagcd
        AND a.diagdd  >= b.diagattrfromdd
        AND a.diagdd  <= b.diagattrtodd
        AND a.diagdd  >= b.termfromdd
        AND a.diagdd  <= b.termtodd
        
        AND b.instcd   = c.instcd
        AND b.icd10cd  = c.trgtcd
        AND a.orddd    BETWEEN c.valifromdd AND c.valitodd
        AND c.hardcdno = '337' -- 진료 하드코팅 테이블 : 장기이식 W/U 대상 상병
        
        AND NOT EXISTS ( -- 공여자 등록 시 보험처리
                SELECT
                    'X'
                FROM
                    pam.picmtrpt -- 이식환자 등록관리
                WHERE
                    instcd    = a.instcd
                AND givpid    = a.pid    -- 공여자 번호
                AND trnptdd   < a.orddd  -- 이식일자
                AND trnptflag = 'O'  -- 이식구분(O:장기이식, B:골수이식)
                AND rowstat   <> 'D' -- (-:생성, I:추가, U:수정, D:삭제)
            )
        ]]>
    </statement>
</sqls>    
